function addNsEvent(t,e){var i=t.split("."),a=i[0];i[1];return this.bindCache=this.bindCache||{},this.bindCache[t]?this.bindCache[t].push(e):this.bindCache[t]=[e],this.addEvent(a,e),this}function removeNsEvent(t){if(void 0===this.bindCache||!this.bindCache.hasOwnProperty(t))return this;for(var e,i=t.split(".")[0],a=0,n=this.bindCache[t];e=n[a++];)this.removeEvent(i,e);return this}function removeNsEvents(t){var e,i,a=this;return Object.each(this.bindCache,(function(n,o){if(o.contains(".")&&o.split(".").getLast()===t)for(e=0;i=n[e++];)a.removeEvent(o.split(".")[0],i)})),this}"function"!=typeof Number.isFinite&&(Number.isFinite=function(t){return"number"==typeof t&&isFinite(t)}),"function"!=typeof Object.values&&(Object.values=function(t){return Object.keys(t).map((function(e){return t[e]}))}),"function"!=typeof Object.assign&&Object.defineProperty(Object,"assign",{enumerable:!1,configurable:!0,writable:!0,value:function(t){"use strict";if(null==t)throw new TypeError("Cannot convert first argument to object");for(var e=Object(t),i=1;i<arguments.length;i++){var a=arguments[i];if(null!=a){a=Object(a);for(var n=Object.keys(Object(a)),o=0,r=n.length;o<r;o++){var s=n[o],l=Object.getOwnPropertyDescriptor(a,s);void 0!==l&&l.enumerable&&(e[s]=a[s])}}}return e}}),"function"!=typeof Object.create&&(Object.create=function(t,e){if(null!==t&&"object"!=typeof t&&"function"!=typeof t)throw TypeError("Argument must be an object, or null");var i=new Object;return i.__proto__=t,"object"==typeof e&&Object.defineProperties(i,e),i}),Array.prototype.find||Object.defineProperty(Array.prototype,"find",{value:function(t){if(null==this)throw new TypeError('"this" is null or not defined');var e=Object(this),i=e.length>>>0;if("function"!=typeof t)throw new TypeError("predicate must be a function");for(var a=arguments[1],n=0;n<i;){var o=e[n];if(t.call(a,o,n,e))return o;n++}}}),Travian.Constants={RES_LUMBER:1,RES_CLAY:2,RES_IRON:3,RES_CROP:4,RESOURCE_NAME:{1:"lumber",2:"clay",3:"iron",4:"crop"},HERO_STATUS_IN_VILLAGE:100,HERO_STATUS_DEAD:101,HERO_STATUS_ON_THE_WAY_TO_ATTACK:3,HERO_STATUS_ON_THE_WAY_TO_RAID:4,HERO_STATUS_ON_THE_WAY_TO_SUPPLY:5,HERO_STATUS_ON_THE_RETURN_PATH:9,HERO_STATUS_ON_ESCAPE:40,HERO_STATUS_ON_ADVENTURE:50,HERO_STATUS_CAPTURED:102,HERO_STATUS_ON_SUPPLY:103,PROFILE_MAX_REPORTS_PLAYER_CAN_CREATE:2,PLAYER_GENDER_DIVERSE:"diverse",PLAYER_GENDER_FEMALE:"female",PLAYER_GENDER_MALE:"male",PLAYER_GENDER_NOT_SPECIFIED:"NotSpecified",BUILDING_SLOT_RALLY_POINT:39,VILLAGE_PERSPECTIVE_RESOURCES:"perspectiveResources",VILLAGE_PERSPECTIVE_BUILDINGS:"perspectiveBuildings",VILLAGE_TYPE_NORMAL:0,VILLAGE_TYPE_CAPITAL:1,VILLAGE_TYPE_OASIS_FREE:3,VILLAGE_TYPE_OASIS_OCCUPIED:2,VILLAGE_TYPE_VILLAGES:{0:0,1:1},VILLAGE_TYPE_OASES:{0:2,1:3},REPORT_REASONS:{multiAccount:"admin.c3_sperrgrund_multi_und_pushing",passwordSharing:"admin.c3_sperrgrund_multiaccount",botScript:"admin.c3_sperrgrund_scripts_und_bots",other:"admin.c3_sperrgrund_sonstiges",inappropriateContent:"admin.inappropriateContent",privateFarm:"admin.banReasonPrivateFarm"},ACTION:{account:"account",troopsSend:"troopsSend",trainTroops:"trainTroops",tradeRoute:"traderoute",heroRevive:"heroRevive",auction:"auction",raidList:"raidList",farmList:"farmList",premiumFeature:"premiumFeature",inventory:"inventory",silverExchange:"silverExchange",marketPlace:"marketPlace"},MEDIUM_LOYALTY_VALUE:100,EVENT_TYPES:{attack:3,raid:4,forward:72},TROOP_NUMBER_TYPES:{hero:"t11"},TIME_FORMAT_MODE:{eu:0,us:1,uk:2,iso:3,acp:4},TRIBE_ID:{roman:1,teuton:2,gaul:3,natar:5,egyptian:6,hun:7,spartan:8},SHOP_TABS:{buyGold:"buyGold",advantages:"pros",vouchers:"vouchers",specialOffers:"specialOffers"},AUTO_COMPLETE:{villageName:"villagename",playerName:"playername"},TRADE_OFFER_RATIO_LIMIT:1,TRADE_POPULATION_THRESHOLD:200,TRANSFER_TYPE_GOLD_TO_SILVER:"GoldToSilver",TRANSFER_TYPE_SILVER_TO_GOLD:"SilverToGold"},Travian.emptyFunction=function(){},Travian.redirectTo=function(t){Travian.WindowManager.getWindows().map((function(t){Travian.WindowManager.unregister(t)})),window.location.assign(t)},Travian.defaultErrorFunction=function(t){t&&t.message&&new Travian.Dialog.Dialog({preventFormSubmit:!0}).setContent(t.message).show()},Travian.api=function(t,e={},i="POST",a="json"){const n=function(t={},e,i){return t.reload?Travian.Autoreload.autoreload():t.redirectTo?Travian.redirectTo(t.redirectTo):void e(t,i)},o=e.success||Travian.emptyFunction,r=e.error||Travian.defaultErrorFunction,s=Object.assign(e.headers||{},{"X-Version":"2022.6",Authorization:"Bearer "+Travian.grislierAffirmCiviliansHereditaryUnknowns}),l=Object.assign({},Travian.Variables.javascript.ajaxOptions||{},e,{url:"/api/v1/"+t,method:i,data:JSON.stringify(e.data),processData:!1,dataType:a,contentType:"application/json; charset=UTF-8",headers:s,complete:e.complete||Travian.emptyFunction,success:function(t,e,i){n(t,o,i)},error:function(t,e,i){n(t&&t.responseJSON,r,t)}});return jQuery.ajax(l)},Travian.graphQL=function(t,e,i){return Travian.api("graphql",{data:{query:t.query,variables:t.variables},success:e,error:i},"POST","json")},Travian.isToggleClosed=function(t,e){t=jQuery(t);var i=(e=jQuery(e)).attr("class").indexOf("Mirrored")>=0,a=t.hasClass("hide"),n=a&&e.hasClass("switchClosed");return i&&(n=a&&e.hasClass("switchClosedMirrored")),n},Travian.toggleSwitch=function(t,e){t=jQuery(t),e=jQuery(e),t.toggleClass("hide");var i=e.attr("class").indexOf("Mirrored")>=0;return e.toggleClass("switchClosed"),i&&e.toggleClass("switchClosedMirrored"),e.toggleClass("switchOpened"),i&&e.toggleClass("switchOpenedMirrored"),this},Travian.toggleSwitchDescription=function(t,e,i){return"element"==typeof t&&(t=[t]),t.each((function(){let t=jQuery(this);t.hasClass("switchClosed")?(t.attr("title",e),t.attr("alt",e)):(t.attr("title",i),t.attr("alt",i))})),this},Travian.updateSideboxVillageHref=function(t){jQuery("#sidebarBoxVillagelist").find("li").each((function(){var e=jQuery(this).find("a"),i=Travian.Browser.parseURL(e.attr("href")),a="",n="?";for(var o in void 0!==t&&(i.searchObject.t=t),i.searchObject)i.searchObject.hasOwnProperty(o)&&(a+=n+o+"="+i.searchObject[o],n="&");e.attr("href",a)}))},Travian.getCursorPosition=function(t){let e=t.pageX,i=t.pageY;return void 0===i&&(void 0!==t.touches&&(e=t.touches[0].pageX,i=t.touches[0].pageY),void 0!==t.originalEvent&&(e=t.originalEvent.touches[0].pageX,i=t.originalEvent.touches[0].pageY),void 0!==t.nativeEvent&&(e=t.nativeEvent.touches[0].pageX,i=t.nativeEvent.touches[0].pageY)),{x:e,y:i,timestamp:new Date}},window.Travian.Autoreload={reloadParameter:"reload",autoreloadParameterValue:"auto",inReload:!1,autoreload:function(){if(this.inReload)return;this.inReload=!0;let t,e=window.location.href;if(-1!==(t=e.indexOf("#"))&&(e=e.substring(0,t)),-1===e.indexOf(Travian.Autoreload.reloadParameter)){let t=Travian.Autoreload.reloadParameter+"="+Travian.Autoreload.autoreloadParameterValue;-1===e.indexOf("?")?e+="?"+t:e+="&"+t}window.location.href=e},removeAutoreloadParameter:function(){let t=document.location.href,e=document.location.hash;if(""!==e){let i=t.indexOf(e);t=t.substring(0,i)}let i=Travian.Autoreload.reloadParameter+"="+Travian.Autoreload.autoreloadParameterValue,a=t.indexOf(i);-1!==a&&(t=t.substring(0,a-1)+e,window.history.pushState({id:t},"",t))}},Travian.Helpers={substitute:function(t,e,i){return t.replace(i||/\\?\{([^{}]+)\}/g,(function(t,i){return"\\"===t.charAt(0)?t.slice(1):null!=e[i]?e[i]:""}))},capitalizeFirstLetter:function(t){return t.charAt(0).toUpperCase()+t.slice(1)}},Travian.Browser={isTouchInput:!1,isMobile:function(){var t=!1,e=navigator.userAgent||navigator.vendor||window.opera;return(/ipad|ipod|(android|bb\d+|meego).+mobile|avantgo|bada\/|blackberry|blazer|compal|elaine|fennec|hiptop|iemobile|ip(hone|od)|iris|kindle|lge |maemo|midp|mmp|mobile.+firefox|netfront|opera m(ob|in)i|palm( os)?|phone|p(ixi|re)\/|plucker|pocket|psp|series(4|6)0|symbian|treo|up\.(browser|link)|vodafone|wap|windows (ce|phone)|windows nt.+touch|xda|xiino/i.test(e)||/1207|6310|6590|3gso|4thp|50[1-6]i|770s|802s|a wa|abac|ac(er|oo|s\-)|ai(ko|rn)|al(av|ca|co)|amoi|an(ex|ny|yw)|aptu|ar(ch|go)|as(te|us)|attw|au(di|\-m|r |s )|avan|be(ck|ll|nq)|bi(lb|rd)|bl(ac|az)|br(e|v)w|bumb|bw\-(n|u)|c55\/|capi|ccwa|cdm\-|cell|chtm|cldc|cmd\-|co(mp|nd)|craw|da(it|ll|ng)|dbte|dc\-s|devi|dica|dmob|do(c|p)o|ds(12|\-d)|el(49|ai)|em(l2|ul)|er(ic|k0)|esl8|ez([4-7]0|os|wa|ze)|fetc|fly(\-|_)|g1 u|g560|gene|gf\-5|g\-mo|go(\.w|od)|gr(ad|un)|haie|hcit|hd\-(m|p|t)|hei\-|hi(pt|ta)|hp( i|ip)|hs\-c|ht(c(\-| |_|a|g|p|s|t)|tp)|hu(aw|tc)|i\-(20|go|ma)|i230|iac( |\-|\/)|ibro|idea|ig01|ikom|im1k|inno|ipaq|iris|ja(t|v)a|jbro|jemu|jigs|kddi|keji|kgt( |\/)|klon|kpt |kwc\-|kyo(c|k)|le(no|xi)|lg( g|\/(k|l|u)|50|54|\-[a-w])|libw|lynx|m1\-w|m3ga|m50\/|ma(te|ui|xo)|mc(01|21|ca)|m\-cr|me(rc|ri)|mi(o8|oa|ts)|mmef|mo(01|02|bi|de|do|t(\-| |o|v)|zz)|mt(50|p1|v )|mwbp|mywa|n10[0-2]|n20[2-3]|n30(0|2)|n50(0|2|5)|n7(0(0|1)|10)|ne((c|m)\-|on|tf|wf|wg|wt)|nok(6|i)|nzph|o2im|op(ti|wv)|oran|owg1|p800|pan(a|d|t)|pdxg|pg(13|\-([1-8]|c))|phil|pire|pl(ay|uc)|pn\-2|po(ck|rt|se)|prox|psio|pt\-g|qa\-a|qc(07|12|21|32|60|\-[2-7]|i\-)|qtek|r380|r600|raks|rim9|ro(ve|zo)|s55\/|sa(ge|ma|mm|ms|ny|va)|sc(01|h\-|oo|p\-)|sdk\/|se(c(\-|0|1)|47|mc|nd|ri)|sgh\-|shar|sie(\-|m)|sk\-0|sl(45|id)|sm(al|ar|b3|it|t5)|so(ft|ny)|sp(01|h\-|v\-|v )|sy(01|mb)|t2(18|50)|t6(00|10|18)|ta(gt|lk)|tcl\-|tdg\-|tel(i|m)|tim\-|t\-mo|to(pl|sh)|ts(70|m\-|m3|m5)|tx\-9|up(\.b|g1|si)|utst|v400|v750|veri|vi(rg|te)|vk(40|5[0-3]|\-v)|vm40|voda|vulc|vx(52|53|60|61|70|80|81|83|85|98)|w3c(\-| )|webc|whit|wi(g |nc|nw)|wmlb|wonu|x700|yas\-|your|zeto|zte\-/i.test(e.substr(0,4)))&&(t=!0),t},monitorInputType:function(){["pointermove","pointerdown"].forEach((t=>window.addEventListener(t,(function(t){Travian.Browser.isTouchInput="touch"===t.pointerType}))))},parseURL:function(t){var e=document.createElement("a"),i={};return e.href=t,e.search.substr(1).split("&").forEach((function(t){var e=t.split("="),a=decodeURIComponent(e[0]);a.length>0&&(i[a]=e[1])})),{protocol:e.protocol,host:e.host,hostname:e.hostname,port:e.port,pathname:("/"!==e.pathname.charAt(0)?"/":"")+e.pathname,searchObject:i,hash:e.hash}},composeURL:function(t){var e=t.protocol+"//"+t.host;return e+=this.composeURI(t)},composeURI:function(t){var e=t.pathname,i="?";for(var a in t.searchObject)t.searchObject.hasOwnProperty(a)&&(e+=i+a+"="+t.searchObject[a],i="&");return e+=t.hash},getScript:function(t,e){const i=jQuery("script");if(i)for(let a=i.length-1;a>=0;a--)if(i[a].src&&i[a].src===t)return e&&e();jQuery.ajax(t,{dataType:"script",success:e,cache:!0})},getCss:function(t){var e=jQuery("link");if(e)for(var i=e.length-1;i>=0;i--)if(e[i].href&&e[i].href===t)return!1;return jQuery('<link rel="stylesheet" type="text/css" href="'+t+'"/>').appendTo("head"),!0}},Travian.Browser.monitorInputType(),Travian.Draggable=function(t,e){this.options=Object.assign({onDrag:function(t,e){},snap:6,unit:"px",grid:!1,style:!0,limit:!1,handle:!1,invert:!1,unDraggableTags:["button","input","a","textarea","select","option"],preventDefault:!0,stopPropagation:!0,compensateScroll:!1,modifiers:{x:"left",y:"top"}},e),this.attach=function(){return this.handles.on("mousedown",this.bound.start),this.handles.on("touchstart",this.bound.start),this.options.compensateScroll&&this.offsetParent.on("scroll",this.bound.scrollListener),this},this.detach=function(){return this.handles.off("mousedown",this.bound.start),this.handles.off("touchstart",this.bound.start),this.options.compensateScroll&&this.offsetParent.off("scroll",this.bound.scrollListener),this},this.scrollListener=function(){if(this.mouse.start){var t={x:this.offsetParent.scrollTop(),y:this.offsetParent.scrollLeft()};if("absolute"===this.element.css("position")){var e=this.sumValues(t,this.compensateScroll.last,-1);this.mouse.now=this.sumValues(this.mouse.now,e,1)}else this.compensateScroll.diff=this.sumValues(t,this.compensateScroll.start,-1);this.offsetParent!==window&&(this.compensateScroll.diff=this.sumValues(this.compensateScroll.start,t,-1)),this.compensateScroll.last=t,this.render(this.options)}},this.sumValues=function(t,e,i){var a={},n=this.options;for(var o in n.modifiers)n.modifiers[o]&&(a[o]=t[o]+e[o]*i);return a},this.start=function(t){if(-1===this.options.unDraggableTags.indexOf(t.target.getAttribute("tag"))){var e=this.options;if(3!==t.which&&2!==t.button){e.preventDefault&&t.preventDefault(),e.stopPropagation&&t.stopPropagation(),this.compensateScroll.start=this.compensateScroll.last={x:this.offsetParent.scrollTop(),y:this.offsetParent.scrollLeft()},this.compensateScroll.diff={x:0,y:0},this.mouse.start={x:t.pageX,y:t.pageY};var i=e.limit;this.limit={x:[],y:[]};var a,n,o=this.offsetParent===window?null:this.offsetParent;for(a in e.modifiers)if(e.modifiers.hasOwnProperty(a)){var r=this.element.css(e.modifiers[a]);if(r&&!r.match(/px$/)&&(n||(n=this.element.getCoordinates(o)),r=n[e.modifiers[a]]),e.style?this.value.now[a]=parseInt(r||0):this.value.now[a]=this.element[e.modifiers[a]],e.invert&&(this.value.now[a]*=-1),this.mouse.pos[a]=this.mouse.start[a]-this.value.now[a],i&&i[a])for(var s=2;s--;){var l=i[a][s];(l||0===l)&&(this.limit[a][s]="function"==typeof l?l():l)}}"number"==typeof this.options.grid&&(this.options.grid={x:this.options.grid,y:this.options.grid});var d={mousemove:this.bound.check,mouseup:this.bound.cancel,touchend:this.bound.cancel};this.document.on(d),document.addEventListener("touchmove",this.bound.check,{passive:!1})}}},this.check=function(t){this.options.preventDefault&&t.preventDefault(),Math.round(Math.sqrt(Math.pow(t.pageX-this.mouse.start.x,2)+Math.pow(t.pageY-this.mouse.start.y,2)))>this.options.snap&&(this.cancel(),this.document.on({mousemove:this.bound.drag,mouseup:this.bound.stop,touchend:this.bound.stop}),document.addEventListener("touchmove",this.bound.drag,{passive:!1}))},this.drag=function(t){var e=this.options;e.preventDefault&&t.preventDefault(),this.mouse.now=this.sumValues({x:t.pageX,y:t.pageY},this.compensateScroll.diff,-1),this.render(e),this.options.onDrag(this.element,t)},this.render=function(t){for(var e in t.modifiers)if(t.modifiers.hasOwnProperty(e)){if(!t.modifiers[e])continue;this.value.now[e]=this.mouse.now[e]-this.mouse.pos[e],t.invert&&(this.value.now[e]*=-1),t.limit&&this.limit[e]&&((this.limit[e][1]||0===this.limit[e][1])&&this.value.now[e]>this.limit[e][1]?this.value.now[e]=this.limit[e][1]:(this.limit[e][0]||0===this.limit[e][0])&&this.value.now[e]<this.limit[e][0]&&(this.value.now[e]=this.limit[e][0])),t.grid[e]&&(this.value.now[e]-=(this.value.now[e]-(this.limit[e][0]||0))%t.grid[e]),t.style?this.element.css(t.modifiers[e],this.value.now[e]+t.unit):this.element[t.modifiers[e]]=this.value.now[e]}},this.cancel=function(t){this.document.off({mousemove:this.bound.check,mouseup:this.bound.cancel,touchmove:this.bound.check,touchend:this.bound.cancel})},this.stop=function(t){var e={mousemove:this.bound.drag,mouseup:this.bound.stop,touchmove:this.bound.drag,touchend:this.bound.stop};this.document.off(e),this.mouse.start=null},this.element=jQuery(t),this.document=jQuery(document),this.handles=jQuery(this.options.handle)||this.element,this.mouse={now:{},pos:{}},this.value={start:{},now:{}},this.offsetParent=this.element.parent(),this.selection="selectstart"in document?"selectstart":"mousedown",this.compensateScroll={start:{},diff:{},last:{}},this.bound={start:this.start.bind(this),check:this.check.bind(this),drag:this.drag.bind(this),stop:this.stop.bind(this),cancel:this.cancel.bind(this),scrollListener:this.scrollListener.bind(this)},this.attach()},Travian.Moveable=function(t,e){if(this.options=Object.assign({onDrop:function(t,e,i){},droppables:[],container:!1,precalculate:!1,includeMargins:!0,checkDroppables:!0},e),this.setContainer=function(t){this.container=jQuery(t)},this.start=function(t){this.container&&(this.options.limit=this.calculateLimit()),this.options.precalculate&&(this.positions=this.droppables.map((function(t){return t.getCoordinates()}))),this.parent.start.call(this,t)},this.calculateLimit=function(){var t=this.element,e=this.container,i=jQuery(t.parent()||document.body),a=e.getCoordinates(i),n={},o={},r={},s={},l={},d=i.scrollTop(),u=i.scrollLeft();["top","right","bottom","left"].each((function(a){n[a]=parseInt(t.css("margin-"+a)),o[a]=parseInt(t.css("border-"+a)),r[a]=parseInt(e.css("margin-"+a)),s[a]=parseInt(e.css("border-"+a)),l[a]=parseInt(i.css("padding-"+a))}),this);var c=t.offsetWidth+n.left+n.right,p=t.offsetHeight+n.top+n.bottom,h=0+d,m=0+u,v=a.right-s.right-c+d,f=a.bottom-s.bottom-p+u;if(this.options.includeMargins?(h+=n.left,m+=n.top):(v+=n.right,f+=n.bottom),"relative"===t.css("position")){var g=t.getCoordinates(i);g.left-=parseInt(t.css("left")),g.top-=parseInt(t.css("top")),h-=g.left,m-=g.top,"relative"!==e.css("position")&&(h+=s.left,m+=s.top),v+=n.left-g.left,f+=n.top-g.top,e!==i&&(h+=r.left+l.left,!l.left&&h<0&&(h=0),m+=i===document.body?0:r.top+l.top,!l.top&&m<0&&(m=0))}else h-=n.left,m-=n.top,e!==i&&(h+=a.left+s.left,m+=a.top+s.top);return{x:[h,v],y:[m,f]}},this.getDroppableCoordinates=function(t){var e=t.getCoordinates();if("fixed"===t.css("position")){var i=window.getScroll();e.left+=i.x,e.right+=i.x,e.top+=i.y,e.bottom+=i.y}return e},this.checkDroppables=function(){var t=this.droppables.filter((function(t,e){t=this.positions?this.positions[e]:this.getDroppableCoordinates(t);var i=this.mouse.now;return i.x>t.left&&i.x<t.right&&i.y<t.bottom&&i.y>t.top}),this).getLast();this.overed!==t&&(this.overed=t)},this.drag=function(t){this.parent.drag.call(this,t),this.options.checkDroppables&&this.droppables.length&&this.checkDroppables()},this.stop=function(t){return this.checkDroppables(),this.options.onDrop(this.element,this.overed,t),this.overed=null,this.parent.stop.call(this,t)},Travian.Draggable.call(this,t,this.options),this.droppables=jQuery(this.options.droppables),this.setContainer(this.options.container||document.body),this.options.style){if("left"===this.options.modifiers.x&&"top"===this.options.modifiers.y){var i=t.position(),a=t.css(["left","top"]);!i||"auto"!==a.left&&"auto"!==a.top||t.offset(t.position())}"static"===t.css("position")&&t.css("position","absolute")}this.overed=null},Travian.Moveable.prototype=Object.create(Travian.Draggable.prototype),Travian.Moveable.constructor=Travian.Moveable,Travian.Moveable.parent=Travian.Draggable.prototype,Travian.Storage=function(){var t=function(t){var e=t?"localStorage":"sessionStorage";return window[e]?window[e]:null},e=function(t){return"Travian."+t};return{cachingTime:31536e6,clear:function(i,a){return function(i,a){var n=t(i);a=e(a),null===n||n.removeItem(a)}(a,i),this},get:function(i,a){var n=function(i,a){var n=t(i),o=null;return a=e(a),null===n||null==(o=n.getItem(a))||void 0===o?null:JSON.decode(o)}(a,i);return null===n||!0===function(t,e){var i=t.cachingTime;return void 0!==e.cachingTime&&null!==e.cachingTime&&(i=e.cachingTime),!1!==e.time&&(new Date).getTime()-e.time>i}(this,n)?null:n.data},set:function(i,a,n,o){var r=function(t,e){return{data:t,time:(new Date).getTime(),cachingTime:e}}(a,o);return function(i,a,n){var o=t(i),r=JSON.encode(n);if(a=e(a),null===o)return null;o.setItem(a,r)}(n,i,r),this}}}(),Travian.Translation={keys:{},add:function(t,e){var i={};return"object"!=typeof t?i[t]=e:i=t,this.keys=Object.assign({},this.keys,i),this},get:function(t){return this.keys[t]},translate:function(t,e){return e=e||{},t.replace(/\\?\{([^{}]+)\}/g,(function(t,i){return Travian.Translation.keys[i]||e[i]||"{"+i+"}"}))}},Travian.Translation.add(Travian.Strings),Travian.Tip=function(){return Object.create({PLACEMENT_DEFAULT:"bottom-start",PLACEMENT_MIRRORED:"bottom-end",initialized:!1,init:function(){tippy.setDefaultProps({theme:"travian",allowHTML:!0,followCursor:!0,arrow:!1,placement:this.PLACEMENT_DEFAULT,offset:[16,16]}),this.initialized=!0,this.refresh()},updateAllInElement:function(t){const e=this;e.initialized||e.init(),t instanceof jQuery&&(t=t[0]),"string"==typeof t&&(t=document.querySelector(t));for(let e of t.querySelectorAll('[title]:not([title=""])'))e._tippy&&e._tippy.destroy();tippy(t.querySelectorAll('[title]:not([title=""])'),{content(t){let i=null;const a=t.getAttribute("title");if(""!==a)return i=e.getTitleFromString(a),t.removeAttribute("title"),i?e.render(i):""},onCreate(t){void 0!==t.reference.dataset.loadTooltip&&(t._tooltipName=t.reference.dataset.loadTooltip,t._tooltipData=JSON.parse(t.reference.dataset.loadTooltipData),t._isAjax=!0,t._hasLoaded=!1,t._isLoading=!1),e.initTimersInContext(t)},onShow(t){if(void 0===t._isAjax||!t._isAjax||t._hasLoaded||t._isLoading||(t._isLoading=!0,Travian.api("tooltip/"+t._tooltipName,{data:t._tooltipData,success:function(i){t._hasLoaded=!0,t._isLoading=!1,!i||!i.text&&!i.title||""===i.text&&""===i.title?(t.setContent(""),t.hide()):t.setContent(e.render(i))},error:function(e){t.setContent(e.message),t._isLoading=!1}})),!t.props.content&&""===t.props.content)return!1}});const i=[...t.querySelectorAll("path, circle, rect")].filter((function(t){return null!==t.querySelector("title")}));tippy(i,{content:function(t){let i=e.unescape(e.getTitleFromString(t.textContent));return t.querySelector("title").remove(),e.render(i)}})},set:function(t,e){const i=this;return t instanceof jQuery&&(t=t[0]),"string"==typeof t&&(t=document.querySelector(t)),"string"==typeof e&&(e=i.getTitleFromString(e)),tippy(t,{content:function(){return i.render(e)}})},setContent:function(t,e){t instanceof jQuery&&(t=t[0]),t._tippy&&this.updateContentOfInstance(t._tippy,e)},updateContentOfInstance:function(t,e){"string"==typeof e&&(e=this.getTitleFromString(e)),t.setContent(this.render(e)),this.initTimersInContext(t)},render:function(t){return t.title&&(t.title=Travian.Translation.translate(t.title)),t.text&&(t.text=Travian.Translation.translate(t.text)),'<div class="title">{{TITLE}}</div><div class="text">{{TEXT}}</div>'.replace("{{TITLE}}",t.title||"").replace("{{TEXT}}",t.text||"")},unescape:function(t){const e=document.createElement("textarea");return e.innerHTML=t.title,t.title=e.value,e.innerHTML=t.text,t.text=e.value,e.remove(),t},getTitleFromString:function(t){const e={title:"",text:""};if(void 0===t)return!1;var i=t.split("||");if(1===i.length)e.text=i[0];else{if(2!==i.length)return!1;e.title=i[0],e.text=i[1]}return e},refresh:function(){this.updateAllInElement(document.body)},hide:function(){tippy.hideAll()},resetAjaxTipsInElement:function(t){t instanceof jQuery&&(t=t[0]);const e=t.querySelectorAll("[data-load-tooltip]");e&&e.forEach((function(t){if(void 0!==t._tippy){const e=t._tippy;e._isAjax&&(e._hasLoaded=!1,e.setContent(Travian.Translation.get("layout.waitingForTooltip")))}}))},clearOnElement:function(t){if(!t)return!1;t instanceof jQuery&&(t=t[0]),void 0!==t._tippy&&t._tippy.destroy()},initTimersInContext:function(instance){Travian.TimersAndCounters.initTimersInContext(instance.popper);const script=instance.popper.querySelector("script");script&&eval(script.textContent)}})}(),jQuery((function(){Travian.Tip.init()})),Travian.Dialog={CLOSE_CONTEXT_FORMSUBMIT:"formSubmit",CLOSE_CONTEXT_OVERLAYBACKGROUND:"overlayBackground",CLOSE_CONTEXT_CANCELBUTTON:"cancelButton",CLOSE_CONTEXT_CLOSEONCLICKOK:"closeOnClickOk",CLOSE_CONTEXT_CLOSEONESCKEY:"closeOnEscKey"},Travian.Dialog.Dialog=function(t){this.overlay=null,this.overlaySize={width:0,height:0},this.clickedOnOverlay=!1,this.options=Object.assign({version:1,cssClass:null,id:null,buttonOk:!0,keepOpen:!1,buttonTextOk:null,buttonCloseOnClickOk:!1,buttonCancel:!0,elementFocus:".dialogButtonOk",relativeTo:null,title:null,useEscKey:!0,submitMethod:"get",submitUrl:null,preventFormSubmit:!1,overlayCancel:!0,draggable:!1,dragPosition:null,enableBackground:!0,darkOverlay:!1,savePositionForSession:{preferenceKey:null},infoIcon:null,buttonTextInfo:null,fx:{duration:400},onOkay:Travian.emptyFunction,onClose:Travian.emptyFunction,afterClose:Travian.emptyFunction,onOpen:Travian.emptyFunction,onDrag:Travian.emptyFunction},t),this.toggleFormState=function(t){return this.buttonOk.toggleClass("disabled",t).disabled=t,this},this.disableForm=function(){return this.toggleFormState(!0)},this.enableForm=function(){return this.toggleFormState(!1)},this.correctDialogPosition=function(t){let e=this.overlaySize.width,i=this.overlaySize.height,a=this.wrapper.width(),n=this.wrapper.height(),o=t.left,r=t.top;return o<0&&(o=0),o+a>=e&&(o=e-a),r<0?r=0:r+n>=i&&(r=i-n),{left:o,top:r}},this.render=function(){let t=this,e=jQuery("body");if(this.options.savePositionForSession.preferenceKey){var i=Travian.Game.Preferences.get(this.options.savePositionForSession.preferenceKey);null!==i&&(i=JSON.parse(i),this.options.savePositionForSession.position=i.position)}let a=jQuery(Travian.Templates["ButtonV"+this.options.version]),n=jQuery(Travian.Templates["DialogV"+this.options.version]);if(a.length<=0||n.length<=0)throw"Dialog.js: Unable to load required template(s).";if(a.addClass("green dialogButtonOk ok textButtonV"+this.options.version),a.attr("type","submit"),2===this.options.version&&a.addClass("buttonFramed withText rectangle"),this.overlay=n,t.options.enableBackground&&(this.overlay.addClass("enabled"),t.options.darkOverlay&&this.overlay.addClass("dark"),t.options.overlayCancel&&(this.overlay.on("mousedown touchstart",(function(e){e.target.classList.contains("dialogOverlay")&&(t.clickedOnOverlay=!0)})),this.overlay.on("touchmove",(function(){t.clickedOnOverlay=!1})),this.overlay.on("click",(function(){t.clickedOnOverlay&&t.close(Travian.Dialog.CLOSE_CONTEXT_OVERLAYBACKGROUND)})))),this.wrapper=this.overlay.find(".dialogWrapper"),void 0!==this.options.context&&this.wrapper.attr("data-context",this.options.context),null===this.options.cssClass&&2===this.options.version&&(this.options.cssClass="basic"),this.wrapper.find(".dialog").addClass(this.options.cssClass),null!==this.options.id&&this.wrapper.find(".dialog").attr("id",this.options.id),this.wrapper.find(".buttons").append(a),e.prepend(this.overlay),this.overlaySize.width=this.overlay.width(),this.overlaySize.height=this.overlay.height(),jQuery(window).on("resize scroll",(function(){let e=jQuery(".dialogOverlay");t.overlaySize.width=e.width(),t.overlaySize.height=e.height(),!t.options.draggable||Travian.Browser.isMobile()?t.updatePosition(200,!0):t.options.draggable&&t.wrapper.css(t.correctDialogPosition(t.wrapper.position()))})),this.content=this.wrapper.find("div#dialogContent"),this.title=this.wrapper.find("div.title"),this.setTitle(this.options.title),this.elementContents=this.wrapper.find("div.dialogContents"),this.infoButton=this.wrapper.find("div.info"),this.dialogDragbar=this.wrapper.find("div.dialogDragBar"),this.options.infoIcon?this.setInfoIcon(this.options.infoIcon):this.infoButton.hide(),this.options.draggable&&(this.wrapper.addClass("dragWrapper"),new Travian.Moveable(this.wrapper,{droppables:this.title,handle:this.dialogDragbar,onDrop:function(e){var i=jQuery(e).position();t.options.dragPosition=t.correctDialogPosition(i),null!==t.options.savePositionForSession.preferenceKey&&(t.options.savePositionForSession.position=t.correctDialogPosition(i))},onDrag:function(e){var i=jQuery(e);i.css(t.correctDialogPosition(i.position())),t.options.onDrag(t)}}),this.title.css("drag")),this.options.draggable&&this.wrapper.on("mousedown touchdown",(function(){t.bringToFront()})),this.form=this.wrapper.find("form").on("submit",(function(e){return t.form.disabled?(e.stopPropagation(),!1):(t.disableForm(),t.options.onOkay(t,t.content),!1===t.options.keepOpen&&t.close(Travian.Dialog.CLOSE_CONTEXT_FORMSUBMIT),t.options.preventFormSubmit?(e.stopPropagation(),!1):void 0)})),this.form.disabled=!1,this.options.submitMethod&&this.form.attr("method",this.options.submitMethod),this.options.submitUrl&&this.form.attr("action",this.options.submitUrl),this.buttonOk=this.wrapper.find("button.ok"),!1===this.options.buttonOk)this.buttonOk.closest(".buttons").hide();else{let t=this.buttonOk.find("div");t.length>0?t.html(this.options.buttonTextOk):this.buttonOk.html(this.options.buttonTextOk),Travian.Tip.set(this.buttonOk,this.options.buttonTextOk)}this.options.buttonCloseOnClickOk&&this.buttonOk.click((function(e){e.preventDefault(),t.close(Travian.Dialog.CLOSE_CONTEXT_CLOSEONCLICKOK)})),this.buttonCancel=this.wrapper.find(".dialogCancelButton"),!1===this.options.buttonCancel?this.buttonCancel.hide():this.buttonCancel.on("click",(function(){t.close(Travian.Dialog.CLOSE_CONTEXT_CANCELBUTTON)})),this.bringToFront()},this.updateInfoButton=function(t){return this.options=Object.assign(this.options,t),this.options.infoIcon?this.setInfoIcon(this.options.infoIcon):this.infoButton.hide(),this},this.displayButtonOk=function(t){null==t||!0===t?(this.buttonOk.closest(".buttons").show(),this.buttonOk.show()):this.buttonOk.hide()},this.setContent=function(t){return this.content.empty(),this.content.append(t),this.updatePosition(),Travian.Tip.updateAllInElement(this.wrapper),jQuery(window).trigger("domAltered",this.wrapper),this},this.setTitle=function(t){return this.options.title=t,this.title.html(this.options.title),this.options.title||this.title.hide(),this},this.calculatePosition=function(){let t=jQuery(window),e=t.scrollLeft(),i=t.scrollTop(),a=jQuery("body"),n=this.overlaySize.width,o=this.overlaySize.height,r=this.wrapper.width(),s=this.wrapper.height(),l=jQuery(this.options.relativeTo);l.length<=0&&(l=a);let d=l.width(),u=l.height(),c={x:l.offset().left,y:l.offset().top};c.x=this.checkValue(c.x),c.y=this.checkValue(c.y);let p={left:c.x+d/2-r/2-e,top:c.y+u/2-s/2-i};return p.left=this.checkValue(p.left,5),p.top=this.checkValue(p.top,40),p.top+s>o&&(p.top=o-s),p.top<0&&(p.top=0),p.left+r>n&&(p.left=n-r),p.left<0&&(p.left=0),p},this.checkValue=function(t,e){return t<0?e||0:t},this.updatePosition=function(t,e){if(this.options.draggable||null!==this.options.relativeTo){if(jQuery("body").hasClass("ie")&&this.wrapper.addClass("iePositionException"),!this.options.savePositionForSession.preferenceKey||!this.options.savePositionForSession.position||void 0!==e&&e)if(this.options.dragPosition&&void 0!==this.options.dragPosition.x&&void 0!==this.options.dragPosition.y)this.setPosition(this.options.dragPosition);else{let e=this.calculatePosition();this.setPosition({x:e.left,y:e.top},t)}else this.setPosition(this.options.savePositionForSession.position)}},this.hide=function(){this.overlay.hide()},this.unhide=function(){this.overlay.show()},this.dispose=function(){this.options.useEscKey&&jQuery("body").off(".dialog"),void 0!==Travian.WindowManager&&Travian.WindowManager.unregister(this),jQuery(this.overlay).remove(),this.overlay=null},this.toElement=function(){return this.wrapper},this.setPosition=function(t,e){return this.wrapper.css({left:t.x,top:t.y}),t},this.bringToFront=function(){if(void 0===Travian.WindowManager)return!1;if(Travian.WindowManager.getCurrentZIndex()===parseInt(this.wrapper.css("zIndex")))return!1;var t=Travian.WindowManager.getZIndex();this.wrapper.css({zIndex:t}),this.overlay.length>0&&this.overlay.css({zIndex:t-5})},this.setInfoIcon=function(t){if(t){this.options.infoIcon=t;var e=this;this.infoButton.off("click"),this.infoButton.show(),this.infoButton.on("click",(function(){return"string"==typeof e.options.infoIcon?window.open(e.options.infoIcon,"_blank"):"function"==typeof e.options.infoIcon?e.options.infoIcon():void 0})),this.options.buttonTextInfo&&Travian.Tip.set(this.infoButton,this.options.buttonTextInfo)}else this.infoButton.hide();return this},this.updateCssClass=function(t){if(t){var e=this.options.cssClass.split(" "),i=this.wrapper.find("div.dialog");if(i){for(var a=0;a<e.length;a++)i.removeClass(e[a]);this.options.cssClass=t;for(var n=t.split(" "),o=0;o<n.length;o++)""!==n[o]&&i.addClass(n[o])}}return this},this.makeInputAmountable=function(t,e,i){var a=e||Number.MAX_VALUE,n=function(t,e,i){t=jQuery(t);var a=e||Number.MAX_VALUE,n=parseInt(t.val())||0,o=Math.max(0,Math.min(n,a));t.val(o),i&&i(o)};jQuery(t).on({keydown:function(t){var e,i,a;e=t.keyCode,i=t.ctrlKey,a=t.metaKey,8===e||46===e||65===e&&(!0===i||!0===a)||67===e&&(!0===i||!0===a)||88===e&&(!0===i||!0===a)||86===e&&(!0===i||!0===a)||e>=35&&e<=39||13===e||9===e||e>=48&&e<=57||e>=96&&e<=105||t.preventDefault()},keyup:function(){n(this,a,i)},paste:function(){n(this,a,i)},change:function(){n(this,a,i)},blur:function(){n(this,a,i)},input:function(){n(this,a,i)}})},Object.assign(this.options,t),this.animateFunction=0===this.options.fx.duration?function(t,e,i,a){t.css(e),"function"==typeof a&&a()}:function(t,e,i,a){t.animate(e,i,a)},this.options.relativeTo=this.options.relativeTo||null,null!==this.options.relativeTo&&(this.options.relativeTo=jQuery(this.options.relativeTo)),null===this.options.buttonTextOk&&(this.options.buttonTextOk=Travian.Translation.get("allgemein.ok")),this.render(),void 0!==Travian.WindowManager&&Travian.WindowManager.register(this)},Travian.Dialog.Dialog.prototype.reload=Travian.emptyFunction,Travian.Dialog.Dialog.prototype.show=function(){var t=this;return this.open=!0,this.updatePosition(),this.overlay.addClass("dialogVisible"),setTimeout((function(){t.options.onOpen(t,t.content);var e=jQuery(t.options.elementFocus);e.length>0&&e.focus(),Travian.Game.Layout.MobileOptimizations.fixNumericKeyboardOnIOS()}),t.options.fx.duration),this.options.useEscKey&&jQuery("body").one("keyup.dialog",(function(e){27===e.keyCode&&t.close(Travian.Dialog.CLOSE_CONTEXT_CLOSEONESCKEY)})),Travian.TabManager.initializeOnDialogLoad(),Travian.Tip.hide(),this},Travian.Dialog.Dialog.prototype.close=function(t){var e=this;return this.open=!1,this.options.onClose(this,this.content),this.overlay&&this.overlay.length>0&&this.overlay.removeClass("dialogVisible"),setTimeout((function(){e.dispose()}),e.options.fx.duration),this.options.savePositionForSession.preferenceKey&&this.options.savePositionForSession.position&&Travian.Game.Preferences.set(this.options.savePositionForSession.preferenceKey,JSON.stringify(this.options.savePositionForSession)),Travian.Tip.hide(),this.options.afterClose(),this},Travian.Dialog.Confirmation=function(t){this.options=Object.assign({onConfirm:Travian.emptyFunction,onCancel:function(){Travian.WindowManager.closeByContext("confirmationDialog")},message:"",confirmText:"",cancelText:"",confirmClass:"green",cancelClass:"grey",buttonCancel:!1,buttonOk:!1,cssClass:"white confirmationDialog",context:"confirmationDialog"},t);var e=jQuery('<div class="confirmationDialog"></div>').append('<div class="message">'+this.options.message+"</div>").append('<div class="buttons"></div>');if(void 0!==Travian.Templates.ButtonV1){var i=jQuery(Travian.Templates.ButtonV1);i.addClass("textButtonV1 "+this.options.confirmClass),i.attr("type","button"),i.on("click",this.options.onConfirm),i.html(this.options.confirmText);var a=jQuery(Travian.Templates.ButtonV1);a.addClass("textButtonV1 "+this.options.cancelClass),a.attr("type","button"),a.on("click",this.options.onCancel),a.html(this.options.cancelText),e.find(".buttons").append(a).append(i)}return new Travian.Dialog.Dialog(this.options).setContent(e)},Travian.WindowManager={windows:[],currentZIndex:6e3,zIndexMaxValue:9900,register:function(t){return void 0===t.options.context&&(t.options.context="noContext"),t.identifier=this.__createIdentifier(),this.windows.push(t),t},unregister:function(t){this.windows=this.windows.filter((function(e){return e!==t}))},closeWindow:function(t){t.close()},hideWindow:function(t){t.hide()},showWindow:function(t){t.unhide()},hideByContext:function(t){var e=this;this.eachWindow((function(i){if(!e.checkContext(t,i))return!1;e.hideWindow(i)}))},showByContext:function(t){var e=this;this.eachWindow((function(i){if(!e.checkContext(t,i))return!1;e.showWindow(i)}))},closeByContext:function(t){var e=this;this.eachWindow((function(i){if(!e.checkContext(t,i))return!1;e.closeWindow(i)}))},getWindowsByContext:function(t){var e=this,i=[];return this.eachWindow((function(a){if(!e.checkContext(t,a))return!1;i.push(a)})),i},checkContext:function(t,e){return void 0!==e.options.context&&e.options.context===t},eachWindow:function(t){for(var e=0;e<this.windows.length;e++)t(this.windows[e])},getWindows:function(){return this.windows},reloadWindow:function(t){t.reload()},reloadWindowsByContext:function(t){var e=this;this.eachWindow((function(i){if(!e.checkContext(t,i))return!1;e.reloadWindow(i)}))},__createIdentifier:function(){return this.windows.length},cleanupZIndex:function(){var t=0;this.eachWindow((function(e){var i=jQuery(e).css("zIndex")-3e3;i>t&&(t=i),jQuery(e).css({zIndex:i})})),this.currentZIndex=t},getZIndex:function(){return this.currentZIndex>=this.zIndexMaxValue&&this.cleanupZIndex(),this.currentZIndex+=10,this.currentZIndex},getCurrentZIndex:function(){return this.currentZIndex},checkOpenWindowByContext:function(t){var e=!1,i=this;return this.eachWindow((function(a){i.checkContext(t,a)&&(e=!0)})),e},closeAllWindows:function(){var t=this;this.eachWindow((function(e){t.closeWindow(e)}))}},Travian.Dialog.Ajax=function(t,e){Travian.Dialog.Dialog.call(this,e),this.cmd=t,this.request()},Travian.Dialog.Ajax.prototype=Object.create(Travian.Dialog.Dialog.prototype),Travian.Dialog.Ajax.constructor=Travian.Dialog.Ajax,Travian.Dialog.Ajax.prototype.reload=function(){this.request()},Travian.Dialog.Ajax.prototype.request=function(){var t=this;return Travian.api(this.cmd,{data:this.options.data,success:function(e){""!==e.html?t.setContent(e.html).setTitle(e.title).setInfoIcon(e.infoIcon).updateCssClass(e.cssClass).show():t.close()}}),this},Travian.Dialog.Api=function(t){Travian.Dialog.Dialog.call(this,t),this.request()},Travian.Dialog.Api.prototype=Object.create(Travian.Dialog.Dialog.prototype),Travian.Dialog.Api.constructor=Travian.Dialog.Api,Travian.Dialog.Api.prototype.reload=function(){this.request()},Travian.Dialog.Api.prototype.request=function(){var t=this;return Travian.api(this.options.call,{data:this.options.data,success:function(e){""!==e.html?t.setContent(e.html).setTitle(e.title).setInfoIcon(e.infoIcon).updateCssClass(e.cssClass).show():t.close()}},this.options.method),this},Travian.DoubleClickPreventer=function(){this.prevent=!1,this.timeout=400,this.timerId=0,this.check=function(){if(this.prevent)return!1;this.prevent=!0;var t=this;return this.timerId=setTimeout((function(){t.prevent=!1}),this.timeout),!0},this.cancelTimer=function(){this.timerId&&(clearTimeout(this.timerId),this.timerId=0,this.prevent=!1)}},Travian.DoubleClickPreventer.globalPrevent=!1,Travian.DoubleClickPreventer.globalTimeout=400,Travian.DoubleClickPreventer.globalCheck=function(){var t=Travian.DoubleClickPreventer.prevent;return!1===t&&(Travian.DoubleClickPreventer.prevent=!0,Travian.DoubleClickPreventer.timer=setTimeout((function(){Travian.DoubleClickPreventer.prevent=!1}),Travian.DoubleClickPreventer.timeout)),!t},window.Travian.Login=function(t){const e=jQuery(t),i=e.find("button[type=submit]"),a=e.find("input[name=name]"),n=e.find("input[name=password]"),o=e.find(".errorSection"),r=o.find("div#error");if(i.hasClass("disabled"))return!1;i.addClass("disabled"),a.addClass("disabled"),n.addClass("disabled");return r.html(""),o.addClass("hide"),Travian.api("auth/login",{data:{name:a.val(),password:n.val(),w:screen.width+":"+screen.height,mobileOptimizations:e.find("input[name=mobileOptimizations]").is(":checked"),captcha:Travian.Login.captchaSolution},success:function({nonce:t}){window.location.href="/api/v1/auth?code="+t+"&response_type=redirect"},error:function(t,e){446===e.status?window.grecaptcha?(Travian.Login.captchaSolution=void 0,window.grecaptcha.reset&&window.grecaptcha.reset()):Travian.Browser.getScript("https://recaptcha.net/recaptcha/api.js?render=explicit&onload=onRecaptchaLoad"):r.html(t.message)&&o.removeClass("hide"),i.removeClass("disabled"),a.removeClass("disabled"),n.removeClass("disabled")}}),!1},onRecaptchaLoad=function(){jQuery(".captchaSection").removeClass("hide");const t=jQuery("div#recaptcha").get(0);window.grecaptcha.render(t.id,{sitekey:t.dataset.sitekey,callback:function(t){Travian.Login.captchaSolution=t}})},Travian.Form=function(){this.elements={},this.addElement=function(t,e){return e.setName(t),this.elements[t]=e,this},this.addInputElementByName=function(t,e){var i=Travian.Form.Element.Input.createElementByName(this,t,e);return this.addElement(t,i),this},this.onElementChanged=function(t){var e,i=t.isDirty();if(!1===i)for(e in this.elements)if(this.elements[e].isDirty()){i=!0;break}return this.onDirty(i),this}},Travian.Form.prototype.onClick=function(t){return this},Travian.Form.prototype.onDirty=function(t){return this},Travian.FormV2=function(t){this.form=null,this.isFormValid=!0,this.initialize=function(t){if(this.form=jQuery(t),0===this.form.length)return!1;this.bindEventListeners()},this.bindEventListeners=function(){let t=this;t.form.find("input:not([type=radio]), textarea, select").on("change",(function(){let t=jQuery(this);""!==t.val()?t.next(".label").addClass("pinned"):t.next(".label").removeClass("pinned")})).on("focus",(function(){let t=jQuery(this);t.parent("label").removeClass("valid").removeClass("invalid"),t.parent("label").find(".validation").removeClass("show")})).on("blur",(function(){t.validate(jQuery(this).parent("label"))})),t.form.find("input[type=radio]").on("click",(function(){let e=jQuery(this);jQuery("input[type=radio][name="+e.attr("name")+"]").each((function(e,i){t.validate(jQuery(i).parent("label"))}))})),t.form.on("submit",(function(e,i){void 0===i&&(e.preventDefault(),t.isFormValid=!0,t.validateForm(),t.isFormValid&&t.form.trigger("submit",[!0]))}))},this.validateForm=function(){let t=this;this.form.find("label").each((function(e,i){t.validate(jQuery(i))}))},this.highlightInvalidElement=function(t){const e=t[0].closest("label");if(t.data("render-into")){const i=document.querySelector(t.data("render-into"));i.innerHTML=t.html(),i.classList.add("show"),e.classList.add("withCustomValidationRenderElement")}else t.addClass("show");e.classList.add("invalid")},this.validate=function(t){let e=this,i=!0,a=t.find("input, textarea, select"),n=t.find(".validation");if(n.length>0&&(n.each((function(t,n){let o=(n=jQuery(n)).data("rule"),r=n.data("parameter");if("function"==typeof e.validationRules[o]&&!e.validationRules[o](a,r))return i=!1,e.isFormValid=!1,e.highlightInvalidElement(n),!1})),i)){t.find(".validation").removeClass("show"),t.removeClass("invalid").addClass("valid");for(let e of t[0].closest("label").querySelectorAll(".validation"))e.classList.remove("show"),e.dataset.renderInto&&this.removeCustomValidationRenderElement(e.dataset.renderInto)}},this.removeCustomValidationRenderElement=function(t){const e=document.querySelectorAll(".validation[data-render-into='"+t+"']");if(e)for(let t of e){const e=t.closest("label");if(e.classList.contains("invalid"))return this.validate(jQuery(e)),!1}document.querySelector(t).classList.remove("show")},this.validationRules={notEmpty:function(t){return""!==t.val()},checked:function(t){return t.is(":checked")},shorterThan:function(t,e){return t.val().length<=e},isEmail:function(t){return-1!==t.val().search(/^\S+@\S+\.\S+$/)}},this.initialize(t)},Travian.Form.UnloadHelper=Object.create({formQueryString:"input, textarea, select",identifierCount:0,htmlForms:{},formStates:{},initialize:function(){},isEnabled:function(){var t;for(t in this.formStates)if(this.formStates[t])return!0;for(t in this.htmlForms){var e=jQuery("#"+t);if(null!==e){if(this.htmlForms[t]!==this.generateFormHash(e))return!0}else delete this.htmlForms[t]}return!1},enableSecurity:function(t){return null===t&&(t=this.getIdentifier()),this.formStates[t]=!0,t},disableSecurity:function(t){this.formStates[t]=!1},getIdentifier:function(){return this.identifierCount++,this.identifierCount},generateFormHash:function(t){var e="";return t.find(this.formQueryString).each((function(){var t=jQuery(this),i=t.prop("tagName").toLowerCase(),a=t.attr("type");switch("string"==typeof a&&(a=a.toLowerCase()),!0){case"input"===i&&("checkbox"===a||"radio"===a):e+=t.is(":checked");break;case"input"===i||"textarea"===i:e+=t.val();break;case"select"===i:var n=t.find("option:selected");n.length>0&&(e+=n.prop("value"))}})),jQuery.md5(e)},watchHtmlForm:function(t){var e=this;t.delegate(this.formQueryString,"change keyup",(function(){e.updateSubmitButtons(t)})),this.htmlForms[t.attr("id")]=this.generateFormHash(t),t.on("submit",(function(){e.htmlForms[t.attr("id")]=e.generateFormHash(t)})),this.updateSubmitButtons(t)},unwatchHtmlForm:function(t){delete this.htmlForms[t.attr("id")]},updateSubmitButtons:function(t){var e=this.htmlForms[t.attr("id")]===this.generateFormHash(t);t.find("input[type=submit], button[type=submit]").each((function(){jQuery(this).toggleClass("disabled",e)[0].disabled=e}))}}),Travian.Form.UnloadHelper.initialize(),Travian.Form.Element=function(t){this.form=null,this.name=null,this.initialize=function(t){this.form=t},this.onClick=function(){return this.form.onClick(this),this},this.setForm=function(t){return this.form=t,this},this.setName=function(t){return this.name=t,this},this.getName=function(){return this.name},this.initialize(t)},Travian.Form.Element.prototype.onChange=function(){return this.form.onElementChanged(this),this},Travian.Form.Element.prototype.isDirty=function(){return!1},Travian.Form.Element.Input=function(t,e){this.originalValue=null,this.currentValue=null,this.type=null,this.element=null,this.initialize=function(t,e){Travian.Form.Element.call(this,t),this.element=e,this.originalValue=this.currentValue=this.getValue(),this.initEvents()},this.getInput=function(){return this.element},this.onChange=function(){return this.currentValue=this.getValue(),Travian.Form.Element.prototype.onChange.call(this),this},this.isDirty=function(){return this.originalValue!==this.currentValue},this.initialize(t,e)},Travian.Form.Element.Input.prototype=Object.create(Travian.Form.Element.prototype),Travian.Form.Element.Input.constructor=Travian.Form.Element.Input,Travian.Form.Element.Input.createElementByName=function(t,e,i){var a=null;void 0===i&&(i=jQuery(document));var n=i.find('[name="'+e+'"]');if(0===n.length)throw new Error('Element with name "'+e+'" not found.');var o=jQuery(n[0]);if("input"===o.prop("tagName").toLowerCase())"radio"!==(a=o.attr("type"))&&"checkbox"!==a||(o=n);else a=o.get(0).nodeName.toLowerCase();if(a=a.charAt(0).toUpperCase()+a.slice(1).toLowerCase(),!Travian.Form.Element.Input[a])throw new Error('Element type "'+a+'" not yet implemented!');return new Travian.Form.Element.Input[a](t,o)},Travian.Form.Element.Input.prototype.initEvents=function(){var t=this;return this.element.on("change",(function(){t.onChange()})),this},Travian.Form.Element.Input.prototype.getValue=function(){return this.element.val()},Travian.Form.Element.Input.Button=function(t,e){this.initEvents=function(){var t=this;return this.element.on("click",(function(){t.onClick()})),this},this.getValue=function(){return null},Travian.Form.Element.Input.call(this,t,e)},Travian.Form.Element.Input.Button.prototype=Object.create(Travian.Form.Element.Input.prototype),Travian.Form.Element.Input.Button.constructor=Travian.Form.Element.Input.Button,Travian.Form.Element.Input.Checkbox=function(t,e){this.valueBefore=null,this.initEvents=function(){var t=this;return this.valueBefore=this.getValue(),this.element.on("click",(function(){t.getValue()!==t.valueBefore&&(t.valueBefore=t.getValue(),t.onChange())})),this},this.getValue=function(){var t=null;return this.element.length>0&&this.element.each((function(e,i){var a=jQuery(i);a.is(":checked")&&(t=a.val())})),t},Travian.Form.Element.Input.call(this,t,e)},Travian.Form.Element.Input.Checkbox.prototype=Object.create(Travian.Form.Element.Input.prototype),Travian.Form.Element.Input.Checkbox.constructor=Travian.Form.Element.Input.Checkbox,Travian.Form.Element.Input.Radio=function(t,e){this.valueBefore=null,this.initEvents=function(){var t=this;return this.valueBefore=this.getValue(),this.element.on("click",(function(){t.getValue()!==t.valueBefore&&(t.valueBefore=t.getValue(),t.onChange())})),this},this.getValue=function(){var t=null;return this.element.length>0&&this.element.each((function(e,i){var a=jQuery(i);a.is(":checked")&&(t=a.val())})),t},Travian.Form.Element.Input.call(this,t,e)},Travian.Form.Element.Input.Radio.prototype=Object.create(Travian.Form.Element.Input.prototype),Travian.Form.Element.Input.Radio.constructor=Travian.Form.Element.Input.Radio,Travian.Form.Element.Input.Text=function(t,e){Travian.Form.Element.Input.call(this,t,e)},Travian.Form.Element.Input.Text.prototype=Object.create(Travian.Form.Element.Input.prototype),Travian.Form.Element.Input.Text.constructor=Travian.Form.Element.Input.Text,Travian.Form.Element.Input.Textarea=function(t,e){Travian.Form.Element.Input.call(this,t,e)},Travian.Form.Element.Input.Textarea.prototype=Object.create(Travian.Form.Element.Input.prototype),Travian.Form.Element.Input.Textarea.constructor=Travian.Form.Element.Input.Textarea,Travian.Formatter=function(t){if(this.options=Object.assign({languageKey:"de-DE",formatType:"type3",decimalSeperator:",",forceDecimal:!0,showDecimalsIfThereAny:!1,minusCharacter:"âˆ’"},t),this.getFormattedNumber=function(t,e){if(isNaN(t)||null==t||""===t)return 0;parseInt(t)!==t?-1===(t=String(parseFloat(t))).indexOf(".")&&-1===t.indexOf(",")&&(t+=".0"):t=String(parseFloat(t))+".0";var i=t.match(/([\d.,\s-]*?)[.,]?(\d*)?$/),a={left:i[1],right:i[2]};a.left=a.left.replace(/[\s,.'"]*/g,"");var n=!1;a.left<0&&(n=!0),a.left=a.left.replace(/[-]*/g,"");var o=0;if(void 0===this.typeFunctions[this.options.formatType])throw"Der Zahlenformattyp"+this.options.formatType+"ist unbekannt!";if(o=this.typeFunctions[this.options.formatType].createNumberFunction(a,this.options),!0===n&&(o=this.options.minusCharacter+o),void 0!==e&&e.hasOwnProperty("unit")&&"percent"===e.unit)o+="%";return o},this.setOptionLanguageKey=function(t){var e=this.getDefinitionByLanguage(t);return!1!==e&&(this.options.formatType=e.type,this.options.decimalSeperator=e.decimalSeperator,!0)},this.getAvailableTypes=function(){var t=[];return Object.each(this.typeFunctions,(function(e,i){t.push(i)})),t},this.removeNonDigits=function(t){var e=t.match(/\d/g);return e=parseInt(e.join(""))},this.getDefinitionByLanguage=function(t){var e=!1;for(var i in this.languageDefinitions){if(-1!==this.languageDefinitions[i].languages.indexOf(t)){e=this.languageDefinitions[i];break}}return e},this.languageDefinitions={1:{decimalSeperator:",",type:"type1",languages:["bg-BG","cs-CZ","et-EE","fi-FI","fr-FR","hu-HU","lt-LT","lv-LV","pl-PL","pt-PT","ru-RU","sk-SK","sv-SE","uk-UA"]},2:{decimalSeperator:".",type:"type2",languages:["bs-BA","en-US","ja-JP","ms-MY","th-TH","com"]},3:{decimalSeperator:",",type:"type3",languages:["ar-AE","da-DK","de-DE","el-GR","es-CL","es-ES","he-IL","hr-HR","id-ID","it-IT","nl-NL","no-NO","pt-BR","ro-RO","sl-SI","sr-RS","tr-TR","vi-VN"]},4:{decimalSeperator:".",type:"type4",languages:["in"]}},this.typeFunctions={type1:{createNumberFunction:function(t,e){for(var i="",a=t.left.split("").reverse().join(""),n=0;n<=a.length-1;n++)n%3==0&&0!==n&&(i+=" "),i+=a.charAt(n);return i=i.split("").reverse().join(""),(void 0!==t.right&&!0===e.forceDecimal||void 0!==t.right&&!0===e.showDecimalsIfThereAny&&"0"!==t.right)&&(i+=","+t.right),i}},type2:{createNumberFunction:function(t,e){for(var i="",a=t.left.split("").reverse().join(""),n=0;n<=a.length-1;n++)n%3==0&&0!==n&&(i+=","),i+=a.charAt(n);return i=i.split("").reverse().join(""),(void 0!==t.right&&!0===e.forceDecimal||void 0!==t.right&&!0===e.showDecimalsIfThereAny&&"0"!==t.right)&&(i+="."+t.right),i}},type3:{createNumberFunction:function(t,e){for(var i="",a=t.left.split("").reverse().join(""),n=0;n<=a.length-1;n++)n%3==0&&0!==n&&(i+="."),i+=a.charAt(n);return i=i.split("").reverse().join(""),(void 0!==t.right&&!0===e.forceDecimal||void 0!==t.right&&!0===e.showDecimalsIfThereAny&&"0"!==t.right)&&(i+=","+t.right),i}},type4:{createNumberFunction:function(t,e){for(var i="",a=3,n=t.left.split("").reverse().join(""),o=0,r=0;r<=n.length-1;r++)o%a==0&&0!==o&&(i+=",",a=2,o=0),i+=n.charAt(r),o++;return i=i.split("").reverse().join(""),(void 0!==t.right&&!0===e.forceDecimal||void 0!==t.right&&!0===e.showDecimalsIfThereAny&&"0"!==t.right)&&(i+="."+t.right),i}},seperatorless:{createNumberFunction:function(t,e){var i=t.left;return void 0!==t.right&&!1===e.forceDecimal&&(i+=e.decimalSeperator+t.right),i}},toInt:{createNumberFunction:function(t,e){return t.left}},toIntRounded:{createNumberFunction:function(t,e){if(void 0===t.right)return t.left;var i=t.left+"."+t.right;return Number.convert(i).round()}}},void 0!==t&&void 0!==t.languageKey||(this.options.languageKey=Travian.Game.language),void 0!==this.options.languageKey){var e=this.getDefinitionByLanguage(this.options.languageKey);!1!==e&&(this.options.formatType=e.type,this.options.decimalSeperator=e.decimalSeperator)}},Travian.Formatter.Filter={aNumber:function(t){t.value.match(/^[0-9\-\.,]+$/)||(t.value=t.value.replace(/[^0-9\-\.,]/g,""))}},Travian.Seasons=Object.create({currentSeason:null,setState:function(t){const e=jQuery("body");e.find("span.pleaseSaveYourChanges").removeClass("hidden");const i=t?Travian.Seasons.currentSeason.name:"default";e.data(Travian.Seasons.currentSeason.data,i),e.attr("data-"+Travian.Seasons.currentSeason.data,i),Travian.Seasons.currentSeason.setState(t)}}),Travian.Seasons.Season=function(){},Travian.Seasons.Season.prototype.data="theme",Travian.Seasons.Season.prototype.name="default",Travian.Seasons.Season.prototype.setState=function(t){},Travian.Seasons.Season.prototype.restart=function(t){},Travian.Seasons.Season.prototype.setPreferences=function(t){return t},Travian.Seasons.currentSeason=new Travian.Seasons.Season,Travian.Seasons.Winter=function(){this.name="winter",this.data="theme",this.snowSettings={enabled:!0,maxFlakes:1800,maxFlakeRadius:10,screenWidth:0,screenHeight:0},this.maxAnimationHeight=1400,this.snowApp=null,this.restarting=!1,this.initSnowAnimation=function(){let t=this,e=jQuery(document);if(this.snowSettings.enabled){this.snowSettings.screenWidth=e.width(),this.snowSettings.screenHeight=t.maxAnimationHeight,jQuery("#background").prepend('<canvas id="snowAnimation" width="'+this.snowSettings.screenWidth+'" height="'+this.snowSettings.screenHeight+'"></canvas>'),PIXI.settings.SCALE_MODE=PIXI.SCALE_MODES.NEAREST,this.snowApp=new PIXI.Application({antialias:!0,transparent:!0,view:document.getElementById("snowAnimation"),width:this.snowSettings.screenWidth,height:this.snowSettings.screenHeight}),t.snowApp.ticker.autoStart=!1,t.snowApp.ticker.maxFPS=30,t.snowApp.ticker.stop();let i=t.snowSettings.maxFlakes/2073600,a=Math.min(t.snowSettings.maxFlakes,Math.ceil(t.snowSettings.screenWidth*t.snowSettings.screenHeight*i)),n=new PIXI.ParticleContainer(a,{alpha:!0,tint:!1,position:!0,rotation:!0});n.width=t.snowSettings.screenWidth,n.height=t.snowSettings.screenHeight;let o=[];for(let e=0;e<a;e++){let e=parseInt((Math.random()*t.snowSettings.maxFlakeRadius).toFixed(2)),i=new PIXI.Sprite.from(Travian.Game.getImageDirectoryPath()+"themes/winter/snowflake.png");i.x=parseFloat((Math.random()*t.snowApp.renderer.width).toFixed(2)),i.y=parseFloat((Math.random()*t.snowApp.renderer.height).toFixed(2)),i.density=e,i.rotation=(360*Math.random()*Math.PI/180).toFixed(2),i.width=e,i.height=e,i.vx=0,o.push(i),n.addChild(i)}t.snowApp.stage.addChild(n);let r=t.snowApp.renderer.height;t.snowApp.ticker.add((function(){let e=0;for(let i=0;i<o.length;i++){let a=o[i];a.y+a.height>r?(a.y=0,a.rotation=(360*Math.random()*Math.PI/180).toFixed(2),a.x=parseFloat((Math.random()*t.snowApp.renderer.width).toFixed(2)),a.alpha=a.density/t.snowSettings.maxFlakeRadius):(a.x+=a.vx,Math.random()>.98&&(a.vx=Math.random()>.5?Math.max(-2,a.vx-1):Math.min(a.vx+1,2)),e=2*a.vx,e=0===e?1:e,a.angle+=e,a.y+=parseFloat((a.density/4).toFixed(2))),r>=t.maxAnimationHeight&&a.y>=r-250&&(a.alpha=(r-a.y)/250)}})),t.snowApp.ticker.start(),jQuery("#snowAnimation").animate({opacity:1},100),jQuery(window).on("resize.travianSnowAnimation",t.restart)}this.restarting=!1},this.restartTimeout=null,this.restart=function(){clearTimeout(this.restartTimeout),this.restartTimeout=setTimeout((function(){t.restarting||(jQuery(window).off("resize.travianSnowAnimation"),t.restarting=!0,null!==t.snowApp&&(t.snowApp.stop(),t.snowApp.destroy(!0,!0),t.snowApp=null),t.initSnowAnimation())}),250)},this.setState=function(t){var e=t&&jQuery("input[name=option_seasonal_snow_enabled]").is(":checked");this.setPreferences({enabled:e}),this.restart()},this.setPreferences=function(t){return this.snowSettings=Object.assign(this.snowSettings,t),this.snowSettings},this.isActive=function(){return jQuery("body").data(this.data)===this.name},Travian.Seasons.Season.call(this);var t=this,e={};try{e=JSON.parse(Travian.Game.Preferences.get("snowAnimation"))}catch(t){}this.setPreferences(e),this.isActive()&&this.restart()},Travian.Seasons.Winter.prototype=Object.create(Travian.Seasons.Season.prototype),Travian.Seasons.Winter.constructor=Travian.Seasons.Winter,Travian.Seasons.Winter.writeNewPreferences=function(t){jQuery("body").find("span.pleaseSaveYourChanges").removeClass("hidden"),jQuery("input[name=option_seasonal_snow_preferencesSettings]").val(JSON.stringify(t)).trigger("change")},Travian.Seasons.Winter.setSettingsElementState=function(t,e){var i=t.find("input, select");e?(t.removeClass("disabled"),i.prop("disabled",!1)):(t.addClass("disabled"),i.prop("disabled",!0))},Travian.Seasons.Winter.bindSettingsEvents=function(t,e){Travian.Seasons.Winter.setSettingsElementState(e,t.is(":checked")),t.on("change",(function(){Travian.Seasons.Winter.setSettingsElementState(e,this.checked)})),e.find("#option_seasonal_snow_enabled").on("change",(function(){var t=this.checked;Travian.Seasons.currentSeason.restarting||setTimeout((function(){var e=Travian.Seasons.currentSeason.setPreferences({enabled:t});Travian.Seasons.Winter.writeNewPreferences(e),Travian.Seasons.currentSeason.restart()}),100)}))},jQuery((function(){"winter"===Travian.Variables.Season&&(Travian.Seasons.currentSeason=new Travian.Seasons.Winter)})),Travian.i18n={DIRECTION_OVERRIDE_LTR:String.fromCharCode(8237),DIRECTION_OVERRIDE_RTL:String.fromCharCode(8238),DIRECTION_STOP_OVERRIDE:String.fromCharCode(8236),LTR:"ltr",RTL:"rtl",RTL_LANGUAGES:["ar-AE","he-IL"],RTL_MATHS:["ar-AE"],RTL_RATIO:["ar-AE"],ARABIC_NUMBERS:["ar-AE","he-IL"],clearDirection:function(t){return t.replace(/[\u202D\u202C\u202E]/g,"")}},Travian.i18n.Number=function(t,e){let i={mathDirection:null,unit:"",sign:!1,locale:null,grouping:null,fraction:null};return function(e){const a={"%":String.fromCharCode(37),x:String.fromCharCode(215)},n={PLUS:String.fromCharCode(43),MINUS:String.fromCharCode(45)},o="de-DE";let r=Travian.Game.language;"com"===r&&(r="en-US"),i.mathDirection=Travian.i18n.RTL_MATHS.indexOf(r)>=0?Travian.i18n.RTL:Travian.i18n.LTR,void 0!==e.unit&&(i.unit=Object.keys(a).indexOf(e.unit)>=0?a[e.unit]:e.unit),i.sign=t<0?n.MINUS:void 0!==e.alwaysShowSign&&e.alwaysShowSign?n.PLUS:"",i.locale=Travian.i18n.ARABIC_NUMBERS.indexOf(r)>=0?o:r||o,i.grouping=void 0!==e.grouping&&e.grouping,i.fraction=void 0!==e.fraction?e.fraction:0}(e=void 0!==e?e:{}),function(){let e=Math.abs(t),a={};if(i.grouping||(a.useGrouping=i.grouping),void 0!==i.fraction&&(a.minimumFractionDigits=i.fraction,a.maximumFractionDigits=i.fraction),e=Travian.i18n.DIRECTION_OVERRIDE_LTR+e.toLocaleString(i.locale,a)+Travian.i18n.DIRECTION_STOP_OVERRIDE,i.unit||i.sign){let t=i.mathDirection===Travian.i18n.LTR?Travian.i18n.DIRECTION_OVERRIDE_LTR:Travian.i18n.DIRECTION_OVERRIDE_RTL,a=i.sign;i.signWrapper&&(a=i.signWrapper.replace("SIGN",a)),e=t+a+e+i.unit+Travian.i18n.DIRECTION_STOP_OVERRIDE}return e}()},Travian.i18n.Ratio=function(t,e,i){const a="&nbsp;";t=Travian.i18n.Number(t,i),e=Travian.i18n.Number(e,i),i=void 0!==i?i:{};return function(){let n=Travian.Game.language,o=function(t){t=void 0!==t&&t;let e=Travian.Game.language,i=Travian.i18n.RTL_RATIO.indexOf(e)>=0?"\\":"/";return t&&(i=a+i+a),i}(i.useSpaces),r=Travian.i18n.RTL_RATIO.indexOf(n)>=0?Travian.i18n.RTL:Travian.i18n.LTR,s=t;void 0!==i.nominatorClass&&(s='<span class="'+i.nominatorClass+'">'+t+"</span>");let l=e;return void 0!==i.denominatorClass&&(l='<span class="'+i.denominatorClass+'">'+e+"</span>"),(r===Travian.i18n.LTR?Travian.i18n.DIRECTION_OVERRIDE_LTR:Travian.i18n.DIRECTION_OVERRIDE_RTL)+s+o+l+Travian.i18n.DIRECTION_STOP_OVERRIDE}()},Travian.SVGHandler={get:function(t,e,i){if(i=i||{},"function"==typeof e){try{const a=JSON.parse(window.sessionStorage.getItem(t));if(a&&a.result&&JSON.stringify(a.config)===JSON.stringify(i))return e(a.result)}catch(t){}Travian.api("svg",{data:{path:t,config:i},success:function(a){void 0!==a&&(window.sessionStorage.setItem(t,JSON.stringify({result:a,config:i})),e(a))}},"POST","HTML")}}},Travian.Game={language:null,bcpLanguageCode:null,timezoneOffsetToUTC:0,gotoPage:function(t,e,i,a){return Travian.api(e,{data:{data:{page:t,entries:a}},success:function(t){jQuery(i).html(t.result)}}),!1},unitZoom:function(t,e){var i=new Travian.Dialog.Dialog({version:2,buttonOk:!1,cssClass:"basic"});return i.setContent('<img class="unitFull u'+t+'Full" src="/img/x.gif" alt="'+e+'">'),i.show(),!1},getDirection:function(){return jQuery("body > div").css("direction").toLowerCase()},getImageDirectoryPath:function(){return Travian.Variables.gpackUrl+"img_"+Travian.Game.getDirection()+"/"},setLanguage:function(t){let e;switch(t){case"sr-RS":e="sr-Cyrl";break;case"bs-BA":e="bs-Latn";break;default:e=t}this.language=t,this.bcpLanguageCode=e}},jQuery((function(){Travian.Autoreload.removeAutoreloadParameter(),jQuery("*.dynamic_img").on({mouseenter:function(t){jQuery(this).addClass("over")},mouseleave:function(t){jQuery(this).removeClass("over").removeClass("clicked")},mousedown:function(t){jQuery(this).removeClass("over").addClass("clicked")}})})),Travian.Game.Preferences={preferences:{},initialize:function(t){var e=this;for(var i in t)if(t.hasOwnProperty(i))switch(t[i]){case"true":e.preferences[i]=!0;break;case"false":e.preferences[i]=!1;break;case"null":e.preferences[i]=null;break;default:e.preferences[i]=t[i]}},get:function(t){return void 0!==this.preferences[t]?this.preferences[t]:null},set:function(t,e){if(this.preferences[t]!==e){this.preferences[t]=e;var i={};i[t]=null==e?e:e.toString(),Travian.api("preferences",{data:i})}},reload:function(){var t=this;Travian.api("preferences/all",{success:function(e){t.preferences={},t.initialize(e),jQuery(window).trigger("travian.preferences.reloaded")}},"get")}},Travian.Game.TwoStepAction=function(t,e){this.nonce=void 0,this.sign=function(i,a){const n=this;Travian.api(t,{data:e,success:function(t,e){n.nonce=e.getResponseHeader("x-nonce"),i&&i(t,e)},error:a},"PUT")},this.execute=function(i,a){Travian.api(t,{data:e,success:i,error:a,headers:{"X-Nonce":this.nonce}},"POST")}},Travian.Game.TwoStepAction.constructor=Travian.Game.TwoStepAction,Travian.Game.Layout={states:{travian_toggle:["expanded","collapsed"]},goldIsUpdating:!1,silverIsUpdating:!1,tabChangeEventTypeName:"tabChange",tabChangeEventClassAttribute:"contentClass",toggleBox:function(t,e,i){var a=e+"_"+i,n=this.states[e],o=Travian.Game.Preferences.get(a);-1===n.indexOf(o)&&(o=n[0]);for(var r="",s=0;s<n.length;s++){var l=n[s];t.removeClass(l),l!==o&&(r=l,t.addClass(r),Travian.Tip.setContent(t.find("button.toggleBox")[0],Travian.Translation.get(i+"_"+r)))}Travian.Game.Preferences.set(a,r),this.setInfoboxItemsRead()},setInfoboxItemsRead:function(){var t=jQuery("#sidebarBoxInfobox");if(t.length>0&&t.hasClass("toggleable")){var e=jQuery("#sidebarBoxInfobox li.unreaded");if(t.hasClass("collapsed")&&e.length>0){var i=[];e.each((function(t,e){i.push(jQuery(e).attr("id").replace("infoID_",""))})),Travian.api("infobox/read",{data:{infoIds:i},success:function(t){jQuery("#sidebarBoxInfobox li.unreaded").removeClass("unreaded");var e=jQuery("#sidebarBoxInfobox div.messageShortInfo");void 0!==t.messageCounterContent&&(e.animate({"margin-top":"15px",opacity:0},250),setTimeout((function(){e.remove(),jQuery(t.messageCounterContent).insertAfter("#sidebarBoxInfobox .boxTitle"),jQuery("#sidebarBoxInfobox div.messageShortInfo").css({"margin-top":"15px",opacity:0}).animate({"margin-top":0,opacity:1},250),Travian.Tip.refresh()}),250))}})}}},setupInfoboxItemsDeletionWithMessage:function(t,e){jQuery("a.infoboxDeleteButton").each((function(i,a){var n=jQuery(a),o=n.attr("data-id");n.click((function(i){var a=new Travian.Dialog.Dialog({preventFormSubmit:!0,buttonTextOk:e,onOkay:function(){Travian.api("infobox",{data:{id:o},success:function(){Travian.Autoreload.autoreload()}},"DELETE")}});return a.setContent(t),a.show(),!1}))}))},updateGold:function(t){Travian.Game.Layout.goldIsUpdating=!0;var e=parseInt(jQuery(".ajaxReplaceableGoldAmount").first().html());Travian.api("player/gold-amount",{data:{},success:function(i){var a=i.goldAmount;if(a!==e){var n=new Travian.Formatter({forceDecimal:!1});jQuery(".ajaxReplaceableGoldAmount").html(n.getFormattedNumber(a)),"function"==typeof t?t():"string"==typeof t&&"function"==typeof t.split(".").reduce((function(t,e){return t[e]}),window)&&t.split(".").reduce((function(t,e){return t[e]}),window)}Travian.Game.Layout.goldIsUpdating=!1}})},updateSilver:function(t){Travian.Game.Layout.silverIsUpdating=!0;var e=parseInt(jQuery(".ajaxReplaceableSilverAmount").first().html());Travian.api("player/silver-amount",{data:{},success:function(i){var a=i.silverAmount;if(a!==e){var n=new Travian.Formatter({forceDecimal:!1});jQuery(".ajaxReplaceableSilverAmount").html(n.getFormattedNumber(a)),"function"==typeof t?t():"string"==typeof t&&"function"==typeof t.split(".").reduce((function(t,e){return t[e]}),window)&&t.split(".").reduce((function(t,e){return t[e]}),window)}Travian.Game.Layout.silverIsUpdating=!1}})},updateShopNotification:function(t,e){if(t>0){let i=jQuery("#header .shopNotification");if(void 0!==e&&e.length>0&&(i=e),i.length>0){let e=parseInt(i.html())-t;e<=0?i.addClass("read"):(i.addClass("updating"),setTimeout((function(){i.html(e)}),150),setTimeout((function(){i.removeClass("updating")}),1500))}}},updateResources:function(){Travian.api("village/resources",{data:{},success:function(t){resources.maxStorage=t.maxStorage,resources.production=t.production,resources.storage=t.storage;let e=new Travian.Formatter({forceDecimal:!1});document.querySelector("#stockBar .warehouse .capacity .value").innerHTML=e.getFormattedNumber(t.maxStorage.l1).toString(),document.querySelector("#stockBar .granary .capacity .value").innerHTML=e.getFormattedNumber(t.maxStorage.l4).toString(),document.getElementById("stockBarFreeCrop").innerHTML=e.getFormattedNumber(t.production.l5).toString(),Travian.TimersAndCounters.initResourcesCounters();for(let e in t.tooltips)if(t.tooltips.hasOwnProperty(e)){let i="l5"===e?"stockBarFreeCrop":e;Travian.Tip.setContent(document.getElementById(i).parentElement,t.tooltips[e])}}})},toggleBackgroundOverlay:function(){var t=jQuery("#backgroundOverlay");t.length>0?(t.removeClass("visible"),setTimeout((function(){t.remove()}),500)):(t=jQuery('<div id="backgroundOverlay"></div>'),jQuery("body").prepend(t),t.addClass("visible"))},disable:function(){jQuery("body").addClass("mainLayoutDisabled")},enable:function(){jQuery("body").removeClass("mainLayoutDisabled")},tabChangeEventListenerRegister:function(){let t=jQuery("#content"),e=this.tabChangeEventClassAttribute;t.on(this.tabChangeEventTypeName,(function(i){t.attr("class",i[e])}))}},jQuery((function(){Travian.Game.Layout.tabChangeEventListenerRegister()})),Travian.Game.Layout.MobileOptimizations={breakPoint:620,enabled:!1,viewportSize:{width:0,height:0},init:function(){Travian.Game.Layout.MobileOptimizations.viewportSize.width=window.outerWidth,Travian.Game.Layout.MobileOptimizations.viewportSize.height=window.outerHeight,Travian.Game.Layout.MobileOptimizations.onResize(),jQuery(window).on("resize",Travian.Game.Layout.MobileOptimizations.onResize);let t=jQuery("#sidebarAfterContent"),e=jQuery("#sidebarBeforeContent"),i=jQuery("body:not(.activate):not(.login):not(.logout):not(.error_site)"),a=i.hasClass("rtl"),n=0,o=0,r=!0;i.on("touchstart",(function(t){let e=jQuery(t.target);e.hasClass("preventMobileSwipeNavigation")||0!==e.parents(".preventMobileSwipeNavigation").length||(n=t.originalEvent.changedTouches[0].pageX),o++})),i.on("touchmove",(function(){r=r&&1===o})),i.on("touchend",(function(s){if(r){let o=jQuery(s.target),r=i.find(".dialogWrapper");if(!(r.length>0&&r.is(":visible"))&&!o.hasClass("preventMobileSwipeNavigation")&&0===o.parents(".preventMobileSwipeNavigation").length&&!i.hasClass("mainLayoutDisabled")){let i=s.originalEvent.changedTouches[0].pageX-n,o=i>=0?"right":"left";Math.abs(i)>=200&&((!a&&"left"===o||a&&"right"===o)&&(e.hasClass("mobileOpened")||t.addClass("mobileOpened"),e.removeClass("mobileOpened")),(!a&&"right"===o||a&&"left"===o)&&(t.hasClass("mobileOpened")||e.addClass("mobileOpened"),t.removeClass("mobileOpened")))}}o>0&&o--,n=0,0===o&&(r=!0)})),jQuery("#sidebarAfterContent, #sidebarAfterContent *, #sidebarBeforeContent, #sidebarBeforeContent *").on("click",(function(a){let n=jQuery(a.target),o=i.find(".dialogWrapper");(!(o.length>0&&o.is(":visible"))&&0===n.parents(".sidebarBox").length||n.is("button:not(.toggleBox)")||n.is("a")||n.parents("a, button:not(.toggleBox)").length>0&&!n.is("img.del"))&&(e.removeClass("mobileOpened"),t.removeClass("mobileOpened"))})),Travian.Game.Layout.MobileOptimizations.fixNumericKeyboardOnIOS()},onResize:function(){let t=!1;Travian.Game.Layout.MobileOptimizations.enabled&&window.outerWidth===Travian.Game.Layout.MobileOptimizations.viewportSize.width&&window.outerWidth<=Travian.Game.Layout.MobileOptimizations.breakPoint&&(t=!0),Travian.Game.Layout.MobileOptimizations.viewportSize.width=window.outerWidth,Travian.Game.Layout.MobileOptimizations.viewportSize.height=window.outerHeight;let e,i=jQuery("body"),a=i.hasClass("mobileOptimized"),n=window.outerHeight>window.outerWidth,o=window.outerWidth<=Travian.Game.Layout.MobileOptimizations.breakPoint&&n,r=a&&o||t;if(Travian.Game.Layout.MobileOptimizations.enabled=r,r?i.addClass("mobileForced"):i.removeClass("mobileForced"),!0===(r&&null!==navigator.userAgent.match(/iPhone/i)))e="width="+Travian.Game.Layout.MobileOptimizations.breakPoint;else e="width=device-width";jQuery("meta[name=viewport]").attr("content",e)},fixNumericKeyboardOnIOS:function(){null!==navigator.userAgent.match(/iPhone/i)&&document.querySelectorAll("input[inputmode=numeric]").forEach((function(t){t.inputMode="text"}))}},Travian.Game.ColorPicker=function(t,e){this.selectColor=function(t){var e=this;return this.container.find("div.moocolorcheckbox-container").removeClass(e.options.selectedClassName),this.container.find('div[colorPick="'+t+'"]').each((function(i,a){jQuery(a).parent("div").addClass(e.options.selectedClassName),e.options.onChange(t)})),this},this.draw=function(){var t=this;return this.container.empty(),this.options.colors.forEach((function(e){var i=jQuery("<div></div>").addClass(t.options.className+" moocolorcheckbox-container").css({float:"left",cursor:"pointer"}).on("click",(function(){t.selectColor(e)})).appendTo(t.container);jQuery("<div></div>").addClass("entry").html("&nbsp;").css({"background-color":e}).attr("colorPick",e).appendTo(i)})),this},this.options=Object.assign({},{colors:[],defaultColor:-1,className:"moocolorcheckbox",selectedClassName:"moocolorcheckbox_selected"},e),this.container=jQuery(t),this.container.css("overflow","hidden"),this.draw(),this.options.defaultColor>=0&&this.selectColor(this.options.colors[this.options.defaultColor])},Travian.Game.ImagePicker=function(t,e){this.selectImage=function(t){var e=this;return this.container.find("div").removeClass(e.options.selectedClassName),this.container.find('img[src$="'+t+'"]').each((function(i,a){jQuery(a).parent("div").addClass(e.options.selectedClassName),e.options.onChange(t)})),this},this.options=Object.assign({},{images:[],defaultImage:-1,className:"mooimagecheckbox",selectedClassName:"mooimagecheckbox_selected",onChange:Travian.emptyFunction},e),this.container=t,this.container.css({overflow:"hidden"});var i=this;i.container.empty(),this.options.images.forEach((function(t){jQuery("<div></div>").addClass(i.options.className).html('<img src="'+t+'" alt="" />').css({float:"left",cursor:"pointer"}).on("click",(function(){i.selectImage(t)})).appendTo(i.container)})),this.options.defaultImage>=0&&this.selectImage(this.options.images[this.options.defaultImage])},Travian.Game.SwitchDown=function(t){this.switchDownElement=jQuery(t);var e=this;this.switchDownElement.on("click",(function(t){return e.switchDownElement.children().toggleClass("hide"),t.stopPropagation(),!1}))},Travian.Game.AddLine=function(t){this.options=Object.assign({insertAfterLastEntry:!0,elements:{add:null,insert:null,table:null,template:null},entryCount:0,maxEntries:!1,selectors:{add:".addLine.addElement",insert:".addLine.insertElement",template:".addLine.templateElement"},onAddBefore:Travian.emptyFunction,onAddAfter:Travian.emptyFunction,onCloneBefore:Travian.emptyFunction,onCloneAfter:Travian.emptyFunction,onInsertBefore:Travian.emptyFunction,onInsertAfter:Travian.emptyFunction,onInsertInputBefore:Travian.emptyFunction,onInsertInputAfter:Travian.emptyFunction},t);var e=this;if(!this.options.elements.table)throw"Table element for Travian.Game.AddLine is not definied";this.options.elements.table=jQuery(this.options.elements.table),"template add insert".split(" ").forEach((function(t){if(e.options.elements[t]||(e.options.elements[t]=e.options.elements.table.find(e.options.selectors[t])),!e.options.elements[t])throw'Element "'+t+'" for Travian.Game.AddLine is not definied'})),this.options.elements.add.addClass("addLine removeElement"),this.options.elements.template=this.options.elements.template.clone(!0),this.options.elements.add.removeClass("addLine removeElement"),this.options.elements.add.on("click",(function(t){t.stopPropagation(),e.options.onAddBefore(),e.options.onCloneBefore();var i=e.options.elements.template.clone(!0);e.options.onCloneAfter(i);var a=i.find("label, input, textarea, button, select");e.options.onInsertBefore(i),a.each((function(t,a){"input"===a.tagName.toLowerCase()?"checkbox"===a.type.toLowerCase()||"radio"===a.type.toLowerCase()?a.tagName.checked=!1:"text"!==a.type.toLowerCase()&&"password"!==a.type.toLowerCase()||(a.tagName.value=""):"select"===a.tagName.toLowerCase()?a.tagName.selectedIndex=-1:"textarea"===a.tagName.toLowerCase()&&(a.tagName.value=""),e.options.onInsertInputBefore(e.options.entryCount,i,a)})),e.options.elements.insert.after(i.css({opacity:0})),i.animate({opacity:1});var n=i.find(".addLine.removeElement");n&&(n.after(e.options.elements.add),n.remove()),e.options.entryCount++,!1!==e.options.maxEntries&&e.options.maxEntries===e.options.entryCount&&(e.options.elements.add.dispose(),Travian.Tip.hide()),a.each((function(t){e.options.onInsertInputAfter(i,t)})),e.options.onInsertAfter(i),!0===e.options.insertAfterLastEntry&&(e.options.elements.insert=i),e.options.onAddAfter(i)}))},Travian.Game.InstantTabs=function(t){var e=t.find(".tabNavi .container");e.on("click",(function(i){i.preventDefault();var a=this,n=0;e.each((function(t,e){null!=a&&(e===a?a=null:n++)})),e.removeClass("active"),jQuery(this).addClass("active");var o=t.find(".tabContainer");o.addClass("hide");var r=o.get(n);return jQuery(r).removeClass("hide"),!1}))},Travian.Game.TabScrollNavigation=function(){this.navigation="",this.scrollFrom="",this.scrollTo="",this.scrollingContainer="",this.isRTL=!1,this.direction=1,this.initialize=function(){var t=this;t.navigation=jQuery(".subNavi"),t.isRTL=jQuery("body.rtl").length>0,t.direction=t.isRTL?-1:1,t.navigation.length>0&&(t.scrollFrom=t.navigation.find(".scrollFrom"),t.scrollTo=t.navigation.find(".scrollTo"),t.scrollingContainer=t.navigation.find(".scrollingContainer"),t.updateButtonStates(),t.scrollToActiveTab(),t.scrollFrom.on("click",(function(){t.scrollingContainer.stop().animate({scrollLeft:0},500),t.scrollFrom.attr("disabled","disabled"),setTimeout((function(){t.updateButtonStates()}),550)})),t.scrollTo.on("click",(function(){t.scrollingContainer.stop().animate({scrollLeft:(t.scrollingContainer[0].scrollWidth-t.scrollingContainer[0].clientWidth)*t.direction},500),t.scrollTo.attr("disabled","disabled"),setTimeout((function(){t.updateButtonStates()}),550)})))},this.updateButtonStates=function(){var t=this;t.scrollingContainer[0].scrollWidth>t.scrollingContainer[0].clientWidth&&(t.isRTL?(t.scrollFrom.attr("disabled",!(t.scrollingContainer[0].scrollLeft<0)&&"disabled"),t.scrollTo.attr("disabled",0!==t.scrollingContainer[0].scrollLeft&&"disabled")):(t.scrollFrom.attr("disabled",!(t.scrollingContainer[0].scrollLeft>0)&&"disabled"),t.scrollTo.attr("disabled",!(t.scrollingContainer[0].scrollLeft<t.scrollingContainer[0].scrollWidth-t.scrollingContainer[0].clientWidth)&&"disabled")))},this.scrollToActiveTab=function(){var t=this,e=t.navigation.find(".tabItem.active").parent(".content");t.scrollingContainer[0].scrollWidth>t.scrollingContainer[0].clientWidth&&(!t.isRTL&&e.position().left+e.width()>t.scrollingContainer[0].clientWidth||t.isRTL&&e.position().left<0)&&(t.scrollingContainer.stop().animate({scrollLeft:(t.scrollingContainer[0].scrollWidth-t.scrollingContainer[0].clientWidth)*t.direction},500),setTimeout((function(){t.updateButtonStates()}),550))},this.initialize()},Travian.Game.AutoCompleter=function(t,e,i){const a=Object.assign({minLength:2,multiple:!1,separator:"",rows:10,width:"auto"},i);let n=null,o=null,r=null;const s=function(e){const i=e.html(),n=t.val(),o=t.get(0),r=n.substr(0,o.selectionStart);let s="";if(a.multiple){const t=n.split(a.separator);t.pop(),s=t.reduce((function(t,e){return t+e+a.separator}),s)}let l=function(t){const e={amp:"&",lt:"<",gt:">",quot:'"',"#039":"'","#60":"<","#62":">","#92":"\\","#34":'"',"#39":"'","#x27":"'"},i=new RegExp("&("+Object.keys(e).join("|")+");","g");return t.replace(i,(function(t,i){return e[i]||t}))}(i);t.val(s+l),o.selectionStart=s.length+r.length,o.selectionEnd=s.length+r.length+l.length},l=function(t){t.is("li")&&t.hasClass("autocompleter")&&o!==t&&(o&&o.removeClass("autocompleter-selected"),o=t.addClass("autocompleter-selected"),s(t))},d=function(t){if(!t.length)return o=null,void h.empty().append(jQuery("<li></li>").html(Travian.Translation.translate("{cropfinder.keine_ergebnisse}"))).show();const e=(t=t.map((function(t){return t.name}))).map((function(t){return jQuery('<li class="autocompleter"></li>').on({mouseover:function(){l(jQuery(this))}}).html(t)}));o=null,h.empty().append(e).show()},u=function(){const e=function(){const e=t.val().substr(0,t.get().selectionStart);return(a.multiple?e.split(a.separator).pop():e).trimStart()}();if(e!==n){if(n=e,e.length<a.minLength)return h.hide();r&&clearTimeout(r),r=setTimeout((()=>{p(e),r=null}),333)}},c=function(){if(!o)return;a.multiple&&t.val(t.val()+a.separator);const e=t.get(0);e.selectionStart=e.selectionEnd=t.val().length,o=null,h.hide()},p=function(t){Travian.api("autocomplete/"+e,{data:{search:t,limit:a.rows,context:a.context},success:d,error:function(){d([])}})},h=jQuery("<ul></ul>").attr("id",t.attr("id")+"-autocompleter").addClass("autocompleter-choices").css({zIndex:42,display:"none",top:t.outerHeight()}).insertAfter(t);t.prop("autocomplete","off").on("keydown",(function(t){switch(t.which){case 13:if(o)return c(),!1;break;case 38:case 40:if(h.is(":visible"))return function(t){switch(t){case"up":l(o?o.prev():h.children().last());break;case"down":l(o?o.next():h.children().first())}}(38===t.which?"up":"down"),!1;break;case 27:return h.hide(),!1}return!0})).on("keyup",(function(t){switch(t.which){case 13:case 38:case 40:case 27:return!1}return u(),!0})).on("click",c).on("focusout",(function(){h.hide()})),t.parent().css({position:"relative"})},Travian.Game.AutoCompleter.PlayerName=function(t,e){new Travian.Game.AutoCompleter(t,"playername",Object.assign({multiple:!0,separator:"; "},e))},Travian.Game.AutoCompleter.VillageName=function(t,e){new Travian.Game.AutoCompleter(t,"villagename",Object.assign({rows:20},e))},Travian.Game.Messages={check_in_progress:!1,recipients_checked:!1,technicalAccounts:["support","multihunter","plus"],checkRecipients:function(t,e){Travian.Game.Messages.check_in_progress||(Travian.Game.Messages.check_in_progress=!0,Travian.api("message/check-recipient",{data:{recipients:t},success:function(){Travian.Game.Messages.check_in_progress=!1,Travian.Game.Messages.recipients_checked=!0,e.trigger("submit")},error:function(t){Travian.Game.Messages.check_in_progress=!1;var e=new Travian.Dialog.Dialog({preventFormSubmit:!0});e.setContent(t.message),e.show()}}))},addRecipient:function(t){var e=jQuery("#receiver"),i=this.getRecipients().filter((function(t){return""!==t}));i.push(t),e.val(i.join("; ")),e.trigger("change")},getRecipients:function(t){return jQuery("#receiver").val().split(";").map((function(e){return t?e.trim().toLowerCase():e.trim()}))},checkIfRecipientsContainTechnicalAccounts:function(t){return this.technicalAccounts.reduce((function(e,i){return e||t.indexOf(i)>-1}),!1)}},Travian.Game.AddressBook={entrypoint:"addressbook",dialog:null,getDialog:function(){return null===this.dialog&&(this.dialog=new Travian.Game.AddressBook.Dialog),this.dialog},show:function(){this.dialog?this.dialog.unhide():this.getDialog().show()},hide:function(){null!==this.dialog&&this.dialog.hide()},call:function(t,e){if(e){var i=this.dialog;i.disableForm(),Travian.api(this.entrypoint+t,{data:{friend:e},success:function(t){i.setContent(t.html)},complete:function(){i.enableForm()}})}},add:function(t){return this.call("/add",t),!1},accept:function(t){return this.call("/accept",t),!1},remove:function(t){return this.call("/delete",t),!1}},Travian.Game.AddressBook.Dialog=function(t){var e=this;this.close=function(){this.hide()},Travian.Dialog.Api.call(this,Object.assign({call:Travian.Game.AddressBook.entrypoint,keepOpen:!0,context:"addressbook",draggable:!1,enableBackground:!1,preventFormSubmit:!0,title:Travian.Translation.translate("{nachrichten.adressbuch}"),buttonTextOk:Travian.Translation.translate("{allgemein.save}"),onOkay:function(){var t=e.content.find("input.friend").map((function(t,e){return e.value})).get().filter((function(t){return t}));Travian.Game.AddressBook.add(t)}},t||{}))},Travian.Game.AddressBook.Dialog.prototype=Object.create(Travian.Dialog.Api.prototype),Travian.Game.AddressBook.Dialog.constructor=Travian.Dialog.Api,Travian.Game.Notice=function(t,e){this.maxNotesLength=-1,this.element=jQuery("#notice"),this.initialize=function(t,e){void 0===t&&(t=-1),this.maxNotesLength=parseInt(t),void 0===e&&(e=jQuery("#notice")),this.element=e;var i=this;jQuery("#send").on("click",(function(t){i.DoubleClickPreventer||(i.DoubleClickPreventer=new Travian.DoubleClickPreventer,i.DoubleClickPreventer.timeout=250),i.DoubleClickPreventer.check()&&(i.checkMaxLength()||(t.preventDefault(),i.showNoticeTooLongMessage()))}))},this.showNoticeTooLongMessage=function(){var t=new Travian.Dialog.Dialog({preventFormSubmit:!0});t.setContent(Travian.Translation.get("nachrichten.notice_too_long")),t.show()},this.checkMaxLength=function(){return 0!==this.element.length&&(this.maxNotesLength<0||this.element.val().length<=this.maxNotesLength)},this.initialize(t,e)},Travian.Game.BBEditor=function(t,e){this.preview=null,this.textArea=null,this.id=null,this.initialize=function(t,e){var i=this;this.id=t,this.textArea=jQuery("#"+t),this.toolbar=jQuery("#"+t+"_toolbar"),this.preview=jQuery("#"+t+"_preview"),this.preview.css("display","none"),this.preview.addClass("preview"),jQuery("#"+t+"_previewButton").on("click",jQuery.proxy((function(t){i.fetchPreview(t)}),i)),jQuery("#"+t+"_resourcesButton").on("click",jQuery.proxy((function(t){i.showToolbarWindow(t)}),i)),jQuery("#"+t+"_smiliesButton").on("click",jQuery.proxy((function(t){i.showToolbarWindow(t)}),i)),jQuery("#"+t+"_troopsButton").on("click",jQuery.proxy((function(t){i.showToolbarWindow(t)}),i)),this.textArea.on("click",jQuery.proxy((function(t){i.hideToolbarWindow(t)}),i)),this.addEvent(this.toolbar,jQuery.proxy((function(t){i.insertTag(t)}),i)),e=void 0!==e&&e,!0===Boolean(e)&&this.fetchPreview(),Travian.Game.Village.enableVillageListShortcuts(),jQuery(window).on("travian.villageList.coordinatesShortcut",(function(t,e,a,n,o){jQuery(".bbToolbar button.bbCoordinate").trigger("click"),i.insertAtCursor(i.textArea,e+"|"+a)}))},this.addEvent=function(t,e){for(var i=jQuery(t).children(),a=0;a<i.length;a++)Travian.Game.BBEditor.getInformationFromClass(i[a],"bbTag")&&jQuery(i[a]).on("click",e)},this.insertTag=function(t){var e,i=this;t.preventDefault(),this.hidePreview(),e=jQuery(t.target).is("button")?jQuery(t.target):jQuery(t.target).parent();var a=Travian.Game.BBEditor.getInformationFromClass(e[0],"bbTag"),n=this.textArea[0].scrollTop;switch(Travian.Game.BBEditor.getInformationFromClass(e[0],"bbType")){case"d":i.insertAroundCursor(this.textArea,"["+a+"]","[/"+a+"]");break;case"s":i.insertAtCursor(this.textArea,a);break;case"o":i.insertAtCursor(this.textArea,"["+Travian.Game.BBEditor.getInformationFromClass(e[0],"bbTag")+"]")}this.textArea[0].scrollTop=n},this.showToolbarWindow=function(t){t.preventDefault();var e=t.target,i=jQuery("#"+this.id+"_"+Travian.Game.BBEditor.getInformationFromClass(e,"bbWin")),a=!0;"block"===i.css("display")&&(a=!1),this.hideToolbarWindow(),a&&(i.show(),i.css("display","block"))},this.hideToolbarWindow=function(t){t&&t.preventDefault();for(var e=jQuery("#"+this.id+"_toolbarWindows").children(),i=0;i<e.length;i++)jQuery(e[i]).css("display","none")},this.fetchPreview=function(t){var e=this;void 0!==t&&t.preventDefault(),"none"===e.textArea.css("display")||e.textArea.val().length<1?e.hidePreview():Travian.api("bb",{data:{nl2br:!0,target:e.id,message:e.textArea.val()},success:function(t){e.showPreview(t)},error:function(t){alert(t.message)}})},this.showPreview=function(t){this.preview.html(t.text),this.preview.css("display","block"),this.textArea.css("display","none")},this.hidePreview=function(){this.preview.css("display","none"),this.textArea.css("display","inline")},this.insertAroundCursor=function(t,e,i){var a=t[0].selectionStart,n=t[0].selectionEnd,o=e+t.val().substring(a,n)+i,r=t.val();t.val(r.substring(0,a)+o+r.substring(n)),t.focus(),t[0].selectionStart=a+e.length,t[0].selectionEnd=a+e.length},this.insertAtCursor=function(t,e){var i=t[0].selectionStart,a=t[0].selectionEnd,n=t.val();t.val(n.substring(0,i)+e+n.substring(a)),t.focus(),t[0].selectionStart=i+e.length,t[0].selectionEnd=i+e.length},this.initialize(t,e)},Travian.Game.BBEditor.getInformationFromClass=function(t,e){var i=jQuery(t);"img"===t.nodeName.toLowerCase()&&((t=i.parent("button")[0])||(t=i.parent("a")[0]));var a=jQuery(t).attr("class").split(" ").filter((function(t){return 0===t.indexOf(e)}));return a.length>0&&a[0].length>0&&(a=2===(a=a[0].substr(0,a[0].length-1).split("{")).length?a[1]:null),a},Travian.Game.RaidList={data:{},weAreAdding:!1,closestDropContainer:null,listsInSelectedVillage:null,captchaField:null,doubleClickPreventer:null,isRaidBeingSent:!1,checksum:null,startAll_inProgress:!1,startAll_sent:0,onError:function(t){var e=new Travian.Dialog.Dialog({buttonOk:!0,buttonCloseOnClickOk:!0,preventFormSubmit:!0});e.setContent(t.message),e.show()},startRaid:function(t,e){const i=this;if(!(e=void 0!==e&&e)&&(null===this.doubleClickPreventer&&(this.doubleClickPreventer=new Travian.DoubleClickPreventer),this.isRaidBeingSent||!this.doubleClickPreventer.check()))return;this.isRaidBeingSent=!0;let a=jQuery("#raidList .startButton");a.attr("disabled","disabled");let n=jQuery("#raidList"+t),o=n.find("input[name=sort]").val(),r=n.find("input[name=direction]").val();e||jQuery("#raidList .attackInfoIcon").remove();let s=n.find(".markSlot:checked"),l=[];s.length>0&&s.each((function(t,e){l.push(jQuery(e).data("slot"))}));let d=jQuery("."+this.captchaField);Travian.api("raid-list",{data:{action:Travian.Constants.ACTION.raidList,checksum:this.checksum,method:"ActionStartRaid",listId:t,slots:l,sort:o,direction:r,captcha:d.length>0?d.val():null,loadedLists:Object.keys(i.data),triggeredBySendAll:e},success:function(s){if(s.captchaRequired)i.confirm(n.find("form:last-of-type",!0));else{let a=[];void 0!==i.data[t]&&a.push({id:t,sortField:o,sortDirection:r,startedRaids:s.startedRaids,errorMessages:s.errorMessages});for(let e=0;e<s.listsToUpdate.length;e++){let n=s.listsToUpdate[e];if(void 0!==i.data[n]&&parseInt(n)!==parseInt(t)){let t=jQuery("#raidList"+n).find('input[name="sort"]').val();a.push({id:n,sortField:t,sortDirection:i.data[n].directions[t]})}}i.loadLists(a);let n={success:s.startedRaids,error:s.errorMessages};i.refreshListHeaders(!e,t,n)}s.limitReached&&i.onError({message:s.limitReached}),i.isRaidBeingSent=!1,i.startAll_inProgress||a.attr("disabled",!1)},error:function(t){new Travian.Dialog.Dialog({buttonOk:!0,buttonCloseOnClickOk:!0,preventFormSubmit:!0,onClose:function(){Travian.Autoreload.autoreload()}}).setContent(t.message).show()}})},refreshListHeaders:function(t,e,i){jQuery("#raidList").length>0&&Travian.api("raid-list",{data:{method:"ActionGetListHeaders",listId:t||void 0===e?null:e,successAndErrorSummary:{[e]:i}},success:function(t){for(let e=0;e<t.lists.length;e++){let i=t.lists[e],a=jQuery("#raidList"+i.id);a.find(".listName .value").html(i.name),a.find(".raidListHeadline .slots").html(i.slotsMarkup),i.tooltip&&a.find(".raidListHeadline .startButton").attr("title",i.tooltip),Travian.Tip.refresh()}},error:this.onError})},addSlot:function(t,e,i,a){var n=this;a=a||null,Travian.api("raid-list",{data:{method:"ActionAddSlotForm",listId:t,weAreAdding:!!Travian.Game.RaidList.weAreAdding||null,x:e,y:i,context:a},success:function(t){return n.dialog({buttonOk:!1,context:"raidAddSlotDialog"},t.html),!0},error:n.onError}),jQuery("#raidList .attackInfoIcon").remove()},deleteSlots:function(t){var e=this;Travian.api("raid-list",{data:{method:"actionDeleteSlots",slots:t},success:function(){var t=Travian.WindowManager.getWindowsByContext("raidAddSlotDialog").pop();return e.refreshList(t.options.raidListId),e.refreshListHeaders(!1,t.options.raidListId),t.close(),!0},error:e.onError}),jQuery("#raidList .attackInfoIcon").remove()},editSlots:function(t,e,i){var a=this,n=jQuery("#raidList"+t+" .markSlot"),o=jQuery("#raidList"+t+" .markSlot:checked"),r=[];void 0===e?(0!==o.length?o:n).each((function(t,e){r.push(jQuery(e).data("slot"))})):r.push(e);Travian.api("raid-list",{data:{method:"actionEditSlotForm",listId:t,slots:r,context:i},success:function(e){return a.dialog({buttonOk:!1,context:"raidAddSlotDialog",raidListId:t},e.html),!0},error:a.onError}),jQuery("#raidList .attackInfoIcon").remove()},addSlotPopupWrapper:function(t,e,i){Travian.Game.RaidList.weAreAdding=!0,Travian.Game.RaidList.addSlotWrapper(t,e,i)},editSlotPopupWrapper:function(t,e){Travian.Game.RaidList.weAreAdding=!1,Travian.Game.RaidList.editSlotWrapper(t,e)},addSlotWrapper:function(t,e,i){var a=Travian.WindowManager.getWindows(),n=a.length?a[a.length-1]:null;a.length>0&&n&&a[a.length-1].close(),Travian.Game.RaidList.addSlot(t,e,i)},editSlotWrapper:function(t,e){var i=Travian.WindowManager.getWindows(),a=i.length?i[i.length-1]:null;i.length>0&&a&&i[i.length-1].close(),Travian.Game.RaidList.editSlots(t,e,!0,"map")},dialog:function(t,e){var i=new Travian.Dialog.Dialog(Object.assign({preventFormSubmit:!0},t));i.setContent(e),i.show()},saveSlot:function(t,e,i){var a=this;null!==e&&e.length>1?a.persistSlotEntry(t,e,i):(Travian.api("raid-list",{data:{method:"ActionCheckForForeignSlotEntry",listId:t,slots:e,x:i.x,y:i.y},success:function(n){if(void 0!==n&&n.hasOwnProperty("entryExists"))if(n.entryExists){var o=new Travian.Dialog.Dialog({buttonOk:!0,buttonCloseOnClickOk:!1,preventFormSubmit:!0,onOkay:function(){a.persistSlotEntry(t,e,i)}});o.setContent('<div class="centeredText">'+Travian.Translation.get("raidList.overwriteFarmListEntry")+"<br>"+Travian.Translation.get("raidList.thisWillOverwriteAnExistingFarmListEntry")+"</div>"),o.show()}else a.persistSlotEntry(t,e,i)},error:a.onError}),jQuery("#raidList .attackInfoIcon").remove())},persistSlotEntry:function(t,e,i){var a=this;jQuery("#raidListSlot #edit_form .troops").siblings(".error").remove(),Travian.api("raid-list",{data:{method:null===e||e.length<2?"ActionAddSlot":"SlotsBulkEdit",listId:t,slots:e,x:i.x,y:i.y,t1:i.t1,t2:i.t2,t3:i.t3,t4:i.t4,t5:i.t5,t6:i.t6,t7:i.t7,t8:i.t8,t9:i.t9,t10:i.t10,slotState:void 0!==i.deactivate&&i.deactivate?"inactive":"active"},success:function(e){var i=Travian.WindowManager.getWindowsByContext("raidAddSlotDialog");return i.length>0&&i.pop().close(),a.refreshAllOpenLists(e.skippedSlots||[]),a.refreshListHeaders(!0,t,null),!0},error:a.onError})},refreshAllOpenLists:function(t){let e=Object.keys(this.data),i=[];for(let t=0;t<e.length;t++){let a=e[t],n=jQuery("#raidList"+a).find('input[name="sort"]').val();i.push({id:parseInt(a),sortField:n,sortDirection:this.data[a].directions[n]})}this.loadLists(i,t)},refreshList:function(t){if(void 0!==this.data[t]){let e=jQuery("#raidList"+t).find('input[name="sort"]').val();this.loadLists([{id:t,sortField:e,sortDirection:this.data[t].directions[e]}])}},loadLists:function(t,e){let i=this;for(let e=t.length-1;e>=0;e--){let a=jQuery("#raidList"+t[e].id+" .expandCollapse");void 0!==i.data[t[e].id]&&a.hasClass("collapsed")?(delete i.data[t[e].id],t.splice(e,1)):a.addClass("loading")}return t.length>0&&Travian.api("raid-list/slots",{data:{listConfigs:t},success:function(a){let n;for(let t=0;t<a.lists.length;t++){let e=a.lists[t];n=e.id;let o=jQuery("#raidList"+n),r=void 0===i.data[n];i.data[n]=e.list;let s=o.find(".raidListContent");s.html(e.html);let l=o.find(".expandCollapse");l.removeClass("loading"),o.find("input[name=sort]").val(e.sort),o.find("input[name=direction]").val(e.direction),r&&s.hasClass("hide")&&(s.removeClass("hide"),l.removeClass("collapsed").addClass("expanded"))}let o=i.data.hasOwnProperty(n)?i.data[n].troops:null;for(let e in i.data){i.data[e].troops=o||i.data[e].troops,i.updateTroopSummaryForAList(e);var r=t.filter((function(t){return t.id==e})).pop();if(r&&void 0!==r.startedRaids){var s=jQuery("#raidList"+e),l=s.find(".feedback");l.find("td span").html(r.startedRaids),l.show(),s.find(".selectedTroops").hide()}}void 0!==e&&e.length>0&&e.forEach((function(t){jQuery("#slot"+t.slotId).prop("checked",!0),i.markSlotForRaid(t.listId,t.slotId,!0,!0)})),Travian.Tip.refresh()},error:i.onError}),this},showCreateNewList:function(t){var e=this;Travian.api("raid-list",{data:{method:"actionAddListForm",did:t},success:function(t){e.dialog({buttonOk:!1,context:"createNewList"},t.html)},error:e.onError})},createNewList:function(){let t=jQuery('input[name="villageId"]').val();var e={did:t,listName:jQuery('input[name="listName"]').val(),method:"actionAddList",t1:jQuery('#raidListCreate input[name="t1"]').val(),t2:jQuery('#raidListCreate input[name="t2"]').val(),t3:jQuery('#raidListCreate input[name="t3"]').val(),t4:jQuery('#raidListCreate input[name="t4"]').val(),t5:jQuery('#raidListCreate input[name="t5"]').val(),t6:jQuery('#raidListCreate input[name="t6"]').val(),t7:jQuery('#raidListCreate input[name="t7"]').val(),t8:jQuery('#raidListCreate input[name="t8"]').val(),t9:jQuery('#raidListCreate input[name="t9"]').val(),t10:jQuery('#raidListCreate input[name="t10"]').val()},i=this;Travian.api("raid-list",{data:e,success:function(e){Travian.WindowManager.closeByContext("createNewList"),jQuery("#raidList").length>0&&(jQuery("#raidList .villageWrapper[data-did="+t+"]").append(e.listHTML),i.enableDragAndDropSorting(),!0===e.maxRaidListsReached&&(jQuery("a.createNew:not(.disabled)").addClass("hidden"),jQuery("a.createNew.disabled").removeClass("hidden")),i.updateRaidListCount())},error:function(t){void 0!==t.metadata&&t.metadata.validation_message?jQuery("#raidListCreate #error").html(t.metadata.validation_message):i.onError(t)}}),jQuery("#raidList .attackInfoIcon").remove()},deleteList:function(t){var e=this;null===e.doubleClickPreventer&&(e.doubleClickPreventer=new Travian.DoubleClickPreventer),e.doubleClickPreventer.check()&&Travian.api("raid-list",{data:{method:"actionDeleteList",listId:t},success:function(){Travian.WindowManager.closeByContext("deleteList"),Travian.WindowManager.closeByContext("updateList"),jQuery("#raidList"+t).parent(".dropContainer").remove(),delete e.data[t],jQuery("a.createNew:not(.disabled)").removeClass("hidden"),jQuery("a.createNew.disabled").addClass("hidden"),e.updateRaidListCount()},error:e.onError})},showUpdateList:function(t){var e=this;Travian.api("raid-list",{data:{method:"actionUpdateListForm",listId:t},success:function(t){e.dialog({buttonOk:!1,context:"updateList"},t.html)},error:e.onError})},updateList:function(t){let e=this,i=jQuery('#raidListUpdate input[name="sortIndex"]').val(),a={method:"actionUpdateList",listId:t,listName:jQuery('input[name="listName"]').val(),t1:jQuery('#raidListUpdate input[name="t1"]').val(),t2:jQuery('#raidListUpdate input[name="t2"]').val(),t3:jQuery('#raidListUpdate input[name="t3"]').val(),t4:jQuery('#raidListUpdate input[name="t4"]').val(),t5:jQuery('#raidListUpdate input[name="t5"]').val(),t6:jQuery('#raidListUpdate input[name="t6"]').val(),t7:jQuery('#raidListUpdate input[name="t7"]').val(),t8:jQuery('#raidListUpdate input[name="t8"]').val(),t9:jQuery('#raidListUpdate input[name="t9"]').val(),t10:jQuery('#raidListUpdate input[name="t10"]').val(),sortIndex:i};Travian.api("raid-list",{data:a,success:function(a){Travian.WindowManager.closeByContext("updateList"),e.refreshListHeaders(!1,t,null);let n=jQuery("#raidList"+t);if(n.length>0){let e=parseInt(n.parent(".dropContainer").data("sortindex")),a=parseInt(i);if(e!==a){n.parents(".villageWrapper").find(".dropContainer[data-sortindex="+a+"]").append(n);let i=n.parents(".villageWrapper").find(".raidList");a>e?i.each((function(){let i=jQuery(this);if(i.data("listid")!==t){let t=i.parent(".dropContainer"),n=t.data("sortindex");n>e&&n<=a&&t.prev(".dropContainer").append(i)}})):i.each((function(){let i=jQuery(this);if(i.data("listid")!==t){let t=i.parent(".dropContainer"),n=t.data("sortindex");n<e&&n>=a&&t.next(".dropContainer").append(i)}}))}}},error:function(t){void 0!==t.metadata&&t.metadata.validation_message?jQuery("#raidListUpdate #error").html(t.metadata.validation_message):e.onError(t)}}),jQuery("#raidList .attackInfoIcon").remove()},markSlotsOfAListForRaid:function(t,e,i){return i=void 0===i||i,jQuery.each(this.data[t].slots,(function(t,a){if(i&&a.isActive||!i){let i=jQuery("#slot"+t);void 0!==a&&(a.marked=e,i.prop("checked",e))}})),this.updateTroopSummaryForAList(t),this.toggleEditButtonText(t),this.toggleStateToggleButtonText(t),jQuery("#raidList .attackInfoIcon").remove(),this},markSlotForRaid:function(t,e,i,a){return this.data[t].slots[e].marked=i,(void 0===a||a)&&this.updateTroopSummaryForAList(t),this.toggleEditButtonText(t),this.toggleStateToggleButtonText(t),jQuery("#raidList .attackInfoIcon").remove(),this},toggleEditButtonText:function(t){var e=jQuery("#raidList"+t+" .editButton"),i=jQuery("#raidList"+t+" .markSlot").length,a=jQuery("#raidList"+t+" .markSlot:checked").length,n=a>0&&i!==a?e.data("selected-text"):e.data("default-text");e.html(n)},toggleStateToggleButtonText:function(t){var e=this.getStateToggleButtonState(t),i=jQuery("#raidList"+t).find(".stateToggleButton"),a={activateSelected:i.data("activate-selected-text"),activateAll:i.data("activate-default-text"),deactivateSelected:i.data("deactivate-selected-text"),deactivateAll:i.data("deactivate-default-text")};i.html(a[e])},getStateToggleButtonState:function(t){var e=jQuery("#raidList"+t),i=e.find(".markSlot").length,a=e.find(".markSlot:checked"),n=a.length,o=e.find(".slotInactive").length,r=0;return a.each((function(){jQuery(this).parents(".slotInactive").length>0&&r++})),n>0&&i!==n?r>0?"activateSelected":"deactivateSelected":i===n?r>0?"activateAll":"deactivateAll":o>0?"activateAll":"deactivateAll"},toggleSlotsState:function(t){var e=this,i=e.getStateToggleButtonState(t),a="activateSelected"===i||"activateAll"===i?"active":"inactive",n=jQuery("#raidList"+t),o=n.find(".markSlot"),r=n.find(".markSlot:checked"),s=r.length>0?r:o,l=[];s.each((function(){l.push(parseInt(jQuery(this).data("slot")))})),Travian.api("raid-list",{data:{method:"toggleSlotsState",slotState:a,slots:l},success:function(){e.refreshList(t)},error:e.onError})},setData:function(t){this.data=t},sort:function(t,e){return this.closeLastRaidSorting(t),this.loadLists([{id:t,sortField:e,sortDirection:"asc"!==this.data[t].directions[e]?"asc":"desc"}])},toggleList:function(t){var e=!jQuery("#raidList"+t+" .expandCollapse").hasClass("expanded");if(void 0===this.data[t])this.loadLists([{id:t}]);else{var i=jQuery("#raidList"+t);i.find(".expandCollapse").toggleClass("collapsed").toggleClass("expanded");let e=i.find(".raidListContent");e.toggleClass("hide"),e.hasClass("hide")&&i.find("input[type=checkbox]").prop("checked",!1)}return this.updateExpandedList(t,e),jQuery("#raidList .attackInfoIcon").remove(),this},collapseList:function(t){var e=jQuery("#raidList"+t);e.find(".expandCollapse").addClass("collapsed").removeClass("expanded"),e.find(".raidListContent").addClass("hide"),e.find("input[type=checkbox]").prop("checked",!1)},updateTroopSummaryForAList:function(t){var e=this,i=[0,0,0,0,0,0,0,0,0,0,0],a=0,n=jQuery("#raidList"+t);n.find(".feedback").hide();return n.find(".selectedTroops").show(),jQuery.each(this.data[t].slots,(function(t,e){if(e.marked){a++;for(var n=1;n<=10;n++)i[n]+=e.troops["t"+n]}})),n.find(".selectedCount").html(Travian.Translation.translate("{raidList.selected}").replace("[COUNT]",a)),a>0?n.find(".equals span").show():n.find(".equals span").hide(),n.find(".troopSelectionUnit").each((function(a,n){n=jQuery(n);let o=a+1;if(i[o]>0){let a=e.data[t].troops.hasOwnProperty("t"+o)?e.data[t].troops["t"+o]:0,r="troopsInVillage";i[o]>a&&(r+=" alert"),n.find("span").html(Travian.i18n.Ratio(i[o],a,{nominatorClass:"troopSelectionValue",denominatorClass:r})),n.show()}else n.hide()})),this},confirm:function(t,e){let i=this;e=void 0!==e&&e;let a=jQuery(t).closest("form").find('input[name="lid"]').val();Travian.api("raid-list/captcha",{data:{lid:a,attempt:e?"retry":"new"},success:function(t){t.captchaIsNeeded?i.dialog({buttonOk:!1,darkOverlay:!0,context:"raidListCaptcha"},t.html):i.startRaid(a)}})},RaidSlot:function(t,e,i){this.slots=t,this.context=e,this.targets=i,this.updateRaidList=function(){var t=jQuery("#xCoordInput").val(),e=jQuery("#yCoordInput").val();this.update({listId:this.getSelectedListId(),x:t,y:e})},this.updateTargetId=function(){var t=jQuery("#target_id").val(),e=this.targets.find((function(e){return e.did==t}));e&&(jQuery("#xCoordInput").val(e.x),jQuery("#yCoordInput").val(e.y),this.update({listId:this.getSelectedListId(),x:e.x,y:e.y}))},this.update=function(t){var e=Object.assign({method:"actionCheckSlotExists",slots:this.slots,context:this.context},t);Travian.api("raid-list",{data:e,success:function(t){t.update&&Travian.WindowManager.getWindowsByContext("raidAddSlotDialog").pop().setContent(t.html)},error:this.onError})},this.getSelectedListId=function(){return jQuery("select#lid option:selected").val()}},updateListSortIndex:function(t,e){Travian.api("raid/list/"+t+"/change-sort-index",{data:{newIndex:e},error:this.onError})},enableDragAndDropSorting:function(){jQuery((function(){jQuery(".dragAndDrop").off("mousedown touchstart").on("mousedown touchstart",(function(e){if("0"===jQuery(this).css("opacity"))return!0;e.preventDefault();var i=jQuery(this).parents(".raidList");Travian.Game.RaidList.collapseList(i.data("listid")),i.addClass("dragged");var a=i.clone();a.attr("id","dragElement"),a.css({width:i.width()}),i.parents(".dropContainer").prepend(a),t(e),jQuery(".villageWrapper").addClass("inactive"),i.parents(".villageWrapper").removeClass("inactive"),Travian.Game.RaidList.closestDropContainer=i.parents(".dropContainer")})),jQuery(window).on("mousemove touchmove",(function(e){var i=jQuery(".raidList.dragged");if(i.length>0){t(e);var a=Travian.getCursorPosition(e);if(Travian.Game.RaidList.closestDropContainer=i.parents(".dropContainer"),i.parents(".villageWrapper").find(".dropContainer").each((function(){var t=jQuery(this);Math.abs(a.y-t.offset().top-t.height()/2)<Math.abs(a.y-Travian.Game.RaidList.closestDropContainer.offset().top-Travian.Game.RaidList.closestDropContainer.height()/2)&&(Travian.Game.RaidList.closestDropContainer=t)})),jQuery(".dropContainer").removeClass("highlightDropSection"),parseInt(Travian.Game.RaidList.closestDropContainer.find(".raidList").data("listid"))!==parseInt(i.data("listid"))){var n=parseInt(Travian.Game.RaidList.closestDropContainer.data("sortindex"))>parseInt(i.parent(".dropContainer").data("sortindex"))?"down":"up";Travian.Game.RaidList.closestDropContainer.removeClass("up").removeClass("down").addClass("highlightDropSection "+n)}}})),jQuery(window).on("mouseup touchend",(function(){var t=jQuery(".raidList.dragged");if(t.length>0){var e=parseInt(t.parents(".dropContainer").data("sortindex")),i=parseInt(Travian.Game.RaidList.closestDropContainer.data("sortindex"));Travian.Game.RaidList.closestDropContainer.append(t),Travian.Game.RaidList.updateListSortIndex(parseInt(t.data("listid")),i);var a=Travian.Game.RaidList.closestDropContainer.parents(".villageWrapper").find(".raidList");i>e?a.each((function(){var a=jQuery(this);if(a.data("listid")!==t.data("listid")){var n=a.parent(".dropContainer"),o=n.data("sortindex");o>e&&o<=i&&n.prev(".dropContainer").append(a)}})):a.each((function(){var a=jQuery(this);if(a.data("listid")!==t.data("listid")){var n=a.parent(".dropContainer"),o=n.data("sortindex");o<e&&o>=i&&n.next(".dropContainer").append(a)}}));var n=jQuery("#dragElement"),o=Travian.Game.RaidList.closestDropContainer.find(".raidList:not(#dragElement)");o.addClass("hidden");var r=o.offset(),s=jQuery(window).scrollTop();n.animate({left:r.left,top:r.top-s},250),setTimeout((function(){o.removeClass("hidden"),n.remove()}),250),jQuery(".villageWrapper").removeClass("inactive"),t.removeClass("dragged"),jQuery(".dropContainer").removeClass("highlightDropSection")}}));var t=function(t){var e=Travian.getCursorPosition(t),i=jQuery(window).scrollTop(),a=jQuery("#dragElement"),n=a.offset(),o=a.find(".dragAndDrop svg"),r=o.offset(),s=n.left-r.left+o.width()/2,l=r.top-n.top+o.height()/2+i;a.css({left:e.x+s,top:e.y-l})}}))},enableClickSorting:function(t){var e,i,a=jQuery(".sortContainer"),n=null,o=1;jQuery.each(Travian.Game.RaidList.listsInSelectedVillage,(function(i,a){parseInt(a.id)===parseInt(t)&&(e=a),parseInt(a.sortIndex)>o&&(o=parseInt(a.sortIndex))})),a.find(".moveUp").on("click",(function(t){t.preventDefault();var a=parseInt(e.sortIndex),o=a-1;a>1&&(i=null,n=null,jQuery.each(Travian.Game.RaidList.listsInSelectedVillage,(function(t,i){var n=parseInt(i.sortIndex);n<a&&n>=o&&(i.sortIndex=n+1),parseInt(i.id)===parseInt(e.id)&&(i.sortIndex=o,e.sortIndex=o)})),r())})),a.find(".moveDown").on("click",(function(t){t.preventDefault();var a=parseInt(e.sortIndex),s=a+1;a<o&&(i=null,n=null,jQuery.each(Travian.Game.RaidList.listsInSelectedVillage,(function(t,i){var n=parseInt(i.sortIndex);n>a&&n<=s&&(i.sortIndex=n-1),parseInt(i.id)===parseInt(e.id)&&(i.sortIndex=s,e.sortIndex=s)})),r())}));var r=function(){jQuery.each(Travian.Game.RaidList.listsInSelectedVillage,(function(t,a){var o=parseInt(a.sortIndex);o===e.sortIndex-1&&(i=a),o===e.sortIndex+1&&(n=a)}));var t=a.find(".listBefore");t.find(".sortIndex").html(null!==i?i.sortIndex:""),t.find(".listName").html(null!==i?i.name:""),a.find(".listCurrent").find(".sortIndex").html(e.sortIndex);var r=a.find(".listAfter");r.find(".sortIndex").html(null!==n?n.sortIndex:""),r.find(".listName").html(null!==n?n.name:"");var s=a.find(".moveUp").removeClass("disabled");1===e.sortIndex&&s.addClass("disabled");var l=a.find(".moveDown").removeClass("disabled");e.sortIndex===o&&l.addClass("disabled"),jQuery('#raidListUpdate input[name="sortIndex"]').val(e.sortIndex)}},openLastRaidSorting:function(t){var e=this,i=jQuery("#raidList"+t).find("nav.lastRaidSorting");i.addClass("open"),i.on("click",(function(a){jQuery(a.target).is(i)&&e.closeLastRaidSorting(t)}))},closeLastRaidSorting:function(t){var e=jQuery("#raidList"+t).find("nav.lastRaidSorting");e.removeClass("open"),e.off("click")},updateExpandedList:function(t,e){Travian.api("raid-list",{data:{method:"updateListExpandedStatus",listId:t,isExpanded:e},success:function(){},error:this.onError})},startAll:function(){let t=this;if(!t.startAll_inProgress){t.startAll_inProgress=!0,t.startAll_sent=0;const e=jQuery(".raidList[data-listid]"),i=jQuery(".startAllWrapper"),a=i.find(".dispatchCount");jQuery("#raidList .attackInfoIcon").remove();const n=[];e.each((function(t,e){n.push(parseInt(jQuery(e).data("listid")))})),i.attr("data-status","dispatching");let o=setInterval((function(){if(t.startAll_inProgress&&0!==n.length){if(!t.isRaidBeingSent){const e=n.shift();void 0!==e&&(Travian.Game.RaidList.startRaid(e,!0),t.startAll_sent++,a.html(t.startAll_sent))}}else clearInterval(o),t.startAll_inProgress=!1,i.attr("data-status","idle"),jQuery("#raidList .startButton").attr("disabled",!1)}),100)}},cancelStartAll:function(){this.startAll_inProgress=!1},updateRaidListCount:function(){const t=jQuery(".raidList[data-listid]").length;jQuery(".raidListCount").html(t);const e=jQuery("#raidList button.startAll");0===t?e.addClass("disabled"):e.removeClass("disabled")}},Travian.Game.Reports={selectedReports:{},dialog:null,editRights:function(t,e){const i="report/rights/"+e.datas.reportId;return Travian.api(i,{success:function(a){e.datas=Object.assign({},e.datas||{},a||{});var n=Travian.Helpers.substitute('<div class="reports" id="editRights"><div><label><input type="checkbox" id="right1" class="check" /> {anonymOpponent}</label></div><div><label><input type="checkbox" id="right2" class="check" /> {anonymMyself}</label></div><div><label><input type="checkbox" id="right3" class="check" /> {hiddenOwnTroops}</label></div><div><label><input type="checkbox" id="right4" class="check" /> {hiddenOtherTroops}</label></div><div class="description">{description}<br /><textarea id="description"></textarea></div></div>',e.text),o=new Travian.Dialog.Dialog({relativeTo:t,buttonTextOk:e.text.buttonTextOk,title:e.text.title,preventFormSubmit:!0,onOpen:function(t,i){jQuery("#right1").prop("checked",e.datas.right1),jQuery("#right2").prop("checked",e.datas.right2),jQuery("#right3").prop("checked",e.datas.right3),jQuery("#right4").prop("checked",e.datas.right4),jQuery("#description").html(e.datas.description)},onOkay:function(t,e){return Travian.api(i,{data:{right1:jQuery("#right1").prop("checked"),right2:jQuery("#right2").prop("checked"),right3:jQuery("#right3").prop("checked"),right4:jQuery("#right4").prop("checked"),description:jQuery("#description").val()}}),!1}});o.setContent(n),o.show()}},"GET"),!1},updateContent:function(){var t=this;let e=jQuery("#content").hasClass("reportsOverview"),i=jQuery("#content .buttonWrapper .markAsRead").add(jQuery("#content .dialogTemplates .markAsReadDialog .confirm")).add(jQuery("#content .buttonWrapper .delete")).add(jQuery("#content .dialogTemplates .deleteDialog .confirm")),a=jQuery("#content .dialogTemplates span.count");i.each((function(){let i=$(this);t.selectedReports.length>0?(i.html(i.data("text-selected")),a.html(t.selectedReports.length)):(i.html(e?i.data("text-all"):i.data("text-category")),a.html(a.data("total-count")))}));let n=jQuery("#content .buttonWrapper .archive");0===this.selectedReports.length||n.data("disabled")?(n.attr("disabled",!0),n.addClass("disabled")):(n.attr("disabled",!1),n.removeClass("disabled"))},updateSelected:function(){let t=jQuery("#reportsForm").find("input.report:checked"),e=[];t.length>0&&t.each((function(t,i){e.push(jQuery(i).val())})),this.selectedReports=e,this.updateContent()},selectAll:function(t){jQuery("#overview").find("input[type=checkbox]").each((function(e,i){i.checked=t.checked}),t),this.updateSelected()},handleMarkAsRead:function(t){this.selectedReports.length>0||t?this.processMarkAsRead():this.showDialog("markAsReadDialog")},processMarkAsRead:function(){jQuery(".markAsReadDialog input.hideMarkAsReadDialog").is(":checked")&&jQuery("#reportsForm input[name=hideDialog]").val("hideMarkAsReadDialog"),jQuery("#reportsForm input[name=do]").val("mark_as_read"),jQuery("#reportsForm").submit()},processArchive:function(){jQuery("#reportsForm input[name=do]").val("archive"),jQuery("#reportsForm").submit()},handleDelete:function(t){t?this.processDelete():this.showDialog("deleteDialog")},processDelete:function(){jQuery(".deleteDialog input.hideDeleteDialog").is(":checked")&&jQuery("#reportsForm input[name=hideDialog]").val("hideDeleteDialog"),jQuery("#reportsForm input[name=do]").val("deleted"),jQuery("#reportsForm").submit()},showDialog:function(t){this.dialog=new Travian.Dialog.Dialog({buttonOk:!1,preventFormSubmit:!0}),this.dialog.setContent(jQuery("#content .dialogTemplates ."+t).clone()),this.dialog.show()},closeDialog:function(){null!==this.dialog&&this.dialog.close()}};var reload_enabled=!0,delayTimeForReload=0,resources={};Travian.TimersAndCounters={timerEndEvent:"timerEnd",timers:[],resourceCounters:{},timeToInt:function(t){var e;return 3600*(e=t.split(":"))[0]+60*e[1]+1*e[2]},intToTime:function(t,e,i){var a,n,o,r;return t<0-delayTimeForReload-1?r=e?"0:00:0?":Travian.Templates.EventJam||"0:00:0?":(t=Math.max(0,t),a=Math.floor(t/3600),"12h"===i&&0===a&&(a=12),r=a+":",(n=Math.floor(t/60)%60)<10&&(r+="0"),r+=n+":",(o=t%60)<10&&(r+="0"),r+=o),{hour:a,minute:n,second:o,time:r}},getTimeByDurationAndOffset(t){const e=new Date;return Math.round(e.getTime()/1e3%86400-Travian.Game.timezoneOffsetToUTC+t)},init:function(){this.initResourcesCounters(),this.initTimers()},initTimers:function(){this.initTimersInContext(document)},initTimer:function(t){let e,i;const a=t.getAttribute("format"),n=Math.floor(Date.now()/1e3);if("down"===t.getAttribute("counting"))e=parseInt(t.getAttribute("value"))||0,i={node:t,value:e,counting:"down",startedAt:n,reloadDelay:e<delayTimeForReload?1e3*delayTimeForReload:0,hasCallback:""!==t.id};else i={node:t,value:this.timeToInt(t.innerHTML||"00:00:00"),counting:"up",startedAt:n,format:a};i.value>-1&&(this.updateTimerValue(n,i),this.addTimer(t,i))},initTimersInContext:function(t){const e=t.getElementsByClassName("timer");for(let t of e)this.initTimer(t)},addTimer:function(t,e){const i=this.timers.findIndex((function(e){return e.node===t}));i>-1?this.timers[i]=e:this.timers.push(e)},clearTimer:function(t){const e=this.timers.findIndex((function(e){return e.node===t}));e>-1&&this.timers.splice(e,1)},updateTimer:function(t,e){const i=this.timers.find((function(e){return e.node===t}));i&&(i.value=parseInt(e),i.startedAt=Math.floor(Date.now()/1e3))},updateTimerValue:function(t,e){let i,a,n,o,r=t-e.startedAt;switch(e.counting){case"down":i=e.value-r,a=this.intToTime(i),e.node.innerHTML=a.time,e.node.setAttribute("value",i),i<1&&(this.clearTimer(e.node),this.finishCountdown(e));break;case"up":n="12h"===e.format?(e.value+r)%43200:(e.value+r)%86400,a=this.intToTime(n,null,e.format),e.node.innerHTML=a.time,"12h"===e.format&&12===a.hour&&0===a.minute&&0===a.second&&(o=jQuery(e.node).next(),o.length>0&&(o[0].innerHTML=-1!==o[0].innerHTML.indexOf("pm")?" am":" pm"))}},initResourcesCounters:function(){this.resourceCounters={},this.initResourcesCounter("l1","lbar1"),this.initResourcesCounter("l2","lbar2"),this.initResourcesCounter("l3","lbar3"),this.initResourcesCounter("l4","lbar4")},initResourcesCounter:function(t,e){var i=document.getElementById(t),a=document.getElementById(e);try{var n=resources.production[t];0===n?this.updateResourceCounter(i,a,resources.storage[t]):(this.resourceCounters[t]={startInMs:Date.now(),production:n,initialResources:resources.storage[t],maximumResources:resources.maxStorage[t],minimumResources:0,tickInMs:Math.max(Math.round(Math.abs(36e5/n)),100),bar:a,node:i},this.executeCounter(t))}catch(t){}},updateResourceCounter:function(t,e,i){var a=new Travian.Formatter({forceDecimal:!1});t.innerHTML=a.getFormattedNumber(i);var n=jQuery(e);if(n.length>0){var o=Math.round(100*i/resources.maxStorage[t.id]);n.removeClass("stockFull"),i>=resources.maxStorage[t.id]&&n.addClass("stockFull"),n.css({width:o+"%"})}},executeCounter:function(t){var e=this.resourceCounters[t],i=Date.now()-e.startInMs,a=Math.floor(e.initialResources+i*(e.production/36e5));switch(!0){case a>=e.maximumResources:a=e.maximumResources;break;case a<=e.minimumResources:a=e.minimumResources;break;default:window.setTimeout("Travian.TimersAndCounters.executeCounter('"+t+"')",e.tickInMs)}resources.storage[t]=a,this.updateResourceCounter(e.node,e.bar,a)},finishCountdown:function(t){if(t.hasCallback){let e=new Event(this.timerEndEvent+"_"+t.node.id,{bubbles:!1,cancelable:!1});window.dispatchEvent(e)}else window.reload_enabled&&setTimeout((function(){Travian.Autoreload.autoreload()}),t.reloadDelay+1e3)},enableReloadEvent:function(){window.reload_enabled=!0},suppressReloadEvent:function(){window.reload_enabled=!1},executeTimers:function(){const t=Date.now(),e=Math.floor(t/1e3);for(let t of this.timers)this.updateTimerValue(e,t);window.setTimeout("Travian.TimersAndCounters.executeTimers()",1e3*(e+1)-t)}},jQuery((function(){Travian.TimersAndCounters.init(),Travian.TimersAndCounters.executeTimers()})),Travian.Game.Hero={refreshInHUD:function(){let t=this;Travian.api("hero/dataForHUD",{success:function(e){let i=jQuery("#topBarHero");t.updateHeroExperienceBar(e.bars.experience),t.updateHeroHealthBar(e.bars.health),i.find(".levelUp").removeClass("show"),e.levelUp&&i.find(".levelUp").addClass("show"),i.find(".heroStatus a, .heroStatus span").html(e.statusInlineIcon),i.find(".heroStatus a").attr("href",e.url),null!==e.url?(i.find(".heroStatus a").removeClass("hide"),i.find(".heroStatus span").addClass("hide")):(i.find(".heroStatus a").addClass("hide"),i.find(".heroStatus span").removeClass("hide")),i.find(".heroStatus").attr("title",e.heroStatusTitle),i.find(".heroImage").removeClass("heroImageMale").removeClass("heroImageFemale").addClass(e.heroGenderImage).attr("src",e.heroImagePath),i.find("#heroImageButton").attr("title",e.heroButtonTitle),Travian.Tip.updateAllInElement(i)}},"get")},updateHeroExperienceBar:function(t){TweenLite.to(jQuery("#experienceMask path"),.5,{morphSVG:t.paths.mask}),TweenLite.to(jQuery("#topBarHero .experience path.title"),.5,{morphSVG:t.paths.title}),jQuery("#topBarHero .experience .title").html("<title>"+t.title+"</title>")},updateHeroHealthBar:function(t){TweenLite.to(jQuery("#healthMask path"),.5,{morphSVG:t.paths.mask}),TweenLite.to(jQuery("#topBarHero .health path.title"),.5,{morphSVG:t.paths.title});let e=jQuery("#topBarHero .health image"),i=e.attr("xlink:href").replace(/^(.*\/)(\w+)(\.png)$/,"$1"+t.image+"$3");e.attr("xlink:href",i),jQuery("#topBarHero .health .title").html("<title>"+t.title+"</title>")}},Travian.Game.Hero.Editor=function(){var t=null;return function(e){this.unloadIdentifier=null,this.options=Object.assign({element:null,command:null,attributes:null,urlHeroImage:null,elementHeroImage:null},e),this.hideAll=function(){return this.options.element.find(".attributes .container .infoOpen").removeClass("infoOpen").find(".headline").removeClass("switchOpened").addClass("switchClosed"),this.options.element.find(".attributes .container .details").hide(),this},this.initialize=function(){var e=this;e.initializeAttributes();var i=e.options.element.find("#save");null!==i&&i.on("click",(function(t){e.sendAction("save",(function(){var t=Travian.Browser.parseURL(e.options.urlHeroImage);delete t.searchObject.code,t.searchObject.time=(new Date).getTime(),jQuery("."+e.options.elementHeroImage).attr("src",Travian.Browser.composeURI(t))})),t.preventDefault()}));var a=e.options.element.find("#random");null!==a&&(a.off("click",t),t=function(t){e.sendAction("random"),t.preventDefault()},a.on("click",t)),this.bindGenderSwitch(),this.storeAttributesInInput(this.options.attributes)},this.initializeAttributes=function(){var t=this;"object"!=typeof t.options.element&&(t.options.element=jQuery("#"+this.options.element)),this.hideAll(),this.options.element.find(".attributes .container:not(.gender) .info .headline").on("click",(function(e){e.preventDefault(),t.showAttribute(jQuery(this).parent(".info"))})),this.options.element.find(".attributes .container:not(.gender) .attribute").on("click",(function(e){var i=parseInt(e.target.id.split("attribute_button_")[1]),a=jQuery(e.target).parents(".info").attr("id");t.options.attributes[a]=i,t.sendAction("show"),e.preventDefault()}))},this.sendAction=function(t,e){"save"===t?Travian.Form.UnloadHelper.disableSecurity(this.unloadIdentifier):this.unloadIdentifier=Travian.Form.UnloadHelper.enableSecurity(this.unloadIdentifier);var i=this;return Travian.api(this.options.command,{data:{action:t,attribs:this.options.attributes},success:function(t){jQuery(".hero_head .image").html(t.html),t.attributesHtml&&(jQuery("#attributesContainer").html(t.attributesHtml),i.initializeAttributes()),i.options.attributes=t.attributes,i.storeAttributesInInput(t.attributes),(e||Travian.emptyFunction)()}}),this},this.showAttribute=function(t){var e=(t=jQuery(t)).hasClass("infoOpen");return this.hideAll(),e||(t.addClass("infoOpen"),t.find(".headline").removeClass("switchClosed").addClass("switchOpened"),t.find(".details").show()),this},this.storeAttributesInInput=function(t){var e=this.options.element.find("input[name=attributes]");return null!==e&&e.val(encodeURI(JSON.stringify(t))),this},this.switchGender=function(t){this.options.element.hasClass("genderSwitch")&&(jQuery("#heroEditorActivateMale, #heroEditorActivateFemale").removeClass("iconActive disabled"),"male"===t?(this.options.element.removeClass("female").addClass("male"),jQuery("#heroEditorActivateMale").addClass("iconActive disabled")):(this.options.element.removeClass("male").addClass("female"),jQuery("#heroEditorActivateFemale").addClass("iconActive disabled"))),this.options.attributes.gender=t,this.sendAction("gender")},this.bindGenderSwitch=function(){var t=this;jQuery("#heroEditorActivateMale, #heroEditorActivateFemale").on("click",(function(e){"heroEditorActivateMale"===jQuery(this).attr("id")&&!1===t.options.element.hasClass("male")?t.switchGender("male"):"heroEditorActivateFemale"===jQuery(this).attr("id")&&!1===t.options.element.hasClass("female")&&t.switchGender("female"),e.preventDefault()}))},this.initialize()}}(),Travian.Game.Hero.Editor.constructor=Travian.Game.Hero.Editor,Travian.Game.Hero.Inventory=function(t){this.dragStatus=!1,this.isClicked=!1,this.dropOnSlotFailed=!1,this.items=[],this.options=Object.assign({did:null,c:null,gender:"male",heroState:{},isInVillage:!0,isDead:!1,data:[],heroBodyHash:!1,images:"img/hero/items/item{typeId}.png",text:{}},t),this.startDrop=!1,this.DoubleClickPreventer=null,this.createAndAddItem=function(t){var e=Object.assign({placeElement:void 0,html_id:"item_"+t.id},t||{});return-1===JSON.stringify(this.items).indexOf(JSON.stringify(e))&&this.items.push(e),this},this.createDivs=function(){var t=this,e=jQuery("#placeHolder"),i=function(e){if(t.dropOnSlotFailed)t.dropOnSlotFailed=!1;else{t.DoubleClickPreventer||(t.DoubleClickPreventer=new Travian.DoubleClickPreventer);var i=Travian.Browser.isMobile()||t.DoubleClickPreventer.check();e.isUseable&&i&&(!Travian.Browser.isMobile()||e.clickedFirstTime&&Travian.Browser.isMobile()?(Travian.Tip.hide(),t.moveToMatchingPlace(e)):(!0!==t.startDrop&&t.mark(e.slot),e.clickedFirstTime=!0))}},a=function(e){t=this,e.isUseable&&!0!==t.startDrop&&t.mark(e.slot)},n=function(e){t=this,e.isUseable&&!0!==t.startDrop&&t.unMark(e.slot)};return jQuery.each(this.items,(function(o,r){r.isUseable=t.options.isInVillage||r.isConsumable||"bag"===r.slot,t.options.isDead&&!r.isUsableIfDead&&(r.isUseable=!1);var s="";r.isUseable||(s=(t.options.isDead?t.options.text.notMoveableTextDead:t.options.text.notMoveableText)+"<br />"),s+=r.attributes.join("<br />");var l=jQuery("<div></div>").attr("id","item_"+r.id).addClass("item "+t.options.gender+"_item_"+r.typeId+" "+(r.isUseable?"":"disabled")).css("position","relative").html('<div class="amount">'+r.amount+"</div>").on({click:jQuery.proxy(i,t,r),mouseover:jQuery.proxy(a,t,r),mouseout:jQuery.proxy(n,t,r)}).appendTo(e);Travian.Tip.set(l,{unescaped:!0,title:"("+r.amount+") "+r.name,text:s}),l[0].item=r,l[0].item.element=l;var d=null;r.placeId<0?(d=jQuery("#"+r.slot),l.addClass("onHero")):d=jQuery("#inventory_"+r.placeId),d.addClass(r.isUseable?"":"disabled"),t.moveToDrop(l,d,!0)})),this.makeDraggable(),this.options.elementHeroBody[0].src=String(this.options.urlBodyImage).replace(/\\?\{([^{}]+)\}/g,jQuery.proxy(this.substitute,{heroBodyHash:t.options.heroBodyHash})),this},this.substitute=function(t,e){return"\\"===t.charAt(0)?t.slice(1):null!=this[e]?this[e]:""},this.dialog=function(t,e){var i=this,a=t.text,n=t.amount,o=t.maximum||t.amount,r=t.calculate;delete t.text,delete t.amount,delete t.calculate,t.onOpen=function(t,e){var a=e.children("input#amount.text");if(a.length>0){var s=function(t){if(r){var i,a=1+r.bonusPercent/100,n=t*Math.round(r.valuePerItem*a),o=t*r.valuePerItem,s=n-o,l=e.find(".displayUseValue"),d=e.find(".displayUseBonusP"),u=e.find(".displayUseBonus"),c=e.find(".displayAfterUse");l.length>0&&l.html(o),d.length>0&&d.html(r.bonusPercent),u.length>0&&u.html(s),c.length>0&&(i=r.maxValue?Math.min(r.currentValue+n,r.maxValue):r.currentValue+n,c.html(i))}};a.val(n),s(n),t.makeInputAmountable(a,o,s.bind(i))}return!0},t.onClose=function(){i.isClicked=!1,i.resetItemDrop(e)},t=Object.assign(t,{buttonTextOk:this.options.text.buttonOk}),a=String(a).replace(/\\?\{([^{}]+)\}/g,jQuery.proxy(this.substitute,{inputField:'<input class="text" id="amount" type="text" inputmode="numeric" value="0" autocomplete="off" />',equipmentBonus:'<span class="displayUseBonusP">0</span>'}));var s=new Travian.Dialog.Dialog(t);return s.setContent(a),s.show(),this},this.executeMovement=function(t,e,i){var a=this;return Travian.api("inventory",{data:{action:Travian.Constants.ACTION.inventory,checksum:this.options.checksum,id:t,drid:e,amount:i,clicked:a.isClicked,did:this.options.did},success:function(t){a.isClicked=!1,a.options.heroState=Object.assign(a.options.heroState,t.heroState||{}),t.heroBodyHash&&(a.options.heroBodyHash=t.heroBodyHash),jQuery.each(a.items,(function(t,e){jQuery("#"+e.html_id).remove()})),a.items=[],jQuery.each(t.items,(function(t,e){a.createAndAddItem(e)})),jQuery(".inventory").each((function(t,e){jQuery(e).remove()}));var e=t.inventorySize;t.heroData.freePoints>0&&jQuery("div.hero_inventory .attribute .setPoint").show();for(var n=1;n<=e;n++)jQuery("<div></div>").attr("id","inventory_"+n).addClass("inventory draggable").insertBefore(jQuery("#itemsToSale").find(".market"));a.createDivs();var o=jQuery("#attributes"),r=jQuery(".heroHealthBarBox"),s=jQuery(".heroXpBarBox");if(jQuery.each(t.heroData,(function(t,e){var i=o.find("."+t);if(i.length>0){var a=i.find(".current"),n=i.find(".progress .bar").not(".setted"),r=i.find(".points"),s=i.find(".tooltip");if(i.hasClass("res")){var l=jQuery("#setResource").find(".resource label .current");jQuery(l).each((function(t,i){jQuery(i).html(e["resourceHero"+t])}))}if(i.hasClass("tooltip")&&s.push(i),a.length>0&&a.find(".value").length>0&&(a=a.find(".value")),void 0!==e.current&&a.length>0&&a.html(e.current),void 0!==e.percent&&n.length>0){var d="experience"!==t?e.percent:Math.ceil(e.percent);n.css("width",d+"%"),void 0!==e.backgroundColor&&n.css("backgroundColor",e.backgroundColor),void 0!==e.points&&r.length>0&&(r.find("input").length>0?r.find("input").val(e.points):r.html(e.points)),void 0!==e.tooltip&&s.length&&jQuery.each(s,(function(t,i){jQuery(i).attr("title",e.tooltip),Travian.Tip.refresh()}))}}})),"hero-dead"!==o[0].className){o.find(".experience").find(".value").html(t.heroData.experience.current);var l=o.find(".health");l.length>0&&(l.find(".value").html(t.heroData.health.percent+"%"),l.find(".bar").css("width",t.heroData.health.percent+"%")),r.prop("title",t.heroData.health.tooltipSidebar),r.find(".bar").css("width",t.heroData.health.percent+"%"),s.prop("title",t.heroData.experience.tooltipSidebar),s.find(".bar").css("width",t.heroData.experience.percent+"%")}void 0!==a.DoubleClickPreventer&&a.DoubleClickPreventer.cancelTimer(),a.dragStatus=!1,a.options.afterRequestCallback[t.itemTypeId]&&a.options.afterRequestCallback[t.itemTypeId](a,a.options,i,t)},error:function(t){new Travian.Dialog.Dialog({preventFormSubmit:!0}).setContent(t.message).show()}}),this},this.initialize=function(){var t=this;jQuery.each(this.options.data,(function(e,i){t.createAndAddItem(i)})),this.createDivs()},this.isInventoryId=function(t){return"inventory"===t.substr(0,9)},this.makeDraggable=function(){var t=this,e=jQuery(".draggable");jQuery("#text");return jQuery(".item").each((function(i,a){!1!==a.item.isUseable&&(Travian.Browser.isMobile()||(jQuery(a).on("mousedown",(function(e){t.dropOnSlotFailed=!1,e.preventDefault(),t.startDrop=!0;var i=this;i.item.dragOrigin=jQuery(this).parent(".draggable"),jQuery("body").on("mousemove.inventoryItem",(function(a){if(t.startDrop&&(t.dragStatus||e.pageX!==a.pageX||e.pageY!==a.pageY)){t.dragStatus=!0,jQuery("#content").children().css({userSelect:"none"});var n=jQuery(i);n.offset({left:a.pageX-n.width()/2,top:a.pageY-n.height()/2}),n.addClass("whileDragging").removeClass("onHero")}}))})),jQuery(a).on("mouseup",(function(i){if(jQuery("#content").children().css({userSelect:"auto"}),jQuery("body").off("mousemove.inventoryItem"),!t.dragStatus)return t.startDrop=!1,!1;var a=jQuery(this),n=this.item,o=i.pageX,r=i.pageY,s=!1,l=!1;jQuery(e).each((function(e,i){if(!l){var d=(i=jQuery(i)).offset(),u=d.left,c=d.left+i.width(),p=d.top,h=d.top+i.height();o>=u&&o<=c&&r>=p&&r<=h&&(l=!0,t.isInventoryId(i.prop("id"))?(t.moveToDrop(a,i,!1),s=!0):n.slot===i.attr("id")&&(t.moveToDrop(a,jQuery("#"+n.slot),!1),s=!0))}})),s||(t.isInventoryId(n.dragOrigin[0].id)||a.addClass("onHero"),t.dragStatus=!1,t.dropOnSlotFailed=!0,t.moveToDrop(a,n.dragOrigin,!0)),a.removeClass("whileDragging"),Travian.Tip.hide(),s=!1,t.startDrop=!1}))))})),this},this.mark=function(t){return jQuery("#"+t).addClass("heroMarked"),this},this.moveItem=function(t,e,i){return i?this.executeMovement(t[0].item.id,e.attr("id"),i):(t.detach().appendTo(e),this.resetItemDrop(t),t[0].item.placeElement=jQuery(e)),this},this.moveToDrop=function(t,e,i){var a=this,n={title:"",text:"",executeAfterOkay:!0,show:!0,onOpen:Travian.emptyFunction,onOkay:Travian.emptyFunction,onClose:Travian.emptyFunction,relativeTo:t[0],amount:t[0].item.amount,preventFormSubmit:!0},o=!1;t[0].item.dragOrigin=null;var r=function(){if(n.executeAfterOkay){var r;if(i)r=!1;else if(!0===o){var s=jQuery("#amount");r=s.length>0?s.val():1}else r=t[0].item.amount;a.moveItem(t,e,r)}else a.resetItemDrop(t)};return!0!==i&&(t[0].item.isConsumable||"bag"===t[0].item.slot)&&(a.isClicked||e&&"bag"===e.attr("id").substr(0,3))?(this.options.useOneDialogTitleCallbacks[t[0].item.typeId]&&(n=Object.assign(n,this.options.useOneDialogTitleCallbacks[t[0].item.typeId](t[0].item,this.options,n)||{})),o=!0,""===n.title&&(n.title=t[0].item.name),""===n.text&&(t[0].item.isConsumable?1===t[0].item.amount?n.text=this.options.text.useOneDialogTitle:n.text=this.options.text.useDialogDescription:n.text=this.options.text.moveDialogDescription),n.show&&(n.onOkay=function(){return r(),!0},this.dialog(n,t))):r(),this},this.moveToMatchingPlace=function(t){if(!1===this.dragStatus){var e=jQuery("#"+(t.place===t.slot?"inventory":t.slot));this.isClicked=!0,this.moveToDrop(t.element,e,!1),this.unMark(t.slot)}else this.dragStatus=!1;return this},this.resetItemDrop=function(t){return t.css({left:0,top:0}),this},this.unMark=function(t){return jQuery("#"+t).removeClass("heroMarked"),this},this.initialize()},Travian.Game.Hero.Properties={},Travian.Game.Hero.Properties.PropertyForm=function(){this.unloadIdentifier=null,this.onDirty=function(t){var e=this.elements.saveHeroAttributes.getInput(),i=jQuery(".heroAttributesFormMessage");return t?(i.removeClass("hide"),e.removeClass("disabled")[0].disabled=!1,this.unloadIdentifier=Travian.Form.UnloadHelper.enableSecurity(this.unloadIdentifier)):(i.addClass("hide"),e.addClass("disabled")[0].disabled=!0,Travian.Form.UnloadHelper.disableSecurity(this.unloadIdentifier)),this},this.onClick=function(t){if("saveHeroAttributes"===t.getName())return this.saveHeroAttributes(),this},this.saveHeroAttributes=function(){var t={resource:this.elements.resource.getValue(),attackBehaviour:this.elements.attackBehaviour.getValue()};void 0!==this.elements.properties&&(t.attributes=this.elements.properties.getPropertyValues()),Travian.Form.UnloadHelper.disableSecurity(this.unloadIdentifier),Travian.api("hero/attributes",{data:t})},Travian.Form.call(this)},Travian.Game.Hero.Properties.PropertyForm.prototype=Object.create(Travian.Form.prototype),Travian.Game.Hero.Properties.PropertyForm.constructor=Travian.Game.Hero.Properties.PropertyForm,Travian.Game.Hero.PropertySetter=function(t,e){this.options=Object.assign({availablePoints:0,element:null,selectorBtnMinus:".pointsValueSetter.sub a",selectorBtnPlus:".pointsValueSetter.add a",elementAvailablePoints:""},e),this.getAvailablePoints=function(){return this.options.availablePoints-this.getSettedPoints()},this.getPropertyValues=function(){var t={};return jQuery.each(this.options.attributes,(function(e,i){t[i.getId()]=i.getSettedPoints()})),t},this.isDirty=function(){return this.getSettedPoints()>0},this.initialize=function(t){var e=this;Travian.Form.Element.call(this,t),jQuery.each(this.options.attributes,(function(t,i){i.setPropertySetter(e)})),this.options.element=jQuery("#"+this.options.element),this.options.elementAvailablePoints=jQuery("#"+this.options.elementAvailablePoints),this.update()},this.getSettedPoints=function(){var t=0;return jQuery.each(this.options.attributes,(function(e,i){t+=i.getSettedPoints()})),t},this.update=function(){jQuery.each(this.options.attributes,(function(t,e){e.updateButtons()}));var t=this.getAvailablePoints()+"/"+this.options.availablePoints;return this.options.elementAvailablePoints.html(t),this.onChange(),this},this.initialize(t)},Travian.Game.Hero.PropertySetter.prototype=Object.create(Travian.Form.Element.prototype),Travian.Game.Hero.PropertySetter.constructor=Travian.Game.Hero.PropertySetter,Travian.Game.Hero.PropertySetter.Attribute=function(t){this.options=Object.assign({id:null,element:null,value:null,usedPoints:null,maxPoints:null,elementBtnMinus:".pointsValueSetter.sub a",elementBtnPlus:".pointsValueSetter.add a",elementInput:".points input",elementProgressBar:".progress .bar.setted",elementValue:".current .value"},t),this.propertySetter=null,this.settedPoints=0,this.getId=function(){return this.options.id},this.getMaxPoints=function(){return this.options.maxPoints},this.getPropertySetter=function(){if(null===this.propertySetter)throw"missing propertySetter in Travian.Game.Hero.PropertySetter.Attribute";return this.propertySetter},this.getSettedPoints=function(){return this.settedPoints},this.getTotalPoints=function(){return this.settedPoints+this.options.usedPoints},this.initialize=function(){var t=this;this.options.element=jQuery("#"+this.options.element),this.options.elementBtnMinus=this.options.element.find(this.options.elementBtnMinus),this.options.elementBtnPlus=this.options.element.find(this.options.elementBtnPlus),this.options.elementInput=this.options.element.find(this.options.elementInput),this.options.elementProgressBar=this.options.element.find(this.options.elementProgressBar),this.options.elementValue=this.options.element.find(this.options.elementValue);var e=null,i=!1,a=function(e,a){return a.preventDefault(),!1===i&&t[e+"Point"](),i=!1,!1},n=function(t){return t.preventDefault(),e&&clearInterval(e),jQuery(t.target).removeClass("click"),!1},o=function(a,o){o.preventDefault(),e&&clearInterval(e),i=!0,jQuery(o.target).addClass("click");var r=jQuery(document.body);return r.off("mouseup",n),r.on("mouseup",n),t[a+"Point"](),e=setInterval(t[a+"Point"].bind(t),200),!1},r=function(i){var a=null,n=i.originalEvent.wheelDelta>0?1:-1;return i.preventDefault(),e&&clearInterval(e),t.setSettedPoints(t.getSettedPoints()+n),n>0?(a=t.options.elementBtnPlus,t.options.elementBtnMinus.removeClass("click")):(a=t.options.elementBtnMinus,t.options.elementBtnPlus.removeClass("click")),a.addClass("click"),e=setTimeout((function(){a.removeClass("click")}),100),!1};this.options.elementBtnMinus.on({click:jQuery.proxy(a,this,"sub"),mousedown:jQuery.proxy(o,this,"sub"),mousewheel:r}),this.options.elementBtnPlus.on({click:jQuery.proxy(a,this,"add"),mousedown:jQuery.proxy(o,this,"add"),mousewheel:r}),this.options.elementInput.on({change:function(e){var i=parseInt(t.options.elementInput.val());isNaN(i)&&(i=t.getTotalPoints()),t.setSettedPoints(i-t.options.usedPoints)},mousewheel:r})},this.setPropertySetter=function(t){return this.propertySetter=t,this},this.setSettedPoints=function(t){t=parseInt(t),isNaN(t)&&(t=this.settedPoints),t<0&&(t=0),t>this.getMaxPoints()-this.options.usedPoints&&(t=this.getMaxPoints()-this.options.usedPoints);var e=this.getPropertySetter().getAvailablePoints();return this.settedPoints<t&&e<t-this.settedPoints&&(t=this.settedPoints+e),this.settedPoints=t,this.update()},this.addPoint=function(t){return null!=t&&""!==t||(t=1),t<0&&(t=0),this.setSettedPoints(this.getSettedPoints()+t)},this.subPoint=function(t){return null!=t&&""!==t||(t=1),t<0&&(t=0),this.setSettedPoints(this.getSettedPoints()-t)},this.updateButtons=function(){return this.options.elementBtnPlus.toggleClass("disabled",this.getTotalPoints()>=this.getMaxPoints()||0===this.getPropertySetter().getAvailablePoints()),this.options.elementBtnMinus.toggleClass("disabled",0===this.getSettedPoints()),this},this.initialize()},Travian.Game.Hero.PropertySetter.Attribute.prototype.calculateValue=function(){return 0},Travian.Game.Hero.PropertySetter.Attribute.prototype.update=function(){return this.options.elementValue.html(this.calculateValue()),this.options.elementInput.val(this.options.usedPoints+this.getSettedPoints()),this.options.elementProgressBar.css("width",Math.max(0,Math.min(100,Math.round(100/Math.min(this.getMaxPoints()+4,100)*this.getSettedPoints())))+"%"),this.getPropertySetter().update(),this},Travian.Game.Hero.PropertySetter.Attribute.Power=function(t){this.options=Object.assign({valueOfItems:0,valueBonus:0},t),this.calculateValue=function(){return 100+this.getTotalPoints()*this.options.valueBonus+this.options.valueOfItems},Travian.Game.Hero.PropertySetter.Attribute.call(this,this.options)},Travian.Game.Hero.PropertySetter.Attribute.Power.prototype=Object.create(Travian.Game.Hero.PropertySetter.Attribute.prototype),Travian.Game.Hero.PropertySetter.Attribute.Power.constructor=Travian.Game.Hero.PropertySetter.Attribute.Power,Travian.Game.Hero.PropertySetter.Attribute.OffBonus=function(t){this.calculateValue=function(){return Math.round(.2*this.getTotalPoints()*10)/10+"%"},Travian.Game.Hero.PropertySetter.Attribute.call(this,t)},Travian.Game.Hero.PropertySetter.Attribute.OffBonus.prototype=Object.create(Travian.Game.Hero.PropertySetter.Attribute.prototype),Travian.Game.Hero.PropertySetter.Attribute.OffBonus.constructor=Travian.Game.Hero.PropertySetter.Attribute.OffBonus,Travian.Game.Hero.PropertySetter.Attribute.DefBonus=function(t){this.calculateValue=function(){return Math.round(.2*this.getTotalPoints()*10)/10+"%"},Travian.Game.Hero.PropertySetter.Attribute.call(this,t)},Travian.Game.Hero.PropertySetter.Attribute.DefBonus.prototype=Object.create(Travian.Game.Hero.PropertySetter.Attribute.prototype),Travian.Game.Hero.PropertySetter.Attribute.DefBonus.constructor=Travian.Game.Hero.PropertySetter.Attribute.DefBonus,Travian.Game.Hero.PropertySetter.Attribute.ProductionPoints=function(t){this.calculateValue=function(){return this.getTotalPoints()},this.options=Object.assign({pointWorth:[6,20,20,20,20]},t),this.elementResources=[],this.getPossibleBonusProductionForResource=function(t){return 0===t?this.calculateValue()*this.options.pointWorth[0]*Travian.Variables.Speed:t<=4?this.calculateValue()*this.options.pointWorth[t]*Travian.Variables.Speed:0},this.initialize=function(){Travian.Game.Hero.PropertySetter.Attribute.call(this,this.options);var t=this,e=jQuery("#setResource");e.length>0&&e.find("div.resource label:not(.baseCrop) span.current").each((function(e){t.elementResources[e]=this}))},this.update=function(){var t=this;return jQuery.each(this.elementResources,(function(e,i){var a=jQuery(i);a.length>0&&a.html(t.getPossibleBonusProductionForResource(e))})),Travian.Game.Hero.PropertySetter.Attribute.prototype.update.call(this)},this.initialize()},Travian.Game.Hero.PropertySetter.Attribute.ProductionPoints.prototype=Object.create(Travian.Game.Hero.PropertySetter.Attribute.prototype),Travian.Game.Hero.PropertySetter.Attribute.ProductionPoints.constructor=Travian.Game.Hero.PropertySetter.Attribute.ProductionPoints,Travian.Game.Hero.PropertySetter.Attribute.RegenBonus=function(t){this.calculateValue=function(){return Math.round(.5*this.getTotalPoints()*10)/10+"%"},Travian.Game.Hero.PropertySetter.Attribute.call(this,t)},Travian.Game.Hero.PropertySetter.Attribute.RegenBonus.prototype=Object.create(Travian.Game.Hero.PropertySetter.Attribute.prototype),Travian.Game.Hero.PropertySetter.Attribute.RegenBonus.constructor=Travian.Game.Hero.PropertySetter.Attribute.RegenBonus,Travian.Game.Activation=function(){this.activationWrapper=null,this.dynamicTitles=null,this.initialize=function(){let t=this;t.activationWrapper=jQuery(".activateWithSectors"),t.dynamicTitles=jQuery(".dynamicTitles"),t.bindEvents(),t.updateSelection()},this.bindEvents=function(){let t=this;t.activationWrapper.find(".buttonWrapper.selectTribe button").on("click",(function(e){e.preventDefault(),jQuery(this).hasClass("update")?t.changeStep("confirm"):t.changeStep("selectSector")})),t.activationWrapper.find(".buttonWrapper.selectSector button").on("click",(function(e){e.preventDefault(),t.changeStep("confirm")})),t.activationWrapper.find("a.change.backToSector").on("click",(function(e){e.preventDefault(),t.changeStep("selectSector",!0)})),t.activationWrapper.find("a.change.backToTribe").on("click",(function(e){e.preventDefault(),t.changeStep("selectTribe",!0)})),t.activationWrapper.find("input[name=vid]").on("change",(function(){t.updateSelection()})),t.activationWrapper.find("input[name=sector]").on("change",(function(){t.updateSelection()}))},this.changeStep=function(t,e){let i=this;const a=["selectTribe","selectSector","confirm"];e=void 0!==e&&e,-1!==a.indexOf(t)&&(e&&i.activationWrapper.addClass("isEditing"),jQuery(a).each((function(t,e){i.activationWrapper.removeClass(e)})),i.dynamicTitles.find(".active").removeClass("active"),i.activationWrapper.addClass(t),i.dynamicTitles.find("."+t).addClass("active"))},this.updateSelection=function(){let t=this.activationWrapper.find("form:visible"),e=t.find("input[name=vid]:checked").val();t.find(".selection.confirm .confirmTribe").removeClass("selected"),t.find(".selection.confirm .confirmTribe.tribe"+e).addClass("selected"),t.find("#map").removeClass((function(t,e){return(e.match(/(^|\s)tribe\S+/g)||[]).join(" ")})).addClass("tribe"+e);let i=t.find(".tribe"+e);t.find("#selectionIndicator").css({left:i.position().left+i.width()/2});let a=t.find("input[name=sector]:checked").val();t.find(".selection.confirm .confirmSector").removeClass("selected"),t.find(".selection.confirm .confirmSector."+a).addClass("selected")},this.initialize()},Travian.AdventureList=function(){this.openDurationsCalulator=function(){var t=jQuery("#durationCalculations");t.toggleClass("hide"),t.hasClass("hide")||this.calculateDurations()},this.calculateDurations=function(){var t=jQuery("#adventureListForm"),e=jQuery("#changeVillage").val();Travian.api("adventures/calculate-duration",{data:{adventureKids:jQuery.map(t.find("input[name*=adventureKid]"),(function(t){return t.value})),currentKidAndDid:e,originalWalkTimes:jQuery.map(t.find("input[name*=adventureWalktimeOriginalVillage]"),(function(t){return t.value}))},success:function(t){if(!1===t.noAdventures)for(var e in t.responseArray)t.responseArray.hasOwnProperty(e)&&jQuery("#"+e).html(t.responseArray[e])}})}},Travian.Game.BuildingUpgradeView={initialize:function(){jQuery("#build .buildingDescription .headline .openedClosedSwitch").on("click",(function(){var t=jQuery(this),e=jQuery("#build .buildingDescription");e.hasClass("collapsed")?(e.removeClass("collapsed"),t.removeClass("switchClosed"),t.addClass("switchOpened"),Travian.Game.Preferences.set("buildingDescriptionCollapsed",!1)):(e.addClass("collapsed"),t.addClass("switchClosed"),t.removeClass("switchOpened"),Travian.Game.Preferences.set("buildingDescriptionCollapsed",!0))}))}},Travian.Game.TrainingTroops={did:null,favouriteTroops:[],trainTroopsContainer:null,favouriteTroopsContainer:null,nonFavouriteTroopsContainer:null,isAnimating:!1,initialize:function(){var t=this;t.trainTroopsContainer=jQuery(".trainUnits"),t.favouriteTroopsContainer=jQuery("#favouriteTroops"),t.nonFavouriteTroopsContainer=jQuery("#nonFavouriteTroops"),t.did=parseInt(t.trainTroopsContainer.find("input[name=did]").val()),t.loadFavouriteTroops(),t.trainTroopsContainer.find(".troop button.favourite").on("click",(function(){if(!t.isAnimating){t.isAnimating=!0;var e=jQuery(this);e.attr("disabled","disabled");var i=e.attr("data-troopID");e.hasClass("faved")?(t.removeFromFavourites(i),e.removeClass("faved")):(t.addToFavourites(i),e.addClass("faved"))}}))},loadFavouriteTroops:function(){var t=Travian.Game.Preferences.get("favouriteTroopsInVillage"+this.did);null!==t&&(this.favouriteTroops=t.split(","))},saveFavouriteTroops:function(){Travian.Game.Preferences.set("favouriteTroopsInVillage"+this.did,this.favouriteTroops.join(","))},addToFavourites:function(t){this.favouriteTroops.push(t),this.favouriteTroops.sort(),this.trainTroopsContainer.find(".innerTroopWrapper.troop"+t).addClass("favourite"),this.orderTroopSection(t),this.saveFavouriteTroops()},removeFromFavourites:function(t){var e=this.favouriteTroops.indexOf(t);-1!==e&&this.favouriteTroops.splice(e,1),this.favouriteTroops.sort(),this.trainTroopsContainer.find(".innerTroopWrapper.troop"+t).removeClass("favourite"),this.orderTroopSection(t),this.saveFavouriteTroops()},orderTroopSection:function(t){var e,i=this,a=i.favouriteTroopsContainer.find(".action.troop"+t),n=i.nonFavouriteTroopsContainer.find(".action.troop"+t),o=a.offset(),r=n.offset(),s=i.trainTroopsContainer.find(".innerTroopWrapper.troop"+t),l=s.offset(),d=s.find("button.favourite"),u=s.parent().height();s.hasClass("favourite")?(e=Math.round(l.top-o.top+u))>u?(s.addClass("moving"),a.removeClass("empty"),n.addClass("empty"),s.animate({top:-1*e},1e3),setTimeout((function(){s.detach(),s.appendTo(a),s.animate({top:0},0),setTimeout((function(){s.removeClass("moving"),d.attr("disabled",!1),i.isAnimating=!1}),50)}),1e3)):(a.addClass("noAnimation").removeClass("empty"),n.addClass("noAnimation").addClass("empty"),s.detach(),s.appendTo(a),setTimeout((function(){a.removeClass("noAnimation"),n.removeClass("noAnimation"),d.attr("disabled",!1),i.isAnimating=!1}),50)):-1*(e=Math.round(l.top-r.top+u))>=u?(s.addClass("moving"),n.removeClass("empty"),a.addClass("empty"),s.animate({top:-1*e},1e3),setTimeout((function(){s.detach(),s.appendTo(n),s.animate({top:0},0),setTimeout((function(){s.removeClass("moving"),d.attr("disabled",!1),i.isAnimating=!1}),50)}),1e3)):(n.addClass("noAnimation").removeClass("empty"),a.addClass("noAnimation").addClass("empty"),s.detach(),s.appendTo(n),setTimeout((function(){n.removeClass("noAnimation"),a.removeClass("noAnimation"),d.attr("disabled",!1),i.isAnimating=!1}),50))}},Travian.Game.Marketplace=function(t){this.merchantsAvailable=0,this.capacityPerMerchant=0,this.merchantCapacity=0,this.merchantsMax=0,this.checksum=void 0,this.initialize=function(t){this.merchantsAvailable=Math.max(t.merchantsAvailable,0),this.capacityPerMerchant=t.capacityPerMerchant,this.merchantCapacity=this.merchantsAvailable*this.capacityPerMerchant,this.autoCompleter=t.autoCompleter,this.merchantsMax=t.merchantsMax,this.checksum=t.checksum,this.updateAutoCompleter(),this.shortcutListener()},this.refresh=function(t){this.merchantsAvailable=Math.max(t,0),this.merchantCapacity=this.merchantsAvailable*this.capacityPerMerchant,jQuery("#merchantCapacityValue").html(this.merchantCapacity),jQuery(".merchantsAvailable").html(this.merchantsAvailable),this.visualizeMerchantCapacity()},this.enableAllLinks=function(){var t;for(t=1;t<=4;t++)linkToUpdate=jQuery("#addRessourcesLink"+t),linkToUpdate.removeClass("notClickable"),linkToUpdate[0].disabled=!1},this.enableAllInputFields=function(){var t=0;for(t=1;t<5;t++)jQuery("#r"+t).removeClass("disabled"),jQuery("#r"+t)[0].readOnly=0},this.disableAllLinks=function(){var t;for(t=1;t<=4;t++)linkToUpdate=jQuery("#addRessourcesLink"+t),linkToUpdate.addClass("notClickable"),linkToUpdate[0].disabled=!0},this.disableAllInputFields=function(){var t=0;for(t=1;t<5;t++)jQuery("#r"+t).addClass("disabled"),jQuery("#r"+t)[0].readOnly=1},this.shortcutListener=function(){jQuery((function(){Travian.Game.Village.enableVillageListShortcuts(),jQuery(window).on("travian.villageList.coordinatesShortcut",(function(t,e,i,a,n){jQuery("#xCoordInput").val(e),jQuery("#yCoordInput").val(i),jQuery("#trade_route_destination").val(a),jQuery("#enterVillageName").val(n)}))}))},this.setNotice=function(t){if(t.notice&&t.formular){jQuery("#note").html(t.notice),jQuery(".destination").html(t.formular),this.enableAllLinks(),this.enableAllInputFields();var e=1;for(e=1;e<5;e++)jQuery("#r"+e).val("");t.button&&jQuery("#button").html(t.button),jQuery(".run_dropdown").removeClass("hide")}},this.setError=function(t){t.errorMessage&&(jQuery("#prepareError").html(t.errorMessage),jQuery("#note").html(""))},this.sendRessources=function(){const t=this;Travian.api("marketplace/prepare",{data:{action:Travian.Constants.ACTION.tradeRoute,checksum:this.checksum,kid:jQuery("#kid").val(),x2:jQuery("#x2").length?jQuery("#x2").first().val():1,r1:jQuery("#r1").val(),r2:jQuery("#r2").val(),r3:jQuery("#r3").val(),r4:jQuery("#r4").val()},success:function(e){e.errorMessage?(jQuery("#prepareError").addClass("fullWidth"),t.setError(e)):e.notice&&(jQuery(".run_dropdown").removeClass("hide"),jQuery("div .destination").html(e.formular),t.setNotice(e),t.reloadMarketPlace(),Travian.Game.Layout.updateResources(),t.updateAutoCompleter())}})},this.prepare=function(){var t=this,e=1;if(jQuery("#x2").length){var i=jQuery("#x2").first();e="checkbox"==i.attr("type")?i[0].checked?2:1:i.val()}Travian.api("marketplace/prepare",{data:{r1:jQuery("#r1").val(),r2:jQuery("#r2").val(),r3:jQuery("#r3").val(),r4:jQuery("#r4").val(),dname:jQuery("#enterVillageName").val(),x:jQuery("#xCoordInput").val(),y:jQuery("#yCoordInput").val(),x2:e},success:function(e){return e.errorMessage?t.setError(e):e.formular&&(t.disableAllLinks(),t.disableAllInputFields(),jQuery(".destination").html(e.formular),jQuery(".run_dropdown").addClass("hide"),jQuery("#prepareError").html(""),jQuery("#note").html(""),jQuery("#r1").focus()),e.button&&jQuery("#button").html('<div id="prepareError" class="error">'+jQuery("#prepareError").html()+"</div>"+e.button+'<div class="clear"></div>'),!1}})},this.goBack=function(){var t=this;this.enableAllLinks(),this.enableAllInputFields(),Travian.api("marketplace/back",{data:{kid:jQuery("#kid").val(),x2:jQuery("#x2").length?jQuery("#x2").first().val():1,dname:jQuery("#dname")?jQuery("#dname").val():""},success:function(e){jQuery(".destination").html(e.formular),jQuery("#button").html('<div id="prepareError" class="error"></div>'+e.button+'<div class="clear"></div>'),jQuery(".run_dropdown").removeClass("hide"),t.updateAutoCompleter()}})},this.reloadMarketPlace=function(){var t=this;Travian.api("marketplace/reload",{data:{},success:function(e){jQuery("#merchantsOnTheWayFormular").html(e.merchantsOnTheWay),Travian.Game.Layout.updateResources(),t.refresh(e.merchantsAvailable)}})},this.visualizeMerchantCapacity=function(){this.merchantCapacity=this.merchantsAvailable*this.capacityPerMerchant;var t=this.summarizeInput();this.setSelectedRessourcesInfo(t),this.setNotEnoughMerchantsError(t),this.updateLinks()},this.validateAndVisualizeMerchantCapacity=function(t){this.validateResources(t),this.visualizeMerchantCapacity()},this.validateResources=function(t){var e=this.getValue(t),i=e+this.clipToStorageMaximum(t,e),a=e;e>i&&(a=i),this.setValue(t,a)},this.validateTradeRouteResources=function(t){var e=Math.max(0,this.getValue(t));this.setValue(t,e);var i=this.summarizeInput(),a=this.merchantsMax*this.capacityPerMerchant,n={},o=jQuery("#tradeSaveButton"),r=jQuery("#tradeRouteError");i>a?(n={MERCHANTS_NEEDED:Math.ceil(i/this.capacityPerMerchant),MERCHANTS_AVAILABLE:this.merchantsMax},r.addClass("error").html(Travian.Helpers.substitute(Travian.Translation.translate("{notEnoughMerchants}"),n,/\\?\[([^\[\]]+)\]/g)),o.addClass("disabled").attr("disabled",!0)):(r.removeClass("error").html(""),o.removeClass("disabled").attr("disabled",!1))},this.validateTradeRouteResourcesSanity=function(){for(var t=1;t<=4;t++){var e=Math.max(0,this.getValue(t));this.setValue(t,e)}return 0!=this.summarizeInput()||(jQuery("#tradeRouteError").addClass("error").html(Travian.Translation.translate("{resourcesNumberInvalid}")),!1)},this.validateTradeRouteSendTime=function(){var t=jQuery("#tradeSaveButton"),e=jQuery("#tradeRouteError");return this.validateTradeRouteSendTimeSanity()?(e.removeClass("error").html(""),t.removeClass("disabled").attr("disabled",!1),!0):(e.addClass("error").html(Travian.Translation.translate("{invalidTimeFormat}")),t.addClass("disabled").attr("disabled",!0),!1)},this.validateTradeRouteSendTimeSanity=function(){var t=jQuery("#tradeRouteEdit").find(".timeSelector"),e=jQuery("#tradeRouteError"),i=t.find("input[name=hour]"),a=t.find("input[name=minute]");i=i.val(),a=a.val();var n=jQuery.isNumeric(i)&&i>=0&&i<=23&&(""===a||jQuery.isNumeric(a)&&a>=0&&a<=59);return!n&&e.addClass("error").html(Travian.Translation.translate("{invalidTimeFormat}")),n},this.furtherMerchantsAvailable=function(){return this.merchantCapacity-this.summarizeInput()>=0},this.updateLinks=function(){var t;for(t=1;t<=4;t++)jQuery("#addRessourcesLink"+t).toggleClass("notClickable",0==this.getValueToAddToRessources(t))},this.addRessources=function(t){if(!jQuery("#addRessourcesLink"+t)[0].disabled){var e=this.getValueToAddToRessources(t),i=this.getValue(t);0!=e&&this.setValue(t,e+i),this.visualizeMerchantCapacity()}},this.getValueToAddToRessources=function(t){var e=0,i=this.summarizeInput(),a=this.merchantCapacity-i;return a>0?a<this.capacityPerMerchant?e=a:a>=this.capacityPerMerchant&&(e=this.capacityPerMerchant):e=0==a?0:a,e=this.clipToStorageMaximum(t,e)},this.clipToStorageMaximum=function(t,e){var i=this.getStorageFor(t),a=this.getValue(t);return e>0?e=Math.min(e,i-a):a+e>i&&(e=i-a),e},this.getStorageFor=function(t){var e="l"+t;return window.resources.storage[e]},this.setValue=function(t,e){var i=parseInt(e);isNaN(i)||jQuery("#r"+t).val(Math.max(i,0))},this.setSelectedRessourcesInfo=function(t){jQuery("#sumResources").toggleClass("notEnoughMerchants",t>this.merchantCapacity).html(t)},this.setNotEnoughMerchantsError=function(t){var e={},i=this.getNeededMerchants(t),a=jQuery("#prepareError"),n=null;if(jQuery("#merchantsNeededNumber").html(i),jQuery(".prepare").length>0&&(n=jQuery(".prepare").first()),i>this.merchantsAvailable)e={MERCHANTS_NEEDED:i,MERCHANTS_AVAILABLE:this.merchantsAvailable},a.addClass("error").html(Travian.Helpers.substitute(Travian.Translation.translate("{notEnoughMerchants}"),e,/\\?\[([^\[\]]+)\]/g)),n.addClass("disabled").attr("disabled",!0),jQuery("#note").html(""),jQuery("#merchantsNeeded").addClass("error"),jQuery(".merchantCapacity").addClass("error"),jQuery("#sumResources").addClass("error");else{if(jQuery("#merchantsNeeded").removeClass("error"),jQuery(".merchantCapacity").removeClass("error"),jQuery("#sumResources").removeClass("error"),a.length>0)a.html("");else{var o=jQuery("#button").html();jQuery("#button").html('<div id="prepareError" class="error"></div>'+o+'<div class="clear"></div>')}n.removeClass("disabled").attr("disabled",!1)}},this.getNeededMerchants=function(t){return Math.ceil(t/this.capacityPerMerchant)},this.getValue=function(t){var e=parseInt(jQuery("#r"+t).val());return isNaN(e)?0:e},this.summarizeInput=function(){for(var t=0,e=1;e<=4;e++)t+=this.getValue(e);return t},this.updateAutoCompleter=function(){var t=jQuery("#enterVillageName");return this.autoCompleter&&t.length>0&&Travian.Game.AutoCompleter.VillageName(t),this},this.initialize(t)},Travian.Game.Marketplace.getPreferences=function(){var t,e,i=Travian.Game.Preferences.get("tradeRoutesOrder");return null!=i?(t=i.charAt(0),e=i.charAt(1)):(t="2",e="a"),{sortingColumn:t,sortingOrder:e}},Travian.Game.Marketplace.toggleSorting=function(t){var e,i=Travian.Game.Marketplace.getPreferences();e=t==i.sortingColumn?i.sortingColumn+("a"==i.sortingOrder?"d":"a"):t+"a",Travian.Game.Preferences.set("tradeRoutesOrder",e)},Travian.Game.Marketplace.toggleTradeRoutes=function(t,e){return Travian.api("trade-routes/"+t,{data:{action:Travian.Constants.ACTION.tradeRoute,enabled:e.checked}},"PUT"),!1},Travian.Game.Marketplace.updateVillageListLinks=function(t){const e=["dname","x","y"],i=jQuery(t).serializeArray().filter((function(t){return e.includes(t.name)})).reduce((function(t,e){return t[e.name]=e.value,t}),{});Travian.Game.VillageList.update(i)},Travian.Game.Marketplace.onLoad=function(){var t=Travian.Game.Marketplace.getPreferences();jQuery("a.sorting#sorting"+t.sortingColumn).addClass("a"==t.sortingOrder?"asc":"desc")},Travian.Game.Marketplace.constructor=Travian.Game.Marketplace,Travian.Game.Marketplace.ExchangeResources=function(t){var e=t;this.calculateRest=function(){var t=e.find('span[id^="org"]'),i=e.find("span#sum").html(),a=e.find('input[name^="desired"]'),n=e.find('span[id^="diff"]'),o=0;a.each((function(e,i){var a=parseInt(i.value||0),r=a-parseInt(t[e].innerHTML);n[e].innerHTML=r>0?"+"+r:r,o+=a})),jQuery("#newsum").text(o),jQuery("#remain").text(i-o),this.testSum()},this.fillup=function(t){jQuery('input[name="desired'+t+'"]').val(resources.maxStorage["l"+(t+1)]||0),this.calculateRest()},this.adjustButtonDisableState=function(){jQuery(".disableButtonHandler").each((function(t,e){"none"===(e=jQuery(e)).css("display")||"hidden"===e.css("visibility")?e.find("button").each((function(t,e){var i=void 0===(e=jQuery(e)).attr("olddisabled")?"true"===e.attr("disabled"):"false"!==e.attr("olddisabled");e.attr("olddisabled",i).attr("disabled",!0)})):e.find("button").each((function(t,e){var i=(e=jQuery(e)).attr("olddisabled");void 0!==i?e.attr("disabled","false"!==i):e.attr("disabled",!1)}))}))},this.testSum=function(){"0"!==document.getElementById("remain").innerHTML?(document.getElementById("submitText").style.display="block",document.getElementById("submitButton").style.display="none"):(document.getElementById("submitText").style.display="none",document.getElementById("submitButton").style.display="block"),this.adjustButtonDisableState()},this.distribute=function(t){var i=[],a=e.find('span[id^="org"]'),n=e.find('input[name^="desired"]'),o=e.find("span#sum");n.each((function(t,e){i[t]=e.value}));var r=this;return Travian.api("marketplace/exchange-resources",{data:{did:t,desired:i},success:function(t){n.each((function(e,i){a[e].innerHTML=t.resources[e],i.value=t.distributed[e]})),o.html(t.resources.reduce((function(t,e){return t+e}),0)),r.calculateRest()},error:function(t){(new Travian.Dialog.Dialog).setContent(t.message).show()}}),!1},this.calculateRest()},Travian.Game.RallyPoint={},Travian.Game.RallyPoint.initialize=function(t){t.find("input[type=text]").each((function(t,e){(e=jQuery(e)).on({keydown:function(t){const e=t.keyCode,i=t.ctrlKey,a=t.metaKey;if(8===e||46===e||65===e&&(!0===i||!0===a)||67===e&&(!0===i||!0===a)||88===e&&(!0===i||!0===a)||86===e&&(!0===i||!0===a)||e>=35&&e<=39||9===e||13===e)return!0;e>=48&&e<=57||e>=96&&e<=105||t.preventDefault()},input:function(t){let i=parseInt(e.val().replace(/^0+/,""))||0;(isNaN(i)||0===i||i<0)&&(i=""),e.val(i)}})})),Travian.Game.Village.enableVillageListShortcuts(),jQuery(window).on("travian.villageList.coordinatesShortcut",(function(t,e,i,a,n){jQuery("#xCoordInput").val(e),jQuery("#yCoordInput").val(i),jQuery("#enterVillageName").val(n)}))},Travian.Game.RallyPoint.updateTravelTime=function(t,e,i,a){const n=jQuery(a).closest("form"),o=n.find("div#in");if(0===o.length)return;const r={};n.find("td.unit input").each((function(t,e){let i=parseInt(e.value)||0;const a=e.name.match(/troop\[t(\d+)\]/);r["t"+a[1]]=Math.max(0,i)})),Travian.api("troop/distanceSpeedAndDuration",{data:{origin:parseInt(t),from:parseInt(e),to:parseInt(i),troops:r},success:function(t){const e=t.data;o.html(e.durationString);const i=n.find("span#at");Travian.TimersAndCounters.updateTimer(i.get(0),Travian.TimersAndCounters.getTimeByDurationAndOffset(e.duration))}})},Travian.AttackSymbol={markAttackSymbol:function(t){var e=jQuery("img#markSymbol_"+t),i=e.prop("class"),a=parseInt(i.replace(/[^0-9]/gi,""))||0;a=(a+1)%4,e.removeClass().addClass("markAttack markAttack"+a),Travian.api("troop/"+t+"/mark",{data:{state:a},success:function(t){const e=jQuery("#sidebarBoxVillagelist").find(".listEntry.active");t.incomingAttacks>0?e.addClass("attack"):e.removeClass("attack"),Travian.Game.VillageList.updateIncomingTroopsTooltips()}})}},Travian.Game.RallyPoint.CoordinatesInputHelper=function(t){this.options=Object.assign({coordinateXInputId:"xCoordInput",coordinateYInputId:"yCoordInput",allowedPattern:/^([0-9\-.,]+)([|/])([0-9\-.,]+)$/},t)},Travian.Game.RallyPoint.CoordinatesInputHelper.prototype.insertCoordinates=function(t){let e;e=void 0!==t.clipboardData?t.clipboardData.getData("text/plain"):window.clipboardData.getData("Text"),e=e.replace(/[\u202D\u202C\u202E]/g,"").replace(/âˆ’/g,"-").replace(/[^0-9\-|/]/g,"");let i=e.match(this.options.allowedPattern);t.preventDefault(),null!==i?(jQuery("#"+this.options.coordinateXInputId).val(i[1]).trigger("change"),jQuery("#"+this.options.coordinateYInputId).val(i[3]).trigger("change").focus()):jQuery(t.target).val(e.replace(/[^0-9\-]/g,""))},Travian.Game.RallyPoint.BulkTroopAction={cropConsumptionPerUnit:{},troopsTotal:0,preparedUnits:{},from:null,destinationInput:{name:null,x:null,y:null},init:function(t){let e;if(Travian.WindowManager.closeByContext("bulkTroopAction"),jQuery.expr[":"].emptyValue=function(t){return""===t.value},e=".troop_details.bulkForwardable",e.length>0){const i=jQuery(e),a=jQuery(".bulkTroopActionContainer"),n=jQuery(".rallyPointOverviewContainer");if(i.length>0){Travian.TimersAndCounters.suppressReloadEvent();let e=jQuery("#content .bulkTroopActionTemplate."+t).clone(),o=1;i.each((function(t,i){const a=(i=jQuery(i)).find("thead td.role a").html(),n=i.find("th.coords").html(),r=i.data("vid"),s=i.data("did"),l=i.data("ort"),d=i.data("player-name"),u={};for(let t=1;t<=11;t++){const e=parseInt(i.find("tbody.units td.unit")[t-1].innerHTML),a=i.find("td.uniticon.t"+t+" img.unit");a.attr("title",a.attr("alt")),e>0&&(u["t"+t]={type:"t"+t===Travian.Constants.TROOP_NUMBER_TYPES.hero?"hero":a[0].className.match(/\b(u\d)\S*/)[0],icon:a.clone()[0],amount:e})}const c=jQuery("<tr></tr>"),p=jQuery("<td></td>").addClass("checkbox"),h=jQuery("<div></div>").addClass("allTroops"),m=jQuery("<td></td>").addClass("source"),v=jQuery("<div></div>").addClass("contentWrapper"),f=jQuery("<label></label>").attr("for","select"+o).html(d+" | "+a+" "+n);v.append(f).append(h),m.append(v);const g=Object.keys(u);for(let t=0;t<g.length;t++){const e=jQuery("<div></div>").addClass("unitWrapper"),i=jQuery("<input />").attr("inputmode","numeric").addClass("text").attr("type","text").attr("maxlength",6).attr("name","troop["+g[t]+"]").attr("data-max",u[g[t]].amount).attr("data-type",g[t]).attr("data-vid",r).attr("data-did",s).attr("data-ort",l).attr("data-village-name",a).attr("data-player-name",d).attr("data-coordinates",n).on("change",(function(){const t=jQuery(this);let e=t.val();if(parseInt(e)<=0||isNaN(e)?t.val(""):parseInt(e)>parseInt(t.data("max"))&&t.val(t.data("max")),e=t.val(),""===e||isNaN(e)){const e=t.parents("td").find("input");t.parents("td").find("input:emptyValue").length===e.length&&t.parents("tr").find("td.checkbox input").prop("checked",!1)}else t.parents("tr").find("td.checkbox input:not(:checked)").prop("checked",!0);Travian.Game.RallyPoint.BulkTroopAction.updateTroopSummary()})),o=jQuery("<a></a>").attr("href","#").append(Travian.i18n.Number(u[g[t]].amount)).on("click",(function(){return jQuery(this).parent(".unitWrapper").find("input").val(u[g[t]].amount).trigger("change"),!1}));e.append(u[g[t]].icon).append(i).append("<span>/</span>").append(o),h.append(e)}const y=jQuery("<input />").attr("type","checkbox").attr("name","select"+o).attr("id","select"+o).on("change",(function(){const t=jQuery(this).is(":checked"),e=jQuery(this).parents("tr").find(".unitWrapper input");if(t){let t=!1;e.each((function(e,i){const a=(i=jQuery(i)).val();if(t=""!==a&&!isNaN(a),t)return!1})),t||e.each((function(t,e){(e=jQuery(e)).val(e.data("max"))}))}Travian.Game.RallyPoint.BulkTroopAction.updateTroopSummary()}));p.append(y),c.append(p).append(m),e.find(".step1 .bulkTroopActionTable tbody").append(c),o++})),e.removeClass("hide"),a.empty().append(e).removeClass("hide"),n.addClass("hide"),Travian.Tip.updateAllInElement(a),Travian.Game.Layout.MobileOptimizations.fixNumericKeyboardOnIOS(),Travian.Game.AutoCompleter.VillageName(jQuery("#enterVillageName")),a.find(".destination input").on("change",Travian.Game.RallyPoint.BulkTroopAction.updateContinueButton),Travian.Game.Village.enableVillageListShortcuts(),jQuery(window).on("travian.villageList.coordinatesShortcut",(function(t,e,i,a,n){jQuery("#xCoordInput").val(e).trigger("change"),jQuery("#yCoordInput").val(i).trigger("change"),jQuery("#enterVillageName").val(n).trigger("change")})),a.find("#bulkTroopActionMarkAll").on("change",(function(){const t=jQuery(this);t.parents("table").find("tbody input[type=checkbox]").prop("checked",t.is(":checked")).trigger("change")})),e.find("input").on("keyup",(function(t){"Enter"===t.key&&(t.preventDefault(),e.find("button.continue:not(.disabled):visible").trigger("click"))}))}}},updateTroopSummary:function(){Travian.Game.RallyPoint.BulkTroopAction.prepareTroops();const t=Travian.Game.RallyPoint.BulkTroopAction.preparedUnits,e=Object.keys(t),i=jQuery(".bulkTroopActionContainer .bulkTroopActionSummary");i.find(".troopSelection").find(".tribeRow, .troopSelectionUnit").addClass("hide");let a=0,n=0,o={};for(let i=0;i<e.length;i++){const r=t[e[i]].troops,s=parseInt(t[e[i]].vid),l=Object.keys(r);for(let t=0;t<l.length;t++){n+=r[l[t]].amount;const e=parseInt(l[t].split("t")[1]),i="u"+("t"+e===Travian.Constants.TROOP_NUMBER_TYPES.hero?"hero":10*(s-1)+e);void 0===o[s]&&(o[s]={}),void 0===o[s][i]?o[s][i]=r[l[t]].amount:o[s][i]+=r[l[t]].amount,a+=r[l[t]].supply}}Travian.Game.RallyPoint.BulkTroopAction.troopsTotal=n;const r=i.find(".equals span"),s=i.find("tr.supply");i.find(".selectedCount").html(Travian.Translation.translate("{raidList.selected}").replace("[COUNT]",n)),n>0?(r.removeClass("hide"),s.removeClass("hide")):(r.addClass("hide"),s.addClass("hide")),i.find(".troopSelection .tribeRow").each((function(t,e){e=jQuery(e);const i=parseInt(e.data("tribe"));let a=!1;void 0!==o[i]&&(Object.keys(o[i]).forEach((function(t){const n=e.find(".troopSelectionUnit[data-unit="+t+"]");n.length>0&&(n.find("span").html(o[i][t]),n.removeClass("hide"),a=!0)})),a&&e.removeClass("hide"))})),i.find(".supplyWrapper .value").html(a),Travian.Game.RallyPoint.BulkTroopAction.updateContinueButton()},prepareTroops:function(){Travian.Game.RallyPoint.BulkTroopAction.preparedUnits={};const t=Travian.Game.RallyPoint.BulkTroopAction.cropConsumptionPerUnit;jQuery(".bulkTroopActionContainer .bulkTroopActionTable").find("tbody tr").each((function(e,i){if(!(i=jQuery(i)).find("td.checkbox input[type=checkbox]").is(":checked"))return;i.find(".unitWrapper input").each((function(e,i){let a=(i=jQuery(i)).val();if(""!==a&&!isNaN(a)){a=parseInt(a);const e=i.data("did"),n=i.data("ort"),o=i.data("vid"),r=i.data("type"),s=i.data("village-name"),l=i.data("player-name"),d=i.data("coordinates");void 0===Travian.Game.RallyPoint.BulkTroopAction.preparedUnits[e]&&(Travian.Game.RallyPoint.BulkTroopAction.preparedUnits[e]={villageId:n,troopVillageId:e,villageName:s,playerName:l,vid:o,coordinates:d,troops:{}}),Travian.Game.RallyPoint.BulkTroopAction.preparedUnits[e].troops[r]={amount:a,supply:t["vid"+o][r]*a}}}))}))},setTarget:function(){const t=jQuery(".bulkTroopActionContainer .destination");let e=t.find("input[name=villagename]").val(),i=t.find("input[name=x]").val(),a=t.find("input[name=y]").val();Travian.Game.RallyPoint.BulkTroopAction.destinationInput.name=""!==e?e:null,Travian.Game.RallyPoint.BulkTroopAction.destinationInput.x=""!==i?parseInt(i):null,Travian.Game.RallyPoint.BulkTroopAction.destinationInput.y=""!==a?parseInt(a):null},hasTarget:function(){Travian.Game.RallyPoint.BulkTroopAction.setTarget();const t=Travian.Game.RallyPoint.BulkTroopAction.destinationInput;return null!==t.name||null!==t.x&&null!==t.y},setFrom:function(t){Travian.Game.RallyPoint.BulkTroopAction.from=t},updateContinueButton:function(){const t=jQuery(".bulkTroopActionContainer button.continue");Travian.Game.RallyPoint.BulkTroopAction.troopsTotal<=0||!Travian.Game.RallyPoint.BulkTroopAction.hasTarget()?t.addClass("disabled"):t.removeClass("disabled")},goToStep:function(t,e){const i=jQuery(".bulkTroopActionContainer .bulkTroopActionTemplate");if(2===e){const a=new Travian.Game.TwoStepAction("troop/send",Object.assign(Travian.Game.RallyPoint.BulkTroopAction.normalizeTroopsForBackend(),{eventType:Travian.Constants.EVENT_TYPES[i.data("type")],target:Travian.Game.RallyPoint.BulkTroopAction.destinationInput,action:Travian.Constants.ACTION.troopsSend}));a.sign((function(n){const o=i.find(".step2 #short_info"),r=jQuery("<a></a>").attr("href","/karte.php?x="+n.target.coordinates.x+"&y="+n.target.coordinates.y).html("("+n.target.coordinates.x+"|"+n.target.coordinates.y+")");o.find("td.coordinates").html(n.target.name+" ").append(r);const s=jQuery("<a></a>").attr("href","/profile/"+n.targetPlayer.id).html(n.targetPlayer.name);o.find("td.destinationOwner").empty().append(s);const l=i.find(".step2 .bulkTroopActionTable");l.find("tbody").empty();const d=Travian.Game.RallyPoint.BulkTroopAction.preparedUnits,u=Object.keys(d);for(let t=0;t<u.length;t++){const e=d[u[t]],a=e.troops,o=parseInt(e.vid),r=jQuery("<tr></tr>"),s=jQuery("<div></div>").addClass("arrival"),c=jQuery("<td></td>").attr("colspan",2).addClass("source"),p=jQuery("<div></div>").addClass("contentWrapper"),h=jQuery("<div></div>").addClass("source").html(e.playerName+" | "+e.villageName+" "+e.coordinates),m=jQuery("<tr></tr>"),v=jQuery("<tr></tr>"),f=jQuery("<tbody></tbody>").addClass("units").append(m),g=jQuery("<tbody></tbody>").addClass("units").append(v),y=jQuery("<table></table>").addClass("troops").append(f).append(g);p.append(h).append(s).append(y),c.append(p),i.find(".step2 .tribeRow[data-tribe="+o+"] img.unit").each((function(t,e){const i=jQuery("<td></td>");i.append(jQuery(e).clone()),m.append(i);let n=0;void 0!==a["t"+(t+1)]&&(n=a["t"+(t+1)].amount);const o=jQuery("<td></td>").html(n);v.append(o)}));const T=Travian.TimersAndCounters.intToTime(n.troops[t].arrivalIn),b=jQuery("<span></span>").html(Travian.Translation.translate("{a2b.in}")+" "+T.time),C=Travian.TimersAndCounters.intToTime(Travian.TimersAndCounters.getTimeByDurationAndOffset(n.troops[t].arrivalIn)),w=jQuery("<span></span>").addClass("timer").attr("counting","up").attr("value",n.troops[t].timeArrive).html(C.time),x=jQuery("<span></span>").html(Travian.Translation.translate("{a2b.um}")+" ").append(w);s.append(b).append(" ").append(x),r.append(c),l.find("tbody.movements").append(r)}i.find(".step2 button.edit").off("click").on("click",(function(){Travian.Game.RallyPoint.BulkTroopAction.goToStep(e,1)})),i.find(".step2 button.confirm").removeClass("disabled").off("click").on("click",(function(){const t=jQuery(this);t.hasClass("disabled")||(t.addClass("disabled"),a.execute(Travian.Autoreload.autoreload,Travian.Game.RallyPoint.BulkTroopAction.onError))})),Travian.Game.RallyPoint.BulkTroopAction.toggleStepClass(t,e),Travian.TimersAndCounters.initTimersInContext(i[0])}),Travian.Game.RallyPoint.BulkTroopAction.onError)}else i.find(".step1").addClass("preventAnimation"),Travian.Game.RallyPoint.BulkTroopAction.toggleStepClass(t,e)},toggleStepClass:function(t,e){jQuery(".bulkTroopActionContainer .bulkTroopActionTemplate").removeClass("step"+t).addClass("step"+e)},normalizeTroopsForBackend:function(){const t=Travian.Game.RallyPoint.BulkTroopAction.preparedUnits,e={troops:[]},i=Object.keys(t);for(let a=0;a<i.length;a++){const n=t[i[a]],o={};for(let t=1;t<=11;t++)void 0!==n.troops["t"+t]&&(o["t"+t]=n.troops["t"+t].amount);const r=Object.assign({},{villageId:n.troopVillageId},o);e.troops.push(r)}return e},onError:function(t){new Travian.Dialog.Dialog({preventFormSubmit:!0}).setContent(t.message).show()},backToOverview:function(){jQuery(".bulkTroopActionContainer").empty().addClass("hide"),jQuery(".rallyPointOverviewContainer").removeClass("hide"),Travian.TimersAndCounters.enableReloadEvent(),Travian.Game.Village.disableVillageListShortcuts(),Travian.Game.RallyPoint.BulkTroopAction.preparedUnits={},Travian.Game.RallyPoint.BulkTroopAction.troopsTotal=0}},Travian.Game.AllianceMembers=function(t){this.options=Object.assign({data:{}},t),this.initialize=function(){Travian.Dialog.Ajax.call(this,"alliance/player-note",this.options)},this.request=function(){var t=this;return Travian.api("alliance/player-note",{data:this.options.data,success:function(e){e.close||""===e.html?(t.close(),Travian.WindowManager.closeAllWindows(),Travian.Autoreload.autoreload()):(t.setContent(e.html).setTitle(e.title).setInfoIcon(e.infoIcon).updateCssClass(e.cssClass),t.show())},error:function(t,e){jQuery("#playerNotePopupError").innerHTML=e}}),this},this.reload=function(){this.request()},this.initialize()},Travian.Game.AllianceMembers.prototype=Object.create(Travian.Dialog.Ajax.prototype),Travian.Game.AllianceMembers.constructor=Travian.Game.AllianceMembers,Travian.Game.AllianceDonation={dialog:null,bonusSelected:!1,getDonationParams:function(t){return this.calculateSum(t),{bid:jQuery("#bid").val(),did:jQuery("#did").val(),r1:jQuery("#"+t+"1").val(),r2:jQuery("#"+t+"2").val(),r3:jQuery("#"+t+"3").val(),r4:jQuery("#"+t+"4").val(),amount:this.toNaturalNumber(jQuery("#"+t+"Sum").html())}},wasGoldUsed:function(t){return-1!==["donate_gold","donate_gold_confirm"].indexOf(t)},calculateSum:function(t){for(var e=0,i=1;i<=4;i++)e+=this.toNaturalNumber(jQuery("#"+t+i).val());jQuery("#"+t+"Sum").html(e.toString()),this.checkAndChangeScalingPopup(t,e),this.checkButtonState(t)},updateBID:function(t){jQuery("#bid").val(t)},checkButtonState:function(t){for(var e=0!=jQuery("#"+t+"Sum").html(),i=!1,a=document.getElementsByName("bonus"),n=0;n<a.length;n++)if(a[n].checked){i=!0,jQuery("#bonusNotSelectedMessage").hide(),this.updateBID(jQuery(a[n]).val());break}var o=1==jQuery("#limitReached").val(),r=e&&i&&!o;if(i||this.updateBID(null),this.bonusSelected=i,1==jQuery("#gold").val()){var s=0!=jQuery("#canTriple").val();r&&s?jQuery("#donate_gold").removeClass("disabled"):jQuery("#donate_gold").addClass("disabled")}r?jQuery("#donate_green").removeClass("disabled"):jQuery("#donate_green").addClass("disabled")},fillUp:function(t,e,i){!0!==t.disabled&&(e=Math.max(e,0),jQuery(t).val(e),this.checkAndChange(t,e,i))},checkAndChange:function(t,e,i){t=jQuery(t);var a=Math.min(this.toNaturalNumber(t.val()),e);t.val()!==a.toString()&&t.val(a),this.calculateSum(i)},toNaturalNumber:function(t){return t=parseInt(t),isNaN(t)&&(t=0),t<0&&(t=0),t},donate:function(t,e,i){var a=jQuery("#donate_gold_confirm");if("donate_gold"!==e&&(jQuery("#contributeButtons").find("button").addClass("disabled"),a.length>0)){if(a.hasClass("disabled"))return;a.off("click").addClass("disabled")}jQuery(".bonus-donation-response").removeClass("visible"),Travian.api("alliance/bonus-donation",{data:{params:i,action:e},success:function(t){""!==t.html?Travian.Game.AllianceDonation.showDialog(t.html,t.dialogContext):Travian.Game.AllianceDonation.closeDialog();var a=Travian.Game.AllianceDonation.wasGoldUsed(e),n=Travian.Game.AllianceDonation.getResourceAnimationSpeed(i.amount,a);t.newTotal>0&&(Travian.Game.AllianceDonation.refreshDailyDonation(t.newTotal,e,i.amount,a),Travian.Game.AllianceDonation.refreshProgressBarTitle(t.limit-t.newTotal)),!0===t.reloadAjax&&(Travian.Game.AllianceDonation.countDownResources(i.amount,!1),setTimeout((function(){Travian.Game.AllianceDonation.refreshDonationForm(t.limitReached),jQuery(".bonus-donation-response").html(t.responseText),Travian.Game.AllianceDonation.refreshAllianceBonusOverview()}),n)),!0===t.goldChanged&&Travian.Game.Layout.updateGold(),!0===t.resourcesChanged&&Travian.Game.Layout.updateResources()},error:function(t){return Travian.Game.AllianceDonation.checkButtonState("donate"),Travian.Game.AllianceDonation.showErrorDialog(t.message),!1}})},closeDialog:function(){null!==this.dialog&&this.dialog.close()},showDialog:function(t,e){let i=this;this.closeDialog(),void 0===e&&(e=""),this.dialog=new Travian.Dialog.Dialog({context:e,buttonOk:!1,onClose:function(){i.checkButtonState("donate")}}),this.dialog.setContent(t),this.dialog.show()},showErrorDialog:function(t){var e=this,i=new Travian.Dialog.Dialog({buttonOk:!0,onClose:function(){e.closeDialog(),e.refreshDonationForm(!0),e.refreshDonationLimitBar(),e.refreshAllianceBonusOverview()}});i.setContent(t),i.show()},showScaleDown:function(t){var e=document.getElementById(t).innerHTML;this.showDialog(e,"allianceDonationScaleDown"),this.scaleDown("scale")},scaleDown:function(t){var e=parseInt(jQuery("#leftResources").val()),i=parseInt(jQuery("#multiplicationFactor").val());e=parseInt(e/i);for(var a=0,n=new Array(5),o=new Array(5),r=1;r<=4;r++)o[r]=this.toNaturalNumber(jQuery("#"+t+r).val()),n[r]=o[r],a+=n[r];0===a&&this.closeDialog(),e>=a&&this.closeDialog();var s=e/a;for(a=0,r=1;r<=4;r++)n[r]>0&&(n[r]=Math.floor(n[r]*s),a+=n[r]);for(var l=e-a;l>0;)for(r=1;r<=4&&l>0;r++)o[r]>0&&(n[r]++,l--);for(r=1;r<=4;r++)jQuery("#"+t+r).val(n[r]),jQuery("#donate"+r).val(n[r]);jQuery("#"+t+"Sum").html(e.toString()),jQuery("#donateSum").html(e.toString()),this.checkAndChangeScalingPopup(t,e),setTimeout((function(){Travian.Game.AllianceDonation.changeScaleButton(!0)}),250)},checkAndChangeScalingPopup:function(t,e){var i=jQuery("#"+t+"SumMultiplied"),a=e;if(i.length>0&&(a=this.toNaturalNumber(i[0].dataset.multiplicator)*e,i.html(a.toString())),"scale"===t){var n=this.toNaturalNumber(jQuery("#resourcesUntilLimit")[0].dataset.limit);this.changeScaleButton(n>=a)}},changeScaleButton:function(t){t?(jQuery("#buttonScale").hide(),jQuery("#scale").addClass("disabled"),jQuery(".bonus-scaleDown").addClass("scaled"),jQuery("#buttonDonate").show()):(jQuery("#buttonDonate").hide(),jQuery("#scale").removeClass("disabled"),jQuery(".bonus-scaleDown").removeClass("scaled"),jQuery("#buttonScale").show())},donateScaled:function(t,e){var i=this.getDonationParams(e);this.closeDialog(),this.donate(e,t.id,i)},refreshGoldConfirmation:function(){var t=jQuery("#donate_gold");t.addClass("disabled");var e=Travian.Game.AllianceDonation.getDonationParams("donate");Travian.Game.AllianceDonation.donate("donate",t.id,e)},refreshDonationForm:function(t){var e=jQuery("#contributionForm"),i=this;e&&(setTimeout((function(){jQuery("#contributionForm").find("input:checked").prop("checked",!1)}),100),Travian.api("alliance/donation-form",{data:{},success:function(a){e.html(a.form),jQuery(window).trigger("domAltered",jQuery("#contributionForm")),t&&Travian.TimersAndCounters.init(),jQuery(".bonus-donation-response").addClass("visible"),i.initBonusIcons(),Travian.Tip.refresh(),i.bonusSelected=!1,i.initContributeDisabledAction()}}))},refreshDonationLimitBar:function(){var t=jQuery("#myDailyContributionLimit");t&&(t.addClass("hidden"),Travian.api("alliance/donation-limit",{data:{},success:function(e){t.html(e.limitBar),jQuery(window).trigger("domAltered",jQuery("#myDailyContributionLimit")),Travian.Tip.refresh(),t.removeClass("hidden")}}))},refreshAllianceBonusOverview:function(){var t=jQuery("#allianceBonusOverview"),e=this;t&&Travian.api("alliance/bonus-overview",{data:{},success:function(i){t.html(i.overview),e.initBonusOverview(),Travian.Tip.refresh()}})},refreshDailyDonation:function(t,e,i,a){var n=jQuery("#donatedToday"),o=jQuery("#dailyContributionTitleText"),r=jQuery("#dailyContributionTitleArrow"),s=parseInt(n.val()),l=parseInt(jQuery("#dailyLimit").val()),d=Math.min(100,t/l*100),u="lightGreen";"donate_gold"!==e&&"donate_gold_confirm"!==e||(u="gold"),r.addClass(u);var c=this.getResourceAnimationSpeed(i,a);i=a?3*i:i;var p=Math.round(i/20),h=c/20;r.css({transition:"width "+c+"ms, opacity 500ms",width:d.toString()+"%"});var m=1,v=setInterval((function(){(s+=p)<t&&o.html(Travian.i18n.Ratio(s,l,{nominatorClass:"donationValueNumber",denominatorClass:"donationMaxNumber"})),20===m&&(o.html(Travian.i18n.Ratio(t,l,{nominatorClass:"donationValueNumber",denominatorClass:"donationMaxNumber"})),r.removeClass(u),clearInterval(v)),m++}),h);100===d&&(jQuery(".bonus-donation-response").addClass("white"),r.css({width:"100%"}),jQuery("#limitReached").val(1),setTimeout((function(){r.addClass("complete"),o.addClass("complete").removeClass("white"),jQuery(".bonus-donation-response").addClass("complete")}),c+500)),n.val(t)},countDownResources:function(t,e){var i=this.getResourceAnimationSpeed(t,e),a=[],n=[];jQuery("#contributeButtons").find("button").addClass("disabled");var o=0;jQuery(".resourceInput input").each((function(t,e){var i=parseInt(jQuery(e).val());a[o]=i;var r=i/20;r<1&&(r=1),n[o]=r,o++}));var r=1,s=setInterval((function(){for(var t=0;t<a.length;t++){var e=a[t]-n[t];e>0&&(a[t]=e,jQuery(jQuery(".resourceInput input")[t]).val(parseInt(e)))}if(20===r){for(var i=0;i<a.length;i++)jQuery(jQuery(".resourceInput input")[i]).val(0);clearInterval(s)}r++}),i/20)},getResourceAnimationSpeed:function(t,e){e&&(t*=3);var i=500+1500*t/parseInt(jQuery("#dailyLimit").val());return i=Math.max(500,Math.min(2e3,i))},initBonusIcons:function(){var t=jQuery("#contributionBox").find("#bonusSelection .bonusButtonRound");t.off("click"),t.on("click",(function(t){t.preventDefault();var e=jQuery("#bonusBox"+jQuery(this).attr("data-index"));e.find(".bonusInfo").hasClass("hide")&&e.find("button").trigger("click"),jQuery("html, body").animate({scrollTop:e.offset().top},250)}))},initBonusOverview:function(){var t,e=jQuery(".bonusCollapse");try{t=JSON.parse(Travian.Game.Preferences.get("allianceBonusesOverview")||"{}")}catch(e){t={}}e.length>0&&e.each((function(i,a){jQuery(a).on("click",(function(i){var a=jQuery(this).attr("ref"),n=jQuery(this).children("img.openedClosedSwitch");if(a.length>0&&n.length>0){var o=jQuery(".bonusInfo."+a);Travian.toggleSwitch(o[0],n[0]),e.each((function(e,i){var a=jQuery(i).attr("ref"),n=jQuery(i).children("img.openedClosedSwitch");if(a.length>0&&n.length>0){var o=jQuery(".bonusInfo."+a);t[a]=!Travian.isToggleClosed(o[0],n[0])}})),Travian.Game.Preferences.set("allianceBonusesOverview",JSON.stringify(t))}}))}))},playLevelUpRewardAnimation:function(t,e,i,a){Travian.Game.Layout.toggleBackgroundOverlay();var n=jQuery("#backgroundOverlay"),o=jQuery("#bonusLevelUpRewardTemplate").html();n.prepend(o),n.find(".bonusLevelUpReward .bonusRepresentation > div").addClass(t),n.find(".bonusLevelUpReward .banner .description p:first-of-type").html(i),n.find(".bonusLevelUpReward .banner .description p:last-of-type").html(a),setTimeout((function(){n.find(".stoneDisplay").addClass("visible"),n.find(".stoneDisplayHeader").addClass("visible"),n.find(".banner").addClass("visible"),n.find(".swords").addClass("visible").addClass("locked"),setTimeout((function(){n.find(".bonusRepresentation .stage1").addClass("visible"),setTimeout((function(){n.find(".bonusRepresentation .glow").addClass("visible"),setTimeout((function(){n.find(".bonusRepresentation .stage2").addClass("visible"),setTimeout((function(){n.find(".bonusRepresentation .stage1").removeClass("visible"),n.find(".bonusRepresentation .glow").removeClass("visible"),n.find(".banner").addClass("enlarged"),setTimeout((function(){n.find(".stoneDisplayHeader .level1 .glow").addClass("visible"),n.find(".stoneDisplayHeader .level1 .star").addClass("visible"),setTimeout((function(){n.find(".stoneDisplayHeader .level1 .glow").removeClass("visible")}),150),e>=2&&setTimeout((function(){n.find(".stoneDisplayHeader .level2 .glow").addClass("visible"),n.find(".stoneDisplayHeader .level2 .star").addClass("visible"),setTimeout((function(){n.find(".stoneDisplayHeader .level2 .glow").removeClass("visible")}),150),e>=3&&setTimeout((function(){n.find(".stoneDisplayHeader .level3 .glow").addClass("visible"),n.find(".stoneDisplayHeader .level3 .star").addClass("visible"),setTimeout((function(){n.find(".stoneDisplayHeader .level3 .glow").removeClass("visible")}),250),e>=4&&setTimeout((function(){n.find(".stoneDisplayHeader .level4 .glow").addClass("visible"),n.find(".stoneDisplayHeader .level4 .star").addClass("visible"),setTimeout((function(){n.find(".stoneDisplayHeader .level4 .glow").removeClass("visible")}),250),e>=5&&setTimeout((function(){n.find(".stoneDisplayHeader .level5 .glow").addClass("visible"),n.find(".stoneDisplayHeader .level5 .star").addClass("visible"),setTimeout((function(){n.find(".stoneDisplayHeader .level5 .glow").removeClass("visible")}),250)}),500)}),500)}),500)}),500),setTimeout((function(){n.find(".bonusRepresentation .glow").addClass("step2 visible"),setTimeout((function(){n.find(".bonusRepresentation .glow").removeClass("visible"),n.find(".banner").removeClass("enlarged"),n.find(".bonusLevelUpReward").addClass("faded"),setTimeout((function(){Travian.Game.Layout.toggleBackgroundOverlay()}),750)}),750)}),2800-500*(5-e))}),1250)}),100)}),300)}),800)}),750)}),250)},refreshProgressBarTitle:function(t){var e=jQuery("div.progressBarDailyLimit"),i=e.attr("data-tooltip").match(/(^.*)(\[AMOUNT\])(.*$)/);e.title=i[1]+t+i[3],Travian.Tip.refresh()},initContributeDisabledAction:function(){var t=this;jQuery("#contributeButtons").find("button").on("click",(function(){t.calculateSum("donate"),!t.bonusSelected&&parseInt(jQuery("#donateSum").html())>0&&jQuery("#bonusNotSelectedMessage").show()}))}},Travian.Game.AllianceLeave=function(t){this.options=Object.assign({data:{}},t),this.initialize=function(){Travian.Dialog.Ajax.call(this,"alliance/leave",this.options)},this.reload=function(){this.request()},this.initialize()},Travian.Game.AllianceLeave.prototype=Object.create(Travian.Dialog.Ajax.prototype),Travian.Game.AllianceLeave.constructor=Travian.Game.AllianceLeave,Travian.Game.PaymentWizard=function(t){let e=this;this.options=deepmerge({shopUIVersion:0,data:{goldProductId:"",goldProductLocation:"",activeTab:Travian.Constants.SHOP_TABS.buyGold},keepOpen:!0,buttonCancel:!0,buttonOk:!1,context:"paymentWizard",cssClass:"",draggable:!1,infoIcon:!0,version:2,reloadOnClose:!1,darkOverlay:!0,overlayCancel:!1,useCallback:!1,callback:Travian.emptyFunction(),callbackScope:null,onClose:function(){Travian.Game.PaymentWizardEventListener.PaymentWizardObject=null,!0===e.options.useCallback&&"function"==typeof e.options.callback&&e.options.callback({scope:e.options.callbackScope}),jQuery(window).trigger("paymentWizardOnCloseEvent"),Travian.Game.Layout.updateGold(e.options.callback),Travian.TimersAndCounters.enableReloadEvent(),e.options.reloadOnClose&&Travian.Autoreload.autoreload()}},t),this.request=function(){let t=this;return Travian.api(this.cmd,{data:this.options.data,success:function(e){""!==e.html?t.setReloadOnClose(e.reloadOnClose).setContent(e.html).setInfoIcon(e.infoIcon).show():t.close()},error:function(e){t.dispose(),new Travian.Dialog.Dialog({preventFormSubmit:!0}).setContent(e.message).show()}}),this},this.initialize=function(){const t=this;Travian.TimersAndCounters.suppressReloadEvent();const e=function(e){const i=jQuery(e.target),a=i.data("tabname");return i.hasClass("disabled")||(a===Travian.Constants.SHOP_TABS.advantages&&(t.options.callback=null),t.options.data.activeTab=a,t.options.data.goldProductId=null,t.reload()),e.stopPropagation(),!1},i=t.options.onOpen;return t.options.onOpen=function(){const a=jQuery("#paymentWizard");a.length>0&&(a.find(".header .tabItem").each((function(t,i){(i=jQuery(i)).off("click.paymentWizard"),i.on("click.paymentWizard",e)}),this),a.find(".iconButton.info").attr("title",Travian.Translation.get("paymentWizard.infoButtonLabel")),t.updateInfoButton({buttonTextInfo:Travian.Translation.get("paymentWizard.infoButtonLabel"),infoIcon:function(){window.open(a.find(".paymentWizardAnswersLink").val())}})),t.options.data.activeTab===Travian.Constants.SHOP_TABS.advantages&&Travian.Game.PaymentWizard.Advantages.initialize(),i&&"function"==typeof i&&i()},Travian.Dialog.Ajax.call(this,"payment-wizard",t.options),this},this.setReloadOnClose=function(t){return this.options.reloadOnClose=!1===this.options.reloadOnClose&&!0===t?t:this.options.reloadOnClose,this},this.initialize()},Travian.Game.PaymentWizard.prototype=Object.create(Travian.Dialog.Ajax.prototype),Travian.Game.PaymentWizard.constructor=Travian.Game.PaymentWizard;var shopUIV4=new ShopUIV4;function ShopUIV4(){this.paymentShop=null,this.paymentWizard=null,this.packages=null,this.countrySelection=null,this.countrySelectionTemplate=null,this.paymentMethods=null,this.selectedPackage=null,this.continueButton=null,this.closeButton=null,this.loader=null,this.progressSteps=null,this.activeTab=null,this.currentProgressStep="selectPackage",this.country=null,this.goldProductId=null,this.goldProductLocation=null,this.goldBookingListenerInterval=null,this.initialize=function(){var t=this;t.paymentShop=jQuery(".dialog.paymentShopV4"),t.paymentWizard=jQuery("#paymentWizard"),t.paymentWizard.addClass("selectPackage"),t.showLoader(!0),t.goldProductId=void 0!==Travian.Game.PaymentWizardEventListener.PaymentWizardObject?Travian.Game.PaymentWizardEventListener.PaymentWizardObject.options.data.goldProductId:null,t.goldProductLocation=void 0!==Travian.Game.PaymentWizardEventListener.PaymentWizardObject?Travian.Game.PaymentWizardEventListener.PaymentWizardObject.options.data.goldProductLocation:null,Travian.api("paynet/init",{success:function(e){if(void 0!==e.html&&(jQuery(window).off("travian.preferences.reloaded"),t.paymentWizard.hasClass("buyGold"))){t.paymentWizard.find(".contentWrapper").empty().append(e.html),t.countrySelection=t.paymentShop.find(".countrySelection"),t.countrySelectionTemplate=t.paymentShop.find("#countrySelectionTemplate"),t.billingWrapper=t.paymentShop.find(".billingWrapper"),t.packages=t.paymentShop.find("input[name=package]"),t.paymentMethods=t.paymentShop.find("input[name=paymentMethod]"),t.continueButton=t.paymentShop.find("button.buyButton"),t.closeButton=t.paymentShop.find("#backToGame"),t.progressSteps=t.paymentShop.find(".buyProgress .step"),t.selectedPackage=null,t.initializePaymentMethods(),t.bindEvents(),t.setProgressStep("selectPackage",!1),Travian.Tip.refresh();const i=t.paymentShop.find(".specialOffersPackages");i.length>0&&Travian.TimersAndCounters.initTimersInContext(i[0]),null!==t.goldProductLocation&&""!==t.goldProductLocation&&t.countrySelectionTemplate.find("input[name=country]:checked").val()!==t.goldProductLocation?(t.hideLoader(),t.changeCountry(t.goldProductLocation)):(t.preselectPackage(),t.hideLoader())}},error:function(e){t.paymentWizard.find(".contentWrapper").empty(),t.errorDialog(e.message),t.hideLoader()}},"get")},this.preselectPackage=function(){let t=this;null!==t.goldProductId&&""!==t.goldProductId&&t.paymentWizard.find("input[value="+t.goldProductId+"]").prop("checked","checked").trigger("change")},this.initializePaymentMethods=function(){var t=this;null!==t.selectedPackage&&(t.hideLoader(),t.showLoader(),Travian.api("paynet/cart",{data:{productID:t.selectedPackage},success:function(e){if(void 0!==e.html){jQuery(".paymentMethods").html(e.html),t.paymentShop.find("input[name=paymentMethod]").on("change.paymentShopV4",(function(){t.paymentShop.find("input[name=paymentMethod]:checked").length>0&&t.continueButton.removeClass("disabled")})),t.setProgressStep("selectPaymentMethod",!1),t.hideLoader(),Travian.Tip.refresh(),t.paymentWizard.find(".paymentMethods .paymentMethod.back").on("click.paymentShopV4",(function(){t.setProgressStep("selectPaymentMethod",!0)}));var i=t.paymentShop.find("input[name=paymentMethod]:not(.notAvailable)");if(1===i.length)i.prop("checked","checked"),t.continueButton.removeClass("disabled");else{var a=Travian.Game.Preferences.get("lastUsedPaymentMethod");if(null!==a){var n=t.paymentShop.find("input[name=paymentMethod][data-code="+a+"]:not(.notAvailable)");n.length>0&&(n.prop("checked","checked"),n.find("+ label").is(":visible")||jQuery("#togglePaymentMethods").prop("checked","checked"),t.continueButton.removeClass("disabled"))}}}},error:function(e){t.hideLoader(),t.errorDialog(e.message)}},"put"))},this.bindEvents=function(){var t=this;t.countrySelection.off("click.paymentShopV4").on("click.paymentShopV4",(function(e){e.preventDefault(),t.renderCountryDialog()})),t.packages.off("change.paymentShopV4").on("change.paymentShopV4",(function(){t.continueButton.addClass("disabled"),t.selectedPackage=t.paymentShop.find("input[name=package]:checked").val(),t.initializePaymentMethods()})),t.packages.off("click.paymentShopV4").on("click.paymentShopV4",(function(){"insertBillingInformation"===t.currentProgressStep&&t.setProgressStep("selectPackage",!0)})),t.paymentWizard.find(".paymentWrapper .smsPayment a").off("click.paymentShopV4").on("click.paymentShopV4",(function(e){e.preventDefault(),t.paymentWizard.addClass("sms")})),t.progressSteps.off("click.paymentShopV4").on("click.paymentShopV4",(function(){var e=jQuery(this);["selectPackage","selectPaymentMethod"].forEach((function(i){e.hasClass(i)&&t.setProgressStep(i,!0)}))}));let e=function(i,a){Travian.api("paynet/create-payment",{data:{paymentMethodCode:i,recreate:a},success:function({url:e,paymentId:a}){if(t.hideLoader(),void 0!==e){var n=jQuery(window),o=(n.width()-900)/2+window.screenX,r=(n.height()-800)/2;if(window.open(e,"paynet","scrollbars=yes,status=yes,resizable=yes,toolbar=yes,width=900,height=800,left="+o+",top="+r),t.setProgressStep("confirmed"),t.paymentShop.find(".confirmation.forwarded").addClass("visible"),Travian.Game.Preferences.set("lastUsedPaymentMethod",i),t.goldBookingListenerInterval=setInterval((function(){t.paymentWizard.is(":visible")&&t.paymentWizard.hasClass("confirmed")&&t.paymentWizard.hasClass("forwarded")?t.pollPaymentSuccess({code:a},t.paymentSuccessful):clearInterval(t.goldBookingListenerInterval)}),3e3),jQuery("input[name=package][value="+t.selectedPackage+"]").parent(".specialOffersPackages").length>0){jQuery("#oneTimeOfferNotification").removeClass("firstTimeAnimation").addClass("dismissed");let t=jQuery(".tabItem.specialOffers").find(".shopNotification");t.length>0&&!t.hasClass("read")&&Travian.Game.Layout.updateShopNotification(1,t)}}else t.errorDialog("Error: The payment method could not be loaded.")},error:function(a){t.hideLoader(),2010===a.code?t.errorConfirmationDialog(a.message,(function(){Travian.WindowManager.closeByContext("confirmationDialog"),t.showLoader(),e(i,!0)})):t.errorDialog(a.message)}},"post")};t.continueButton.off("click.paymentShopV4").on("click.paymentShopV4",(function(){var i=jQuery(this);if(!i.hasClass("disabled")&&"disabled"!==i.prop("disabled")){var a=t.paymentShop.find("input[name=paymentMethod]:checked");if(0===a.length)return!1;var n=!1;switch(t.currentProgressStep){case"selectPaymentMethod":t.setProgressStep("insertBillingInformation",!1);break;case"insertBillingInformation":t.showLoader(),n=!0}if(n){var o=a.data("code");e(o,!1)}}})),t.closeButton.off("click.paymentShopV4").on("click.paymentShopV4",(function(){Travian.WindowManager.closeByContext("paymentWizard")}))},this.changeCountry=function(t){var e=this;e.country=t,e.showLoader();let i=e.countrySelectionTemplate.find("input[name=country][value="+t+"]").parent("label"),a=e.paymentWizard.find("h1.countrySelection");a.find(".inlineIcon .value").html(i.data("country-native")),a.find(".inlineIcon").find("svg").remove(),a.find(".inlineIcon").prepend(i.find("svg").clone()),Travian.api("paynet/productsByCountry/"+e.country,{success:function(t){e.hideLoader(),void 0!==t.renderedPackages&&void 0!==t.renderedSmsPackages&&void 0!==t.renderedSpecialOffersPackages&&(e.paymentWizard.find(".packages:not(.smsPackages):not(.specialOffersPackages").empty().append(t.renderedPackages),e.paymentWizard.find(".smsPackages").empty().append(t.renderedSmsPackages),e.paymentWizard.find(".specialOffersPackages").empty().append(t.renderedSpecialOffersPackages),Travian.TimersAndCounters.initTimersInContext(e.paymentShop.find(".specialOffersPackages")[0]),e.packages=e.paymentShop.find("input[name=package]"),""===t.renderedSmsPackages?e.paymentWizard.find(".smsPayment").removeClass("available"):e.paymentWizard.find(".smsPayment").addClass("available"),e.setProgressStep("selectPackage",!1),e.bindEvents(),e.preselectPackage())},error:function(t){e.hideLoader(),e.errorDialog(t.message)}},"get")},this.showLoader=function(t){var e=this;e.loader=e.paymentShop.find(".loading"),void 0!==t&&!0===t?e.loader.addClass("visible").addClass("preview"):(e.loader.addClass("visible"),e.paymentShop.find(".contentNavi .content.active .tabItem .shopNotification.read").remove()),e.paymentShop.find("h1.countrySelection").addClass("disabled"),e.paymentShop.find(".contentNavi .tabItem.buyGold").addClass("disabled"),e.activeTab=e.paymentShop.find(".contentNavi .content.active"),e.activeTab.removeClass("active")},this.hideLoader=function(){var t=this;t.loader.removeClass("visible"),t.paymentShop.find("h1.countrySelection").removeClass("disabled"),t.paymentShop.find(".contentNavi .tabItem.buyGold").removeClass("disabled"),t.activeTab.addClass("active")},this.setProgressStep=function(t,e){var i=this,a={selectPackage:1,selectPaymentMethod:2,insertBillingInformation:3,confirmed:4};if(e&&(a={selectPackage:1,selectPaymentMethod:2}),void 0===a[t])return!1;if(e&&a[i.currentProgressStep]<a[t])return!1;i.progressSteps.removeClass("locked"),i.progressSteps.removeClass("done"),i.progressSteps.removeClass("active");var n=!1;switch(i.progressSteps.each((function(e,i){i=jQuery(i),n?i.addClass("locked"):i.hasClass(t)?(n=!0,i.addClass("active")):i.addClass("done")})),t){case"selectPackage":i.paymentWizard.removeClass("sms").removeClass("selectPaymentMethod").removeClass("insertBillingInformation").removeClass("confirmed").addClass("selectPackage"),i.paymentShop.find("input[name=package]:checked").prop("checked",!1),i.paymentShop.find("input[name=paymentMethod]:checked").prop("checked",!1),i.paymentShop.find("input[name=paymentMethod]").attr("disabled","disabled"),i.paymentWizard.removeClass("forwarded").removeClass("successful"),i.paymentWizard.find(".silwia").addClass("normal").removeClass("success"),i.continueButton.addClass("disabled");break;case"selectPaymentMethod":i.paymentWizard.removeClass("selectPackage").removeClass("insertBillingInformation").removeClass("confirmed").addClass("selectPaymentMethod"),i.paymentShop.find("input[name=paymentMethod]:checked").prop("checked",!1),i.continueButton.addClass("disabled");break;case"insertBillingInformation":var o=i.paymentShop.find("input[name=paymentMethod]:checked").val();i.paymentWizard.removeClass("selectPackage").removeClass("selectPaymentMethod").removeClass("confirmed").addClass("insertBillingInformation"),"SMART2PAY_VTC"===o&&i.paymentShop.find(".vatInfo").html("*&nbsp;"+Travian.Translation.get("paymentWizard.pricesAreFinalExceptExtraTaxes"));break;case"confirmed":i.paymentWizard.removeClass("selectPackage").removeClass("selectPaymentMethod").removeClass("insertBillingInformation").addClass("confirmed").addClass("forwarded")}i.currentProgressStep=t},this.pollPaymentSuccess=function(t,e){const i=this;Travian.api("paynet/payment-success",{data:t,success:function(t){e.call(i,t),clearInterval(i.goldBookingListenerInterval)}},"post")},this.paymentSuccessful=function({gold:t}){this.paymentWizard.find(".confirmation .confirmationText .value").html(t),this.paymentWizard.removeClass("forwarded").addClass("successful"),this.paymentWizard.find(".silwia").removeClass("normal").addClass("success"),Travian.Game.Layout.updateGold()},this.voucherSuccessful=function(){Travian.Game.Layout.updateGold()},this.errorDialog=function(t){new Travian.Dialog.Dialog({preventFormSubmit:!0}).setContent('<div class="error centeredText errorMessage">'+t+"</div>").show()},this.errorConfirmationDialog=function(t,e){new Travian.Dialog.Confirmation({message:t,confirmText:Travian.Translation.get("spieler.ja"),cancelText:Travian.Translation.get("spieler.nein"),onConfirm:e}).show()},this.initializeVouchers=function(){var t=this;t.paymentShop=jQuery(".dialog.paymentShopV4"),t.paymentWizard=jQuery("#paymentWizard");var e=t.paymentShop.find("form"),i=t.paymentWizard.find(".voucherForm");if(i.length>0){var a=t.paymentWizard.find(".silwia"),n=i.find("input[name=voucher]"),o=i.find(".errorMessageContainer"),r=i.find("#redeemVoucher");n.on("keyup input",(function(t){if("Enter"===t.key)return t.preventDefault(),!1;n.removeClass("invalid"),""===jQuery(this).val().trim()?r.addClass("disabled"):r.removeClass("disabled")})),e.off("submit"),e.on("submit",(function(e){if(e.preventDefault(),r.hasClass("disabled"))return!1;t.showLoader();const i=n.val().trim();Travian.api("paynet/redeem-voucher",{data:{code:i},success:function(e){t.paymentWizard.find(".packages label .amount .value").html(e.data.value),t.paymentWizard.find(".confirmation .confirmationText .value").html(e.data.value),t.paymentShop.find("#backToGame").on("click.paymentShopV4",(function(){Travian.WindowManager.closeByContext("paymentWizard")})),t.hideLoader(),t.paymentWizard.addClass("confirmed"),a.removeClass("normal").addClass("success"),t.goldBookingListenerInterval=setInterval((function(){t.paymentWizard.hasClass("confirmed")?t.pollPaymentSuccess({code:i},t.voucherSuccessful):clearInterval(t.goldBookingListenerInterval)}),1e3)},error:function(e){t.hideLoader(),e.code&&e.code>=4001&&e.code<=4008?(n.addClass("invalid"),o.html(e.message),Travian.TimersAndCounters.initTimers()):t.errorDialog(e.message)}},"post")}))}},this.renderSmallestPackageDialog=function(t){var e=this;Travian.api("paynet/smallestPackageDialog/"+t,{success:function(t){if(void 0!==t.html){var e=Travian.WindowManager.getWindowsByContext("smallestPackage")[0];void 0!==e&&e.setContent(t.html)}},error:function(t){e.errorDialog(t.message)}},"get")},this.renderTransactionHistoryDialog=function(){var t=this;t.showLoader(),Travian.api("paynet/transactionHistoryDialog",{success:function(e){t.hideLoader();var i=new Travian.Dialog.Dialog({version:2,preventFormSubmit:!0,buttonOk:!1,cssClass:"basic scrollable transactionHistory"});i.setContent(e.html),i.show()},error:function(e){t.hideLoader(),t.errorDialog(e.message)}},"get")},this.copyOrderCodeListener=function(){var t=jQuery(".copyOrderCode");t.off("click.paymentShopV4"),t.on("click.paymentShopV4",(function(t){t.preventDefault();var e=jQuery(t.target);jQuery(".copiedNotice").removeClass("success");var i=jQuery("<input/>");jQuery("body").append(i),i.val(e.data("order-id")).select(),document.execCommand("copy"),i.remove(),e.parent(".orderCode").find(".copiedNotice").removeClass("success").addClass("success")}))},this.renderCountryDialog=function(){var t=this,e=new Travian.Dialog.Dialog({version:2,preventFormSubmit:!0,buttonOk:!1,infoIcon:!1,cssClass:"basic scrollable countrySelection",context:"paymentShopV4CountrySelection"});e.setContent('<div id="countrySelection" class="'+t.countrySelectionTemplate.prop("class")+'">'+t.countrySelectionTemplate.html()+"</div>"),e.show();var i=jQuery("#countrySelection");i.find("input[name=country][value="+t.country+"]").prop("checked","checked"),i.find("input[name=country]").off("change.paymentShopV4").on("change.paymentShopV4",(function(){Travian.WindowManager.closeByContext("paymentShopV4CountrySelection"),t.changeCountry(jQuery(this).val())})),i.find(".filterCountry input").off("keyup").on("keyup",(function(){var t=jQuery(this).val().toUpperCase();i.find(".countryListItem").each((function(e,i){-1!==(i=jQuery(i)).data("country-native").toUpperCase().indexOf(t)||-1!==i.data("country-english").toUpperCase().indexOf(t)||-1!==i.find("input").val().toUpperCase().indexOf(t)?i.show():i.hide()})),0===i.find(".countryListItem:visible").length?i.find(".noCountryFound").removeClass("hide"):i.find(".noCountryFound").addClass("hide")}))}}Travian.Game.PaymentWizard.Advantages={lastFeatureName:null,initialize:function(){const t=Travian.Game.PaymentWizardEventListener.PaymentWizardObject,e=jQuery("#featureCollectionWrapper");e.find(".prosButton").each((function(e,i){(i=jQuery(i)).off("click"),i.on("click",(function(){const e=jQuery(this);return t.setReloadOnClose(!0),e.hasClass("productionboostLumber")?jQuery(window).trigger("startWayOfPayment",["productionboostLumber","paymentWizard"]):e.hasClass("productionboostClay")?jQuery(window).trigger("startWayOfPayment",["productionboostClay","paymentWizard"]):e.hasClass("productionboostIron")?jQuery(window).trigger("startWayOfPayment",["productionboostIron","paymentWizard"]):e.hasClass("productionboostCrop")?jQuery(window).trigger("startWayOfPayment",["productionboostCrop","paymentWizard"]):e.hasClass("plus")?jQuery(window).trigger("startWayOfPayment",["plus","paymentWizard"]):e.hasClass("goldclub")&&jQuery(window).trigger("startWayOfPayment",["goldclub","paymentWizard"]),!1}))})),e.find(".checkbox").each((function(t,e){(e=jQuery(e)).off("click"),e.on("click",(function(t){const e=jQuery(this);return e.hasClass("prolongProductionboostLumber")?Travian.Game.PaymentWizard.Advantages.toggleAutoprolong("productionboostLumber","productionBoost"):e.hasClass("prolongProductionboostClay")?Travian.Game.PaymentWizard.Advantages.toggleAutoprolong("productionboostClay","productionBoost"):e.hasClass("prolongProductionboostIron")?Travian.Game.PaymentWizard.Advantages.toggleAutoprolong("productionboostIron","productionBoost"):e.hasClass("prolongProductionboostCrop")?Travian.Game.PaymentWizard.Advantages.toggleAutoprolong("productionboostCrop","productionBoost"):e.hasClass("prolongPlus")?Travian.Game.PaymentWizard.Advantages.toggleAutoprolong("plus","plus"):(t.stopPropagation(),!1)}))}));const i=jQuery("#paymentWizard");e.find(".feature").on("mouseover",(function(t){const e=jQuery(this).find(".premiumFeatureName").val();if(!e||e===Travian.Game.PaymentWizard.Advantages.lastFeatureName)return t.stopPropagation(),!1;i.find(".infoArea .premiumFeature").removeClass("show"),i.find(".infoArea .premiumFeature").filter("."+e).addClass("show");const a=i.find("#featureIndicator"),n=jQuery(this),o=n.get(0).offsetTop+n.height()/2-a.height()/2;a.stop().addClass("moving").animate({top:o},250,"linear",(function(){jQuery(this).removeClass("moving")})),Travian.Game.PaymentWizard.Advantages.lastFeatureName=e})),e.find(".feature.preSelected").trigger("mouseover"),e.length>0&&Travian.TimersAndCounters.initTimersInContext(e[0])},toggleAutoprolong:function(t){Travian.api("premium",{data:{action:Travian.Constants.ACTION.premiumFeature,featureKey:t,toggleAutoprolong:1},success:function(){Travian.Game.PaymentWizardEventListener.PaymentWizardObject.reload()}})}},Travian.Game.VideoFeatureShowVideo=function(t){this.request=function(){var t=this;return Travian.api(this.options.call,{data:this.options.data,success:function(e){t.setContent(e.html),t.show()}}),this},this.close=function(t){if(void 0!==this.requestSend&&!0===this.requestSend)return Travian.Autoreload.autoreload();[Travian.Dialog.CLOSE_CONTEXT_OVERLAYBACKGROUND,Travian.Dialog.CLOSE_CONTEXT_CANCELBUTTON].indexOf(t)>-1?new Travian.Game.VideoFeatureAbort:(Travian.TimersAndCounters.enableReloadEvent(),Travian.Dialog.Api.prototype.close.call(this))},Travian.Dialog.Api.call(this,Object.assign({call:"adsales/open",buttonOk:!1,context:"videoFeatureShowVideo",version:2,darkOverlay:!0,cssClass:"videoFeature",onClose:function(t){Travian.Game.VideoFeatureEventListener.VideoFeatureObject=null}},t))},Travian.Game.VideoFeatureShowVideo.prototype=Object.create(Travian.Dialog.Api.prototype),Travian.Game.VideoFeatureShowVideo.constructor=Travian.Game.VideoFeatureShowVideo,Travian.Game.VideoFeatureInfo=function(t){this.request=function(){var t=this;return Travian.api(this.options.call,{data:this.options.data,success:function(e){t.setContent(e.html),t.show()}}),this},Travian.Dialog.Api.call(this,Object.assign({call:"adsales/info",buttonOk:!1,context:"videoFeatureInfo",version:2,darkOverlay:!0,cssClass:"videoFeature"},t))},Travian.Game.VideoFeatureInfo.prototype=Object.create(Travian.Dialog.Api.prototype),Travian.Game.VideoFeatureInfo.constructor=Travian.Game.VideoFeatureInfo,Travian.Game.VideoFeatureAbort=function(t){this.abortVideo=function(){Travian.Autoreload.autoreload(),Travian.WindowManager.closeByContext("videoFeatureAbort"),Travian.WindowManager.closeByContext("videoFeatureShowVideo")},Travian.Dialog.Api.call(this,Object.assign({call:"adsales/abort",buttonOk:!1,buttonCancel:!1,context:"videoFeatureAbort",darkOverlay:!0,overlayCancel:!1},t)),jQuery(window).one("videoFeatureAbortConfirm",this.abortVideo)},Travian.Game.VideoFeatureAbort.prototype=Object.create(Travian.Dialog.Api.prototype),Travian.Game.VideoFeatureAbort.constructor=Travian.Game.VideoFeatureAbort,Travian.Game.VideoFeatureSuccess=function(t){Travian.Dialog.Api.call(this,Object.assign({call:"adsales/success",context:"videoFeatureSuccess",darkOverlay:!0,overlayCancel:!0,preventFormSubmit:!0,onOkay:function(){Travian.Game.Preferences.set("adSalesVideoSuccessDialogDisabled",jQuery("input#dontShowThisAgain").is(":checked")?1:0)}},t))},Travian.Game.VideoFeatureSuccess.prototype=Object.create(Travian.Dialog.Api.prototype),Travian.Game.VideoFeatureSuccess.constructor=Travian.Game.VideoFeatureSuccess,Travian.Game.MoreGames=function(t){this.activeCounterElement=null,this.activeCounter=0,this.autoHoverDelay=3e3,this.timeoutId=0,this.elements=null,this.options=Object.assign({countOfGamesToShow:0},t),this.initialize=function(){this.elements=jQuery("div.moreGames .game.game-image"),this.options.countOfGamesToShow&&this.events().toggleChildren(this.activeCounter).autoHover()},this.autoHover=function(){var t=this;return t.timeoutId&&clearTimeout(t.timeoutId),t.timeoutId=setTimeout(function(){t.toggleChildren(t.activeCounter),t.toggleChildren((t.activeCounter+1)%t.options.countOfGamesToShow),t.autoHover()}.bind(t),t.autoHoverDelay),t},this.events=function(){var t=this,e=function(e){t=this,clearTimeout(t.timeoutId),e!==t.activeCounter&&(t.activeCounterElement.length>0&&t.toggleChildren(t.activeCounter),t.toggleChildren(e))},i=function(){(t=this).autoHover()};return this.elements.each((function(a,n){jQuery(n).on({mouseenter:jQuery.proxy(e,t,a),mouseleave:jQuery.proxy(i,t)})})),this},this.toggleChildren=function(t){return this.activeCounter=t,this.activeCounterElement=jQuery(this.elements[t]),this.activeCounterElement.find("img").each((function(t,e){jQuery(e).toggleClass("hide")})),this},this.initialize()},Travian.Game.VideoFeatureEventListener=Object.create({VideoFeatureObject:null,options:null,infoScreenEnabled:!0,videoOptions:{},initialize:function(t){this.DoubleClickPreventer=new Travian.DoubleClickPreventer,this.DoubleClickPreventer.timeout=1e3,this.bindEvents();var e=Travian.Game.Preferences.get("adSalesVideoInfoScreen");return this.infoScreenEnabled=null===e||"enabled"===e,this},bindEvents:function(){var t=this;jQuery(window).on("showVideoWindow",(function(e,i){if(void 0===t.VideoFeatureObject||null===t.VideoFeatureObject){if(!t.DoubleClickPreventer.check())return!1;t.infoScreenEnabled?(t.videoOptions=i,t.showVideoInfoDialog()):t.VideoFeatureObject=t.startVideoDialog(i)}else t.VideoFeatureObject.options=Object.assign({},t.VideoFeatureObject.options,i||{}),t.VideoFeatureObject.reload()})),jQuery(window).on("showVideoWindowAfterInfoScreen",(function(){Travian.WindowManager.closeByContext("videoFeatureInfo"),void 0===t.VideoFeatureObject||null===t.VideoFeatureObject?t.VideoFeatureObject=t.startVideoDialog(t.videoOptions):(t.VideoFeatureObject.options=Object.assign({},t.VideoFeatureObject.options,options||{}),t.VideoFeatureObject.reload())})),jQuery(window).on("toggleAdSalesVideoInfoScreen",(function(e,i){Travian.Game.Preferences.set("adSalesVideoInfoScreen",i),t.infoScreenEnabled="enabled"===i})),jQuery(window).on("message",(function(t){Travian.Game.VideoFeatureEventListener.onMessage(t)}))},addEvent:function(t,e,i){t.addEventListener?t.addEventListener(e,i,!1):t.attachEvent&&t.attachEvent("on"+e,i)},onMessage:function(t){if("http://media.oadts.com"===t.originalEvent.origin||"https://media.oadts.com"===t.originalEvent.origin){var e=t.originalEvent.data;if("videoStart"===e){var i=jQuery('input[name="vrid"]').val();i&&Travian.api("adsales/start",{data:{vrid:i}})}else if("noVideo"===e);else if("videoEnds"===e);else if(0===e.indexOf("videoEnds:")){var a=e.replace("videoEnds:",""),n=a.indexOf(":");Travian.api("adsales/ends",{data:{vrid:a.substring(0,n),hash:a.substring(n+1)}})}}},startVideoDialog:function(t){return Travian.TimersAndCounters.suppressReloadEvent(),new Travian.Game.VideoFeatureShowVideo(t)},showVideoInfoDialog:function(){new Travian.Game.VideoFeatureInfo}}),jQuery((function(){Travian.Game.VideoFeatureEventListener.initialize()})),Travian.Game.PaymentWizardEventListener=Object.create({DoubleClickPreventer:null,PaymentWizardObject:null,defaultOptions:{},initialize:function(){this.DoubleClickPreventer=new Travian.DoubleClickPreventer,this.DoubleClickPreventer.timeout=2e3,this.bindEvents()},bindEvents:function(){var t=this;jQuery(window).on("paymentWizardOnCloseEvent",(function(e){t.PaymentWizardObject=null})),jQuery(window).on("startPaymentWizard",(function(e,i){if(i=deepmerge(t.defaultOptions,i||{}),!t.DoubleClickPreventer.check())return!1;void 0===t.PaymentWizardObject||null===t.PaymentWizardObject?t.PaymentWizardObject=t.startPaymentWizard(i):(t.PaymentWizardObject.options=deepmerge(t.PaymentWizardObject.options,i||{}),t.PaymentWizardObject.reload())}))},startPaymentWizard:function(t){return new Travian.Game.PaymentWizard(t)}}),jQuery((function(){Travian.Game.PaymentWizardEventListener.initialize()})),Travian.Game.WayOfPaymentEventListener=Object.create({WayOfPaymentObject:null,initialize:function(){this.DoubleClickPreventer=new Travian.DoubleClickPreventer,this.DoubleClickPreventer.timeout=500,this.bindEvents()},bindEvents:function(){var t=this;jQuery(window).on("buttonClicked",(function(e,i,a){"object"==typeof a.wayOfPayment&&t.DoubleClickPreventer.check()&&!jQuery(i).hasClass("disabled")&&(t.WayOfPaymentObject=t.startWayOfPayment(a.wayOfPayment.featureKey,a.wayOfPayment.context,a.wayOfPayment.dataCallback,a.wayOfPayment.confirmPopup,a.wayOfPayment.closeAllDialogs))})),jQuery(window).on("startWayOfPayment",(function(e,i,a,n,o,r){if(!t.DoubleClickPreventer.check())return!1;t.WayOfPaymentObject=t.startWayOfPayment(i,a,n,o,r)}))},startWayOfPayment:function(t,e,i,a,n){return new Travian.Game.WayOfPayment(t,e,i,a,n)}}),jQuery((function(){Travian.Game.WayOfPaymentEventListener.initialize()})),Travian.Game.ButtonEventListener={bindEvents:function(){jQuery(window).on("buttonClicked",(function(t,e,i){return jQuery(e).blur(),"object"==typeof i.dialog&&i.dialog&&Travian.DoubleClickPreventer.globalCheck()?new Travian.Dialog.Ajax(i.dialog.cmd,i.dialog):"object"==typeof i.plusDialog&&i.plusDialog&&Travian.DoubleClickPreventer.globalCheck()?new Travian.Game.PlusDialog(i.plusDialog):"object"==typeof i.productionBoostDialog&&i.productionBoostDialog&&Travian.DoubleClickPreventer.globalCheck()?new Travian.Game.ProductionBoostDialog(i.productionBoostDialog):"object"==typeof i.reportSpamMessagesDialog&&i.reportSpamMessagesDialog&&Travian.DoubleClickPreventer.globalCheck()?new Travian.Game.ReportSpamMessagesDialog(i.reportSpamMessagesDialog):"object"==typeof i.goldclubDialog&&i.goldclubDialog&&Travian.DoubleClickPreventer.globalCheck()?new Travian.Game.GoldclubDialog(i.goldclubDialog):void 0!==i.questButtonGainReward&&i.questButtonGainReward?Travian.Game.Quest.rewardButtonClick(i.questId):void 0!==i.questButtonOverviewAchievements&&i.questButtonOverviewAchievements?Travian.Game.Quest.openTodoListDialog("",!0):void 0!==i.villageDialog&&i.villageDialog&&Travian.DoubleClickPreventer.globalCheck()?Travian.Game.showEditVillageDialog(i.villageDialog.title,i.villageDialog.description,i.villageDialog.saveText,i.villageDialog.villageId):void 0})),jQuery(window).on("tabClicked",(function(t,e,i){return"object"==typeof i.dialog&&i.dialog&&Travian.DoubleClickPreventer.globalCheck()?new Travian.Dialog.Ajax(i.dialog.cmd,i.dialog):"object"==typeof i.plusDialog&&i.plusDialog&&Travian.DoubleClickPreventer.globalCheck()?new Travian.Game.PlusDialog(i.plusDialog):"object"==typeof i.goldclubDialog&&i.goldclubDialog&&Travian.DoubleClickPreventer.globalCheck()?new Travian.Game.GoldclubDialog(i.goldclubDialog):void 0}))}},jQuery((function(){Travian.Game.ButtonEventListener.bindEvents()})),Travian.Game.PremiumFeature=function(t,e){this.twoStepAction=new Travian.Game.TwoStepAction("premium/"+t,Object.assign(e,{action:Travian.Constants.ACTION.premiumFeature})),this.sign=function(t,e){this.twoStepAction.sign(t,e)},this.book=function(t,e){this.twoStepAction.execute(t,(function(t,i){428!==i.status?e&&e(t,i):new Travian.Dialog.Dialog(t.dialogOptions).setContent(t.dialogContent).show()}))}},Travian.Game.PremiumFeature.constructor=Travian.Game.PremiumFeature,Travian.Game.WayOfPayment=function(t,e,i,a,n){this.featureKey=null,this.context=null,this.confirmPopup=null,this.closeAllDialogs=null,this.initialize=function(t,e,i,a,n){if(void 0===t)throw"Feature Key must not be empty!";var o={};"string"==typeof i&&"function"==typeof this[i]&&(o=this[i]()),"string"==typeof i&&"function"==typeof i.split(".").reduce((function(t,e){return t[e]}),window)&&(o=i.split(".").reduce((function(t,e){return t[e]}),window)()),"function"==typeof i&&(o=i()),this.featureKey=t,this.context=e,this.confirmPopup=a,this.closeAllDialogs=n,void 0!==a&&"object"==typeof a?this.checkConfirmation(o):this.bookPremiumFeature(o)},this.checkConfirmation=function(t){var e=this;Travian.api("player/gold-amount",{data:{},success:function(i){var a=i.goldAmount,n=t.coins;a>0&&n<=a?e.showCustomConfirmationPopup(e.confirmPopup,t):e.bookPremiumFeature(t)}})},this.showCustomConfirmationPopup=function(t,e){new Travian.Dialog.Ajax(t.name,{buttonOk:!1,data:{goldAmount:e.coins},context:this.context,elementFocus:t.options.elementFocus||".dialogButtonOk"})},this.bookPremiumFeature=function(t){var e={action:Travian.Constants.ACTION.premiumFeature,featureKey:this.featureKey,context:this.context,additionalData:t},i=this;Travian.api("premium",{data:e,success:function(t){t.hasOwnProperty("functionToCall")&&("function"==typeof i[t.functionToCall]?i[t.functionToCall](t.options,t.context):"function"==typeof window[t.functionToCall]&&window[t.functionToCall](t.options,t.context))},error:function(t){new Travian.Dialog.Dialog({preventFormSubmit:!0}).setContent(t.message).show()}})},this.renderDialog=function(t){var e=t.dialogOptions,i=t.html;return Travian.WindowManager.getWindowsByContext("convertGoldPopup")&&Travian.WindowManager.closeByContext("convertGoldPopup"),void 0!==this.closeAllDialogs&&null!==this.closeAllDialogs&&this.closeAllDialogs&&Travian.WindowManager.closeAllWindows(),t.context=this.featureKey,$dialog=new Travian.Dialog.Dialog(e),$dialog.setContent(i),$dialog.show(),$dialog},this.closeDialog=function(t,e){Travian.WindowManager.closeByContext(e)},this.hideDialog=function(t,e){Travian.WindowManager.hideByContext(e)},this.unhideDialog=function(t,e){Travian.WindowManager.showByContext(e)},this.reloadDialog=function(t,e){null===e&&void 0!==t.scope&&(e=t.scope.context),Travian.WindowManager.reloadWindowsByContext(e)},this.reloadUrl=function(){Travian.Autoreload.autoreload()},this.submitForm=function(t,e){var i=document.getElementById(t.buttonId);i&&"BUTTON"===i.tagName&&(i.type="submit",i.click())},this.openPaymentWizard=function(t,e){var i,a=Travian.emptyFunction;void 0!==t.goldProductId&&(i=t.goldProductId),void 0!==t.callback&&"function"==typeof t.callback&&(a=t.callback),"string"==typeof t.callback&&"function"==typeof t.callback.split(".").reduce((function(t,e){return t[e]}),window)&&(a=t.callback.split(".").reduce((function(t,e){return t[e]}),window)),this.closeDialog(t,"smallestPackage"),jQuery(window).trigger("startPaymentWizard",{data:{goldProductId:i,activeTab:Travian.Constants.SHOP_TABS.buyGold},callback:a,callbackScope:this})},this.openPaymentWizardWithProsTab=function(){jQuery(window).trigger("startPaymentWizard",{data:{activeTab:Travian.Constants.SHOP_TABS.advantages}})},this.initialize(t,e,i,a,n)},Travian.Game.WayOfPayment.constructor=Travian.Game.WayOfPayment,Travian.Game.PlusDialog=function(t){this.requestSent=!1,this.contentReloaded=!1,this.request=function(){var t=this;this.options.data.context=this.context;var e=this.options.premiumFeatureDialogVersion;return Travian.api(this.cmd,{data:this.options.data,success:function(i){switch(e){case 1:default:t.setContent(t.createContent(t,i));break;case 2:t.setContent(i.html)}t.show()},error:function(e){t.dispose(),new Travian.Dialog.Dialog({preventFormSubmit:!0}).setContent(e.message).show()}}),this},this.createContent=function(t,e){var i=this,a=jQuery('<div class="paymentPopupDialogWrapper"></div>'),n=jQuery("<h1></h1>"),o=jQuery('<span class="headlineText">'+e.title+"</span>");n.append(o);var r=jQuery('<span class="goldWrapper">'+e.gold+"</span>");n.append(r),n.append(jQuery('<div class="clear"></div>'));var s=jQuery('<h2 class="subHeadline">'+e.subHeadLine+"</h2>"),l=jQuery('<div class="goldButtonWrapper"></div>'),d=jQuery("<div>"+e.goldButton+"</div>"),u=jQuery('<div class="buttonSubTitle">'+e.buttonSubtitle+"</div>");l.append(d),l.append(u);var c=jQuery('<h3 class="extraFeatures">'+e.plusPopupButtonExtraFeatures+"</h3>"),p=jQuery("<div></div>"),h=jQuery('<div class="furtherFeatures"></div>');jQuery.each(e.features,(function(t,e){t===i.options.featureKey?p.append(jQuery('<div class="feature featureInfo">'+i.options.featureMarkup(e.title,e.text,t)+"</div>")):h.append(jQuery('<div class="feature featureInfo">'+i.options.featureMarkup(e.title,e.text,t)+"</div>"))}));var m=jQuery('<p class="furtherInfos">'+e.furtherInfos+"</p>");return a.append(n),a.append(p),a.append(s),a.append(l),a.append(c),a.append(h),a.append(m),d.on("click",(function(){i.goldButtonClicked()})),a},this.reload=function(){this.contentReloaded=!0,Travian.Dialog.Ajax.prototype.reload.call(this)},this.goldButtonClicked=function(){return this.requestSent=!0,jQuery(window).trigger("startWayOfPayment",["plus","plus"]),!1},this.close=function(){if(this.requestSent&&this.contentReloaded)return Travian.Autoreload.autoreload();Travian.Dialog.Ajax.prototype.close.call(this)},Travian.Dialog.Ajax.call(this,"plus",Object.assign({data:{featureKey:t.featureKey},buttonOk:!1,context:"plus",darkOverlay:!0,overlayCancel:!1,featureMarkup:function(t,e,i){return['<div class="featureImage '+i+'"></div>','<div class="featureContent">','<h3 class="featureTitle">'+t+"</h3>",'<div class="featureText">'+e+"</div>","</div>",'<div class="clear"></div>'].join("")}},t))},Travian.Game.PlusDialog.prototype=Object.create(Travian.Dialog.Ajax.prototype),Travian.Game.PlusDialog.constructor=Travian.Game.PlusDialog,Travian.Game.GoldclubDialog=function(t){this.options=Object.assign({data:{featureKey:t.featureKey},buttonOk:!1,context:"goldclub",darkOverlay:!0,overlayCancel:!1,featureMarkup:function(t,e,i){return['<div class="featureImage '+i+'"></div>','<div class="featureContent">','<h3 class="featureTitle">'+t+"</h3>",'<div class="featureText">'+e+"</div>","</div>",'<div class="clear"></div>'].join("")}},t),this.request=function(){var t=this;this.options.data.context=this.context;var e=this.options.premiumFeatureDialogVersion;return Travian.api(this.cmd,{data:this.options.data,success:function(i){switch(e){case 1:default:t.setContent(t.createContent(t,i));break;case 2:t.setContent(i.html)}t.show()},error:function(e){t.dispose(),new Travian.Dialog.Dialog({preventFormSubmit:!0}).setContent(e.message).show()}}),this},this.initialize=function(){Travian.Dialog.Ajax.call(this,"goldclub",this.options)},this.createContent=function(t,e){var i=this,a=jQuery('<div class="paymentPopupDialogWrapper"></div>'),n=jQuery("<h1></h1>"),o=jQuery('<span class="headlineText">'+e.title+"</span>");n.append(o);var r=jQuery('<span class="goldWrapper">'+e.gold+"</span>");n.append(r),n.append(jQuery('<div class="clear"></div>'));var s=jQuery('<h2 class="subHeadline">'+e.subHeadLine+"</h2>"),l=jQuery('<div class="goldButtonWrapper"></div>'),d=jQuery("<div>"+e.goldButton+"</div>"),u=jQuery('<div class="buttonSubTitle">'+e.buttonSubtitle+"</div>");l.append(d),l.append(u);var c=jQuery('<h3 class="extraFeatures">'+e.goldclubPopupButtonExtraFeatures+"</h3>"),p=jQuery("<div></div>"),h=jQuery('<div class="furtherFeatures"></div>');jQuery.each(e.features,(function(t,e){t===i.options.featureKey?p.append(jQuery('<div class="feature featureInfo">'+i.options.featureMarkup(e.title,e.text,t)+"</div>")):h.append(jQuery('<div class="feature featureInfo">'+i.options.featureMarkup(e.title,e.text,t)+"</div>"))}));var m=jQuery('<p class="furtherInfos">'+e.furtherInfos+"</p>");return a.append(n),a.append(p),a.append(s),a.append(l),a.append(c),a.append(h),a.append(m),d.on("click",(function(){i.goldButtonClicked()})),a},this.goldButtonClicked=function(){return this.requestSend=!0,jQuery(window).trigger("startWayOfPayment",["goldclub","goldclub"]),!1},this.initialize()},Travian.Game.GoldclubDialog.prototype=Object.create(Travian.Dialog.Ajax.prototype),Travian.Game.GoldclubDialog.constructor=Travian.Game.GoldclubDialog,Travian.Game.ProductionBoostDialog=function(t){this.options=Object.assign({data:{},buttonOk:!1,context:"productionBoost",darkOverlay:!0,overlayCancel:!1,featureMarkup:function(t,e,i,a,n,o){return['<div class="featureImage '+t+'"></div>','<div class="featureContent">','<h3 class="featureTitle productionBoostTitle">'+e+"</h3>",'<div class="featureRemainingTime productionBoostSubtitle subtitle '+a+'">'+i+"</div>",'<div class="featureButton productionBoostButtonPos">'+n+"</div>",'<div class="featureDuration featureRenewal productionBoostButtonSubtitle subtitle">'+o+"</div>","</div>",'<div class="clear"></div>'].join("")}},t),this.request=function(){var t=this;this.options.data.context=this.context;var e=this.options.premiumFeatureDialogVersion;return Travian.api(this.cmd,{data:this.options.data,success:function(i){switch(e){case 1:default:t.setContent(t.createContent(t,i)),t.bindElements();break;case 2:t.setContent(i.html),t.bindEvents()}t.show()},error:function(e){t.dispose(),new Travian.Dialog.Dialog({preventFormSubmit:!0}).setContent(e.message).show()}}),this},this.toggleAutoprolong=function(t,e){var i=this,a={action:Travian.Constants.ACTION.premiumFeature,featureKey:t,toggleAutoprolong:1};Travian.api("premium",{data:a,success:function(){Travian.WindowManager.reloadWindowsByContext(e)},error:function(){i.reload()}})},this.createContent=function(t,e){var i=jQuery('<div class="paymentPopupDialogWrapper"></div>'),a=jQuery('<h1 class="headline"></h1>').html(e.title),n=jQuery('<span class="goldWrapper"></span>').html(e.gold);a.append(n);var o=jQuery('<h3 class="subHeadLine"></h3>').html(e.productionBoostChooseText),r=jQuery('<div class="featureCollection" id="featureCollectionWrapper"></div>');for(var s in e.features){var l=jQuery('<div class="feature featureBooking">').html(t.options.featureMarkup(s,e.features[s].title,e.features[s].subtitle,e.features[s].subtitleClassExtension,e.features[s].button,e.features[s].buttonSubtitle));r.append(l)}var d=jQuery('<p class="furtherInfos"></p>').html(e.furtherInfos);return i.append(a),i.append(o),i.append(r),i.append(d),i},this.bindElements=function(){var t=this,e=jQuery("#featureCollectionWrapper");e.find("button.productionBoostButton").each((function(e,i){var a=jQuery(i);a.off("click"),a.on("click",(function(e){t.requestSend=!0;var i=jQuery(window),a=jQuery(this);return a.hasClass("lumber")?i.trigger("startWayOfPayment",["productionboostLumber","productionBoost"]):a.hasClass("clay")?i.trigger("startWayOfPayment",["productionboostClay","productionBoost"]):a.hasClass("iron")?i.trigger("startWayOfPayment",["productionboostIron","productionBoost"]):a.hasClass("crop")&&i.trigger("startWayOfPayment",["productionboostCrop","productionBoost"]),!1}))})),e.find(".checkbox").each((function(e,i){var a=jQuery(i);a.off("click"),a.on("click",(function(e){return a.hasClass("prolongProductionboostLumber")?t.toggleAutoprolong("productionboostLumber","productionBoost"):a.hasClass("prolongProductionboostClay")?t.toggleAutoprolong("productionboostClay","productionBoost"):a.hasClass("prolongProductionboostIron")?t.toggleAutoprolong("productionboostIron","productionBoost"):a.hasClass("prolongProductionboostCrop")?t.toggleAutoprolong("productionboostCrop","productionBoost"):!!a.hasClass("prolongPlus")&&t.toggleAutoprolong("plus","plus")}))}))},this.bindEvents=function(){var t=this,e=jQuery("#featureCollectionWrapper");e.find(".featureButton button").each((function(){var e=jQuery(this);e.off("click.productionBoost"),e.on("click.productionBoost",(function(){t.requestSend=!0}))}));var i=["Lumber","Clay","Iron","Crop"];e.find("input[type=checkbox]").each((function(){var e=jQuery(this);e.off("change.productionBoost"),e.on("change.productionBoost",(function(){for(var e=jQuery(this),a=0;a<i.length;a++)if(e.hasClass("prolongProductionboost"+i[a])){t.toggleAutoprolong("productionboost"+i[a],"productionBoost");break}}))}))},this.close=function(){if(void 0!==this.requestSend&&!0===this.requestSend)return Travian.Autoreload.autoreload();Travian.Dialog.Ajax.prototype.close.call(this)},Travian.Dialog.Ajax.call(this,"premium/production-boost",this.options)},Travian.Game.ProductionBoostDialog.prototype=Object.create(Travian.Dialog.Ajax.prototype),Travian.Game.ProductionBoostDialog.constructor=Travian.Game.ProductionBoostDialog,Travian.Game.GoldTransferDialog=function(t,e,i){this.request=function(){var t=this;return this.options.data.context=this.context,Travian.api(this.cmd,{data:this.options.data,success:function(e){if(!0===e.showDialog)return t.setContent(t.createContent(t,e)),t.show(),!0;Travian.Autoreload.autoreload()}}),this},this.createContent=function(t,e){return e.statusText},this.close=function(){Travian.Autoreload.autoreload()},Travian.Dialog.Ajax.call(this,"gtl",{data:{code:e,messageId:t,accept:i?1:0,refuse:i?0:1}})},Travian.Game.GoldTransferDialog.prototype=Object.create(Travian.Dialog.Ajax.prototype),Travian.Game.GoldTransferDialog.constructor=Travian.Game.GoldTransferDialog,Travian.Game.HospitalBonus={showDialog:function(t,e){Travian.api("premium/hospital-bonus/"+t+"/"+e,{success:function(t){const e=new Travian.Dialog.Dialog({preventFormSubmit:!0,buttonOk:!1,cssClass:"hospitalBonusDialog"});e.setContent("<div><p>"+t.info+"</p><p><strong>"+t.bonus+'</strong></p><div class="cta">'+t.button+"</div></div>"),e.show()}},"GET")},activate:function(t,e){const i=new Travian.Game.PremiumFeature("hospital-bonus",{action:Travian.Constants.ACTION.premiumFeature,villageId:t,effect:e});i.sign((function(){i.book(Travian.Autoreload.autoreload)}))}},Travian.Game.Quest=Object.create({options:{listData:{},dialogListData:{}},setOptions:function(t){this.options=Object.assign({},this.options,t)},dialog:{quest:null,achievement:null},mentorClick:function(t){Travian.WindowManager.getWindowsByContext("quest").length>0?Travian.WindowManager.closeByContext("quest"):this.openTodoListDialog(this.options.dialogListData.answersLink)},rewardButtonClick:function(t){Travian.WindowManager.closeByContext("quest");var e="tasks",i={questTutorialId:t,action:"reward"};-1!==t.search(/DailyQuest/)&&(e="daily-quest",i={questId:t,action:"reward"}),Travian.api(e,{data:i})},openInformationDialog:function(t,e,i){var a="quest";-1===t.search(/Achievement/)&&-1===t.search(/DailyQuest/)||(a="achievement");var n=this;null===this.dialog[a]?(Travian.WindowManager.closeByContext("quest"),this.dialog[a]=new Travian.Dialog.Ajax("tasks",{data:{questTutorialId:t,action:i},context:a,buttonOk:!1,enableBackground:!1,darkOverlay:!1,draggable:!0,savePositionForSession:{preferenceKey:"QuestDialogPosition"},overlayCancel:!1,infoIcon:e,cssClass:"white questInformation "+t+" quest",preventFormSubmit:!0,buttonTextInfo:Travian.Translation.get("answers."+t.toLowerCase()+"_title")||"Answers",fx:{duration:0},onClose:function(){n.dialog[a]=null}})):(-1!==t.search(/DailyQuest/)?(this.dialog[a].cmd="daily-quest",this.dialog[a].options.data.questId=t):(this.dialog[a].cmd="tasks",this.dialog[a].options.data.questTutorialId=t),this.dialog[a].displayButtonOk(!1),this.dialog[a].options.data.action=i,this.dialog[a].options.infoIcon=e,this.dialog[a].options.buttonTextInfo=Travian.Translation.get("answers."+t.toLowerCase()+"_title")||"Answers",this.dialog[a].request()),this.dialog[a].wrapper.find("form").off("submit"),this.dialog[a].wrapper.find("form").on("submit",(function(t){return t.stopPropagation(),!1}))},openTodoListDialog:function(t,e){var i=this,a="tasks",n="quest",o=!1,r="",s=!1;null!=e&&(a="daily-quest",n="achievement",o=!0,r=Travian.Translation.get("allgemein.close_with_capital_c"),s=!0),null===this.dialog[n]?(Travian.WindowManager.closeByContext(a),this.dialog[n]=new Travian.Dialog.Ajax(a,{data:{},context:n,buttonOk:o,buttonTextOk:r,buttonCloseOnClickOk:s,enableBackground:!1,draggable:!0,infoIcon:t,savePositionForSession:{preferenceKey:"QuestDialogAchievementPosition"},overlayCancel:!1,cssClass:"white questTodoList",preventFormSubmit:!0,fx:{duration:0},onClose:function(){i.dialog[n]=null}})):(this.dialog[n].cmd=a,this.dialog[n].displayButtonOk(o),this.dialog[n].options.infoIcon=null,this.dialog[n].options.data.questId=void 0,this.dialog[n].options.data.questTutorialId=void 0,this.dialog[n].options.data.action=void 0,this.dialog[n].request())},bindListDelegation:function(t){var e=this;t.on("click",(function(t){t.stopPropagation();var i=jQuery(t.delegateTarget),a=i.attr("data-questId"),n=i.attr("data-category");n&&a&&e.openInformationDialog(a,e.options.listData[n].quests[a].answersLink)}))},addListData:function(t){for(var e in t=t||{})t.hasOwnProperty(e)&&(this.options.listData[e]=t[e])},closeDialog:function(){null!==this.dialog.quest&&this.dialog.quest.close()}}),Travian.Game.ReportSpamMessagesDialog={reportSpam:function(t,e,i,a,n){var o=[],r='<select size="1" id="spamReason">';for(var s in n)n.hasOwnProperty(s)&&(r+='<option value="'+s+'">'+n[s]+"</option>");r+='</select><br/><br/><span class="notice">'+a+"</span>";var l=new Travian.Dialog.Dialog({title:e,keepOpen:!0,buttonTextOk:i,preventFormSubmit:!0,onOpen:function(){l.disableForm()},onOkay:function(){o.length>0&&Travian.api("message/spam-report",{data:{messageId:t,spamReason:o.val()},success:function(t){void 0!==t.reportingSuccessful&&t.reportingSuccessful&&(l.setContent(t.reportingSuccessful),jQuery(".dialog button").html(t.closeButtonText),jQuery("#reportSpam").addClass("disabled").off("click").attr("onclick",(function(){return!1})),l.enableForm(),jQuery(".dialog form").on("submit",(function(t){t.stopPropagation(),l.close()})))}})}});l.setContent(r),l.show(),(o=jQuery("#spamReason")).on("change",(function(){var t="not_chosen"===o.val();l.toggleFormState(t)}))}},Travian.Game.Village={initializeWallStates:function(){var t=jQuery(".a40 .level"),e=jQuery(".a40.bottom svg, .a40.top svg"),i=jQuery(e.find("path"));t.on("focus",(function(){e.addClass("hover focus")})),t.on("blur",(function(){e.removeClass("hover focus ")})),i.hover((function(){e.addClass("hover")}),(function(){e.removeClass("hover")})),i.on("mousedown touchstart",(function(){e.addClass("active")})),i.on("mouseup mouseleave touchend",(function(){e.removeClass("active")}))},toggleMobileUnitDisplay:function(){var t=Travian.Game.Preferences.get("mobileUnitDisplay");Travian.Game.Preferences.set("mobileUnitDisplay","expanded"===t?"collapsed":"expanded")},enableVillageListShortcuts:function(){const t=jQuery("#sidebarBoxVillagelist .content .villageList"),e=t.find(".listEntry:not(.active) .coordinatesGrid"),i=e[0];void 0!==i&&i.hasAttribute("data-x")&&i.hasAttribute("data-y")&&i.hasAttribute("data-did")&&i.hasAttribute("data-villagename")&&(t.addClass("shortcutsEnabled"),e.each((function(){const t=jQuery(this);t.attr("title",t.data("title"))})),Travian.Tip.refresh(),t.find(".listEntry:not(.active)").off("click").on("click",(function(t){let e=jQuery(t.target);if(e.is(".coordinatesGrid")||e.parents(".coordinatesGrid").length>0){t.preventDefault();let e=jQuery(this).find(".coordinatesGrid");if(e.length>0){let t=parseInt(e.data("x")),i=parseInt(e.data("y")),a=parseInt(e.data("did")),n=e.data("villagename");jQuery(window).trigger("travian.villageList.coordinatesShortcut",[t,i,a,n]),jQuery(this).parents(".sidebar.mobileOpened").removeClass("mobileOpened")}}})))},disableVillageListShortcuts:function(){jQuery("#sidebarBoxVillagelist .content .villageList").removeClass("shortcutsEnabled")},getColorClassByLoyaltyValue:function(t){switch(!0){case t<Travian.Constants.MEDIUM_LOYALTY_VALUE:return"low";case t>Travian.Constants.MEDIUM_LOYALTY_VALUE:return"high";default:return"medium"}},updateLoyalty:function(t){if(!t)return;const e=jQuery("#sidebarBoxActiveVillage .loyalty"),i=this.getColorClassByLoyaltyValue(t);e.removeClass("high medium low").addClass(i),e.find("span").html(t+"%")}},Travian.Game.ActiveVillage={updateActiveVillageName:function(){Travian.api("villageList/getVillageNames",{success:function(t){let e=document.querySelector("#villageName input");e.value=t.villageNames[e.dataset.did]}},"get")}},Travian.Game.VillageList={closestDropContainer:null,enableDragAndDropSorting:function(){jQuery((function(){jQuery(".villageList .dragAndDrop").off("mousedown touchstart").on("mousedown touchstart",(function(e){if("0"===jQuery(this).find("svg.handle").css("opacity"))return!0;e.preventDefault();let i=jQuery(this).parents(".listEntry");i.addClass("dragged");let a=i.clone();a.attr("id","villageListDragElement"),a.css({width:i.width()}),i.parents(".dropContainer").prepend(a),t(e),Travian.Game.VillageList.closestDropContainer=i.parents(".dropContainer")})),jQuery(window).on("mousemove touchmove",(function(e){let i=jQuery(".villageList .listEntry.dragged");if(i.length>0){t(e);let a=Travian.getCursorPosition(e);if(Travian.Game.VillageList.closestDropContainer=i.parents(".dropContainer"),i.parents(".villageList").find(".dropContainer").each((function(){let t=jQuery(this);Math.abs(a.y-t.offset().top-t.height()/2)<Math.abs(a.y-Travian.Game.VillageList.closestDropContainer.offset().top-Travian.Game.VillageList.closestDropContainer.height()/2)&&(Travian.Game.VillageList.closestDropContainer=t)})),jQuery(".villageList .dropContainer").removeClass("highlightDropSection"),parseInt(Travian.Game.VillageList.closestDropContainer.find(".listEntry").data("did"))!==parseInt(i.data("did"))){let t=parseInt(Travian.Game.VillageList.closestDropContainer.data("sortindex"))>parseInt(i.parent(".dropContainer").data("sortindex"))?"down":"up";Travian.Game.VillageList.closestDropContainer.removeClass("up").removeClass("down").addClass("highlightDropSection "+t)}}})),jQuery(window).on("mouseup touchend",(function(t){let e=jQuery(".villageList .listEntry.dragged");if(e.length>0){let i=parseInt(e.parents(".dropContainer").data("sortindex")),a=parseInt(Travian.Game.VillageList.closestDropContainer.data("sortindex")),n=parseInt(e.data("did"));Travian.Game.VillageList.closestDropContainer.append(e),i!==a&&Travian.Game.VillageList.updateVillageSortIndex(n,a+ +(i<a));let o=Travian.Game.VillageList.closestDropContainer.parents(".villageList").find(".listEntry");a>i?o.each((function(){let t=jQuery(this);if(t.data("did")!==e.data("did")){let e=t.parent(".dropContainer"),n=e.data("sortindex");n>i&&n<=a&&e.prev(".dropContainer").append(t)}})):o.each((function(){let t=jQuery(this);if(t.data("did")!==e.data("did")){let e=t.parent(".dropContainer"),n=e.data("sortindex");n<i&&n>=a&&e.next(".dropContainer").append(t)}}));let r=jQuery("#villageListDragElement"),s=Travian.Game.VillageList.closestDropContainer.find(".listEntry:not(#villageListDragElement)");s.addClass("hidden");let l=s.offset(),d=jQuery(window).scrollTop();if("auto"===jQuery("#sidebarAfterContent").css("overflow")){let e=jQuery(t.target).parents(".sidebarBoxWrapper").css("transform").match(/-?[\d.]+/g);if(null!==e){e=parseFloat(e[0]);let t=jQuery(".villageList");d=0,l.left=t.position().left-10,l.top=s.parents(".sidebarBox").position().top/e+s.parent(".dropContainer").position().top/e+10}}r.animate({left:l.left,top:l.top-d},250),setTimeout((function(){s.removeClass("hidden"),r.remove()}),250),e.removeClass("dragged"),jQuery(".villageList .dropContainer").removeClass("highlightDropSection");const u=jQuery(".villageList .dropContainer").length;let c=jQuery(".villageList .listEntry.active").parent(".dropContainer"),p=c.prev();u>2&&p.length<=0&&(p=jQuery(".villageList .dropContainer:last-child"));let h=c.next();u>2&&h.length<=0&&(h=jQuery(".villageList .dropContainer:first-child")),jQuery(".villageList .listEntry a").attr("accesskey",null),jQuery(p.find("a")).attr("accesskey","b"),jQuery(h.find("a")).attr("accesskey","n")}else jQuery("#villageListDragElement").remove()}));let t=function(t){let e=Travian.getCursorPosition(t),i=jQuery("#sidebarAfterContent");const a="auto"===i.css("overflow");let n=jQuery(window).scrollTop();a&&(n=n-i.scrollTop()+i.offset().top);let o=jQuery("#villageListDragElement"),r=o.offset(),s=o.find(".dragAndDrop svg"),l=s.offset(),d=r.left-l.left+s.width()/2,u=l.top-r.top+s.height()/2+n;if(a){let i=jQuery(t.target).parents(".sidebarBoxWrapper").css("transform").match(/-?[\d.]+/g);null!==i&&(i=parseFloat(i[0]),jQuery("body").hasClass("rtl")?e.x=(e.x+o.width()/2)/i+10:e.x=(e.x-o.parents(".sidebarBox").offset().left)/i-10,e.y/=i,u=u/i+u-n)}o.css({left:e.x+d,top:e.y-u})}}))},updateVillageSortIndex:function(t,e){Travian.api("village/"+t+"/update-sort-index",{data:{to:e},success:Travian.emptyFunction(),error:this.onError})},update:function(t){jQuery("#sidebarBoxVillagelist").find(".listEntry a").each((function(e,i){const a=Travian.Browser.parseURL(i.href);Object.keys(t).forEach((function(e){a.searchObject[e]=encodeURIComponent(t[e])})),i.href=Travian.Browser.composeURL(a)}))},onError:function(t){const e=new Travian.Dialog.Dialog({buttonOk:!0,buttonCancel:!1,buttonCloseOnClickOk:!0,preventFormSubmit:!0,version:2,cssClass:"basic"});e.setContent(t.message),e.show()},updateIncomingTroopsTooltips:function(){const t=document.getElementById("sidebarBoxVillagelist");Travian.Tip.resetAjaxTipsInElement(t),Travian.Tip.updateAllInElement(t)},updateVillageNames:function(){Travian.api("villageList/getVillageNames",{success:function(t){[...document.querySelectorAll("#sidebarBoxVillagelist .villageList .listEntry .name")].forEach((e=>{e.innerHTML=t.villageNames[e.dataset.did]}))}},"get")}},Travian.Game.Village.RearrangeBuildings={did:null,step:1,slotFrom:null,slotTo:null,hash:null,buildingSlotPositions:{},isMousedown:!1,isDragging:!1,isDropping:!1,dragObject:null,lastCursorPosition:{x:null,y:null},closestBuildingSlot:null,initialize:function(t){this.did=t,Travian.Game.Layout.disable(),Travian.Game.contextHelpData={},jQuery("body").addClass("rearrangeBuildings"),jQuery("#contentOuterContainer .rearrangeBuildings").prependTo("#background");let e=jQuery("#background .rearrangeBuildings").removeClass("hide");setTimeout((function(){e.addClass("show")}),1),this.hash=jQuery.md5(JSON.stringify(this.getBuildingPositions())),this.bindEvents(),this.calculateBuildingSlotPositions(),this.enableDragAndDrop()},bindEvents:function(){let t=this,e=jQuery("#villageContent");e.find(".buildingSlot.movable[data-aid]").off("mouseup touchend").on("mouseup touchend",(function(){if(!t.isDragging){let e=jQuery(this),i=parseInt(e.data("aid")),a=parseInt(e.data("gid"));switch(t.step){case 1:0!==a&&(t.slotFrom=i,t.step=2);break;case 2:t.slotTo=i,t.step=3;break;default:t.slotFrom=null,t.slotTo=null,t.step=1}t.executeStep()}}));let i=e.find(".buildingSlot svg path, .buildingSlot .level");i.off("hover").off("mousedown touchstart").off("mouseup mouseleave blur touchend"),i.hover((function(){jQuery(this).parents(".buildingSlot").find(".buildingShape.iso").addClass("hover")}),(function(){jQuery(this).parents(".buildingSlot").find(".buildingShape.iso").removeClass("hover")})),i.on("mousedown touchstart",(function(){jQuery(this).parents(".buildingSlot").find(".buildingShape.iso").addClass("active")})),i.on("mouseup mouseleave blur touchend",(function(){jQuery(this).parents(".buildingSlot").find(".buildingShape.iso").removeClass("active")})),jQuery(window).on("resize",(function(){t.calculateBuildingSlotPositions()}))},executeStep:function(){let t=this,e=jQuery("#villageContent"),i=jQuery("#background .rearrangeBuildings").find(".instructions"),a=i.find(".step1"),n=i.find(".step2");switch(t.step){case 2:let o=e.find(".buildingSlot.aid"+t.slotFrom).addClass("selected"),r=o.data("name"),s=o.find(".level").data("level");n.html(Travian.Translation.get("gid15.rearrangeBuildings_step2").replace("[NAME]","<strong>"+r+"</strong>").replace("[LEVEL]",s)),a.removeClass("active"),n.addClass("active"),e.addClass("selectTarget");break;case 3:t.animateMovement(),e.removeClass("selectTarget"),i.find(".step.active").removeClass("active"),a.addClass("active")}},animateMovement:function(){let t=this,e=t.slotFrom===t.slotTo;if(!t.isDragging&&t.slotFrom===t.slotTo)return void t.animationCallback();let i=jQuery("#villageContent"),a=jQuery("body").hasClass("rtl")?"right":"left",n=i.find(".buildingSlot.aid"+t.slotFrom),o=i.find(".buildingSlot.aid"+t.slotTo),r=t.isDragging?i.find(".dragContainer"):i.find(".animationContainer.buildingFrom"),s=i.find(".animationContainer.buildingTo");n.addClass("animating"),o.addClass("animating"),t.isDragging||(r.empty(),n.find("img.building").clone().appendTo(r),n.find(".level").clone().appendTo(r)),e||(s.empty(),o.find("img.building").clone().appendTo(s),o.find(".level").clone().appendTo(s));let l={};t.isDragging||(l[a]=n.css(a),l.top=n.css("top"),r.css(l)),l[a]=o.css(a),l.top=o.css("top"),s.css(l),r.animate(l,t.isDragging?150:300),e||(l[a]=n.css(a),l.top=n.css("top"),s.animate(l,300)),setTimeout((function(){t.animationCallback(),n.removeClass("animating"),o.removeClass("animating"),r.empty(),s.empty()}),300)},animationCallback:function(){let t=this;if(t.move(),t.isDragging){let e=jQuery("#villageContent"),i=e.find(".dragContainer");t.dragObject.removeClass("dragged"),t.dragObject=null,t.isDragging=!1,t.isDropping=!1,e.removeClass("dragMode"),i.removeClass("enabled"),i.empty()}},move:function(){let t=this,e=jQuery("#villageContent"),i=e.find(".buildingSlot.aid"+t.slotFrom),a=e.find(".buildingSlot.aid"+t.slotTo);if(i.length>0&&a.length>0){let e=i.html(),n=a.html(),o=i.data("building-id"),r=a.data("building-id"),s=i.data("gid"),l=a.data("gid"),d=i.data("name"),u=a.data("name");i.html(n),a.html(e),i.data("gid",l),i.data("building-id",r),i.removeClass("g"+s).addClass("g"+l),a.data("gid",s),a.data("building-id",o),a.removeClass("g"+l).addClass("g"+s),i.data("name",u),a.data("name",d),jQuery(".buildingSlot .hover").removeClass("hover"),t.bindEvents(),i.removeClass("selected"),t.step=1,t.slotFrom=null,t.slotTo=null,t.updateProceedButton()}},getBuildingPositions:function(){let t=jQuery("#villageContent").find(".buildingSlot[data-aid]"),e={};return t.each((function(t,i){let a=jQuery(i);e[a.data("aid")]=a.data("building-id")||null})),e},isAllowedToProceed:function(){return this.hash!==jQuery.md5(JSON.stringify(this.getBuildingPositions()))},updateProceedButton:function(){let t=jQuery("#background .rearrangeBuildings").find("button.confirm");this.isAllowedToProceed()?(t.removeClass("disabled"),Travian.Tip.setContent(t,Travian.Translation.get("gid15.rearrangeBuildings"))):(t.addClass("disabled"),Travian.Tip.setContent(t,Travian.Translation.get("gid15.rearrangeToContinue")))},proceed:function(){if(this.isAllowedToProceed()){let t=new Travian.Dialog.Dialog({context:"rearrangeBuildingsConfirm",cssClass:"rearrangeBuildingsConfirmDialog",preventFormSubmit:!0,buttonOk:!1,relativeTo:jQuery("#background .rearrangeBuildings button.confirm")});t.setContent(jQuery("#background .rearrangeBuildings .proceedDialog").html()),t.show()}},wayOfPaymentDataCallback:function(){return{did:Travian.Game.Village.RearrangeBuildings.did,buildingPositions:Travian.Game.Village.RearrangeBuildings.getBuildingPositions()}},abort:function(){if(this.isAllowedToProceed()){let t=new Travian.Dialog.Dialog({context:"rearrangeBuildingsAbort",cssClass:"rearrangeBuildingsAbortDialog",preventFormSubmit:!0,buttonOk:!1,buttonCancel:!1,overlayCancel:!1,relativeTo:jQuery("#background .rearrangeBuildings .container .close svg")});t.setContent(jQuery("#background .rearrangeBuildings .abortDialog").html()),t.show()}else window.location.href="/dorf2.php"},enableDragAndDrop:function(){let t=this,e=jQuery("#background .rearrangeBuildings").find(".instructions"),i=jQuery("#villageContent"),a=jQuery("body").hasClass("rtl")?"right":"left";jQuery(".buildingSlot.movable[data-aid]").on("mousedown touchstart",(function(e){if(e.preventDefault(),t.isMousedown=!0,!t.isDragging&&!t.isDropping){let i=jQuery(this);0!==parseInt(i.data("gid"))?(t.dragObject=i,t.lastCursorPosition=Travian.getCursorPosition(e)):t.dragObject=null}})),jQuery(window).on("mousemove touchmove",(function(n){if(t.isMousedown&&1===t.step&&null!==t.dragObject){let o=Travian.getCursorPosition(n);if((!Travian.Browser.isTouchInput||new Date-t.lastCursorPosition.timestamp>200)&&(o.x!==t.lastCursorPosition.x||o.y!==t.lastCursorPosition.y)){t.isDragging=!0,i.addClass("dragMode");let n=i.find(".dragContainer");if(!n.hasClass("enabled")){let n=jQuery(t.dragObject);n.addClass("dragged");let o=i.find(".dragContainer");o.empty(),o.addClass("enabled"),n.find("img.building").clone().appendTo(o),n.find(".level").clone().appendTo(o),n.find("svg.buildingShape:not(.iso)").clone().appendTo(o);let r={};r[a]=n.css(a),r.top=n.css("top"),o.css(r),e.find(".step.active").removeClass("active");let s=n.data("name"),l=n.find(".level").data("level");e.find(".dragAndDrop").html(Travian.Translation.get("gid15.rearrangeBuildings_dragAndDrop").replace("[NAME]","<strong>"+s+"</strong>").replace("[LEVEL]",l)).addClass("active")}let r=i.offset(),s=r.left+n.width()/2,l=r.top+n.height()/2,d={};d[a]="left"===a?o.x-s:jQuery(window).outerWidth()-o.x-s+10,d.top=o.y-l,n.css(d),t.closestBuildingSlot=t.dragObject;let u=null;Object.keys(t.buildingSlotPositions).map((function(e){let i=t.buildingSlotPositions[e],a=o.y-n.height()/2,r=o.x-n.width()/2,s=Math.sqrt(Math.pow(i.left-r,2)+Math.pow(i.top-a,2));(null===u||s<u)&&(t.closestBuildingSlot=jQuery(".buildingSlot.aid"+e),u=s)})),jQuery(".dropTarget").removeClass("dropTarget"),t.closestBuildingSlot.addClass("dropTarget")}}})),jQuery(window).on("mouseup touchend",(function(){!t.isDropping&&t.isDragging&&null!==t.dragObject&&t.dragObject.length>0&&t.closestBuildingSlot.length>0&&(t.isDropping=!0,t.slotFrom=t.dragObject.data("aid"),t.slotTo=t.closestBuildingSlot.data("aid"),t.step=3,t.executeStep()),t.isMousedown=!1}))},calculateBuildingSlotPositions:function(){let t=this;t.buildingSlotPositions={},jQuery("#villageContent .buildingSlot.movable[data-aid]").each((function(){let e=jQuery(this),i=e.data("aid"),a=e.offset();t.buildingSlotPositions[i]={left:a.left,top:a.top}}))}},Travian.TabManager={initializeOnPageLoad:function(){var t=window.location.hash.trim();""!==t&&Travian.TabManager.applyAnchor(t)},initializeOnDialogLoad:function(){jQuery(".dialog .contentNavi .tabItem:not([id])").off("click.tabManger").on("click.tabManger",(function(t){t.preventDefault();var e=jQuery(this),i=e.attr("href");"#"!==i&&Travian.api(i,{success:function(t){var i=Travian.WindowManager.getWindowsByContext(e.parents(".dialogWrapper").data("context"))[0];i.updateInfoButton(t.options),i.setContent(t.content),void 0!==t.options.cssClass&&i.updateCssClass(t.options.cssClass),Travian.TabManager.initializeOnDialogLoad()},error:function(t){new Travian.Dialog.Dialog({preventFormSubmit:!0}).setContent('<div class="error">'+t.status+" "+t.statusText+"</div>").show()}},"GET")}))},handlers:{payment:function(t){jQuery(window).trigger("startPaymentWizard",{data:{activeTab:t}})}},applyAnchor:function(t){var e=t.split("-"),i=e[0].substring(1);delete e[0],e.length&&void 0!==Travian.TabManager.handlers[i]&&Travian.TabManager.handlers[i](e.join(""))}},jQuery((function(){Travian.TabManager.initializeOnPageLoad()})),Travian.Game.Vacation={dialog:null,updateVacationTime:function(t,e){var i=parseInt(Date.now())+864e5*parseInt(t);jQuery("#vacationTime").html(function(t,e){var i=function(t){return t<10?"0"+t:t},a=new Date(t.getTime()+6e4*t.getTimezoneOffset()+1e3*e);return i(a.getDate())+"."+i(a.getMonth()+1)+"."+i(a.getFullYear()%100)+", "+i(a.getHours())+":"+i(a.getMinutes())}(new Date(i),e))},closeDialog:function(){null!==this.dialog&&this.dialog.close()},showDialog:function(t){this.dialog=new Travian.Dialog.Dialog({buttonOk:!1,submitMethod:"post",submitUrl:"/options/vacation",keepOpen:!0}),this.dialog.setContent(t),this.dialog.show()},openConfirmation:function(){Travian.api("vacation-mode/confirmation",{data:{days:jQuery("#dayInput").val()},success:function(t){""!==t.html?Travian.Game.Vacation.showDialog(t.html):Travian.Game.Vacation.closeDialog()}})}},Travian.Game.Arifact={setAutoProlongue:function(t,e){Travian.api("artifact",{data:{id:t,action:"reactivate",state:e?1:0}})}},Travian.Game.ContextualHelp={groupName:"",restartableGroup:null,helpData:[],stickyElements:[],documentDimensions:{width:0,height:0},currentStep:0,isRTL:!1,isInitialized:!1,isMousedown:!1,isKeydown:!1,keyDownInterval:null,overlay:!1,initialize:function(){this.reset();var t=this,e=jQuery(document);jQuery((function(){t.documentDimensions.width=e.width(),t.documentDimensions.height=e.height(),t.isRTL=jQuery("body").hasClass("rtl");var i=Travian.Game.contextHelpData,a=i.steps||[];t.groupName=i.groupName,t.restartableGroup=i.restartableGroup,a.forEach((function(e){var i=e.stickToElement;t.addStep(e.content,i,e.boxPosition,e.arrowPosition,!!e.dismissButton,e.delay,e.teaser)}))})),jQuery(window).on("resize scroll click keyup travian.map.zoomed travian.map.imageLoaded travian.toggleMapDialog",(function(){t.updateStickyElements(),t.updateElements()})),e.on("mousedown touchstart",(function(){t.isMousedown=!0})),e.on("mouseup touchend",(function(){t.isMousedown=!1})),e.on("keydown",(function(){t.isKeydown=!0,t.keyDownInterval&&clearInterval(t.keyDownInterval),t.keyDownInterval=setInterval((function(){t.updateStickyElements(),t.updateElements()}),25)})),e.on("keyup",(function(){t.isKeydown=!1,clearInterval(t.keyDownInterval)})),e.on("mousemove",(function(){t.isMousedown&&(t.updateStickyElements(),t.updateElements())})),jQuery(window).on("travian.contextualHelp.add",(function(e,i,a,n,o,r,s,l){t.addStep(i,a,n,o,r,s,l)}))},addStep:function(t,e,i,a,n,o,r){var s=this,l=0===s.helpData.length;o=void 0!==o?o:0,r=void 0!==r?r:null,!1!==s.registerStickyElement(e)&&(s.helpData.push({content:t,stickToElement:e,boxPosition:i,arrowPosition:a,dismissButton:n,delay:o,teaser:r,active:l,dimensions:{width:0,height:0}}),setTimeout((function(){l&&(s.initialRender(),jQuery(".contextualHelp .helpBody nav svg").on("click",(function(){jQuery(this).hasClass("chevronForward")?s.currentStep+=1:s.currentStep-=1,s.updateElements()})),jQuery(".contextualHelp .helpBody nav button").on("click",(function(){s.close()})),s.isInitialized=!0),jQuery("<div></div>").appendTo(".contextualHelp .helpBody .steps").html(t),jQuery("<div></div>").appendTo(".contextualHelp .helpBody .progress"),null!==r&&!1!==s.registerStickyElement(r.stickToElement)&&jQuery("<div></div>").insertAfter(".contextualHelp .helpBody .steps").addClass("teaser hide").html(r.content),l||jQuery(".contextualHelp .helpBody .steps div:last-of-type").addClass("hide"),s.updateElements()}),1e3*o))},close:function(){var t=this;jQuery("#contextualHelp").addClass("close").fadeOut(150),setTimeout((function(){Travian.api("contextHelp/finish",{data:{group:t.groupName},success:function(){t.reset()}},"POST")}),150)},restart:function(){var t=this;this.restartableGroup!=this.groupName&&Travian.api("contextHelp/restart",{data:{group:this.restartableGroup},success:function(e){e.groupName&&e.steps&&e.steps.length>0&&(t.reset(),t.groupName=e.groupName,e.steps.forEach((function(e){var i=e.stickToElement;t.addStep(e.content,i,e.boxPosition,e.arrowPosition,!!e.dismissButton,e.delay,e.teaser)})))}},"POST")},check:function(t){this.reset();const e=this;Travian.api("contextHelp/check",{data:{page:t},success:function(t){if(Travian.Game.contextHelpData=t,t.groupName&&(!e.isInitialized||t.groupName!==e.groupName)&&t.steps&&t.steps.length>0&&(e.groupName=t.groupName,t.steps.forEach((function(t){let i=t.stickToElement;e.addStep(t.content,i,t.boxPosition,t.arrowPosition,!!t.dismissButton,t.delay,t.teaser)}))),t.restartableGroup!==e.restartableGroup){e.restartableGroup=t.restartableGroup;let i=jQuery(".contentTitle"),a=i.find("#contextualHelpButton"),n=jQuery("#tabFavorButton");t.restartableGroup&&0===a.length?(a=jQuery('<a id="contextualHelpButton" class="contentTitleButton buttonFramed green withIcon rectangle">&nbsp;</a>'),a.attr("title",Travian.Translation.get("contextHelp.show_contextual_help")),a.on("click",(function(){e.restart()})),i.append(a),n.addClass("extraMargin")):t.restartableGroup||(n.removeClass("extraMargin"),a.remove())}}},"POST")},reset:function(){this.groupName="",this.helpData=[],this.stickyElements=[],this.currentStep=0,jQuery("#contextualHelp").remove()},updateElements:function(t){void 0===t&&(t=!1);var e=this;if(!e.isInitialized||0===e.helpData.length)return;var i=e.helpData[e.currentStep],a=jQuery(window),n=jQuery(".contextualHelp .helpBody"),o=n.find(".steps div"),r=n.find("nav"),s=r.find("svg"),l=r.find(".chevronForward"),d=r.find(".chevronBack"),u=r.find("button"),c=n.find(".progress div"),p=jQuery(".contextualHelp .pointingArrow"),h=n.find(".teaser:eq("+e.currentStep+")");r.removeClass("hide"),1!==e.helpData.length||e.helpData[0].dismissButton||r.addClass("hide");var m=h.length>0&&!h.hasClass("hide");o.addClass("hide"),c.removeClass("active"),s.addClass("hide"),u.addClass("hide"),m||(n.find(".steps div:nth-of-type("+(e.currentStep+1)+")").removeClass("hide"),n.find(".progress div:nth-of-type("+(e.currentStep+1)+")").addClass("active"),e.helpData.length>1&&(e.currentStep>0&&d.removeClass("hide"),e.currentStep+1<e.helpData.length&&l.removeClass("hide")),i.dismissButton&&u.removeClass("hide"));var v=jQuery("#contextualHelp .contextualHelp"),f=v.outerWidth(),g=v.outerHeight();v.offset();let y=parseInt(v.data("currentstep"));v.removeClass("hide");var T=e.stickyElements.filter((function(t){return t.selector===i.stickToElement}))[0];if(null===i.teaser||jQuery(T.selector).is(":visible")){if(m)return h.addClass("hide"),void e.updateElements()}else{var b=e.stickyElements.filter((function(t){return t.selector===i.teaser.stickToElement}))[0];if(jQuery(b.selector).length>0&&(T=b,!m))return h.removeClass("hide"),void e.updateElements()}var C=T.isMapElement?T.mapSelector:T.selector;if(jQuery(C).is(":visible")){var w,x,k,S=27,j=m?i.teaser.boxPosition:i.boxPosition,D=m?i.teaser.arrowPosition:i.arrowPosition;let n=y!==e.currentStep;if(T.y1-5>a.height()+a.scrollTop()){var M=j;switch(j="above",k="from",x=a.height()-g,w=T.x1-(f-T.width)/2+(f-54)*(.5-D/100)-a.scrollLeft(),M){case"before":D=100,w=T.x1-f+S;break;case"after":D=0,w=T.x2-S}v.addClass("teasing")}else switch(v.removeClass("teasing"),j){case"above":x=T.y1-g-5,w=T.x1-(f-T.width)/2+(f-54)*(.5-D/100),k="from",x<0&&(j="below",x=T.y2+5),w<0&&(j="after",w=T.x2+5,x=T.y1-(g-T.height)/2+(g-54)*(.5-D/100),k="top"),w+f>e.documentDimensions.width&&(j="before",w=T.x1-f-5,x=T.y1-(g-T.height)/2+(g-54)*(.5-D/100),k="top");break;case"below":if(x=T.y2+5,w=T.x1-(f-T.width)/2+(f-54)*(.5-D/100),k="from",x+g>a.height()+a.scrollTop()){j="above";let t=T.y1-g-5;if(t>=0)x=t;else{j="above",k="from";let t=50;x=a.height()+window.scrollY>T.y2-t?T.y2-g-window.scrollY-t:a.height()-g,w=T.x1-(f-T.width)/2+(f-54)*(.5-D/100)-a.scrollLeft(),v.addClass("teasing")}}w<0&&(j="after",w=T.x2+5,x=T.y1-(g-T.height)/2+(g-54)*(.5-D/100),k="top"),w+f>e.documentDimensions.width&&(j="before",w=T.x1-f-5,x=T.y1-(g-T.height)/2+(g-54)*(.5-D/100),k="top");break;case"before":w=T.x1-f-5,k="top",(x=T.y1-(g-T.height)/2+(g-54)*(.5-D/100))<0&&(j="below",x=T.y2+5,w=T.x1-(f-T.width)/2+(f-54)*(.5-D/100),k="from"),x+g>a.height()+a.scrollTop()&&(j="above",k="from",D=100,x=T.y1-g-5,w=T.x1-f+S),w<0&&(j="after",w=T.x2+5),(w+f>e.documentDimensions.width||t&&v.hasClass("above"))&&(j="above",k="from",D=50,x=T.y1-g-5,w=T.x1-(f-T.width)/2+(f-54)*(.5-D/100));break;case"after":w=T.x2+5,k="top",(x=T.y1-(g-T.height)/2+(g-54)*(.5-D/100))<0&&(j="below",x=T.y2+5,w=T.x1-(f-T.width)/2+(f-54)*(.5-D/100),k="from"),x+g>a.height()+a.scrollTop()&&(j="above",k="from",D=0,x=T.y1-g-5,w=T.x2-S),w+f>e.documentDimensions.width&&(j="before",w=T.x1-f-5),(w<0||t&&v.hasClass("above"))&&(j="above",k="from",D=50,x=T.y1-g-5,w=T.x1-(f-T.width)/2+(f-54)*(.5-D/100))}if(T.isMapElement){var I=jQuery("body.map.fullScreen");if(I.length<=0&&(I=jQuery("#content.map")),I.length>0){var O=I.outerWidth(),L=I.outerHeight(),P=I.offset();T.x2<=P.left||T.x1>=P.left+O||T.y2<=P.top||T.y2>=P.top+L?v.addClass("hide"):I.hasClass("fullScreen")||(D=T.x2<=P.left+O/2?80:20,x="below"===(j=T.y2<=P.top+L/2?"above":"below")?T.y2+5:T.y1-g-5,w=T.x1-(f-T.width)/2+(f-54)*(.5-D/100))}}var Q=!v.hasClass(j);v.removeClass("above").removeClass("below").removeClass("before").removeClass("after").addClass(j),Q||(e.isRTL?n?v.stop().animate({right:w+"px",top:x+"px"},250):v.css({right:w+"px",top:x+"px"}):n?v.stop().animate({left:w+"px",top:x+"px"},250):v.css({left:w+"px",top:x+"px"}),"from"===k?e.isRTL?p.css({top:0,right:D+"%"}):p.css({top:0,left:D+"%"}):e.isRTL?p.css({right:0,top:D+"%"}):p.css({left:0,top:D+"%"}),v.data("currentstep",e.currentStep)),Q&&e.updateElements(!0)}else v.addClass("hide")},registerStickyElement:function(t){var e=this,i=[];i.selector=t,i.isMapElement=/^MapID/.test(t),i.mapSelector="."+Travian.Game.Map.mapIds[t.replace("MapID.","")],jQuery("#contextualHelp").removeClass("overlay"),/\.dialog/.test(t)&&(this.overlay=!0);var a=jQuery(i.isMapElement?i.mapSelector:t);if(!(a.length>0))return!1;var n=a.offset();i.width=a.outerWidth(),i.height=a.outerHeight();var o=jQuery(window),r=e.documentDimensions.width-o.width();e.isRTL?(i.x1=e.documentDimensions.width-r-n.left-i.width,i.x2=e.documentDimensions.width-r-n.left):(i.x1=n.left,i.x2=n.left+i.width),i.y1=n.top,i.y2=n.top+i.height,e.stickyElements.push(i)},updateStickyElements:function(){var t=this,e=jQuery(window),i=t.documentDimensions.width-e.width();t.stickyElements.map((function(e){var a=jQuery(e.isMapElement?e.mapSelector:e.selector);if(a.length>0){var n=a.offset();e.width=a.outerWidth(),e.height=a.outerHeight(),t.isRTL?(e.x1=t.documentDimensions.width-i-n.left-e.width,e.x2=t.documentDimensions.width-i-n.left):(e.x1=n.left,e.x2=n.left+e.width),e.y1=n.top,e.y2=n.top+e.height}else e.isMapElement&&(e.mapSelector="."+Travian.Game.Map.mapIds[e.selector.replace("MapID.","")])}));var a=jQuery(document);t.documentDimensions.width=a.width(),t.documentDimensions.height=a.height()},initialRender:function(){jQuery('<div id="contextualHelp"></div>').prependTo("body"),this.overlay&&jQuery("#contextualHelp").addClass("overlay");let t='<div class="contextualHelp" data-currentstep="0"><div class="arrowContainer"><svg class="pointingArrow" viewBox="0 0 20 20"><path d="M20 0L1 10L20 20"/></svg></div> <div class="helpBody"><div class="progress"></div><div class="steps"></div><nav>   <svg class="chevronBack" viewBox="0 0 20 20" preserveAspectRatio="none">      <path d="M19 1L1 10L19 19"/>   </svg>   <svg class="chevronForward" viewBox="0 0 20 20" preserveAspectRatio="none">      <path d="M1 1L19 10L1 19"/>   </svg>   <button type="button" class="textButtonV1">'+Travian.Translation.get("allgemein.ok")+"</button></nav></div></div>";jQuery(t).appendTo("#contextualHelp")}},Travian.Game.Profile={},Travian.Game.Profile.Languages={init:function(t,e,i,a){var n,o={},r=!1,s=!1,l="",d=jQuery(t),u=jQuery(t+" #playerLanguages"),c=jQuery(t+" .addLanguageButton"),p=function(){r=Object.keys(o).length>1,s=Object.keys(o).length<4,r?u.addClass("deletable"):u.removeClass("deletable"),s?d.addClass("addable"):d.removeClass("addable")};let h=function(e){if(void 0!==e&&!o.hasOwnProperty(e)){let a=i[e],n=a.langNative+" ("+a.countryNative+")";Travian.SVGHandler.get("flags/"+a.flag+".svg",(function(i){u.append(jQuery('<div class="flagContainer" title="'+n+'" data-flag="'+e+'" >'+i+'<input value="'+e+'" type="hidden" name="languages[]"/></div>')),Travian.Tip.updateAllInElement(t)}),{attributes:{title:n,class:"languageFlag"},titleFollowsPath:!1}),o[e]=e}window.dispatchEvent(new CustomEvent("travian.profileLanguages.sync",{detail:{languagesSelected:o}}))};var m=function(e,i){Object.values(e).length>0&&(h(e.language),p()),i.close(),Travian.Tip.updateAllInElement(t),Travian.Form.UnloadHelper.updateSubmitButtons(jQuery(a))};e.forEach((function(t){h(t)})),p(),u.on("click",".flagContainer",(function(t){var e=jQuery(t.target);if(1===Object.keys(o).length)return!0;var i=e.data("flag");delete o[i],e.remove(),p(),Travian.Form.UnloadHelper.updateSubmitButtons(jQuery(a))})),c.off("click").on("click","",(function(t){t.preventDefault();var e={},i=new Travian.Dialog.Dialog({version:2,preventFormSubmit:!0,buttonOk:!1,cssClass:"profileLanguages"});i.form.keydown((function(t){13===t.keyCode&&m(e,i)}));var a=function(t,e){var i=Object.values(o),a="profile-languages?"+jQuery.param({query:e,languages:i});Travian.api(a,{success:function(e){t(e)}},"GET","html")};jQuery("body").off("keyup",'#dialogLanguagesList input[type="text"]').on("keyup",'#dialogLanguagesList input[type="text"]',(function(t){clearTimeout(n),n=setTimeout((function(){l=jQuery(t.target).val(),a((function(t){i.setContent(t),jQuery('#dialogLanguagesList input[type="text"]').val(l),jQuery('#dialogLanguagesList input[type="text"]').focus()}),jQuery(t.target).val())}),700)})),jQuery("body").off("click","#dialogLanguagesList label").on("click","#dialogLanguagesList label",(function(t){var i=jQuery(this).data("language");e={language:i}})),jQuery("body").off("click","#dialogLanguagesList button").on("click","#dialogLanguagesList button",(function(t){m(e,i)})),a((function(t){i.setContent(t).show(),jQuery('#dialogLanguagesList input[type="text"]').focus()}))}))}},Travian.Game.Manual={dialog:null,position:null,open:function(t,e){void 0===t&&(t=0),void 0===e&&(e=0);let i=this;new Travian.api("manual/"+t+"/"+e,{success:function(t){let e=jQuery(".dialogWrapper[data-context=manual]");0===e.length?(i.dialog=new Travian.Dialog.Dialog({context:"manual",title:Travian.Translation.translate("{allgemein.anleitung}"),buttonOk:!1,enableBackground:!1,draggable:!0,cssClass:"manual"}),i.position=null):i.position=e.position(),i.dialog.setContent(t.html),i.dialog.show(),null!==i.position&&i.dialog.setPosition({x:i.position.left,y:i.position.top})},error:function(t){let e=new Travian.Dialog.Dialog({buttonOk:!0,buttonCloseOnClickOk:!0,preventFormSubmit:!0});e.setContent(t.message),e.show()}},"GET")}},Travian.Game.Map=function(){var t=0;return{_map:null,Containers:null,version:1,getNewId:function(){return"mapId"+ ++t},mapIds:{},isPositionInRect:function(t,e){return t.x0<=e.x&&t.y0<=e.y&&e.x<=t.x1&&e.y<=t.y1},register:function(t){},wrapCoordinate:function(t,e){var i=Travian.Variables.Map.Size;return{$x:((t-i.left)%i.width+i.width)%i.width+i.left,$y:((e-i.bottom)%i.height+i.height)%i.height+i.bottom}},xy2id:function(t,e){var i=this.wrapCoordinate(t,e),a=Travian.Variables.Map.Size;return(a.top-i.$y)*a.width+(i.$x-a.left)+1},popup:function(t,e){e=e||{};var i=Object.keys(e).filter((function(t){return e[t]})).reduce((function(t,e){return t+","+e+"=yes"}),"");return window.open(t,e.id||"_blank",i,!0)}}}(),Travian.Game.Map.Base=function(t,e){var i;for(i in this.options=Object.assign({},t),t)t.hasOwnProperty(i)&&(this[i]=t[i]);if(null==this.id&&(this.id=Travian.Game.Map.getNewId()),e){this.parentContainer=e;for(var a=0;a<this.globalProperties.length;a++)i=this.globalProperties[a],this.parentContainer[i]&&(this[i]=this.parentContainer[i]);"Travian.Game.Map.Container"===e.classType?this.mapContainer=e:e.mapContainer&&(this.mapContainer=this.parentContainer.mapContainer)}},Travian.Game.Map.Base.prototype.classType="Travian.Game.Map.Base",Travian.Game.Map.Base.prototype.id=null,Travian.Game.Map.Base.prototype.element=null,Travian.Game.Map.Base.prototype.position=null,Travian.Game.Map.Base.prototype.mapCoordinates=null,Travian.Game.Map.Base.prototype.contextMenu=null,Travian.Game.Map.Base.prototype.transition=null,Travian.Game.Map.Base.prototype.updater=null,Travian.Game.Map.Base.prototype.globalProperties=["cookie","dataStore","transition","updater","contextMenu"],Travian.Game.Map.Base.prototype.parentContainer=null,Travian.Game.Map.Base.prototype.render=function(t){return(t=t||{}).nodeType||(t.nodeType="<div/>"),this.element=jQuery(t.nodeType).prop("unselectable","on"),this},Travian.Game.Map.Base.prototype.destroy=function(){this.element&&this.element.remove()},Travian.Game.Map.Base.prototype.isCoordinatesInRect=function(t){return this.mapCoordinates.x<=t.x&&this.mapCoordinates.y<=t.y&&t.x<=this.mapCoordinates.right&&t.y<=this.mapCoordinates.top},Travian.Game.Map.Base.prototype.isPositionInRect=function(t){return Travian.Game.Map.isPositionInRect({x0:this.position.x,y0:this.position.y,x1:this.position.x+this.position.width,y1:this.position.y+this.position.height},t)},Travian.Game.Map.Dialog=function(){this.open=function(t,e,i){new Travian.Dialog.Ajax("map/tile-details",Object.assign({},t,{context:"map",stickToUrlOnRestore:!0,data:{x:e.x,y:e.y},onOpen:function(t,e){null!=i&&(jQuery(e).find('a[href^="/karte.php"]').on("click",(function(e){e.preventDefault();var a=Travian.Browser.parseURL(e.target.href);return i.moveTo({x:parseInt(a.searchObject.x||"0"),y:parseInt(a.searchObject.y||"0")}),t.close(),!1})),setTimeout((function(){jQuery(window).trigger("travian.toggleMapDialog")}),500))},onClose:function(){setTimeout((function(){jQuery(window).trigger("travian.toggleMapDialog")}),500)}}))}},Travian.Game.Map.Container=function(){var t=function(t){this.blocks=null,this.classType="Travian.Game.Map.Container",this.containerRender=null,this.containerSize=null,this.containerViewSize=null,this.currentMousePosition={browserAbsolute:{x:null,y:null},browser:{x:null,y:null},map:{x:null,y:null}},this.element=null,this.elementSize=null,this.eventsEnabled=!0,this.noGrid=!1,this.loading=!1,this.forcedUpdates=0,this.savedURL={},this.mapMarks={},this.addSymbol=function(t){var e=this.blocks.find((function(e){return e.isCoordinatesInRect(t.position)}));return e&&e.addSymbol(t),this},this.deleteSymbol=function(t){var e=this.blocks.find((function(e){return e.isCoordinatesInRect(t.position)}));return e&&e.deleteSymbol(t),this},this.disableEvents=function(){return this.eventsEnabled=!1,this},this.enableEvents=function(){return this.eventsEnabled=!0,this},this.forceUpdateBlocksLayer=function(t){return this.forcedUpdates=this.forcedUpdates+1,this.blocks.forEach((function(e){e.forceUpdateLayer(t)})),this},this.forceUpdateBlocksSymbols=function(t,e){return this.blocks.forEach((function(i){i.forceUpdateSymbols(t,e)})),this},this.getContentForTooltip=function(t){var e=this.blocks.find((function(e){return e.isPositionInRect(t)}));return!!e&&e.getContentForTooltip(t)},this.setContainerSizes=function(t){this.containerViewSize={x:t.x,y:t.y,width:t.width,height:t.height,right:t.x+t.width,bottom:t.y+t.height},this.containerSize={x:this.containerViewSize.x,y:this.containerViewSize.y,width:Math.ceil(this.containerViewSize.width/this.blockSize.width)*this.blockSize.width,height:Math.ceil(this.containerViewSize.height/this.blockSize.height)*this.blockSize.height,right:this.containerViewSize.x+Math.ceil(this.containerViewSize.width/this.blockSize.width)*this.blockSize.width,bottom:this.containerViewSize.y+Math.ceil(this.containerViewSize.height/this.blockSize.height)*this.blockSize.height}},this.positionChange=function(){var t=Object.assign(this.containerRender.getDimensions({computeSize:!0}),this.containerRender.getPosition()),e={x:this.containerViewSize.x-t.x,y:this.containerViewSize.y-t.y};this.setContainerSizes(t),this.miniMap.containerPosition=this.miniMap.container.getPosition(),this.transition.containerPositionChange(e)},this.invalidateBlockVersionCache=function(){for(var t in this.blocks)this.blocks.hasOwnProperty(t)&&this.blocks[t].invalidateVersionCache();return this},this.isEventsEnabled=function(){return this.eventsEnabled},this.updateBrowserURL=function(t){this.savedURL.searchObject=Object.assign(this.savedURL.searchObject,t),window.history.replaceState(this.savedURL,document.title,Travian.Browser.composeURI(this.savedURL)),jQuery(document).trigger("toolbar.updateCoordinates",[t])},this.move=function(t){return this.transition.move(t),null!==this.blocks&&this.blocks.forEach((function(e){e.move(t)})),this.loading&&(this.blockInitialDelta||(this.blockInitialDelta={x:0,y:0}),this.blockInitialDelta.x+=t.x,this.blockInitialDelta.y+=t.y),this.onMove(this,t),this},this.moveDown=function(t){return"string"==typeof t&&(t=this.speeds[t]),t?this.move({x:0,y:t}):this},this.moveLeft=function(t){return"string"==typeof t&&(t=this.speeds[t]),t?this.move({x:t,y:0}):this},this.moveLeftDown=function(t){return"string"==typeof t&&(t=this.speeds[t]),t?this.move({x:t,y:t}):this},this.moveLeftUp=function(t){return"string"==typeof t&&(t=this.speeds[t]),t?this.move({x:t,y:-t}):this},this.moveRight=function(t){return"string"==typeof t&&(t=this.speeds[t]),t?this.move({x:-t,y:0}):this},this.moveRightDown=function(t){return"string"==typeof t&&(t=this.speeds[t]),t?this.move({x:-t,y:t}):this},this.moveRightUp=function(t){return"string"==typeof t&&(t=this.speeds[t]),t?this.move({x:-t,y:-t}):this},this.moveTo=function(t){var e=this.transition.translateToBrowser({x:Math.floor(t.x),y:Math.floor(t.y)});return e.x+=this.blockSize.width/this.transition.elementsPerBlock.x/2,e.y+=this.blockSize.height/this.transition.elementsPerBlock.y/2,e.x+=(this.containerSize.width-this.containerViewSize.width)/2,e.y+=(this.containerSize.height-this.containerViewSize.height)/2,this.updateBrowserURL(t),this.move({x:this.elementSize.width/2-e.x,y:-(this.elementSize.height/2-e.y)})},this.moveUp=function(t){if("string"==typeof t&&(t=this.speeds[t]),t)return this.move({x:0,y:-t})},this.openDialog=function(t,e,i){(new Travian.Game.Map.Dialog).open(t,e,i)},this.render=function(){return this.container=jQuery("<div></div>").css({overflow:"hidden",position:"relative",left:0,top:0,width:"100%",height:"100%",right:0,bottom:0}).prop("unselectable","on").attr("oncontextmenu","return false;").prependTo(this.containerRender),this.elementSize={x:-this.blockSize.width*this.blockOverflow,y:-this.blockSize.height*this.blockOverflow,width:this.containerSize.width+this.blockSize.width*this.blockOverflow*2,height:this.containerSize.height+this.blockSize.height*this.blockOverflow*2},Travian.Game.Map.Base.prototype.render.call(this),this.element.css({position:"absolute",left:this.elementSize.x,top:this.elementSize.y,width:this.elementSize.width,height:this.elementSize.height}).prependTo(this.container),this.containerMover=jQuery("<div></div>").css({overflow:"hidden",position:"absolute",left:0,top:0,width:this.containerViewSize.width,height:this.containerViewSize.height,zIndex:100,backgroundColor:"transparent",opacity:1}).prop("unselectable","on").appendTo(this.container),this.onRender(this),this.moveTo(this.mapInitialPosition),this.renderBlocks(),this.updateGrid(),function(t){var e=!1,i=!1,a=null,n={count:0,shift:!1,control:!1,alt:!1,keys:{},fn:null};for(var o in t.keyboard)t.keyboard.hasOwnProperty(o)&&(t.keyboard[o],"string"==typeof t.keyboard[o]&&(t.keyboard[o]={fn:t.keyboard[o]}),t.keyboard[o]=Object.assign({periodical:1},t.keyboard[o]),"string"==typeof t.keyboard[o].fn&&(n.keys[o]=!1));var r=t.containerRender.css("cursor"),s=function(t){return jQuery(t.target).closest("div.dialogContainer").length},l=function(n,o,r,l){if(!s(n)&&t.isEventsEnabled()){var d=3===n.which||2===n.button;t.containerViewSize.x<=o&&t.containerViewSize.y<=r&&o<=t.containerViewSize.right&&r<=t.containerViewSize.bottom&&l===t.containerMover.get(0)&&!d&&(e=!0,i=!1,a={x:o,y:r},n.stopPropagation())}},d=function(n,o,r){if(t.containerViewSize.x<=o&&t.containerViewSize.y<=r&&o<=t.containerViewSize.right&&r<=t.containerViewSize.bottom?(t.currentMousePosition.browserAbsolute.x=o,t.currentMousePosition.browserAbsolute.y=r,t.currentMousePosition.browser.x=o-t.containerSize.x-t.elementSize.x,t.currentMousePosition.browser.y=r-t.containerSize.y-t.elementSize.y,t.currentMousePosition.map=t.transition.translateToMap(t.currentMousePosition.browser,{})):(t.currentMousePosition.browserAbsolute.x=null,t.currentMousePosition.browserAbsolute.y=null,t.currentMousePosition.browser.x=null,t.currentMousePosition.browser.y=null,t.currentMousePosition.map.x=null,t.currentMousePosition.map.y=null),e&&t.isEventsEnabled()){var s={x:o-a.x,y:-(r-a.y)};Math.abs(s.x)+Math.abs(s.y)>0&&(a={x:o,y:r},i=!0,t.containerRender.css({cursor:"move"}),t.move(s)),n.stopPropagation()}},u=function(a,n,o){if(!s(a)&&t.isEventsEnabled()){var l=3===a.which||2===a.button;if(null!==n&&null!==o&&t.containerViewSize.x<=n&&t.containerViewSize.y<=o&&n<=t.containerViewSize.right&&o<=t.containerViewSize.bottom&&!l&&!i&&e&&!Travian.WindowManager.checkOpenWindowByContext("map")){var d=t.transition.translateToMap({x:n-t.containerViewSize.x-t.elementSize.x,y:o-t.containerViewSize.y-t.elementSize.y},{});"dialog"===t.tileDisplayInformation.type?t.openDialog(t.tileDisplayInformation.optionsDialog,d,t):Travian.Game.Map.popup(Travian.Helpers.substitute(t.tileDisplayInformation.optionsPopup.url,d),t.tileDisplayInformation.optionsPopup.windowOptions)}t.containerRender.css({cursor:r}),i&&(a.stopPropagation(),t.updateBrowserURL(t.transition.getPointOfCenterInView())),e=!1,i=!1}},c=null;jQuery(window).on({selectstart:function(e){if(!s(e)&&t.isEventsEnabled()&&i)return e.stopPropagation(),!1},dragstart:function(e){if(!$(e.target).closest("div.dialogContainer").length&&t.isEventsEnabled()&&i)return e.stopPropagation(),!1},mousedown:function(t){l(t,t.pageX,t.pageY,t.target)},mousemove:function(t){s(t)||(d(t,t.pageX,t.pageY),t.preventDefault())},mouseup:function(t){u(t,t.pageX,t.pageY)},touchstart:function(t){c=t,l(t,t.touches[0].pageX,t.touches[0].pageY,t.touches[0].target)},touchend:function(e){var i=c.touches[0].pageX,a=c.touches[0].pageY;if(c=null,u(e,i,a),e.target===t.containerMover.get(0))return!1},keydown:function(e){t.isEventsEnabled()&&(e.shiftKey&&(n.shift=!0),e.ctrlKey&&(n.control=!0),e.altKey&&(n.alt=!0),!1===n.keys[e.keyCode]&&"input"!==e.target.nodeName.toLowerCase()&&(n.count++,n.keys[e.keyCode]=!0,e.stopPropagation(),n.fnTimer||(n.fn=function(){var e=0;for(var i in n.keys)if(n.keys.hasOwnProperty(i)&&n.keys[i]){if(n.keys[i]){if(!t.keyboard[i])return;var a=t.keyboard[i].fn;if(!1===a||!t[a])return;var o="";if("move"===a.substring(0,4)){o="normal";var r=t.keyboard.speed.slow,s=t.keyboard.speed.fast;n[r]&&!n[s]?o="slow":!n[r]&&n[s]&&(o="fast")}else"zoom"===a.substring(0,4)&&(o=null);t[a](o)}e+=t.keyboard[i].periodical}e>0&&(n.fnTimer=requestAnimationFrame(n.fn))},0===t.keyboard[e.keyCode].periodical?n.fn():t.keyboard[e.keyCode].periodical>0&&(n.fnTimer=requestAnimationFrame(n.fn)))))},keyup:function(e){t.isEventsEnabled()&&(e.shift||(n.shift=!1),e.control||(n.control=!1),e.alt||(n.alt=!1),n.keys[e.keyCode]&&(n.count--,n.keys[e.keyCode]=!1,e.stopPropagation(),0===n.count&&n.fnTimer&&(cancelAnimationFrame(n.fnTimer),n.fnTimer=null,t.updateBrowserURL(t.transition.getPointOfCenterInView()))))}}),window.addEventListener("touchmove",(function(e){return e.target===t.containerMover.get(0)&&e.preventDefault(),d(e,e.touches[0].pageX,e.touches[0].pageY),!1}),{passive:!1}),window.addEventListener("wheel",(function(e){if(t.isEventsEnabled()&&t.containerViewSize.x<=e.pageX&&t.containerViewSize.y<=e.pageY&&e.pageX<=t.containerViewSize.right&&e.pageY<=t.containerViewSize.bottom&&e.target===t.containerMover.get(0)){e.preventDefault();const i=t.transition.translateToMap({x:e.pageX-t.containerViewSize.x-t.elementSize.x,y:e.pageY-t.containerViewSize.y-t.elementSize.y},{});e.deltaY>0?t.zoomOut(i):e.deltaY<0&&t.zoomIn(i)}}),{passive:!1})}(this),this},this.renderBlocks=function(){if(this.blocks)return this;this.blocks=[];var t=Math.ceil(this.elementSize.width/this.blockSize.width),e=Math.ceil(this.elementSize.height/this.blockSize.height),i=Object.assign({x:0,y:0},this.blockInitialDelta);delete this.blockInitialDelta;for(var a=null,n=null,o=null,r=0,s=0;r<e;r++)for(var l=0;l<t;l++)a=Travian.Game.Map.Layer.Block.getCorrectPosition({x:l*this.blockSize.width+i.x,y:r*this.blockSize.height-i.y,width:this.blockSize.width,height:this.blockSize.height},this).position,n=this.transition.translateToMap(a,{}),o={id:s++,version:0},this.data.blocks[n.x]&&this.data.blocks[n.x][n.y]&&this.data.blocks[n.x][n.y][n.right]&&this.data.blocks[n.x][n.y][n.right][n.top]&&(o=Object.assign({},o,this.data.blocks[n.x][n.y][n.right][n.top])),this.blocks.push(new Travian.Game.Map.Layer.Block(Object.assign({},this.options.block,{id:o.id,symbolTypes:this.symbolTypes,position:a,mapCoordinates:n,version:o.version}),this));return this},this.toggleMiniMap=function(){return this.miniMap.animate()},this.toggleOutline=function(){return this.outline.animate()},this.toggleGrid=function(){var t=!this.noGrid;Travian.Game.Preferences.set("grid",t),this.noGrid=t,this.updateGrid()},this.updateGrid=function(){var t=!this.noGrid&&this.grid[this.transition.zoomLevel];return this.element.find(".imageMark").each((function(e,i){jQuery(i).css({backgroundColor:"transparent",backgroundImage:!1!==t?"url("+t+")":"none",backgroundPosition:"left top",backgroundRepeat:"repeat"})})),this},this.updateSymbolData=function(t){var e=this.blocks.find((function(e){return e.isCoordinatesInRect(t.position)}));return e&&e.updateSymbolData(t),this},this.zoom=function(t,e){var i=this.transition.zoomLevel;return this.transition.zoom(t)&&(this.savedURL.searchObject.zoom=this.transition.zoomLevel,this.onZoom(this),(Travian.Variables.feature_flags.territory&&3===i||3===this.transition.zoomLevel)&&this.dataStore.removeAllOfType(Travian.Game.Map.DataStore.TYPE_TOOLTIP),this.moveTo(e),this.updateGrid(),jQuery(window).trigger("travian.map.zoomed")),this},this.zoomIn=function(t){return t||(t=this.transition.getPointOfCenterInView()),this.zoom(-1,t)},this.zoomOut=function(t){return t||(t=this.transition.getPointOfCenterInView()),this.zoom(1,t)},this.loading=!0,void 0===t&&(t=Travian.Game.Map.Options.Default),Travian.Game.Map.Base.call(this,t),this.onMove=this.onMove||Travian.emptyFunction,this.onCreate=this.onCreate||Travian.emptyFunction,this.onRender=this.onRender||Travian.emptyFunction,this.onZoom=this.onZoom||Travian.emptyFunction,Travian.Game.Map.register(this),this.containerRender=this.container=jQuery(this.container),Travian.Game.Map._map=this;var e={x:this.containerRender.offset().left,y:this.containerRender.offset().top,width:this.containerRender.width(),height:this.containerRender.height()};this.setContainerSizes(e);for(var i=0;i<this.globalProperties.length;i++){var a=this.globalProperties[i],n=Travian.Helpers.capitalizeFirstLetter(a);Travian.Game.Map[n]&&(this[a]=new Travian.Game.Map[n](this[a]||{},this))}this.data.elements&&this.dataStore.setMultiple(Travian.Game.Map.DataStore.TYPE_TILE,this.data.elements),this.noGrid=!!Travian.Game.Preferences.get("grid"),this.onCreate(this),this.savedURL=Travian.Browser.parseURL(window.location.href),this.render(),this.loading=!1,jQuery("window").on({resize:this.positionChange.bind(this)})};return t.prototype=Object.create(Travian.Game.Map.Base.prototype),t.constructor=t,t}(),Travian.Game.Map.Transition=function(){var t=[],e=function(t){t.elementsPerBlock=t.zoomOptions.sizes[t.zoomLevel-1],t.pixelPerTile={x:t.mapContainer.blockSize.width/t.elementsPerBlock.x,y:t.mapContainer.blockSize.height/t.elementsPerBlock.y},t.elementsInView={x:t.elementsPerBlock.x*t.mapContainer.containerSize.width/t.mapContainer.blockSize.width,y:t.elementsPerBlock.y*t.mapContainer.containerSize.height/t.mapContainer.blockSize.height}},i=function(i,a){this.classType="Travian.Game.Map.Transition",this.elementsPerBlock=null,this.pixelPerTile=null,this.zoomLevel=null,this.zoomOptions=null,this.border=null,this.mapContainer=null,this.getPointOfCenterInView=function(){var t={x:this.mapContainer.containerViewSize.x+this.mapContainer.containerViewSize.width/2,y:this.mapContainer.containerViewSize.y+this.mapContainer.containerViewSize.height/2};return t.x-=this.mapContainer.containerSize.x,t.y-=this.mapContainer.containerSize.y,t.x-=this.mapContainer.elementSize.x,t.y-=this.mapContainer.elementSize.y,this.translateToMap(t,{})},this.containerPositionChange=function(t){this.positionOrigin.browser.x-=t.x,this.positionOrigin.browser.y+=t.y},this.move=function(t){return this.positionOrigin.browser.x+=t.x,this.positionOrigin.browser.y-=t.y,this.onMove(this,t),this},this.registerCallbackOnZoom=function(e){return t.push(e),this},this.translateToBrowser=function(t){var e=this.mapContainer.containerSize.x+this.mapContainer.elementSize.x,i=this.mapContainer.containerSize.y+this.mapContainer.elementSize.y,a=this.mapContainer.blockSize.height/this.elementsPerBlock.y;return{x:(t.x-this.positionOrigin.map.x)*this.pixelPerTile.x+this.positionOrigin.browser.x-e,y:(this.positionOrigin.map.y-t.y)*this.pixelPerTile.y-a-i+this.positionOrigin.browser.y}},this.translateToMap=function(t,e){e=Object.assign({round:!0,correct:!0},e||{});var i=this.mapContainer.containerSize.x+this.mapContainer.elementSize.x,a=this.mapContainer.containerSize.y+this.mapContainer.elementSize.y,n=this.mapContainer.blockSize.height/this.elementsPerBlock.y;void 0!==t.height&&(n=t.height);var o=null;return o=e.round?{x:Math.floor((t.x+i-this.positionOrigin.browser.x)/this.pixelPerTile.x)+this.positionOrigin.map.x,y:this.positionOrigin.map.y-Math.floor((t.y+n+(a-this.positionOrigin.browser.y))/this.pixelPerTile.y)}:{x:(t.x+i-this.positionOrigin.browser.x)/this.pixelPerTile.x+this.positionOrigin.map.x-1,y:this.positionOrigin.map.y-(t.y+n+(a-this.positionOrigin.browser.y))/this.pixelPerTile.y},t.width&&(o.right=o.x+t.width/this.pixelPerTile.x-1),t.height&&(o.top=o.y+t.height/this.pixelPerTile.y-1),e.correct&&(o=function(t,e){var i=!1;do{i=!1,Math.round(t.x)>e.border.right?(t.x=e.border.left+(t.x-e.border.right)-1,i=!0):Math.round(t.x)<e.border.left&&(t.x=e.border.right-(e.border.left-t.x)+1,i=!0),Math.round(t.right)>e.border.right?(t.right=e.border.left+(t.right-e.border.right)-1,i=!0):Math.round(t.right)<e.border.left&&(t.right=e.border.right-(e.border.left-t.right)+1,i=!0),Math.round(t.y)>e.border.top?(t.y=e.border.bottom+(t.y-e.border.top)-1,i=!0):Math.round(t.y)<e.border.bottom&&(t.y=e.border.top-(e.border.bottom-t.y)+1,i=!0),Math.round(t.top)>e.border.top?(t.top=e.border.bottom+(t.top-e.border.top)-1,i=!0):Math.round(t.top)<e.border.bottom&&(t.top=e.border.top-(e.border.bottom-t.top)+1,i=!0)}while(i);return t}(o,this)),o},this.zoom=function(i){if(0===i||i<0&&this.zoomLevel+i<1||i>0&&this.zoomLevel+i>this.zoomOptions.sizes.length)return!1;this.zoomLevel+=i,e(this),this.onZoom(this);for(var a=0;a<t.length;a++)t[a](this);return!0},Travian.Game.Map.Base.call(this,i,a),this.onMove=this.onMove||Travian.emptyFunction,this.onCreate=this.onCreate||Travian.emptyFunction,this.onZoom=this.onZoom||Travian.emptyFunction,this.zoomLevel=this.zoomOptions.level,this.positionOrigin={browser:{x:this.mapContainer.containerSize.x,y:this.mapContainer.containerSize.y+this.mapContainer.containerSize.height},map:{x:0,y:0}},e(this),this.onCreate(this)};return i.prototype=Object.create(Travian.Game.Map.Base.prototype),i.constructor=i,i}(),Travian.Game.Map.Transition.Precision=2,Travian.Game.Map.Updater=function(){var t=function(e){e.requestCountImages>=e.maxRequestCount||Object.keys(e.objects.images).map((function(t,i){return{imageId:t,priority:e.objects.images[t].getPriority()}})).sort((function(t,e){return t.priority-e.priority})).some((function(i,a){var n=e.objects.images[i.imageId];return delete e.objects.images[n.updaterId],e.requestCountImages++,e.updateWorking(1),n.imageLoader||(n.imageLoader=jQuery(new Image).on("load",(function(){!function(e,i){i.element.attr("src",i.srcUrl),i.finishedLoading&&i.finishedLoading(),delete e.loadings[i.blockContainer.updaterId][i.updaterId],0===Object.keys(e.loadings[i.blockContainer.updaterId]).length&&i.blockContainer.layers.loading.hide(),e.requestCountImages--,e.updateWorking(-1),t(e),jQuery(window).trigger("travian.map.imageLoaded")}(e,n)}))),n.refreshSrcUrl(),n.imageLoader.attr("src",n.srcUrl),e.requestCountImages>=e.maxRequestCount}))},e=function(e,i){this.lastRequestPosition={x:null,y:null},this.loadings={},this.requestCount=0,this.requestCountImages=0,this.maxRequestCount=5,this.requestDelayId={multiple:null,position:null},this.requestObject={multiple:null,position:null},this.classType="Travian.Game.Map.Updater",this.register=function(t,e){return this.objects[t]?(e.updaterId||(e.updaterId=Travian.Game.Map.getNewId()),this.objects[t][e.updaterId]||(this.objects[t][e.updaterId]=e),"images"===t&&(e.blockContainer.updaterId||(e.blockContainer.updaterId=Travian.Game.Map.getNewId()),this.loadings[e.blockContainer.updaterId]||(this.loadings[e.blockContainer.updaterId]={}),this.loadings[e.blockContainer.updaterId][e.updaterId]=!0,e.blockContainer.layers.loading.show()),this.request(),this):this},this.request=function(){var e=this;return this.requestObject.multiple&&this.requestObject.multiple.cancel&&(this.requestObject.multiple.cancel(),this.requestObject.multiple=null,this.updateWorking(-1)),this.requestDelayId.multiple&&(clearTimeout(this.requestDelayId.multiple),this.requestDelayId.multiple=null),this.requestDelayId.multiple=setTimeout((function(){!1===function(e){if(Object.keys(e.objects.ajax).length<=0)return!1;e.updateWorking(1);var i=[];for(var a in e.objects.ajax)if(e.objects.ajax.hasOwnProperty(a)){var n=e.objects.ajax[a].getRequestData();!1!==n&&i.push(n)}return e.requestObject.multiple=Travian.api("map/info",{data:Object.assign({},e.parameters.multiple,{data:i,zoomLevel:e.transition.zoomLevel}),success:function(i){e.updateWorking(-1),e.setContentDataAndRefresh(i),t(e)},error:function(i){e.updateWorking(-1),e.setContentDataAndRefresh(i),t(e)}}),!0}(e)&&t(e)}),this.requestDelayTime.multiple),this},this.requestPosition=function(t){var e=this;return this.lastRequestPosition.x===t.position.x&&this.lastRequestPosition.y===t.position.y||(this.lastRequestPosition.x=t.position.x,this.lastRequestPosition.y=t.position.y,this.requestObject.position&&this.requestObject.position.cancel&&(this.requestObject.position.cancel(),this.requestObject.position=null,this.updateWorking(-1)),this.requestDelayId.position&&(clearTimeout(this.requestDelayId.position),this.requestDelayId.position=null),this.requestDelayId.position=setTimeout((function(){!function(t,e){t.updateWorking(1);var i={x0:e.position.x+t.options.positionOptions.areaAroundPosition[t.transition.zoomLevel].left,y0:e.position.y+t.options.positionOptions.areaAroundPosition[t.transition.zoomLevel].bottom,x1:e.position.x+t.options.positionOptions.areaAroundPosition[t.transition.zoomLevel].right,y1:e.position.y+t.options.positionOptions.areaAroundPosition[t.transition.zoomLevel].top};t.requestObject.position&&(t.requestObject.position.abort(),t.requestObject.position=null,t.updateWorking(-1)),t.requestObject.position=Travian.api("map/position",{data:Object.assign({},t.parameters.position,{data:Object.assign({},e.position,{zoomLevel:t.transition.zoomLevel,ignorePositions:t.dataStore.getPositionsOfData(e.dataStoreType).filter((function(t){return Travian.Game.Map.isPositionInRect(i,t)})).map((function(t){return Travian.Game.Map.xy2id(t.x,t.y)}))})}),success:function(i){t.updateWorking(-1),(e.onSuccess||Travian.emptyFunction)(i)},error:function(i){t.updateWorking(-1),(e.onError||Travian.emptyFunction)(i)}})}(e,t)}),this.requestDelayTime.position)),this},this.setContentDataAndRefresh=function(t){if(t.blocks){for(var e in t.blocks)if(t.blocks.hasOwnProperty(e))for(var i in t.blocks[e])if(t.blocks[e].hasOwnProperty(i))for(var a in t.blocks[e][i])if(t.blocks[e][i].hasOwnProperty(a))for(var n in t.blocks[e][i][a])if(t.blocks[e][i][a].hasOwnProperty(n)){var o={x:e,y:i,right:a,top:n},r=Object.assign({},this.dataStore.get(Travian.Game.Map.DataStore.TYPE_BLOCKS,o,"block")||{},t.blocks[e][i][a][n]);this.dataStore.push({type:Travian.Game.Map.DataStore.TYPE_BLOCKS,position:o,index:"block",data:r})}this.mapContainer.invalidateBlockVersionCache()}for(var s in t.elements&&this.dataStore.setMultiple(Travian.Game.Map.DataStore.TYPE_TILE,t.elements),this.objects.ajax)this.objects.ajax.hasOwnProperty(s)&&(this.objects.ajax[s].refreshContent&&this.objects.ajax[s].refreshContent(),delete this.objects.ajax[s]);return this},this.updateWorking=function(t){return this.requestCount+=t,this.elementWorking.length>0&&(this.requestCount>0?this.elementWorking.css({visibility:"visible"}):this.elementWorking.css({visibility:"hidden"}),this.elementWorking.html(this.requestCount)),this},Travian.Game.Map.Base.call(this,e,i),this.objects={ajax:{},images:{}},this.elementWorking=jQuery(this.elementWorking)};return e.prototype=Object.create(Travian.Game.Map.Base.prototype),e.constructor=e,e}(),Travian.Game.Map.ContextMenu=function(t,e){for(var i in this.classType="Travian.Game.Map.ContextMenu",this.addAction=function(t){var e=this;if(t.element=jQuery(t.element),t.element.length>0){var i=t.element.find("a");i.length>0?(i.on("click",(function(i){t.fn(e,e.mapPosition,e.contentData)})),this.actions.push(t)):t.element.hide()}return this},this.disable=function(){return this.options.disabled=!0,this},this.enable=function(){return this.options.disabled=!1,this},this.hide=function(){return this.shown&&(this.fx(this.menu,!1),this.parentContainer.enableEvents(),this.menu.hide(),this.shown=!1,Travian.Game.Map.Tips.tooltipInstance.setProps({placement:Travian.Tip.PLACEMENT_DEFAULT,offset:[16,16]})),this},this.show=function(){return this.fx(this.menu,!0),this.parentContainer.disableEvents(),this.menu.show(),this.shown=!0,Travian.Game.Map.Tips.tooltipInstance.setProps({placement:Travian.Tip.PLACEMENT_MIRRORED,offset:[-16,16]}),this},this.startListener=function(){var t=this;return this.targets.each((function(e,i){jQuery(i).on(t.options.trigger,(function(e){e.target!==t.parentContainer.containerMover.get(0)||t.options.disabled||(t.options.stopEvent&&e.stopPropagation(),t.options.element=jQuery(i),t.menu.css({left:e.pageX+t.options.offsets.x,top:e.pageY+t.options.offsets.y,position:"absolute"}),t.show())}))})),jQuery("body").on("click",(function(){t.hide()})),this},this.update=function(){var t=this;return this.options.disabled||!this.shown||(this.menu.find("div.separator").each((function(t,e){var i=jQuery(e);i.prev().show(),i.show()})),this.contentData=this.parentContainer.dataStore.get(Travian.Game.Map.DataStore.TYPE_TOOLTIP,this.mapPosition),this.actions.forEach((function(e){null!=t.contentData&&e.shouldDisplay(t.contentData)?e.element.show():e.element.hide()})),this.menu.find("div.separator").each((function(t,e){var i=jQuery(e),a=i.prev();0===a.find(".entry:visible").length&&(a.hide(),i.hide())}))),this},this.options=Object.assign({actions:{},menu:"#contextmenu",stopEvent:!0,targets:"#mapContainer",trigger:"contextmenu",offsets:{x:0,y:0},onShow:Travian.emptyFunction,onHide:Travian.emptyFunction,onClick:Travian.emptyFunction,fadeSpeed:200},t),this.parentContainer=e,this.mapPosition=null,this.menu=jQuery(this.options.menu),this.targets=jQuery(this.options.targets),this.fx=function(t,e){t.animate({opacity:e?1:0},this.options.fadeSpeed,(function(){t.css({display:e?"block":"none"})}))},this.hide().startListener(),this.menu.css({position:"absolute",top:"-900000px",display:"block"}),this.menu.detach().appendTo("body"),this.actions=[],this.options.actions)this.options.actions.hasOwnProperty(i)&&this.addAction(this.options.actions[i]);var a=this;this.targets.each((function(t,e){jQuery(e).on(a.options.trigger,(function(t){a.mapPosition=a.parentContainer.transition.translateToMap({x:t.pageX-a.parentContainer.containerSize.x-a.parentContainer.elementSize.x,y:t.pageY-a.parentContainer.containerSize.y-a.parentContainer.elementSize.y}),a.update()}))}))},Travian.Game.Map.DataStore=function(){var t=0,e=function(t){for(var e in t.options.useStorageForType)t.options.useStorageForType.hasOwnProperty(e)&&t.options.useStorageForType[e]&&Travian.Storage.set("mapDataContainer."+e,t.data[e],t.options.persistentStorage)},i=function(e,i,a){var n=a.x,o=a.y,r=void 0!==a.right?a.right:n,s=void 0!==a.top?a.top:o;return e.data[i]||(e.data[i]={all:{}}),e.data[i][n]||(e.data[i][n]={}),e.data[i][n][o]||(e.data[i][n][o]={}),e.data[i][n][o][r]||(e.data[i][n][o][r]={}),e.data[i][n][o][r][s]||(e.data[i][n][o][r][s]={}),e.data[i][n][o][r][s].id||(t++,e.data[i][n][o][r][s].id=t),e.data[i][n][o][r][s].position=a,e.data[i][n][o][r][s]},a=function(t,e,i){var a=i.x,o=i.y,r=void 0!==i.right?i.right:a,s=void 0!==i.top?i.top:o;return t.data[e]&&t.data[e][a]&&t.data[e][a][o]&&t.data[e][a][o][r]&&t.data[e][a][o][r][s]?n(t,t.data[e][a][o][r][s],e)?null:t.data[e][a][o][r][s]:null},n=function(t,e,i){return!1!==e.time&&(new Date).getTime()-e.time>t.cachingTimeForType[i]},o=function(o,r){var s;for(s in this.classType="Travian.Game.Map.DataStore",this.data={},this.get=function(t,e,i){var n=a(this,t,e);return null==n?null:void 0!==i?n.data[i]?n.data[i]:null:n.data},this.getDataForArea=function(t,e,i){var a=[],o=Object.assign({},e);if(!this.data[t]||!this.data[t].all)return a;for(var r in o.x>o.right&&(o.right+=this.parentContainer.transition.border.width),o.y>o.top&&(o.top+=this.parentContainer.transition.border.height),this.data[t].all)if(this.data[t].all.hasOwnProperty(r)){var s=this.data[t].all[r],l={x:s.position.x,y:s.position.y};if(o.x>l.x&&(l.x+=this.parentContainer.transition.border.width),o.y>l.y&&(l.y+=this.parentContainer.transition.border.height),!1===n(this,s,t)&&o.x<=l.x&&l.x<=o.right&&o.y<=l.y&&l.y<=o.top)if(i)for(var d in s.data)s.data.hasOwnProperty(d)&&a.push(s.data[d]);else a.push(s.data)}return a},this.getPositionsOfData=function(t){var e=this;return this.data[t]&&this.data[t].all?Object.keys(this.data[t].all).filter((function(i){return!1===n(e,e.data[t].all[i],t)})).map((function(i){return e.data[t].all[i].position})):[]},this.push=function(t){void 0===t.time&&(t.time=(new Date).getTime()),-1===t.time&&(t.time=!1);var e=i(this,t.type,t.position);return e.data||(e.data={}),e.data[t.index]=t.data,e.time=t.time,this.data[t.type].all[e.id]=e,this},this.refresh=function(t){var e=a(this,t.type,t.position);return null!=e&&(void 0===t.time&&(t.time=(new Date).getTime()),-1===t.time&&(t.time=!1),e.time=t.time),this},this.remove=function(t,e,i){var n=a(this,t,e);return null==n?this:void 0!==i?(n.data[i]&&delete n.data[i],this):(n.time=0,this)},this.removeAllOfType=function(t){void 0!==this.data[t]&&delete this.data[t]},this.saveDataToStorage=function(){return e(this),this},this.set=function(t){void 0===t.time&&(t.time=(new Date).getTime()),-1===t.time&&(t.time=!1);var e=i(this,t.type,t.position);if(e.data=t.data,e.time=t.time,this.data[t.type].all[e.id]=e,t.data.symbols)for(var a in t.data.symbols)if(t.data.symbols.hasOwnProperty(a)){var n=t.data.symbols[a];n.dataId||(n.dataId=n.type+"-"+a),this.push({type:Travian.Game.Map.DataStore.TYPE_SYMBOL,position:t.position,data:n,index:n.dataId,time:!1})}return this},this.setMultiple=function(t,i,a){for(var n=0;n<i.length;n++){var o=i[n];this.set({type:t,position:o.position,data:o,time:a})}return e(this),this},Travian.Game.Map.Base.call(this,o,r),this.options.clearStorageForType)this.options.clearStorageForType.hasOwnProperty(s)&&this.options.clearStorageForType[s]&&Travian.Storage.clear("mapDataContainer."+s,this.options.persistentStorage);for(s in this.options.useStorageForType)if(this.options.useStorageForType.hasOwnProperty(s)&&this.options.useStorageForType[s])if(this.data[s]=Travian.Storage.get("mapDataContainer."+s,this.options.persistentStorage)||{},this.data[s].all){var l=Math.max(Object.keys(this.data[s].all).map((function(t){return parseInt(t)})));l>t&&(t=l)}else this.data[s].all={}};return o.TYPE_BLOCKS="blocks",o.TYPE_SYMBOL="symbol",o.TYPE_TILE="tile",o.TYPE_TOOLTIP="tooltip",o.prototype=Object.create(Travian.Game.Map.Base.prototype),o.constructor=o,o}(),Travian.Game.Map.Tips={lastText:"",lastTitle:"",tooltipHtml:'<span class="xCoord">({x}</span><span class="pi">|</span><span class="yCoord">{y})</span><span class="clear"></span>',tooltipInstance:null,render:function(t,e){var i=this;return i.tooltipInstance||(i.tooltipInstance=Travian.Tip.set(e,{title:"",text:""}),i.tooltipInstance.setProps({trigger:"mouseenter click"})),jQuery(e).on("mousemove",(function(e){var a={x:e.pageX-t.containerSize.x-t.elementSize.x,y:e.pageY-t.containerSize.y-t.elementSize.y},n=t.getContentForTooltip(a);!1===n&&(n={title:"",text:Travian.Helpers.substitute(i.tooltipHtml,t.transition.translateToMap(a))}),i.lastText===n.text&&i.lastTitle===n.title||(n.unescaped=!0,Travian.Tip.updateContentOfInstance(i.tooltipInstance,n),i.lastText=n.text,i.lastTitle=n.title)})),this}},Travian.Game.Map.Rulers=function(){var t=function(t){t.elements.moverX.css({backgroundImage:"url("+Travian.Helpers.substitute(t.imgSource.x,{zoomLevel:t.transition.zoomLevel})+")"}),t.elements.moverY.css({backgroundImage:"url("+Travian.Helpers.substitute(t.imgSource.y,{zoomLevel:t.transition.zoomLevel})+")"})},e=function(t){t.elements.coordinates&&(t.elements.coordinates.x.forEach((function(t){t.remove()})),t.elements.coordinates.y.forEach((function(t){t.remove()}))),t.elements.coordinates={x:[],y:[]};for(var e=t.transition.elementsInView.x+2*t.transition.elementsPerBlock.x,a=t.steps.x[t.transition.zoomLevel],n=0,o=null;n<e;n+=a)(o=jQuery("<div></div>").addClass("coordinate zoom"+t.transition.zoomLevel).css({position:"absolute",left:n*t.mapContainer.blockSize.width/t.transition.elementsPerBlock.x,top:0,width:a*t.mapContainer.blockSize.width/t.transition.elementsPerBlock.x,height:t.containerSize.height}).appendTo(t.elements.moverX)).rulerLeft=n*t.mapContainer.blockSize.width/t.transition.elementsPerBlock.x,t.elements.coordinates.x[n]=o;var r=t.transition.elementsInView.y+2*t.transition.elementsPerBlock.y,s=t.steps.y[t.transition.zoomLevel];for(n=0,o=null,null;n<r;n+=s)(o=jQuery("<div></div>").addClass("coordinate zoom"+t.transition.zoomLevel).css({position:"absolute",left:0,top:n*t.mapContainer.blockSize.height/t.transition.elementsPerBlock.y,width:t.containerSize.width,height:s*t.mapContainer.blockSize.height/t.transition.elementsPerBlock.y}).appendTo(t.elements.moverY)).rulerTop=n*t.mapContainer.blockSize.height/t.transition.elementsPerBlock.y,t.elements.coordinates.y[n]=o;i(t,!0,!0)},i=function(t,e,i){var a=!1;do{a=!1,t.position.x<-2*t.mapContainer.blockSize.width&&(t.position.x+=1*t.mapContainer.blockSize.width,e=!0,a=!0),t.position.x>0&&(t.position.x+=-1*t.mapContainer.blockSize.width,e=!0,a=!0),t.position.y<-2*t.mapContainer.blockSize.height&&(t.position.y+=1*t.mapContainer.blockSize.height,i=!0,a=!0),t.position.y>0&&(t.position.y+=-1*t.mapContainer.blockSize.height,i=!0,a=!0)}while(a);t.elements.moverX.css({left:t.position.x}),t.elements.moverY.css({top:t.position.y}),e&&t.elements.coordinates&&jQuery(t.elements.coordinates.x).each((function(e,i){if(i&&i.length>0){var a=t.transition.translateToMap({x:t.position.x+i.rulerLeft-t.mapContainer.elementSize.x,y:0});i.html(function(t,e){return(e+=t.delta.x[t.transition.zoomLevel])<t.transition.border.left?e=t.transition.border.right-(t.transition.border.left-e)+1:e>t.transition.border.right&&(e=t.transition.border.left+(e-t.transition.border.right)-1),e}(t,a.x))}})),i&&t.elements.coordinates&&jQuery(t.elements.coordinates.y).each((function(e,i){if(i&&i.length>0){var a=t.transition.translateToMap({x:0,y:t.position.y+i.rulerTop-t.mapContainer.elementSize.y});i.html(function(t,e){return(e+=t.delta.y[t.transition.zoomLevel])<t.transition.border.bottom?e=t.transition.border.top-(t.transition.border.bottom-e)+1:e>t.transition.border.top&&(e=t.transition.border.bottom+(e-t.transition.border.top)-1),e}(t,a.y))}}))},a=function(a,n){this.classType="Travian.Game.Map.Rulers",this.destroy=function(){return this.elements.containerX.remove(),this.elements.containerY.remove(),this},this.render=function(a){return this.position={x:this.mapContainer.blockSize.width,y:this.mapContainer.blockSize.height},this.elements={containerX:jQuery("<div></div>").addClass(this.cls.x).css({position:"absolute",left:0,right:0,width:this.mapContainer.containerViewSize.width,overflow:"hidden"}).appendTo(this.mapContainer.containerRender),containerY:jQuery("<div></div>").addClass(this.cls.y).css({position:"absolute",top:0,bottom:0,height:this.mapContainer.containerViewSize.height,overflow:"hidden"}).appendTo(this.mapContainer.containerRender)},this.containerSize={width:this.elements.containerY.width(),height:this.elements.containerX.height()},this.elements.containerX.css({height:this.containerSize.height}),"ltr"===this.direction.toLowerCase()?this.elements.containerY.css({left:-this.containerSize.width}):"rtl"===this.direction.toLowerCase()&&this.elements.containerY.css({right:-this.containerSize.width}),this.elements.moverX=jQuery("<div></div>").css({position:"absolute",left:0,top:0,width:this.mapContainer.containerSize.width+2*this.mapContainer.blockSize.width,height:"100%",backgroundPosition:"left top",backgroundColor:"transparent",backgroundRepeat:"repeat-x"}).appendTo(this.elements.containerX),this.elements.moverY=jQuery("<div></div>").css({position:"absolute",left:0,top:0,width:"100%",height:this.mapContainer.containerSize.height+2*this.mapContainer.blockSize.height,backgroundPosition:"left top",backgroundColor:"transparent",backgroundRepeat:"repeat-y"}).appendTo(this.elements.containerY),t(this),e(this),i(this),this},this.move=function(t){return this.position.x+=t.x,this.position.y-=t.y,i(this),this},this.zoom=function(){return t(this),e(this),i(this),this},a.direction||(a.direction=Travian.Game.getDirection()),Travian.Game.Map.Base.call(this,a,n),this.position={x:0,y:0}};return a.prototype=Object.create(Travian.Game.Map.Base.prototype),a.constructor=a,a}(),Travian.Game.Map.MiniMap=function(){var t=function(t){var e=t.transition.translateToMap({x:-t.mapContainer.elementSize.x,y:-t.mapContainer.elementSize.y},{}),i=t.transition.translateToMap({x:0,y:0,width:t.mapContainer.containerViewSize.width,height:t.mapContainer.containerViewSize.height},{round:!1,correct:!1});i.width=i.right-i.x,i.height=i.top-i.y;var a=t.containerSize.width/t.transition.border.width,n=t.containerSize.height/t.transition.border.height;t.position={x:e.x*a+t.containerSize.width/2-1,y:e.y*n+t.containerSize.height/2-i.height*n-1,width:i.width*a,height:i.height*n};var o=t.position;o.width>=t.containerSize.width&&(o.x=-1),o.height>=t.containerSize.height&&(o.y=-1),t.element.css({left:o.x,bottom:o.y,width:o.width,height:o.height});var r=Object.assign({},o);o.x<0?o.x+=t.containerSize.width:o.x+o.width>t.containerSize.width&&(o.x-=t.containerSize.width),o.y<0?o.y+=t.containerSize.height:o.y+o.height>t.containerSize.height&&(o.y-=t.containerSize.height),t.elementHelpers[0].css({left:o.x,bottom:o.y,width:o.width,height:o.height}),t.elementHelpers[1].css({left:r.x,bottom:o.y,width:o.width,height:o.height}),t.elementHelpers[2].css({left:o.x,bottom:r.y,width:o.width,height:o.height})},e=function(t,e){var i=e.containerSize.width/e.transition.border.width,a=e.containerSize.height/e.transition.border.height;return{x:Math.floor((t.pageX-e.containerPosition.x)/i-Math.abs(e.transition.border.left)),y:-Math.floor((t.pageY-e.containerPosition.y)/a-Math.abs(e.transition.border.bottom))}},i=function(i,a){this.classType="Travian.Game.Map.MiniMap",this.expanded=!0,this.animate=function(){var t=this;this.elements.container.stop(!0),this.expanded=!!Travian.Game.Preferences.get("minimap-expanded");var e=function(){return t.expanded?t.elements.container._height.max:t.elements.container._height.min};return this.expanded=!this.expanded,Travian.Game.Preferences.set("minimap-expanded",this.expanded),this.elements.headlineExpander.toggleClass("expand collapse"),this.elements.container.animate({height:e()},200),this.parentContainer.outline.update(this.elements.container.height()-e()),this},this.getContentForTooltip=function(t,i){var a=e(i,this);return{text:Travian.Helpers.substitute(Travian.Game.Map.MiniMap.Tips.tooltipHtml,a)}},this.render=function(i){var a=this;this.container=jQuery(this.container).css({overflow:"hidden"}).prop("unselectable","on").on("click",(function(t){a.mapContainer.moveTo(e(t,a))})),Travian.Game.Map.Base.prototype.render.call(this,i),this.element.addClass("view").css({position:"absolute",zIndex:3}).appendTo(this.container),jQuery("<div></div>").addClass("inner").css({height:"100%",opacity:.25,width:"100%"}).appendTo(this.element),this.elementHelpers=[];for(var n=0;n<3;n++){var o=jQuery("<div></div>").addClass("view").css({position:"absolute",zIndex:3}).appendTo(this.container);jQuery("<div></div>").addClass("inner").css({height:"100%",opacity:.25,width:"100%"}).appendTo(o),this.elementHelpers.push(o)}this.containerSize={width:this.container.width(),height:this.container.height()},this.containerPosition={x:this.container.offset().left,y:this.container.offset().top},this.elementSize={width:this.element.width(),height:this.element.height()},this.showToolTip&&Travian.Game.Map.MiniMap.Tips.render(this,this.container.find("img")),t(this);var r=jQuery(this.containerContent);this.elements={container:r,headline:r.find(".headline"),headlineExpander:r.find(".iconButton"),background:r.find(".background")},this.expanded=!!Travian.Game.Preferences.get("minimap-expanded"),this.elements.headlineExpander.addClass(this.expanded?"expand":"collapse");a.elements.container._height={max:a.elements.container.height(),min:a.elements.headline.height()+parseInt(a.elements.headline.css("margin-top"))+parseInt(a.elements.headline.css("margin-bottom"))},!0!==a.expanded&&a.elements.container.css({height:a.elements.container._height.min}),a.elements.headline.on("click",(function(t){a.animate()}))},this.move=function(){return t(this),this},this.zoom=function(){return t(this),this},Travian.Game.Map.Base.call(this,i,a),this.position={x:0,y:0,width:0,height:0}};return i.prototype=Object.create(Travian.Game.Map.Base.prototype),i.constructor=i,i}(),Travian.Game.Map.MiniMap.Tips={lastText:"",lastTitle:"",tooltipHtml:'<span class="xCoord">({x}</span><span class="pi">|</span><span class="yCoord">{y})</span><span class="clear"></span>',render:function(t,e){var i=this;return Travian.Tip.set(e,{title:"",text:""}),jQuery(e).on("mousemove",(function(a){var n={x:a.pageX-t.containerSize.width-t.elementSize.width,y:a.pageY-t.containerSize.height-t.elementSize.height},o=t.getContentForTooltip(n,a);!1===o&&(o={title:"",text:Travian.Helpers.substitute(i.tooltipHtml,t.transition.translateToMap(n))}),i.lastText===o.text&&i.lastTitle===o.title||(o.unescaped=!0,Travian.Tip.setContent(e,o),i.lastText=o.text,i.lastTitle=o.title)})),this}},Travian.Game.Map.Toolbar=function(t,e){this.classType="Travian.Game.Map.Toolbar",this.render=function(t){var e=this;this.element=jQuery(this.element),this.zoomIn=this.element.find(".iconButton.zoomIn").on("click",(function(t){e.mapContainer.zoomIn()})),this.zoomOut=this.element.find(".iconButton.zoomOut").on("click",(function(t){e.mapContainer.zoomOut()}));var i=function(){e.zoomDropDownDataContainer._dropped=!1,e.zoomDropDownDataContainer.css({height:e.zoomDropDownDataContainer._styleBackup.height}),e.zoomDropDownEntries.each((function(t,e){var i=jQuery(e);i.hasClass("selected")&&i.addClass("display"),i.addClass("hide").removeClass("selected")})),jQuery(e.zoomDropDownEntries[e.transition.zoomLevel-1]).removeClass("hide").addClass("display")};this.zoomDropDownDataContainer=this.element.find(".dropdown .dataContainer"),this.zoomDropDownEntries=this.zoomDropDownDataContainer.find(".entry"),this.zoomDropDownDataContainer._styleBackup={height:this.zoomDropDownDataContainer.height(),maxHeight:this.zoomDropDownEntries.toArray().reduce((function(t,e){return t+jQuery(e).height()}),0)},this.zoomDropDownClick=this.element.find(".dropdown .iconButton.dropDownImage").on("click",(function(t){e.mapContainer.isEventsEnabled()&&(t.stopPropagation(),e.zoomDropDownDataContainer._dropped?i():(e.zoomDropDownDataContainer._dropped=!0,e.zoomDropDownEntries.each((function(t,e){var i=jQuery(e);i.hasClass("display")&&i.addClass("selected"),i.removeClass("display").removeClass("hide")})),e.zoomDropDownDataContainer.css({height:e.zoomDropDownDataContainer._styleBackup.maxHeight})))})),this.zoomDropDownEntries.each((function(t,i){var a=jQuery(i);a.on("click",(function(i){i.stopPropagation(),e.zoomDropDownDataContainer._dropped&&(e.zoomDropDownDataContainer._dropped=!1,e.zoomDropDownDataContainer.css({height:e.zoomDropDownDataContainer._styleBackup.height}),e.zoomDropDownEntries.each((function(t,e){jQuery(e).addClass("hide").removeClass("selected")})),a.removeClass("hide").addClass("display"),e.mapContainer.zoom(t+1-e.mapContainer.transition.zoomLevel,e.mapContainer.transition.getPointOfCenterInView()))}))})),jQuery("body").on("click",(function(){e.zoomDropDownDataContainer._dropped&&i()}));var a=this.element.find(".viewFull");a.length>0&&(this.viewFull=a.on("click",(function(t){window.location.href=Travian.Helpers.substitute(e.viewFullScreenUrl,Object.assign({},e.mapContainer.transition.getPointOfCenterInView(),{zoom:e.mapContainer.transition.zoomLevel}))}))),(a=this.element.find(".iconButton.viewNormal")).length>0&&(this.viewNormal=this.element.find(".iconButton.viewNormal").on("click",(function(t){window.location.href=Travian.Helpers.substitute(e.viewNormalUrl,Object.assign({},e.mapContainer.transition.getPointOfCenterInView(),{zoom:e.mapContainer.transition.zoomLevel}))}))),this.filterPlayer=this.element.find(".iconButton.filterMy").on("click",(function(t){Travian.api("map/setting",{data:{data:{type:"outline",outline:"user"}},success:function(t){e.filterPlayer[t.result?"addClass":"removeClass"]("checked"),e.filterPlayer.checked=t.result,e.mapContainer.forceUpdateBlocksLayer("imageMark"),e.mapContainer.forceUpdateBlocksSymbols("player",t.result)}})})),this.filterPlayer.checked=this.filterPlayer.hasClass("checked"),this.filterAlliance=this.element.find(".iconButton.filterAlliance"),this.filterAlliance.hasClass("disabled")||(this.filterAlliance.on("click",(function(t){Travian.api("map/setting",{data:{data:{type:"outline",outline:"alliance"}},success:function(t){e.filterAlliance[t.result?"addClass":"removeClass"]("checked"),e.filterAlliance.checked=t.result,e.mapContainer.forceUpdateBlocksLayer("imageMark"),e.mapContainer.forceUpdateBlocksSymbols("alliance",t.result)}})})),this.filterAlliance.checked=this.filterAlliance.hasClass("checked")),(a=this.element.find(".iconButton.linkCropfinder")).length>0&&!a.parent().hasClass("iconRequireGold")&&a.on("click",(function(t){window.location.href="/cropfinder.php"})),this.coordinateEnter=jQuery("#mapCoordEnter").on("submit",(function(t){var i={x:parseInt(e.coordinateEnter.find("input.coordinates.x").val()),y:parseInt(e.coordinateEnter.find("input.coordinates.y").val())};return isNaN(i.x)||isNaN(i.y)||e.mapContainer.moveTo(i),t.stopPropagation(),!1})),jQuery(document).on("toolbar.updateCoordinates",(function(t,e){var i=jQuery("#mapCoordEnter");i.find("input.coordinates.x").val(e.x),i.find("input.coordinates.y").val(e.y)})),this.update()},this.update=function(){var t=this;1===this.transition.zoomLevel?(this.zoomIn.addClass("disabled"),this.zoomOut.removeClass("disabled")):this.transition.zoomLevel===this.transition.zoomOptions.sizes.length?(this.zoomIn.removeClass("disabled"),this.zoomOut.addClass("disabled")):(this.zoomIn.removeClass("disabled"),this.zoomOut.removeClass("disabled")),this.zoomDropDownEntries.each((function(e,i){var a=jQuery(i);t.zoomDropDownDataContainer._dropped?a.removeClass("selected"):a.addClass("hide").removeClass("display")})),jQuery(this.zoomDropDownEntries[this.transition.zoomLevel-1]).removeClass("hide").addClass(this.zoomDropDownDataContainer._dropped?"selected":"display")},this.zoom=function(){this.update()},Travian.Game.Map.Base.call(this,t,e)},Travian.Game.Map.Toolbar.prototype=Object.create(Travian.Game.Map.Base.prototype),Travian.Game.Map.Toolbar.constructor=Travian.Game.Map.Toolbar,Travian.Game.Map.Outline=function(){var t=function(t,e){this.classType="Travian.Game.Map.Outline",this.expanded=!1,this.animate=function(){var t=this;return this.element.stop(!0),!1===this.expanded?(this.expanded=!0,this.elements.tabContainer.show(),Travian.Game.Preferences.set("outline-expanded",!0),this.elements.headlineExpander.removeClass("expand").addClass("collapse"),this.element.animate({height:this.element._height.max},200,(function(){for(var e in t.parentContainer.mapMarks)t.parentContainer.mapMarks.hasOwnProperty(e)&&t.parentContainer.mapMarks[e].update(!1)}))):(this.expanded=!1,Travian.Game.Preferences.set("outline-expanded",!1),this.elements.headlineExpander.removeClass("collapse").addClass("expand"),this.element.animate({height:this.element._height.min},200,(function(){t.elements.tabContainer.hide()}))),this},this.render=function(t){var e=this;this.element=jQuery(this.element),this.elements={headline:this.element.find(".headline"),headlineExpander:this.element.find(".headline").find(".iconButton"),tabContainer:this.element.find(".tabContainer"),mapMarks:this.element.find("#mapMarks"),background:this.element.find(".background")},this.expanded=!!Travian.Game.Preferences.get("outline-expanded"),this.elements.headlineExpander.addClass(this.expanded?"expand":"collapse");return function(){if(e.element._height={max:e.parentContainer.containerViewSize.height-parseInt(e.element.css("bottom"))-e.parentContainer.miniMap.elements.container.height()-2,min:e.element.height()},e.elements.tabContainer.hide(),!0===e.expanded)for(var t in e.elements.tabContainer.show(),e.element.css({height:e.element._height.max}),e.parentContainer.mapMarks)e.parentContainer.mapMarks.hasOwnProperty(t)&&e.parentContainer.mapMarks[t].update(!1);e.elements.headlineExpander.on("click",(function(t){e.animate()}))}(),this},this.update=function(t){var e=this;return this.element._height.max+=t,this.expanded&&(this.element.stop(!0),this.element.animate({height:this.element._height.max},200,(function(){for(var t in e.parentContainer.mapMarks)e.parentContainer.mapMarks.hasOwnProperty(t)&&e.parentContainer.mapMarks[t].update(!1)}))),this},Travian.Game.Map.Base.call(this,t,e),this.render(t)};return t.prototype=Object.create(Travian.Game.Map.Base.prototype),t.constructor=t,t}(),Travian.Game.Map.Layer=function(t,e){Travian.Game.Map.Base.call(this,t,e),null===this.position&&null!==this.parentContainer&&(this.position={x:0,y:0,width:Math.ceil(this.parentContainer.element.width()),height:Math.ceil(this.parentContainer.element.height())}),"Travian.Game.Map.Layer.Block"===this.parentContainer.classType?this.blockContainer=this.parentContainer:this.parentContainer.blockContainer&&(this.blockContainer=this.parentContainer.blockContainer),void 0!==t.version&&this.setVersion(t.version),this.render()},Travian.Game.Map.Layer.prototype=Object.create(Travian.Game.Map.Base.prototype),Travian.Game.Map.Layer.constructor=Travian.Game.Map.Layer,Travian.Game.Map.Layer.prototype.classType="Travian.Game.Map.Layer",Travian.Game.Map.Layer.prototype.parentContainer=null,Travian.Game.Map.Layer.prototype.position=null,Travian.Game.Map.Layer.prototype.render=function(t){return Travian.Game.Map.Base.prototype.render.call(this,t),null!==this.id&&this.element.addClass(this.id),this.position&&this.element.css({position:"absolute",left:this.position.x,top:this.position.y,width:this.position.width,height:this.position.height}),this.zIndex&&this.element.css({zIndex:this.zIndex+1}),this.parentContainer&&this.parentContainer.element&&this.element.appendTo(this.parentContainer.element),this},Travian.Game.Map.Layer.prototype.finishedLoading=function(){return this},Travian.Game.Map.Layer.prototype.forceUpdateContent=function(){return this},Travian.Game.Map.Layer.prototype.getContentForTooltip=function(t){return!1},Travian.Game.Map.Layer.prototype.getRequestData=function(){return!1},Travian.Game.Map.Layer.prototype.hide=function(){return this.element.hide(),this},Travian.Game.Map.Layer.prototype.refreshContent=function(){return this},Travian.Game.Map.Layer.prototype.setVersion=function(t){return this},Travian.Game.Map.Layer.prototype.show=function(){return this.element.show(),this},Travian.Game.Map.Layer.prototype.update=function(){return this.element.css({left:this.position.x+"px",top:this.position.y+"px"}),this},Travian.Game.Map.Layer.prototype.updateContent=function(){return this},Travian.Game.Map.Layer.Block=function(){var t=function(t,e,i){return e.position=e.position||i,void 0===e.text&&void 0===e.title&&(e.text=Travian.Helpers.substitute(t.tooltipHtml,{x:e.position.x,y:e.position.y})),e},e=function(t,e){if(!e.type)throw"Missing symbol type for symbol: "+e.dataId;e.position&&(e.x=e.position.x,e.y=e.position.y);var i=t.symbolTypes[e.type];if(i&&i.class&&i.visibleInZoom[t.transition.zoomLevel]){t.symbols[e.x]||(t.symbols[e.x]={}),t.symbols[e.x][e.y]||(t.symbols[e.x][e.y]={});var a=function(t,e){var i=Object.assign({},e),a=t.transition.getPointOfCenterInView(),n=Object.assign({},t.mapCoordinates);i.x=parseFloat(i.x),i.y=parseFloat(i.y),a.x=parseFloat(a.x),a.y=parseFloat(a.y),n.x=parseFloat(n.x),n.y=parseFloat(n.y);var o=function(t){return t>0?1:t<0?-1:0},r=t.transition.border.right-Math.abs(i.x)<t.transition.border.right/2,s=t.transition.border.top-Math.abs(i.y)<t.transition.border.top/2,l=t.transition.border.right-Math.abs(a.x)<t.transition.border.right/2,d=t.transition.border.top-Math.abs(a.y)<t.transition.border.top/2,u=t.transition.border.right-Math.abs(n.x)<t.transition.border.right/2,c=t.transition.border.top-Math.abs(n.y)<t.transition.border.top/2,p=o(i.x),h=o(a.x);(r||l)&&p+h===0&&p!==h&&(i.x+=h*t.transition.border.width);var m=o(i.y),v=o(a.y);(s||d)&&m+v===0&&m!==v&&(i.y+=v*t.transition.border.height);var f=o(n.x);(u||l)&&f+h===0&&f!==h&&(n.x+=h*t.transition.border.width);var g=o(n.y);return(c||d)&&g+v===0&&g!==v&&(n.y+=v*t.transition.border.height),{x:(i.x-n.x)*t.transition.pixelPerTile.x,y:(t.transition.elementsPerBlock.y-(i.y-n.y)-1)*t.transition.pixelPerTile.y}}(t,{x:e.x,y:e.y}),o=t.symbols[e.x][e.y],r=n(t,i,o);o[e.dataId]=new i.class(Object.assign({},i,e,{positionOfTile:{x:a.x,y:a.y},positionInTile:r,position:{x:a.x+r.x,y:a.y+r.y,width:i.sizes[t.transition.zoomLevel].width,height:i.sizes[t.transition.zoomLevel].height},positionDefault:{x:a.x+r.x,y:a.y+r.y,width:i.sizes[t.transition.zoomLevel].width,height:i.sizes[t.transition.zoomLevel].height},symbolSize:{width:i.sizes[t.transition.zoomLevel].width,height:i.sizes[t.transition.zoomLevel].height}}),t)}},i=function(t){a(t),t.dataStore.getDataForArea(Travian.Game.Map.DataStore.TYPE_SYMBOL,t.mapCoordinates,!0).forEach((function(i){e(t,i)}))},a=function(t){for(var e in t.symbols)if(t.symbols.hasOwnProperty(e))for(var i in t.symbols[e])if(t.symbols[e].hasOwnProperty(i))for(var a in t.symbols[e][i])t.symbols[e][i].hasOwnProperty(a)&&t.symbols[e][i][a].destroy();t.symbols={}},n=function(t,e,i){var a={x:!1,y:!1},n=e.sizes[t.transition.zoomLevel].width,o=Object.keys(i).reverse().find((function(t){var e=i[t].position.x===i[t].positionDefault.x;return e=(e=(e=e&&i[t].position.y===i[t].positionDefault.y)&&i[t].position.width===i[t].positionDefault.width)&&i[t].position.height===i[t].positionDefault.height}));return o&&(a.x=i[o].positionInTile.x,a.x+=n),!1===a.x&&(a.x=0),a.x+n>t.position.width/t.transition.elementsPerBlock.x&&(a.x=0,a.y+=e.sizes[t.transition.zoomLevel].height),a},o=function(n,o){this.mapCoordinates=null,this.layers=null,this.symbols={},this.dataStore=null,this.versionCache=null,this.classType="Travian.Game.Map.Layer.Block",this.addSymbol=function(t){return e(this,t),this},this.deleteSymbol=function(t){return this.symbols&&this.symbols[t.position.x]&&this.symbols[t.position.x][t.position.y]?(this.symbols[t.position.x][t.position.y][t.dataId]&&(this.symbols[t.position.x][t.position.y][t.dataId].destroy(),delete this.symbols[t.position.x][t.position.y][t.dataId]),this):this},this.forceUpdateLayer=function(t){return this.layers[t]&&this.layers[t].forceUpdateContent(),this},this.forceUpdateSymbols=function(t,e){if(this.symbols)for(var i in this.symbols)if(this.symbols.hasOwnProperty(i))for(var a in this.symbols[i])if(this.symbols[i].hasOwnProperty(a))for(var n in this.symbols[i][a])if(this.symbols[i][a].hasOwnProperty(n)){var o=this.symbols[i][a][n];o.layer===t&&o.forceUpdate(e)}return this},this.getContentForTooltip=function(t){var e=this,i=this.transition.translateToMap(t);if(this.symbols&&this.symbols[i.x]&&this.symbols[i.x][i.y]&&0!==this.symbols[i.x][i.y]){var a=!1;if(function(i){for(var n in i)if(i.hasOwnProperty(n)){var o=i[n];if(!1!==(a=o.getContentForTooltip())&&o.isPositionInRect({x:t.x-e.position.x,y:t.y-e.position.y}))return o}}(this.symbols[i.x][i.y])&&!1!==a)return a}var n=this.dataStore.get(Travian.Game.Map.DataStore.TYPE_TOOLTIP,i);return null==n||void 0===n.text&&void 0===n.title?(n={title:"",text:Travian.Translation.translate(this.tooltipHtml,i)},this.requestDataForPosition(i)):n={text:n.text,title:n.title},n},this.getData=function(){return Object.assign({loaded:!1,version:0},this.dataStore.get(Travian.Game.Map.DataStore.TYPE_BLOCKS,this.mapCoordinates,"block")||{})},this.getRequestData=function(){return{position:{x0:this.mapCoordinates.x,y0:this.mapCoordinates.y,x1:this.mapCoordinates.right,y1:this.mapCoordinates.top}}},this.getVersion=function(){return null==this.versionCache&&(this.versionCache=this.getData().version),this.versionCache},this.invalidateVersionCache=function(){return this.versionCache=null,this},this.move=function(t){if(0===t.x&&0===t.y)return this;this.position.x+=t.x,this.position.y-=t.y;var e=Travian.Game.Map.Layer.Block.getCorrectPosition(this.position,this.mapContainer);return this.position=e.position,this.mapCoordinates=this.transition.translateToMap(this.position),this.update(e.updateInnerContent),this},this.refreshContent=function(t){if(t){var e=this.getData();e.loaded=!0,this.setData(e)}for(var a in Travian.Game.Map.Layer.prototype.refreshContent.call(this),this.layers)this.layers.hasOwnProperty(a)&&this.layers[a].refreshContent();return i(this),this},this.render=function(t){var e=this;for(var a in this.layers={},Travian.Game.Map.Layer.prototype.render.call(this,t),this.mapCoordinates=this.transition.registerCallbackOnZoom((function(){e.mapCoordinates=e.transition.translateToMap(e.position),e.update(!0)})).translateToMap(this.position),this.mapContainer.layers)if(this.mapContainer.layers.hasOwnProperty(a)){var n=this.mapContainer.layers[a];if(!n.class)continue;var o=Object.assign({},n,{index:a});this.layers[o.id]=new n.class(o,this)}var r=this.getData();return r.loaded=!0,this.setData(r),i(this),this},this.requestDataForPosition=function(e){var i=this;return this.updater.requestPosition({dataStoreType:Travian.Game.Map.DataStore.TYPE_TOOLTIP,position:e,onSuccess:function(a,n){!function(e,i,a){if(void 0===a&&(a={}),void 0!==a.tiles&&0!==a.tiles.length){for(var n in a.tiles)if(a.tiles.hasOwnProperty(n)){var o=a.tiles[n];(o=t(e,o,i)).position.x===i.x&&o.position.y===i.y&&(a.tile=o),e.dataStore.set({position:o.position,type:Travian.Game.Map.DataStore.TYPE_TOOLTIP,data:o})}e.dataStore.saveDataToStorage()}if(i.x===e.mapContainer.currentMousePosition.map.x&&i.y===e.mapContainer.currentMousePosition.map.y){e.mapContainer.contextMenu.update();var r=Object.assign({},e.dataStore.get(Travian.Game.Map.DataStore.TYPE_TOOLTIP,i));Travian.Tip.updateContentOfInstance(Travian.Game.Map.Tips.tooltipInstance,r)}}(i,e,a)},onError:function(t,a){!function(t,e,i){null!=t.mapContainer.currentMousePosition.map.x&&null!=t.mapContainer.currentMousePosition.map.y&&e.x===t.mapContainer.currentMousePosition.map.x&&e.y===t.mapContainer.currentMousePosition.map.y&&Travian.Tip.updateContentOfInstance(Travian.Game.Map.Tips.tooltipInstance,{title:"",text:Travian.Helpers.substitute("{x}|{y}",e)})}(i,e)}}),this},this.setData=function(t){return this.dataStore.push({type:Travian.Game.Map.DataStore.TYPE_BLOCKS,position:this.mapCoordinates,index:"block",data:Object.assign({loaded:!1,version:0},t)}),this},this.setVersion=function(t){var e=this.getData();return e.version=t,this.setData(e)},this.update=function(t){return Travian.Game.Map.Layer.prototype.update.call(this),this.updateContent(t),this},this.updateContent=function(t){for(var e in Travian.Game.Map.Layer.prototype.updateContent.call(this),this.layers)this.layers.hasOwnProperty(e)&&this.layers[e].updateContent(t);return t&&(a(this),this.getData.loaded?this.refreshContent(!1):this.updater.register("ajax",this)),this},this.updateSymbolData=function(t){return this.symbols&&this.symbols[t.position.x]&&this.symbols[t.position.x][t.position.y]?(this.symbols[t.position.x][t.position.y][t.dataId]&&this.symbols[t.position.x][t.position.y][t.dataId].updateData(t),this):this},Travian.Game.Map.Layer.call(this,n,o)};return o.prototype=Object.create(Travian.Game.Map.Layer.prototype),o.constructor=o,o}(),Travian.Game.Map.Layer.Block.getCorrectPosition=function(t,e){var i={position:t,updateInnerContent:!1,updateBlockPosition:!1};do{i.updateBlockPosition=!1,i.position.x<0&&Math.abs(i.position.x)>=e.blockSize.width?(i.position.x=e.elementSize.width+i.position.x,i.updateInnerContent=!0,i.updateBlockPosition=!0):i.position.x+i.position.width>e.elementSize.width&&(i.position.x=i.position.x-e.elementSize.width,i.updateInnerContent=!0,i.updateBlockPosition=!0),i.position.y<0&&Math.abs(i.position.y)>=e.blockSize.height?(i.position.y=e.elementSize.height+i.position.y,i.updateInnerContent=!0,i.updateBlockPosition=!0):i.position.y+i.position.height>e.elementSize.height&&(i.position.y=i.position.y-e.elementSize.height,i.updateInnerContent=!0,i.updateBlockPosition=!0)}while(i.updateBlockPosition);return i},Travian.Game.Map.Layer.Image=function(t,e){this.image=null,this.srcUrl=null,this.getPriority=function(){var t=this.blockContainer.mapCoordinates.x+(this.blockContainer.mapCoordinates.right-this.blockContainer.mapCoordinates.x)/2,e=this.blockContainer.mapCoordinates.y+(this.blockContainer.mapCoordinates.top-this.blockContainer.mapCoordinates.y)/2,i=this.transition.getPointOfCenterInView(),a={x:i.x-t,y:i.y-e};return Math.pow(a.x,2)+Math.pow(a.y,2)},this.getSrcUrl=function(){return Travian.Helpers.substitute(this.src,{x:this.parentContainer.mapCoordinates.x,y:this.parentContainer.mapCoordinates.y,right:this.parentContainer.mapCoordinates.right,top:this.parentContainer.mapCoordinates.top,suffix:"?t="+this.time})},this.refreshSrcUrl=function(){return this.srcUrl=this.getSrcUrl(),this},this.render=function(t){return Travian.Game.Map.Layer.prototype.render.call(this,{nodeType:'<img src="'+this.srcInit+'">'}),this.time=(new Date).getTime(),this.updateContent(),this},Travian.Game.Map.Layer.call(this,t,e)},Travian.Game.Map.Layer.Image.prototype=Object.create(Travian.Game.Map.Layer.prototype),Travian.Game.Map.Layer.Image.constructor=Travian.Game.Map.Layer.Image,Travian.Game.Map.Layer.Image.prototype.classType="Travian.Game.Map.Layer.Image",Travian.Game.Map.Layer.Image.prototype.updateContent=function(t){var e=this.getSrcUrl();return(this.srcUrl!==e||t)&&(this.refreshSrcUrl(),this.updater.register("images",this)),this},Travian.Game.Map.Layer.ImageMark=function(t,e){this.classType="Travian.Game.Map.Layer.ImageMark",this.finishedLoading=function(){return Travian.Game.Map.Layer.Image.prototype.finishedLoading.call(this),this.show(),this},this.forceUpdateContent=function(){return this.time=(new Date).getTime(),this.updateContent(!0),this},this.updateContent=function(t){return Travian.Game.Map.Layer.Image.prototype.updateContent.call(this,t),t&&this.hide(),this},Travian.Game.Map.Layer.Image.call(this,t,e)},Travian.Game.Map.Layer.ImageMark.prototype=Object.create(Travian.Game.Map.Layer.Image.prototype),Travian.Game.Map.Layer.ImageMark.constructor=Travian.Game.Map.Layer.Image,Travian.Game.Map.Layer.Loading=function(t,e){this.classType="Travian.Game.Map.Layer.Loading",this.render=function(t){return Travian.Game.Map.Layer.prototype.render.call(this,t),this.element.hide(),this},this.updateContent=function(t){return this},Travian.Game.Map.Layer.call(this,t,e)},Travian.Game.Map.Layer.Loading.prototype=Object.create(Travian.Game.Map.Layer.prototype),Travian.Game.Map.Layer.Loading.constructor=Travian.Game.Map.Layer,Travian.Game.Map.Layer.Symbol=function(t,e){this.byUser=!1,this.visible=!0,this.destroy=function(){return this.element&&this.element.remove(),this},this.forceUpdate=function(t){return this.byUser&&(this.visible=t,this.element[t?"show":"hide"]()),this},t.mapCoordinates=t.mapCoordinates||e.transition.translateToMap({x:t.position.x+e.position.x,y:t.position.y+e.position.y}),t.id=t.id||Travian.Game.Map.getNewId(),t.parameters=t.parameters||{},Travian.Game.Map.mapIds[t.dataId]=t.id,Travian.Game.Map.Layer.call(this,t,e)},Travian.Game.Map.Layer.Symbol.prototype=Object.create(Travian.Game.Map.Layer.prototype),Travian.Game.Map.Layer.constructor=Travian.Game.Map.Layer,Travian.Game.Map.Layer.Symbol.prototype.classType="Travian.Game.Map.Layer.Symbol",Travian.Game.Map.Layer.Symbol.prototype.updateData=function(t){this.title=t.title,this.text=t.text},Travian.Game.Map.Layer.Symbol.prototype.getContentForTooltip=function(){return!(!this.visible||!this.title&&!this.text)&&{title:this.title,text:this.text}},Travian.Game.Map.Layer.Symbol.prototype.render=function(t){return Travian.Game.Map.Layer.prototype.render.call(this,{nodeType:"<img/>"},t),this.element.attr("src",Travian.Helpers.substitute(this.imgSource,Object.assign({},this.parameters,{width:this.symbolSize.width,height:this.symbolSize.height,zoomLevel:this.transition.zoomLevel}))).css({position:"absolute",left:this.position.x,top:this.position.y,width:this.position.width,height:this.position.height}),this},Travian.Game.Map.Layer.Symbol.Flag=function(t,e){this.classType="Travian.Game.Map.Layer.Symbol.Flag",this.index=null,this.render=function(t){this.parameters.index=this.index||1,Travian.Game.Map.Layer.Symbol.prototype.render.call(this,t);var e=Travian.Game.Map.Options.Toolbar,i="alliance"===this.layer?"filterAlliance":"filterPlayer";return this.mapContainer.toolbar&&(e=this.mapContainer.toolbar),this.forceUpdate(e[i].checked),this},this.updateData=function(t){Travian.Game.Map.Layer.Symbol.prototype.updateData.call(this,t),this.parameters.index=this.index=t.index,this.element.attr("src",Travian.Helpers.substitute(this.imgSource,Object.assign({},this.parameters,{zoomLevel:this.transition.zoomLevel,width:this.symbolSize.width,height:this.symbolSize.height})))},Travian.Game.Map.Layer.Symbol.call(this,t,e)},Travian.Game.Map.Layer.Symbol.Flag.prototype=Object.create(Travian.Game.Map.Layer.Symbol.prototype),Travian.Game.Map.Layer.Symbol.constructor=Travian.Game.Map.Layer.Symbol,Travian.Game.Map.Layer.Symbol.Attack=function(t,e){this.classType="Travian.Game.Map.Layer.Symbol.Attack",Travian.Game.Map.Layer.Symbol.call(this,t,e)},Travian.Game.Map.Layer.Symbol.Attack.prototype=Object.create(Travian.Game.Map.Layer.Symbol.prototype),Travian.Game.Map.Layer.Symbol.Attack.constructor=Travian.Game.Map.Layer.Symbol,Travian.Game.Map.Layer.Symbol.BattleGround=function(t,e){this.classType="Travian.Game.Map.Layer.Symbol.BattleGround",this.getContentForTooltip=function(){return!1},this.render=function(t){return this.position={x:this.positionOfTile.x,y:this.positionOfTile.y,width:this.transition.pixelPerTile.x,height:this.transition.pixelPerTile.y},Travian.Game.Map.Layer.Symbol.prototype.render.call(this,t),this},Travian.Game.Map.Layer.Symbol.call(this,t,e)},Travian.Game.Map.Layer.Symbol.BattleGround.prototype=Object.create(Travian.Game.Map.Layer.Symbol.prototype),Travian.Game.Map.Layer.Symbol.BattleGround.constructor=Travian.Game.Map.Layer.Symbol.BattleGround,Travian.Game.Map.Layer.Symbol.Adventure=function(t,e){this.classType="Travian.Game.Map.Layer.Symbol.Adventure",this.render=function(t){return this.position={x:this.positionOfTile.x+this.transition.pixelPerTile.x-this.position.width,y:this.positionOfTile.y+this.transition.pixelPerTile.y-this.position.height,width:this.position.width,height:this.position.height},Travian.Game.Map.Layer.Symbol.prototype.render.call(this,t),this},Travian.Game.Map.Layer.Symbol.call(this,t,e)},Travian.Game.Map.Layer.Symbol.Adventure.prototype=Object.create(Travian.Game.Map.Layer.Symbol.prototype),Travian.Game.Map.Layer.Symbol.Adventure.constructor=Travian.Game.Map.Layer.Symbol.Adventure,Travian.Game.Map.Layer.Symbol.Reinforcement=function(t,e){this.classType="Travian.Game.Map.Layer.Symbol.Reinforcement",this.render=function(t){return this.position={x:this.positionOfTile.x,y:this.positionOfTile.y+this.transition.pixelPerTile.y-this.position.height,width:this.position.width,height:this.position.height},Travian.Game.Map.Layer.Symbol.prototype.render.call(this,t),this},Travian.Game.Map.Layer.Symbol.call(this,t,e)},Travian.Game.Map.Layer.Symbol.Reinforcement.prototype=Object.create(Travian.Game.Map.Layer.Symbol.prototype),Travian.Game.Map.Layer.Symbol.Reinforcement.constructor=Travian.Game.Map.Layer.Symbol.Reinforcement,Travian.Game.Map.MapMark=function(t,e){this.classType="Travian.Game.Map.MapMark",this.render=function(){for(var t in this.element=jQuery(this.element),this.layers)if(this.layers.hasOwnProperty(t)){var e=this.layers[t];this.layers[t]=new e.class(e,this)}this.update();for(var i=0;i<this.data.length;i++){var a=this.data[i];a.layer&&this.layers[a.layer]&&this.layers[a.layer].addData(a)}return this},this.update=function(){var t=[],e=this.element.height();for(var i in this.layers)if(this.layers.hasOwnProperty(i)){var a=this.layers[i];t.push({data:a.elements.data,expandContainer:a.elements.expandContainer,expanded:a.expanded}),e-=a.element.outerHeight()-a.elements.expandContainer.outerHeight()}for(var n=0;n<t.length;n++){var o=t[n];o.data.parent().css({height:e}),o.expandContainer.css({height:o.expanded?e:0})}},Travian.Game.Map.Base.call(this,t,e),this.render()},Travian.Game.Map.MapMark.prototype=Object.create(Travian.Game.Map.Base.prototype),Travian.Game.Map.MapMark.constructor=Travian.Game.Map.MapMark,Travian.Game.Map.MapMark.Layer=function(t,e){Travian.Game.Map.Base.call(this,t,e);var i=Travian.Game.Preferences.get("markLayer-"+this.parentContainer.typeId+"-"+this.typeId+"-expanded");null!=i&&(this.expanded=i),this.datas={},this.render()},Travian.Game.Map.MapMark.Layer.prototype=Object.create(Travian.Game.Map.Base.prototype),Travian.Game.Map.MapMark.Layer.constructor=Travian.Game.Map.MapMark.Layer,Travian.Game.Map.MapMark.Layer.prototype.classType="Travian.Game.Map.MapMark.Layer",Travian.Game.Map.MapMark.Layer.prototype.addData=function(t){return this},Travian.Game.Map.MapMark.Layer.prototype.deleteData=function(t){return this.datas[t.id]&&delete this.datas[t.id],this},Travian.Game.Map.MapMark.Layer.prototype.render=function(t){var e=this;this.element=jQuery("<div></div>").addClass("collapseContainer").html(Travian.Helpers.substitute(this.html,Object.assign({},t||{},{data:"scroll-dataContainer",add:"addButton",expandButton:"expandButton",expandContainer:"expandContainer",title:this.title}))).appendTo(this.parentContainer.element),this.elements={data:this.element.find(".scroll-dataContainer"),title:this.element.find(".title"),add:this.element.find(".addButton"),expandButton:this.element.find(".expandButton"),expandContainer:this.element.find(".expandContainer")},!this.editable&&this.elements.add&&this.elements.add.hide();const i=new SimpleBar(this.elements.expandContainer[0],{autoHide:!1,direction:Travian.direction});return this.elements.expandButton&&(this.elements.expandButton.addClass(this.expanded?"collapse":"expand"),this.elements.expandButton.on("click",(function(t){if(!e.expanded){for(var a in e.parentContainer.layers)if(e.parentContainer.layers.hasOwnProperty(a)){var n=e.parentContainer.layers[a];n.expanded=!1,n.elements.expandButton.removeClass("collapse").addClass("expand"),Travian.Game.Preferences.set("markLayer-"+n.parentContainer.typeId+"-"+n.typeId+"-expanded",n.expanded)}e.expanded=!0,e.elements.expandButton.removeClass("expand").addClass("collapse"),Travian.Game.Preferences.set("markLayer-"+e.parentContainer.typeId+"-"+e.typeId+"-expanded",!0)}e.parentContainer.update(),jQuery(".simplebar-offset").css({left:0}),i.recalculate()}))),this},Travian.Game.Map.MapMark.Layer.Mark=function(t,e){for(var i in this.classType="Travian.Game.Map.MapMark.Layer.Mark",this.dialogInstance=null,this.addData=function(t){var e=new Travian.Game.Map.MapMark.Layer.Data.Mark(Object.assign({},t,this.optionsData,{editable:this.editable}),this);return this.datas[e.id]=e,this},this.add=function(t){var e=this;return this.editable?(Travian.api("map/multi-mark",{data:{data:{x:t.position.x,y:t.position.y,type:this.typeId,color:t.color||0,owner:this.parentContainer.typeId,text:t.text||void 0,title:t.title||void 0}},success:function(t){e.addData(t),e.mapContainer.forceUpdateBlocksLayer("imageMark"),e.dialogInstance.close(),e.dialogInstance=null},error:function(t){return e.dialogInstance.enableForm().toElement().find(".errorMessage").html(t.message),!1}}),this):this},this.render=function(t){var e=this;return Travian.Game.Map.MapMark.Layer.prototype.render.call(this,t),this.elements.add.on("click",(function(t){e.showDialog()})),this},this.showDialog=function(t){var e=this;t=Object.assign({color:this.color,onOkay:this.add.bind(this),onOpen:Travian.emptyFunction,position:{x:"",y:""}},t||{}),this.color=t.color;var i=Travian.Helpers.substitute(this.dialog.html,{select:"select",textX:this.dialog.textX,textY:this.dialog.textY,textDisplay:"textDisplay",coord:"coord",inputX:"inputX",inputY:"inputY"});return this.dialogInstance=new Travian.Dialog.Dialog({keepOpen:!0,relativeTo:this.mapContainer.container,elementFocus:""===t.position.x?this.dialog.elementFocusNew:this.dialog.elementFocusEdit,buttonTextOk:this.dialog.textOkay,title:this.dialog.title,preventFormSubmit:!0,onOpen:function(i,a){a.find("input.inputX").val(t.position.x),a.find("input.inputY").val(t.position.y);var n=new Travian.Game.ColorPicker(a.find(".select"),{colors:e.colorsArray,defaultColor:e.color,onChange:function(t,i){e.colorsArray.map((function(i,a){i===t&&(e.color=a)}))}});t.onOpen(i,a,n)},onOkay:function(i,a){t.onOkay({color:e.color,position:{x:a.find("input.inputX").val(),y:a.find("input.inputY").val()}},i,a)}}),this.dialogInstance.setContent(i),this.dialogInstance.show(),this},Travian.Game.Map.MapMark.Layer.call(this,t,e),this.colorsArray=[],this.colors)this.colors.hasOwnProperty(i)&&"string"==typeof this.colors[i]&&this.colorsArray.push(this.colors[i])},Travian.Game.Map.MapMark.Layer.Mark.prototype=Object.create(Travian.Game.Map.MapMark.Layer.prototype),Travian.Game.Map.MapMark.Layer.Mark.constructor=Travian.Game.Map.MapMark.Layer,Travian.Game.Map.MapMark.Layer.Flag=function(t,e){this.classType="Travian.Game.Map.MapMark.Layer.Flag",this.dialogInstance=null,this.add=function(t){var e=this;return this.editable?(t.index<this.indexes.min&&(t.index=this.indexes.max),t.index>this.indexes.max&&(t.index=this.indexes.min),Travian.api("map/flag",{data:{data:{x:t.position.x,y:t.position.y,color:t.index||this.indexes.min,owner:this.parentContainer.typeId,text:t.text||void 0,title:t.title||void 0}},success:function(i){i.type="flag",e.dataStore.push({type:Travian.Game.Map.DataStore.TYPE_SYMBOL,index:i.dataId,position:i.position,data:i,time:!1}),e.addData(i),i.position=t.position,i.layer=e.parentContainer.typeId,e.mapContainer.addSymbol(i),e.dialogInstance.close(),e.dialogInstance=null},error:function(t){return e.dialogInstance.enableForm().toElement().find(".errorMessage").html(t.message),!1}}),this):this},this.addData=function(t){var e=new Travian.Game.Map.MapMark.Layer.Data.Flag(Object.assign({},t,this.optionsData,{editable:this.editable}),this);return this.datas[e.id]=e,this},this.render=function(t){Travian.Game.Map.MapMark.Layer.prototype.render.call(this,t);var e=this;return this.elements.add.on("click",(function(i){e.showDialog(t)})),this},this.showDialog=function(t){var e=this;t=Object.assign({index:this.index,onOkay:this.add.bind(this),onOpen:Travian.emptyFunction,text:"",position:{x:"",y:""}},t||{}),this.index=t.index;var i=Travian.Helpers.substitute(this.dialog.html,{select:"select",textX:this.dialog.textX,textY:this.dialog.textY,textDisplay:"textDisplay",coord:"coord",inputX:"inputX",inputY:"inputY",inputText:"inputText"});return this.dialogInstance=new Travian.Dialog.Dialog({keepOpen:!0,relativeTo:this.mapContainer.container,elementFocus:""===t.position.x?this.dialog.elementFocusNew:this.dialog.elementFocusEdit,buttonTextOk:this.dialog.textOkay,title:this.dialog.title,preventFormSubmit:!0,onOpen:function(i,a){a.find("input.inputX").val(t.position.x),a.find("input.inputY").val(t.position.y),a.find("input.inputText").val(t.text);var n=new Travian.Game.ImagePicker(a.find(".select"),{images:e.imagesArray,defaultImage:e.index-e.indexes.min,onChange:function(t){e.imagesArray.map((function(i,a){i===t&&(e.index=a+1)}))}});t.onOpen(i,a,n)},onOkay:function(i,a){e.index<e.indexes.min&&(e.index+=e.indexes.min-1),t.onOkay({index:e.index,text:a.find("input.inputText").val(),position:{x:a.find("input.inputX").val(),y:a.find("input.inputY").val()}},i,a)}}),this.dialogInstance.setContent(i),this.dialogInstance.show(),this},Travian.Game.Map.MapMark.Layer.call(this,t,e),this.imagesArray=[];for(var i=this.indexes.min;i<=this.indexes.max;i++)this.imagesArray.push(Travian.Helpers.substitute(this.imgSource,{index:i}))},Travian.Game.Map.MapMark.Layer.Flag.prototype=Object.create(Travian.Game.Map.MapMark.Layer.prototype),Travian.Game.Map.MapMark.Layer.Flag.constructor=Travian.Game.Map.MapMark.Layer,Travian.Game.Map.MapMark.Layer.Data=function(t,e){Travian.Game.Map.MapMark.Layer.call(this,t,e)},Travian.Game.Map.MapMark.Layer.Data.prototype=Object.create(Travian.Game.Map.MapMark.Layer.prototype),Travian.Game.Map.MapMark.Layer.Data.constructor=Travian.Game.Map.MapMark.Layer,Travian.Game.Map.MapMark.Layer.Data.prototype.classType="Travian.Game.Map.MapMark.Layer.Data",Travian.Game.Map.MapMark.Layer.Data.prototype.del=function(){return this.destroy(),this.parentContainer.deleteData(this),this},Travian.Game.Map.MapMark.Layer.Data.prototype.render=function(t){var e=this;return this.element=jQuery("<div></div>").html(Travian.Helpers.substitute(this.html,Object.assign({},t||{},{entry:this.id,text:"textContainer",delete:"deleteButton",select:"selectLink",editDelete:"editDeleteContainer"}))).appendTo(this.parentContainer.elements.data),this.elements={text:this.element.find(".textContainer"),delete:this.element.find(".deleteButton"),select:this.element.find(".selectLink"),editDelete:this.element.find(".editDeleteContainer")},this.elements.delete.on("click",(function(t){e.del()})),this.elements.text.html(this.text),!this.editable&&this.elements.editDelete&&this.elements.editDelete.hide(),this},Travian.Game.Map.MapMark.Layer.Data.Mark=function(){var t=function(t){t.elements.color.css({backgroundColor:t.parentContainer.colors[t.color]})},e=function(e,i){this.classType="Travian.Game.Map.MapMark.Layer.Data.Mark",this.del=function(){var t=this;return this.editable?(Travian.api("map/flag",{data:{data:{dataId:this.dataId,owner:this.parentContainer.parentContainer.typeId,type:"mark"}},success:function(e){e.result&&(t.destroy(),t.mapContainer.forceUpdateBlocksLayer("imageMark"))}},"DELETE"),this):this},this.render=function(e){var i=this;return Travian.Game.Map.MapMark.Layer.Data.prototype.render.call(this,{color:"colorContainer",urlLink:"urlLink"}),this.elements.color=this.element.find(".colorContainer"),this.elements.urlLink=this.element.find(".urlLink"),this.elements.urlLink&&(this.elements.urlLink.href=Travian.Helpers.substitute(this.urlLink,{markId:this.markId})),this.editable&&this.elements.select.on("click",(function(t){i.parentContainer.showDialog({color:i.color,onOpen:function(t,e,a){e.find(".coord").each((function(t,e){jQuery(e).hide()})),e.find(".textDisplay").show().html(i.text)},onOkay:function(t,e,a){i.setColor(t.color)}})})),this.elements.urlLink.on("click",(function(t){i.elements.urlLink&&(window.location.href=i.elements.urlLink.href)})),t(this),this},this.setColor=function(e){var i=this;return this.editable?("number"!=typeof e||(e<this.parentContainer.colors.min&&(e=this.parentContainer.colors.max),e>this.parentContainer.colors.max&&(e=this.parentContainer.colors.min),Travian.api("map/multi-mark",{data:{data:{color:e,dataId:this.dataId,owner:this.parentContainer.parentContainer.typeId}},success:function(a){a&&(i.color=e,t(i),i.mapContainer.forceUpdateBlocksLayer("imageMark")),i.parentContainer.dialogInstance.close(),i.parentContainer.dialogInstance=null},error:function(t){return i.parentContainer.dialogInstance.enableForm().toElement().find(".errorMessage").html(t.message),!1}},"PATCH")),this):this},e.color=Number(e.color),Travian.Game.Map.MapMark.Layer.Data.call(this,e,i)};return e.prototype=Object.create(Travian.Game.Map.MapMark.Layer.Data.prototype),e.constructor=e,e}(),Travian.Game.Map.MapMark.Layer.Data.Flag=function(){var t=function(t){t.elements.text.html(t.text),t.elements.index.html('<img src="'+Travian.Helpers.substitute(t.parentContainer.imgSource,{index:t.index})+'" alt="" />')},e=function(e,i){this.classType="Travian.Game.Map.MapMark.Layer.Data.Flag",this.del=function(){var t=this;return this.editable?(Travian.api("map/flag",{data:{data:{dataId:this.dataId,owner:this.parentContainer.parentContainer.typeId,type:"flag"}},success:function(e){e.result&&(t.destroy(),t.dataStore.remove(Travian.Game.Map.DataStore.TYPE_SYMBOL,{x:t.x,y:t.y},t.dataId),t.mapContainer.deleteSymbol({position:{x:t.x,y:t.y},dataId:t.dataId}))}},"DELETE"),this):this},this.render=function(e){var i=this;return Travian.Game.Map.MapMark.Layer.Data.prototype.render.call(this,{index:"indexContainer",urlLink:"urlLink"}),this.elements.index=this.element.find(".indexContainer"),this.elements.urlLink=this.element.find(".urlLink"),this.editable&&this.elements.select.on("click",(function(t){i.parentContainer.showDialog({index:i.index,text:i.text,position:{x:i.x,y:i.y},onOpen:function(t,e,a){i.dialogInstance=t,e.find("input.inputX").prop("disabled",!0),e.find("input.inputY").prop("disabled",!0)},onOkay:function(t,e,a){i.setIndex(t.index,t.text)}})})),this.elements.urlLink.on("click",(function(t){i.mapContainer.isEventsEnabled()&&i.mapContainer.moveTo({x:i.x,y:i.y})})),t(this),this},this.setIndex=function(e,i){var a=this;return this.editable?("number"!=typeof e||(e<this.parentContainer.indexes.min&&(e=this.parentContainer.indexes.max),e>this.parentContainer.indexes.max&&(e=this.parentContainer.indexes.min),Travian.api("map/flag",{data:{data:{index:e,text:i,dataId:this.dataId,owner:this.parentContainer.parentContainer.typeId}},success:function(n){if(n){a.index=e,a.text=i,t(a);var o=a.dataStore.get(Travian.Game.Map.DataStore.TYPE_SYMBOL,{x:a.x,y:a.y},a.dataId);o.index=a.index,o.text=a.text,a.dataStore.push({type:Travian.Game.Map.DataStore.TYPE_SYMBOL,position:{x:a.x,y:a.y},index:a.dataId,data:o,time:!1}),a.mapContainer.updateSymbolData({position:{x:a.x,y:a.y},dataId:a.dataId,index:a.index,text:a.text})}a.dialogInstance.close(),a.dialogInstance=null},error:function(t){return a.parentContainer.dialogInstance.enableForm().toElement().down(".errorMessage").html(t.message),!1}},"PATCH")),this):this},e.index=Number(e.index),Travian.Game.Map.MapMark.Layer.Data.call(this,e,i)};return e.prototype=Object.create(Travian.Game.Map.MapMark.Layer.Data.prototype),e.constructor=e,e}(),Travian.Game.Map.Options={},Travian.Game.Map.Options.Symbols={flag:{class:Travian.Game.Map.Layer.Symbol.Flag,imgSource:"img/map/flag/flag-{index}/{width}x{height}.png",byUser:!0,zIndex:10,visibleInZoom:{1:!0,2:!0,3:!1,4:!1},sizes:{1:{width:16,height:16},2:{width:10,height:10},3:{width:6,height:6},4:{width:4,height:4}}},attack:{class:Travian.Game.Map.Layer.Symbol.Attack,imgSource:"img/map/attack/attack-{attackType}/{width}x{height}.gif",zIndex:10,visibleInZoom:{1:!0,2:!0,3:!1,4:!1},sizes:{1:{width:16,height:16},2:{width:10,height:10},3:{width:6,height:6},4:{width:4,height:4}}},battleGround:{class:Travian.Game.Map.Layer.Symbol.BattleGround,imgSource:"img/map/battleground/battleground-{center}-{north}-{east}-{south}-{west}-{width}x{height}.png",zIndex:9,visibleInZoom:{1:!0,2:!0,3:!1,4:!1},sizes:{1:{width:16,height:16},2:{width:8,height:8},3:{width:4,height:4},4:{width:4,height:4}}},adventure:{class:Travian.Game.Map.Layer.Symbol.Adventure,imgSource:"img/map/adventure/difficulty-{difficulty}/{width}x{height}.png",zIndex:10,visibleInZoom:{1:!0,2:!0,3:!1,4:!1},sizes:{1:{width:16,height:16},2:{width:8,height:8},3:{width:6,height:6},4:{width:4,height:4}}},reinforcement:{class:Travian.Game.Map.Layer.Symbol.Reinforcement,imgSource:"img/map/reinforcement/{width}x{height}.gif",zIndex:10,visibleInZoom:{1:!0,2:!0,3:!1,4:!1},sizes:{1:{width:16,height:16},2:{width:10,height:10},3:{width:6,height:6},4:{width:4,height:4}}}},Travian.Game.Map.Options.Rulers={direction:null,imgSource:{x:"img/map/rulers/x-{zoomLevel}.gif",y:"img/map/rulers/y-{zoomLevel}.gif"},cls:{x:"ruler x",y:"ruler y"},steps:{x:{1:1,2:1,3:10,4:20},y:{1:1,2:1,3:10,4:20}},delta:{x:{1:0,2:0,3:0,4:0},y:{1:0,2:0,3:-9,4:-19}}},Travian.Game.Map.Options.MiniMap={container:"#miniMap",containerContent:"#minimapContainer",showToolTip:!0,classLines:{x:"lines",y:"lines"},tooltipHtml:'<span class="xCoord">({x}</span><span class="pi">|</span><span class="yCoord">{y})</span><span class="clear"></span>'},Travian.Game.Map.Options.Toolbar={element:"#toolbar",viewFullScreenUrl:"/karte.php?fullscreen=1&x={x}&y={y}&zoom={zoom}",viewNormalUrl:"/karte.php?x={x}&y={y}&zoom={zoom}",filterPlayer:{checked:!0},filterAlliance:{checked:!0}},Travian.Game.Map.Options.Outline={element:"#outline"},Travian.Game.Map.Options.MapMark=Travian.Game.Map.Options.MapMark||{},Travian.Game.Map.Options.MapMark.Mark={class:Travian.Game.Map.MapMark.Layer.Mark,title:"",typeId:"player",editable:!0,expanded:!1,color:0,colors:{0:"#C0C0C0",1:"#FF7722",2:"#B15BDB",3:"#DF4E78",4:"#34822F",5:"#3F90C5",6:"#C2AF09",7:"#8B1C1C",8:"#575BD2",9:"#4FE600",min:0,max:9},html:'<div class="title">{title} <a href="#" class="add {add}">+</a></div><div class="iconButton {expandButton} small"></div><div class="clear"></div><div class="{expandContainer}"><div class="{data}"></div></div>',dialog:{title:"",textOkay:"okay",textCancel:"cancel",textX:"X:",textY:"Y:",elementFocusNew:"#coordinateDialogX",elementFocusEdit:"#coordinateDialogX",html:'<div class="mapMarkMark"><div class="color {select}"></div><div class="{coord}"><span>{textX}</span><input id="coordinateDialogX" class="text coordinates x {inputX}" type="text" /><span>{textY}</span><input class="text coordinates y {inputY}" type="text" /></div><div class="{textDisplay}"></div></div>'},optionsData:{urlLink:"/profile/{markId}",html:'<div class="entry flag {entry}"><div class="marker color"><a href="#" class="{select} {color}"></a></div><div class="text"><a href="#" class="{urlLink} {text}"></a></div><div class="iconButton delete small {editDelete} {delete}"></div></div>'}},Travian.Game.Map.Options.MapMark=Travian.Game.Map.Options.MapMark||{},Travian.Game.Map.Options.MapMark.Flag={class:Travian.Game.Map.MapMark.Layer.Flag,title:"",editable:!0,expanded:!0,typeId:"flag",index:1,indexes:{min:1,max:20},imgSource:Travian.Helpers.substitute(Travian.Game.Map.Options.Symbols.flag.imgSource,{index:"{index}",zoomLevel:1,width:16,height:16}),html:'<div class="title">{title} <a href="#" class="add {add}">+</a></div><div class="iconButton {expandButton} small"></div><div class="clear"></div><div class="{expandContainer}"><div class="{data}"></div></div>',dialog:{title:"",textOkay:"okay",textCancel:"cancel",textX:"X:",textY:"Y:",elementFocusNew:"#coordinateDialogX",elementFocusEdit:"#coordinateDialogText",html:'<div class="mapMarkField"><div class="flag {select}"></div><div class="{coord}"><span>{textX}</span><input id="coordinateDialogX" class="text coordinates x {inputX}" type="text" /><span>{textY}</span><input class="text coordinates y {inputY}" type="text" /></div><div class="{textDisplay}"><input id="coordinateDialogText" class="text {inputText}" type="text" /></div><p class="error errorMessage"></p></div>'},optionsData:{html:'<div class="entry flag {entry}"><div class="marker index"><a href="#" class="{select} {index}"></a></div><div class="text"><a href="#" class="{urlLink} {text}"></a></div><div class="iconButton delete small {editDelete} {delete}"></div></div>'}},Travian.Game.Map.Options.Default={container:"#mapContainer",containerViewSize:null,tileDisplayInformation:{type:"dialog",optionsPopup:{url:"/position_details.php?x={x}&y={y}",windowOptions:{}},optionsDialog:{buttonOk:!1,data:{x:null,y:null}}},blockOverflow:1,blockSize:{width:170,height:150},mapInitialPosition:{x:0,y:0},grid:{1:"/img/map/grid/grid-1.gif",2:"/img/map/grid/grid-2.gif",3:"/img/map/grid/grid-3.gif",4:!1},speeds:{slow:5,normal:20,fast:40},symbolTypes:Travian.Game.Map.Options.Symbols,onCreate:function(t){},onRender:function(t){if(Travian.Game.Map.Tips.render(t,t.containerMover),t.rulers=new Travian.Game.Map.Rulers(Travian.Game.Map.Options.Rulers,t),t.rulers.render(),t.miniMap=new Travian.Game.Map.MiniMap(Travian.Game.Map.Options.MiniMap,t),t.miniMap.render(),t.mapMarks)for(var e in t.mapMarks)if(t.mapMarks.hasOwnProperty(e)){var i=t.mapMarks[e];!0===i.enabled?t.mapMarks[e]=new Travian.Game.Map.MapMark(i,t):delete t.mapMarks[e]}t.outline=new Travian.Game.Map.Outline(Travian.Game.Map.Options.Outline,t),t.toolbar=new Travian.Game.Map.Toolbar(Travian.Game.Map.Options.Toolbar,t),t.toolbar.render()},onMove:function(t,e){t.rulers&&t.rulers.move(e),t.miniMap&&t.miniMap.move()},onZoom:function(t){t.rulers&&t.rulers.zoom(),t.miniMap&&t.miniMap.zoom(),t.toolbar&&t.toolbar.zoom()}},Travian.Game.Map.Options.Default.contextMenu={targets:"#mapContainer",zIndex:2e3,menu:"#contextmenu",actions:[{element:"#contextMenuSendTroops",displayOn:"did",shouldDisplay:function(t){return void 0!==t[this.displayOn]},fn:function(t,e,i){window.location.href="/build.php?gid=16&tt=2&eventType=5&x="+i.position.x+"&y="+i.position.y}},{element:"#contextMenuSendTraders",displayOn:"uid",shouldDisplay:function(t){var e=void 0!==t[this.displayOn],i="{k.bt}"!==t.title;return e&&i},fn:function(t,e,i){window.location.href="/build.php?gid=17&t=5&x="+i.position.x+"&y="+i.position.y}},{element:"#contextMenuMarkPlayerAlliance",displayOn:"aid",shouldDisplay:function(t){return void 0!==t[this.displayOn]},fn:function(t,e,i){t.parentContainer.mapMarks.player.layers.alliance.showDialog({position:e})}},{element:"#contextMenuMarkPlayerPlayer",displayOn:"uid",shouldDisplay:function(t){return void 0!==t[this.displayOn]},fn:function(t,e,i){t.parentContainer.mapMarks.player.layers.player.showDialog({position:e})}},{element:"#contextMenuFlagPlayer",displayOn:!0,shouldDisplay:function(t){return!0},fn:function(t,e,i){t.parentContainer.mapMarks.player.layers.flag.showDialog({position:e})}},{element:"#contextMenuMarkAllianceAlliance",displayOn:"aid",shouldDisplay:function(t){return void 0!==t[this.displayOn]},fn:function(t,e,i){t.parentContainer.mapMarks.alliance.layers.alliance.showDialog({position:e})}},{element:"#contextMenuMarkAlliancePlayer",displayOn:"uid",shouldDisplay:function(t){return void 0!==t[this.displayOn]},fn:function(t,e,i){t.parentContainer.mapMarks.alliance.layers.player.showDialog({position:e})}},{element:"#contextMenuFlagAlliance",displayOn:!0,shouldDisplay:function(t){return!0},fn:function(t,e,i){t.parentContainer.mapMarks.alliance.layers.flag.showDialog({position:e})}}]},Travian.Game.Map.Options.Default.transition={onCreate:function(t){},onMove:function(t,e){},onZoom:function(t){},zoomOptions:{level:1,sizes:[]},border:Travian.Variables.Map.Size},Travian.Game.Map.Options.Default.layers=[{id:"loading",class:Travian.Game.Map.Layer.Loading,zIndex:20},{id:"image",src:"/map/block/{x}.{y}.{right}.{top}.png",srcInit:"/img/x.gif",class:Travian.Game.Map.Layer.Image,zIndex:1},{id:"imageMark",src:"/map/mark/{x}.{y}.{right}.{top}.png{suffix}",srcInit:"/img/x.gif",class:Travian.Game.Map.Layer.ImageMark,zIndex:2}],Travian.Game.Map.Options.Default.block={tooltipHtml:'<span class="xCoord">({x}</span><span class="pi">|</span><span class="yCoord">{y})</span><span class="clear"></span><br />{k.loadingData}'},Travian.Game.Map.Options.Default.updater={maxRequestCount:5,parameters:{multiple:{},position:{}},requestDelayTime:{multiple:100,position:300},elementWorking:"#working",positionOptions:{areaAroundPosition:{1:{left:-5,bottom:-4,right:5,top:4},2:{left:-10,bottom:-8,right:10,top:8},3:{left:-25,bottom:-25,right:25,top:25},4:{left:-25,bottom:-25,right:25,top:25}}}},Travian.Game.Map.Options.Default.keyboard={37:"moveLeft",65:"moveLeft",100:"moveLeft",39:"moveRight",68:"moveRight",102:"moveRight",38:"moveUp",87:"moveUp",104:"moveUp",40:"moveDown",83:"moveDown",98:"moveDown",103:"moveLeftUp",97:"moveLeftDown",105:"moveRightUp",99:"moveRightDown",speed:{slow:"control",fast:"shift"},61:{fn:"zoomIn",periodical:0},107:{fn:"zoomIn",periodical:0},109:{fn:"zoomOut",periodical:0},71:{fn:"toggleGrid",periodical:0},77:{fn:"toggleMiniMap",periodical:0},79:{fn:"toggleOutline",periodical:0}},Travian.Game.Map.Options.Default.dataStore={cachingTimeForType:{blocks:18e5,symbol:6e5,tile:6e5,tooltip:12e4},persistentStorage:!1,useStorageForType:{blocks:!1,symbol:!1,tile:!1,tooltip:!0},clearStorageForType:{blocks:!1,symbol:!1,tile:!1,tooltip:!1}},Travian.Game.Map.Options.Default.data={elements:[]},Travian.Game.Map.Options.Default.mapMarks={player:{enabled:!0,data:[],element:"#tabPlayer",typeId:"player",layers:{alliance:Object.assign({},Travian.Game.Map.Options.MapMark.Mark,{typeId:"alliance",optionsData:Object.assign({},Travian.Game.Map.Options.MapMark.Mark.optionsData,{urlLink:"/alliance/{markId}"})}),player:Object.assign({},Travian.Game.Map.Options.MapMark.Mark,{typeId:"player"}),flag:Object.assign({},Travian.Game.Map.Options.MapMark.Flag,{indexes:{min:1,max:10}})}},alliance:{enabled:!0,data:[],element:"#tabAlliance",typeId:"alliance",layers:{alliance:Object.assign({},Travian.Game.Map.Options.MapMark.Mark,{typeId:"alliance",optionsData:Object.assign({},Travian.Game.Map.Options.MapMark.Mark.optionsData,{urlLink:"/alliance/{markId}"})}),player:Object.assign({},Travian.Game.Map.Options.MapMark.Mark,{typeId:"player"}),flag:Object.assign({},Travian.Game.Map.Options.MapMark.Flag,{indexes:{min:11,max:20}})}}};
